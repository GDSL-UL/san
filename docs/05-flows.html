<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>5&nbsp; Spatial Interaction Modelling – Spatial Modelling for Data Scientists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./06-spatial-econometrics.html" rel="next">
<link href="./04-points.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3d62d204ba1604a696ce2d8f1e6896bb.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-050f1b1f236d8b339ca4f69fc358516a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./05-flows.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Modelling for Data Scientists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/GDSL-UL/san" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-spatial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Spatial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Data Wrangling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Point Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-flows.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-spatial-econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-multilevel-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-multilevel-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-gwr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically Weighted Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-st_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatio-Temporal Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Data Sets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#dependencies" id="toc-dependencies" class="nav-link active" data-scroll-target="#dependencies"><span class="header-section-number">5.1</span> Dependencies</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">5.2</span> Data</a></li>
  <li><a href="#seeing-flows" id="toc-seeing-flows" class="nav-link" data-scroll-target="#seeing-flows"><span class="header-section-number">5.3</span> “<em>Seeing</em>” flows</a></li>
  <li><a href="#modelling-flows" id="toc-modelling-flows" class="nav-link" data-scroll-target="#modelling-flows"><span class="header-section-number">5.4</span> Modelling flows</a></li>
  <li><a href="#predicting-flows" id="toc-predicting-flows" class="nav-link" data-scroll-target="#predicting-flows"><span class="header-section-number">5.5</span> Predicting flows</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">5.6</span> Questions</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/05-flows.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-chp5" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>This chapter covers spatial interaction flows. Using open data from the city of San Francisco about trips on its bikeshare system, we will estimate spatial interaction models that try to capture and explain the variation in the amount of trips on each given route. After visualizing the dataset, we begin with a very simple model and then build complexity progressively by augmenting it with more information, refined measurements, and better modeling approaches. Throughout the chapter, we explore different ways to grasp the predictive performance of each model. We finish with a prediction example that illustrates how these models can be deployed in a real-world application.</p>
<p>Content is based on the following references, which are great follow-up’s on the topic:</p>
<ul>
<li>
<span class="citation" data-cites="fotheringham1989spatial">Fotheringham and O’Kelly (<a href="references.html#ref-fotheringham1989spatial" role="doc-biblioref">1989</a>)</span> offer a historical overview of spatial interaction models and illustration of use cases.</li>
<li>
<span class="citation" data-cites="rowe2022">Rowe, Lovelace, and Dennett (<a href="references.html#ref-rowe2022" role="doc-biblioref">2022</a>)</span> provide a good overview of the existing limitations and opportunities of spatial interaction modelling.</li>
<li>
<span class="citation" data-cites="gds_ua17">Singleton (<a href="references.html#ref-gds_ua17" role="doc-biblioref">2017</a>)</span>, an online short course on R for Geographic Data Science and Urban Analytics. In particular, the section on <a href="https://github.com/alexsingleton/GDS_UA_2017/tree/master/Mapping_Flows">mapping flows</a> is specially relevant here.</li>
<li>The predictive checks section draws heavily from <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span>, in particular Chapters 6 and 7.</li>
</ul>
<section id="dependencies" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="dependencies">
<span class="header-section-number">5.1</span> Dependencies</h2>
<p>We will rely on the following libraries in this section, all of them included in <a href="01-overview.html#sec-dependencies" class="quarto-xref"><span>Section 1.4.1</span></a>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data management</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># Spatial Data management</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span></span>
<span><span class="co"># Pretty graphics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co"># Thematic maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span></span>
<span><span class="co"># Add basemaps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Chrisjb/basemapR">basemapR</a></span><span class="op">)</span></span>
<span><span class="co"># Simulation methods</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=arm">arm</a></span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In this chapter we will show a slightly different way of managing spatial data in R. Although most of the functionality will be similar to that seen in previous chapters, we will not rely on the “<code>sf</code> stack” and we will instead show how to read and manipulate data using the more traditional <code>sp</code> stack. Although this approach is being slowly phased out, it is still important to be aware of its existence and its differences with more modern approaches.</p>
</section><section id="data" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="data">
<span class="header-section-number">5.2</span> Data</h2>
<p>In this note, we will use data from the city of San Francisco representing bike trips on their public bike share system. The original source is the <a href="https://datasf.org/opendata/">SF Open Data portal</a> and the dataset comprises both the location of each station in the Bay Area as well as information on trips (station of origin to station of destination) undertaken in the system from September 2014 to August 2015 and the following year. Since this note is about modeling and not data preparation, a cleanly reshaped version of the data, together with some additional information, has been created and placed in the <code>sf_bikes</code> folder. The data file is named <code>flows.geojson</code> and, in case you are interested, the (Python) code required to created from the original files in the SF Data Portal is also available on the <code>flows_prep.ipynb</code> <a href="https://github.com/darribas/spa_notes/blob/master/sf_bikes/flows_prep.ipynb">notebook</a>, also in the same folder.</p>
<p>Let us then directly load the file with all the information necessary:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'./data/sf_bikes/flows.geojson'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `flows' from data source 
  `/Users/franciscorowe/Library/CloudStorage/Dropbox/Francisco/uol/teaching/envs453/202526/san/data/sf_bikes/flows.geojson' 
  using driver `GeoJSON'
Simple feature collection with 1722 features and 9 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -122.4237 ymin: 37.76914 xmax: -122.3875 ymax: 37.80737
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<p>Note how the interface is slightly different since we are reading a <code>GeoJSON</code> file instead of a shapefile.</p>
<p>The data contains the geometries of the flows, as calculated from the <a href="https://developers.google.com/maps/">Google Maps API</a>, as well as a series of columns with characteristics of each flow:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 9 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -122.4083 ymin: 37.7838 xmax: -122.3945 ymax: 37.80097
Geodetic CRS:  WGS 84
  flow_id dest orig straight_dist street_dist total_down total_up trips15
1   39-41   41   39      1452.201   1804.1150  11.205753 4.698162      68
2   39-42   42   39      1734.861   2069.1557  10.290236 2.897886      23
3   39-45   45   39      1255.349   1747.9928  11.015596 4.593927      83
4   39-46   46   39      1323.303   1490.8361   3.511543 5.038044     258
5   39-47   47   39       715.689    769.9189   0.000000 3.282495     127
6   39-48   48   39      1996.778   2740.1290  11.375186 3.841296      81
  trips16                       geometry
1      68 LINESTRING (-122.4083 37.78...
2      29 LINESTRING (-122.4083 37.78...
3      50 LINESTRING (-122.4083 37.78...
4     163 LINESTRING (-122.4083 37.78...
5      73 LINESTRING (-122.4083 37.78...
6      56 LINESTRING (-122.4083 37.78...</code></pre>
</div>
</div>
<p>where <code>orig</code> and <code>dest</code> are the station IDs of the origin and destination, <code>street/straight_dist</code> is the distance in metres between stations measured along the street network or as-the-crow-flies, <code>total_down/up</code> is the total downhil and climb in the trip, and <code>tripsXX</code> contains the amount of trips undertaken in the years of study.</p>
</section><section id="seeing-flows" class="level2 page-columns page-full" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="seeing-flows">
<span class="header-section-number">5.3</span> “<em>Seeing</em>” flows</h2>
<p>The easiest way to get a quick preview of what the data looks like spatially is to make a simple plot:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">db</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Equally, if we want to visualize a single route, we can simply subset the table. For example, to get the shape of the trip from station <code>39</code> to station <code>48</code>, we can:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">orig</span> <span class="op">==</span> <span class="fl">39</span> <span class="op">&amp;</span> <span class="va">dest</span> <span class="op">==</span> <span class="fl">48</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>          size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>or, for the most popular route, we can:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">most_pop</span> <span class="op">&lt;-</span> <span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">trips15</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">trips15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>These however do not reveal a lot: there is no geographical context (<em>why are there so many routes along the NE?</em>) and no sense of how volumes of bikers are allocated along different routes. Let us fix those two.</p>
<p>The easiest way to bring in geographical context is by overlaying the routes on top of a background map of tiles downloaded from the internet. Let us download this using <code>basemapR</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a bounding box</span></span>
<span><span class="va">bbox_db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span>
<span><span class="co"># download a basemap using ggplot and basemapR</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/basemapR/man/base_map.html">base_map</a></span><span class="op">(</span><span class="va">bbox_db</span>, increase_zoom <span class="op">=</span> <span class="fl">2</span>, basemap <span class="op">=</span> <span class="st">"positron"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">db</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now to combine tiles and routes, we need to pull out the coordinates that make up each line. For the route example above, this would be:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">xys1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">most_pop</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we can plot the route (note we also dim down the background to focus the attention on flows):</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Task</strong></p>
<p>Can you plot the route for the largest climb?</p>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/basemapR/man/base_map.html">base_map</a></span><span class="op">(</span><span class="va">bbox_db</span>, increase_zoom <span class="op">=</span> <span class="fl">2</span>, basemap <span class="op">=</span> <span class="st">"dark"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">db</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">xys1</span>, </span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span> <span class="op">)</span>, </span>
<span>             <span class="co">#size = 1,</span></span>
<span>             color <span class="op">=</span> <span class="st">"green"</span>,</span>
<span>             lineend <span class="op">=</span><span class="st">'round'</span></span>
<span>             <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now we can plot all of the lines by using a short <code>for</code> loop to build up the table:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set up shell data.frame</span></span>
<span><span class="va">lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, </span>
<span>  lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, </span>
<span>  trips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Run loop</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Pull out row</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span></span>
<span>  <span class="co"># Extract lon/lat coords</span></span>
<span>  <span class="va">xys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">xys</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'lon'</span>, <span class="st">'lat'</span><span class="op">)</span></span>
<span>  <span class="co"># Insert trips and id</span></span>
<span>  <span class="va">xys</span><span class="op">[</span><span class="st">'trips'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">r</span><span class="op">$</span><span class="va">trips15</span></span>
<span>  <span class="va">xys</span><span class="op">[</span><span class="st">'id'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="co"># Append them to `lines`</span></span>
<span>  <span class="va">lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">lines</span>, <span class="va">xys</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we can go on and plot all of them:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># call basemap</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/basemapR/man/base_map.html">base_map</a></span><span class="op">(</span><span class="va">bbox_db</span>, increase_zoom <span class="op">=</span> <span class="fl">2</span>, basemap <span class="op">=</span> <span class="st">"dark"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">db</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">lines</span>, </span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">lon</span>, y<span class="op">=</span><span class="va">lat</span>, </span>
<span>                 group<span class="op">=</span><span class="va">id</span></span>
<span>                 <span class="op">)</span>, </span>
<span>             size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"green"</span>,</span>
<span>             lineend <span class="op">=</span> <span class="st">'round'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can get a sense of the distribution of the flows by associating a color gradient to each flow based on its number of trips:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># call basemap</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/basemapR/man/base_map.html">base_map</a></span><span class="op">(</span><span class="va">bbox_db</span>, increase_zoom <span class="op">=</span> <span class="fl">2</span>, basemap <span class="op">=</span> <span class="st">"dark"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">db</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add flow data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">lines</span>, </span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span>, group <span class="op">=</span> <span class="va">id</span>, colour <span class="op">=</span> <span class="va">trips</span> <span class="op">)</span>, </span>
<span>             size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">lines</span><span class="op">$</span><span class="va">trips</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lines</span><span class="op">$</span><span class="va">trips</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             lineend <span class="op">=</span> <span class="st">'round'</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># create a colour palette</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span><span class="op">(</span></span>
<span>    low<span class="op">=</span><span class="st">'#440154FF'</span>, high<span class="op">=</span><span class="st">'#FDE725FF'</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note how we transform the size so it’s a proportion of the largest trip and then it is compressed with a logarithm.</p>
</section><section id="modelling-flows" class="level2 page-columns page-full" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="modelling-flows">
<span class="header-section-number">5.4</span> Modelling flows</h2>
<p>Now we have an idea of the spatial distribution of flows, we can begin to think about modeling them. The core idea in this section is to fit a model that can capture the particular characteristics of our variable of interest (the volume of trips) using a set of predictors that describe the nature of a given flow. We will start from the simplest model and then progressively build complexity until we get to a satisfying point. Along the way, we will be exploring each model using concepts from <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> such as predictive performance checks<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> (PPC)</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;For a more elaborate introduction to PPC, have a look at Chapters 7 and 8.</p></div></div><p>Before we start running regressions, let us first standardize the predictors so we can interpret the intercept as the average flow when all the predictors take the average value, and so we can interpret the model coefficients as changes in standard deviation units:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Scale all the table</span></span>
<span><span class="va">db_std</span> <span class="op">&lt;-</span> <span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">scale</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reset trips as we want the original version</span></span>
<span><span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">$</span><span class="va">trips15</span></span>
<span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">$</span><span class="va">trips16</span></span>
<span></span>
<span><span class="co"># Reset origin and destination station and express them as factors</span></span>
<span><span class="va">db_std</span><span class="op">$</span><span class="va">orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">db</span><span class="op">$</span><span class="va">orig</span><span class="op">)</span></span>
<span><span class="va">db_std</span><span class="op">$</span><span class="va">dest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">db</span><span class="op">$</span><span class="va">dest</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Baseline model</strong></p>
<p>One of the simplest possible models we can fit in this context is a linear model that explains the number of trips as a function of the straight distance between the two stations and total amount of climb and downhill. We will take this as the baseline on which we can further build later:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="st">'trips15 ~ straight_dist + total_up + total_down'</span>, data<span class="op">=</span><span class="va">db_std</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = "trips15 ~ straight_dist + total_up + total_down", 
    data = db_std)

Residuals:
   Min     1Q Median     3Q    Max 
-261.9 -168.3 -102.4   30.8 3527.4 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    182.070      8.110  22.451  &lt; 2e-16 ***
straight_dist   17.906      9.108   1.966   0.0495 *  
total_up       -44.100      9.353  -4.715 2.61e-06 ***
total_down     -20.241      9.229  -2.193   0.0284 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 336.5 on 1718 degrees of freedom
Multiple R-squared:  0.02196,   Adjusted R-squared:  0.02025 
F-statistic: 12.86 on 3 and 1718 DF,  p-value: 2.625e-08</code></pre>
</div>
</div>
<p>To explore how good this model is, we will be comparing the predictions the model makes about the number of trips each flow should have with the actual number of trips. A first approach is to simply plot the distribution of both variables:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  main<span class="op">=</span><span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col<span class="op">=</span><span class="st">'red'</span>,</span>
<span>  main<span class="op">=</span><span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span><span class="op">)</span>,</span>
<span>  col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'red'</span><span class="op">)</span>,</span>
<span>  lwd<span class="op">=</span><span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"Predictive check, point estimates - Baseline model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot makes pretty obvious that our initial model captures very few aspects of the distribution we want to explain. However, we should not get too attached to this plot just yet. What it is showing is the distribution of predicted <em>point</em> estimates from our model. Since our model is not deterministic but inferential, there is a certain degree of uncertainty attached to its predictions, and that is completely absent from this plot.</p>
<p>Generally speaking, a given model has two sources of uncertainty: <em>predictive</em>, and <em>inferential</em>. The former relates to the fact that the equation we fit does not capture all the elements or in the exact form they enter the true data generating process; the latter has to do with the fact that we never get to know the true value of the model parameters only guesses (estimates) subject to error and uncertainty. If you think of our linear model above as</p>
<p><span class="math display">\[
T_{ij} = X_{ij}\beta + \epsilon_{ij}
\]</span> where <span class="math inline">\(T_{ij}\)</span> represents the number of trips undertaken between station <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, <span class="math inline">\(X_{ij}\)</span> is the set of explanatory variables (length, climb, descent, etc.), and <span class="math inline">\(\epsilon_{ij}\)</span> is an error term assumed to be distributed as a normal distribution <span class="math inline">\(N(0, \sigma)\)</span>; then predictive uncertainty comes from the fact that there are elements to some extent relevant for <span class="math inline">\(y\)</span> that are not accounted for and thus subsummed into <span class="math inline">\(\epsilon_{ij}\)</span>. Inferential uncertainty comes from the fact that we never get to know <span class="math inline">\(\beta\)</span> but only an estimate of it which is also subject to uncertainty itself.</p>
<p>Taking these two sources into consideration means that the black line in the plot above represents only the behaviour of our model we expect if the error term is absent (no predictive uncertainty) and the coefficients are the true estimates (no inferential uncertainty). However, this is not necessarily the case as our estimate for the uncertainty of the error term is certainly not zero, and our estimates for each parameter are also subject to a great deal of inferential variability. We do not know to what extent other outcomes would be just as likely. Predictive checking relates to simulating several feasible scenarios under our model and use those to assess uncertainty and to get a better grasp of the quality of our predictions.</p>
<p>Technically speaking, to do this, we need to build a mechanism to obtain a possible draw from our model and then repeat it several times. The first part of those two steps can be elegantly dealt with by writing a short function that takes a given model and a set of predictors, and produces a possible random draw from such model:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">generate_draw</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Set up predictors matrix</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="va">m</span> <span class="op">)</span></span>
<span>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span>  <span class="va">sim_bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arm/man/sim.html">sim</a></span><span class="op">(</span> <span class="va">m</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="co"># Predicted value</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">sim_bs</span><span class="op">@</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span>  <span class="co"># Draw</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span> <span class="va">mu</span> <span class="op">)</span></span>
<span>  <span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span> <span class="va">n</span>, <span class="va">mu</span>, <span class="va">sim_bs</span><span class="op">@</span><span class="va">sigma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">y_hat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This function takes a model <code>m</code> and the set of covariates <code>x</code> used and returns a random realisation of predictions from the model. To get a sense of how this works, we can get and plot a realisation of the model, compared to the expected one and the actual values:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_y</span> <span class="op">&lt;-</span> <span class="fu">generate_draw</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span>                <span class="op">)</span></span>
<span>         <span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">new_y</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'green'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span>, <span class="st">'Simulated'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'green'</span> <span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Once we have this “draw engine”, we can set it to work as many times as we want using a simple <code>for</code> loop. In fact, we can directly plot these lines as compared to the expected one and the trip count:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>     <span class="op">)</span>,</span>
<span>  col<span class="op">=</span><span class="st">'white'</span>,</span>
<span>  main<span class="op">=</span><span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Loop for realizations</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">250</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tmp_y</span> <span class="op">&lt;-</span> <span class="fu">generate_draw</span><span class="op">(</span> <span class="va">m1</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">tmp_y</span> <span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">'grey'</span>,</span>
<span>        lwd <span class="op">=</span> <span class="fl">0.1</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Actual'</span>, <span class="st">'Predicted'</span>, <span class="st">'Simulated (n=250)'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'red'</span>, <span class="st">'black'</span>, <span class="st">'grey'</span><span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"Predictive check - Baseline model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows there is a significant mismatch between the fitted values, which are much more concentrated around small positive values, and the realisations of our “inferential engine”, which depict a much less concentrated distribution of values. This is likely due to the combination of two different reasons: on the one hand, the accuracy of our estimates may be poor, causing them to jump around a wide range of potential values and hence resulting in very diverse predictions (inferential uncertainty); on the other hand, it may be that the amount of variation we are not able to account for in the model<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is so large that the degree of uncertainty contained in the error term of the model is very large, hence resulting in such a flat predictive distribution.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;The <span class="math inline">\(R^2\)</span> of our model is around 2%</p></div><div id="fn3"><p><sup>3</sup>&nbsp;which they are not really, in light of the comparison between the black and red lines.</p></div></div><p>Keep in mind that the issues discussed in the paragraph above relate to the uncertainty behind our model. This is not to the point predictions derived from them, which are a mechanistic result of the minimisation of the squared residuals and hence are not subject to probability or inference. That allows the model in this case to provide a fitted distribution much more accurate apparently (black line above). However, the lesson to take from the model is that, even if the point predictions (fitted values) are artificially accurate<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, our capabilities to infer about the more general underlying process are fairly limited.</p>
<p><strong>Improving the model</strong></p>
<p>The bad news from the previous section is that our initial model is not great at explaining bike trips. The good news is there are several ways in which we can improve this. In this section we will cover three main extensions that exemplify three different routes you can take when enriching and augmenting models in general, and spatial interaction ones in particular<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. These three routes are aligned around the following principles:</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;These principles are general and can be applied to pretty much any modeling exercise you run into. The specific approaches we take in this note relate to spatial interaction models</p></div></div><ol type="1">
<li>Use better approximations to model your dependent variable.</li>
<li>Recognize the structure of your data.</li>
<li>Get better predictors.</li>
</ol>
<ul>
<li><strong>Use better approximations to model your dependent variable</strong></li>
</ul>
<p>Standard OLS regression assumes that the error term and, since the predictors are deterministic, the dependent variable are distributed following a normal (gaussian) distribution. This is usually a good approximation for several phenomena of interest, but maybe not the best one for trips along routes: for one, we know trips cannot be negative, which the normal distribution does not account for<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>; more subtly, their distribution is not really symmetric but skewed with a very long tail on the right. This is common in variables that represent counts and that is why usually it is more appropriate to fit a model that relies on a distribution different from the normal.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;For an illustration of this, consider the amount of probability mass to the left of zero in the predictive checks above.</p></div></div><p>One of the most common distributions for this cases is the Poisson, which can be incorporated through a general linear model (or GLM). The underlying assumption here is that instead of <span class="math inline">\(T_{ij} \sim N(\mu_{ij}, \sigma)\)</span>, our model now follows:</p>
<p><span class="math display">\[
T_{ij} \sim Poisson (\exp^{X_{ij}\beta})
\]</span></p>
<p>As usual, such a model is easy to run in R:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="st">'trips15 ~ straight_dist + total_up + total_down'</span>, </span>
<span>  data<span class="op">=</span><span class="va">db_std</span>,</span>
<span>  family<span class="op">=</span><span class="va">poisson</span>,</span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now let’s see how much better, if any, this approach is. To get a quick overview, we can simply plot the point predictions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>   <span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'red'</span><span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span>main <span class="op">=</span> <span class="st">"Predictive check, point estimates - Poisson model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To incorporate uncertainty to these predictions, we need to tweak our <code>generate_draw</code> function so it accommodates the fact that our model is not linear anymore.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">generate_draw_poi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Set up predictors matrix</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="va">m</span> <span class="op">)</span></span>
<span>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span>  <span class="va">sim_bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/arm/man/sim.html">sim</a></span><span class="op">(</span> <span class="va">m</span>, <span class="fl">1</span> <span class="op">)</span></span>
<span>  <span class="co"># Predicted value</span></span>
<span>  <span class="va">xb</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">sim_bs</span><span class="op">@</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span>  <span class="co">#xb &lt;- x %*% m$coefficients</span></span>
<span>  <span class="co"># Transform using the link function</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span> <span class="va">xb</span> <span class="op">)</span></span>
<span>  <span class="co"># Obtain a random realization</span></span>
<span>  <span class="va">y_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span> n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span> <span class="va">mu</span> <span class="op">)</span>, lambda <span class="op">=</span> <span class="va">mu</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">y_hat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then we can examine both point predictions an uncertainty around them:</p>
<div class="cell" data-fig.fullwidth="true">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>   <span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Loop for realizations</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">250</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tmp_y</span> <span class="op">&lt;-</span> <span class="fu">generate_draw_poi</span><span class="op">(</span> <span class="va">m2</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">tmp_y</span> <span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="st">'grey'</span>,</span>
<span>    lwd <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span>, <span class="st">'Simulated (n=250)'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'grey'</span><span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span> main <span class="op">=</span> <span class="st">"Predictive check - Poisson model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Voila! Although the curve is still a bit off, centered too much to the right of the actual data, our predictive simulation leaves the fitted values right in the middle. This speaks to a better fit of the model to the actual distribution othe original data follow.</p>
<ul>
<li><strong>Recognize the structure of your data</strong></li>
</ul>
<p>So far, we’ve treated our dataset as if it was flat (i.e.&nbsp;comprise of fully independent realizations) when in fact it is not. Most crucially, our baseline model does not account for the fact that every observation in the dataset pertains to a trip between two stations. This means that all the trips from or to the same station probably share elements which likely help explain how many trips are undertaken between stations. For example, think of trips to and from a station located in the famous Embarcadero, a popular tourist spot. Every route to and from there probably has more trips due to the popularity of the area and we are currently not acknowledging it in the model.</p>
<p>A simple way to incorporate these effects into the model is through origin and destination fixed effects. This approach shares elements with both spatial fixed effects and multilevel modeling and essentially consists of including a binary variable for every origin and destination station. In mathematical notation, this equates to:</p>
<p><span class="math display">\[
T_{ij} = X_{ij}\beta + \delta_i + \delta_j + \epsilon_{ij}
\]</span></p>
<p>where <span class="math inline">\(\delta_i\)</span> and <span class="math inline">\(\delta_j\)</span> are origin and destination station fixed effects<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>, and the rest is as above. This strategy accounts for all the unobserved heterogeneity associated with the location of the station. Technically speaking, we simply need to introduce <code>orig</code> and <code>dest</code> in the the model:</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;In this session, <span class="math inline">\(\delta_i\)</span> and <span class="math inline">\(\delta_j\)</span> are estimated as independent variables so their estimates are similar to interpret to those in <span class="math inline">\(\beta\)</span>. An alternative approach could be to model them as random effects in a multilevel framework.</p></div></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="st">'trips15 ~ straight_dist + total_up + total_down + orig + dest'</span>, </span>
<span>  data <span class="op">=</span> <span class="va">db_std</span>,</span>
<span>  family <span class="op">=</span> <span class="va">poisson</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And with our new model, we can have a look at how well it does at predicting the overall number of trips<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>:</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Although, theoretically, we could also include simulations of the model in the plot to get a better sense of the uncertainty behind our model, in practice this seems troublesome. The problems most likely arise from the fact that many of the origin and destination binary variable coefficients are estimated with a great deal of uncertainty. This causes some of the simulation to generate extreme values that, when passed through the exponential term of the Poisson link function, cause problems. If anything, this is testimony of how a simple fixed effect model can sometimes lack accuracy and generate very uncertain estimates. A potential extension to work around these problems could be to fit a multilevel model with two specific levels beyond the trip-level: one for origin and another one for destination stations.</p></div></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m3</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">m3</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>   <span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'red'</span><span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span> main <span class="op">=</span> <span class="st">"Predictive check - Orig/dest FE Poisson model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That looks significantly better, doesn’t it? In fact, our model now better accounts for the long tail where a few routes take a lot of trips. This is likely because the distribution of trips is far from random across stations and our origin and destination fixed effects do a decent job at accounting for that structure. However our model is still notably underpredicting less popular routes and overpredicting routes with above average number of trips. Maybe we should think about moving beyond a simple linear model.</p>
<ul>
<li><strong>Get better predictors</strong></li>
</ul>
<p>The final extension is, in principle, always available but, in practice, it can be tricky to implement. The core idea is that your baseline model might not have the best measurement of the phenomena you want to account for. In our example, we can think of the distance between stations. So far, we have been including the distance measured “as the crow flies” between stations. Although in some cases this is a good approximation (particularly when distances are long and likely route taken is as close to straight as possible), in some cases like ours, where the street layout and the presence of elevation probably matter more than the actual final distance pedalled, this is not necessarily a safe assumption.</p>
<p>As an exampe of this approach, we can replace the straight distance measurements for more refined ones based on the Google Maps API routes. This is very easy as all we need to do (once the distances have been calculated!) is to swap <code>straight_dist</code> for <code>street_dist</code>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>  <span class="st">'trips15 ~ street_dist + total_up + total_down + orig + dest'</span>, </span>
<span>  data <span class="op">=</span> <span class="va">db_std</span>,</span>
<span>  family <span class="op">=</span> <span class="va">poisson</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And we can similarly get a sense of our predictive fitting with:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">m4</span><span class="op">$</span><span class="va">fitted.values</span> <span class="op">)</span>, </span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">m4</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>   <span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span> <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span> <span class="op">)</span>, </span>
<span>  col <span class="op">=</span> <span class="st">'red'</span>,</span>
<span>  main <span class="op">=</span> <span class="st">''</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span></span>
<span>  <span class="st">'topright'</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Predicted'</span>, <span class="st">'Actual'</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'red'</span><span class="op">)</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span><span class="op">(</span> main <span class="op">=</span> <span class="st">"Predictive check - Orig/dest FE Poisson model"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="05-flows_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Hard to tell any noticeable difference, right? To see if there is any, we can have a look at the estimates obtained:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m4</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">'street_dist'</span>, <span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate     Std. Error        z value       Pr(&gt;|z|) 
 -9.961619e-02   2.688731e-03  -3.704952e+01  1.828096e-300 </code></pre>
</div>
</div>
<p>And compare this to that of the straight distances in the previous model:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m3</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">'straight_dist'</span>, <span class="op">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate     Std. Error        z value       Pr(&gt;|z|) 
 -7.820014e-02   2.683052e-03  -2.914596e+01  9.399407e-187 </code></pre>
</div>
</div>
<p>As we can see, the differences exist but they are not massive. Let’s use this example to learn how to interpret coefficients in a Poisson model<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. Effectively, these estimates can be understood as multiplicative effects. Since our model fits</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;See section 6.2 of <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="references.html#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> for a similar treatment of these.</p></div></div><p><span class="math display">\[
T_{ij} \sim Poisson (\exp^{X_{ij}\beta})
\]</span></p>
<p>we need to transform <span class="math inline">\(\beta\)</span> through an exponential in order to get a sense of the effect of distance on the number of trips. This means that for the street distance, our original estimate is <span class="math inline">\(\beta_{street} = -0.0996\)</span>, but this needs to be translated through the exponential into <span class="math inline">\(e^{-0.0996} = 0.906\)</span>. In other words, since distance is expressed in standard deviations<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, we can expect a 10% decrease in the number of trips for an increase of one standard deviation (about 1Km) in the distance between the stations. This can be compared with <span class="math inline">\(e^{-0.0782} = 0.925\)</span> for the straight distances, or a reduction of about 8% the number of trips for every increase of a standard deviation (about 720m).</p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;Remember the transformation at the very beginning.</p></div></div></section><section id="predicting-flows" class="level2 page-columns page-full" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="predicting-flows">
<span class="header-section-number">5.5</span> Predicting flows</h2>
<p>So far we have put all of our modeling efforts in understanding the model we fit and improving such model so it fits our data as closely as possible. This is essential in any modelling exercise but should be far from a stopping point. Once we’re confident our model is a decent representation of the data generating process, we can start exploiting it. In this section, we will cover one specific case that showcases how a fitted model can help: out-of-sample forecasts.</p>
<p>It is August 2015, and you have just started working as a data scientist for the bikeshare company that runs the San Francisco system. You join them as they’re planning for the next academic year and, in order to plan their operations (re-allocating vans, station maintenance, etc.), they need to get a sense of how many people are going to be pedalling across the city and, crucially, <em>where</em> they are going to be pedalling through. What can you do to help them?</p>
<p>The easiest approach is to say “well, a good guess for how many people will be going between two given stations this coming year is how many went through last year, isn’t it?”. This is one prediction approach. However, you could see how, even if the same process governs over both datasets (2015 and 2016), each year will probably have some idiosyncracies and thus looking too closely into one year might not give the best possible answer for the next one. Ideally, you want a good stylized synthesis that captures the bits that stay constant over time and thus can be applied in the future and that ignores those aspects that are too particular to a given point in time. That is the rationale behind using a fitted model to obtain predictions.</p>
<p>However good any theory though, the truth is in the pudding. So, to see if a modeling approach is better at producing forecasts than just using the counts from last year, we can put them to a test. The way this is done when evaluating the predictive performance of a model (as this is called in the literature) relies on two basic steps: a) obtain predictions from a given model and b) compare those to the actual values (in our case, with the counts for 2016 in <code>trips16</code>) and get a sense of “how off” they are. We have essentially covered a) above; for b), there are several measures to use. We will use one of the most common ones, the root mean squared error (RMSE), which roughly gives a sense of the average difference between a predicted vector and the real deal:</p>
<p><span class="math display">\[
RMSE = \sqrt{ \sum_{ij} (\hat{T_{ij}} - T_{ij})^2}
\]</span></p>
<p>where <span class="math inline">\(\hat{T_{ij}}\)</span> is the predicted amount of trips between stations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. RMSE is straightforward in R and, since we will use it a couple of times, let’s write a short function to make our lives easier:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">se</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">t</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span></span>
<span>  <span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>where <code>t</code> stands for the vector of true values, and <code>p</code> is the vector of predictions. Let’s give it a spin to make sure it works:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rmse_m4</span> <span class="op">&lt;-</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">m4</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span></span>
<span><span class="va">rmse_m4</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 256.2197</code></pre>
</div>
</div>
<p>That means that, on average, predictions in our best model <code>m4</code> are 256 trips off. Is this good? Bad? Worse? It’s hard to say but, being practical, what we can say is whether this better than our alternative. Let us have a look at the RMSE of the other models as well as that of simply plugging in last year’s counts:[^05-flows-11]</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Task</strong></p>
<p>Can you create a single plot that displays the distribution of the predicted values of the five different ways to predict trips in 2016 and the actual counts of trips?</p>
</div>
</div>
</div>
</div></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rmses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'OLS'</span>, </span>
<span>    <span class="st">'Poisson'</span>, </span>
<span>    <span class="st">'Poisson + FE'</span>, </span>
<span>    <span class="st">'Poisson + FE + street dist.'</span>,</span>
<span>    <span class="st">'Trips-2015'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  RMSE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">m1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>,</span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">m2</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>,</span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">m3</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>,</span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">m4</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>,</span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">db_std</span><span class="op">$</span><span class="va">trips16</span>, <span class="va">db_std</span><span class="op">$</span><span class="va">trips15</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rmses</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        model     RMSE
1                         OLS 323.6135
2                     Poisson 320.8962
3                Poisson + FE 254.4468
4 Poisson + FE + street dist. 256.2197
5                  Trips-2015 131.0228</code></pre>
</div>
</div>
<p>The table is both encouraging and disheartning at the same time. On the one hand, all the modeling techniques covered above behave as we would expect: the baseline model displays the worst predicting power of all, and every improvement (except the street distances!) results in notable decreases of the RMSE. This is good news. However, on the other hand, all of our modelling efforts fall short of given a better guess than simply using the previous year’s counts. <em>Why? Does this mean that we should not pay attention to modeling and inference?</em> Not really. Generally speaking, a model is as good at predicting as it is able to mimic the underlying process that gave rise to the data in the first place. The results above point to a case where our model is not picking up all the factors that determine the amount of trips undertaken in a give route. This could be improved by enriching the model with more/better predictors, as we have seen above. Also, the example above seems to point to a case where those idiosyncracies in 2015 that the model does not pick up seem to be at work in 2016 as well. This is great news for our prediction efforts this time, but we have no idea why this is the case and, for all that matters, it could change the coming year. Besides the elegant quantification of uncertainty, the true advantage of a modeling approach in this context is that, if well fit, it is able to pick up the fundamentals that apply over and over. This means that, if next year we’re not as lucky as this one and previous counts are not good predictors but the variables we used in our model continue to have a role in determining the outcome, the data scientist should be luckier and hit a better prediction.</p>
<!-- #region -->
</section><section id="questions" class="level2" data-number="5.6"><h2 data-number="5.6" class="anchored" data-anchor-id="questions">
<span class="header-section-number">5.6</span> Questions</h2>
<p>We will be using again the Madrid AirBnb dataset: <!-- #endregion --></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mad_abb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'./data/assignment_1_madrid/madrid_abb.gpkg'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `madrid_abb' from data source 
  `/Users/franciscorowe/Library/CloudStorage/Dropbox/Francisco/uol/teaching/envs453/202526/san/data/assignment_1_madrid/madrid_abb.gpkg' 
  using driver `GPKG'
Simple feature collection with 18399 features and 16 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -3.86391 ymin: 40.33243 xmax: -3.556 ymax: 40.56274
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<p>The columns to use here are:</p>
<ul>
<li>
<code>price_usd</code>: price expressed in USD</li>
<li>
<code>log1p_price_usd</code>: logarithm of the price expressed in USD</li>
<li>
<code>accommodates</code>: number of people the property accommodates</li>
<li>
<code>bathrooms</code>: number of bathrooms the property includes</li>
<li>
<code>bedrooms</code>: number of bedrooms the property includes</li>
<li>
<code>beds</code>: number of beds the property includes</li>
</ul>
<p>With these data at hand, accomplish the following challenges:</p>
<ol type="1">
<li>Set up a baseline regression model where you explain the price of a property as a function of its characteristics:</li>
</ol>
<p><span class="math display">\[
P_i = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<ol start="2" type="1">
<li>Fit a parallel model that uses the log of price as dependent variable:</li>
</ol>
<p><span class="math display">\[
\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<ol start="3" type="1">
<li>Perform a predictive check analysis of both models, discussing how they compare, which one you would prefer, and why</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-fotheringham1989spatial" class="csl-entry" role="listitem">
Fotheringham, A Stewart, and Morton E O’Kelly. 1989. <em>Spatial Interaction Models: Formulations and Applications</em>. Vol. 1. Kluwer Academic Publishers Dordrecht.
</div>
<div id="ref-gelman2006data" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.
</div>
<div id="ref-rowe2022" class="csl-entry" role="listitem">
Rowe, Francisco, Robin Lovelace, and Adam Dennett. 2022. <span>“Spatial Interaction Modelling: A Manifesto.”</span> <a href="http://dx.doi.org/10.31219/osf.io/xcdms">http://dx.doi.org/10.31219/osf.io/xcdms</a>.
</div>
<div id="ref-gds_ua17" class="csl-entry" role="listitem">
Singleton, Alex. 2017. <span>“Geographic Data Science for Urban Analytics.”</span> <a href="http://www.alex-singleton.com/GDS_UA_2017/">http://www.alex-singleton.com/GDS_UA_2017/</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/gdsl-ul\.github\.io\/san\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./04-points.html" class="pagination-link" aria-label="Point Data Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Point Data Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./06-spatial-econometrics.html" class="pagination-link" aria-label="Spatial Econometrics">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Interaction Modelling {#sec-chp5}</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>This chapter covers spatial interaction flows. Using open data from the city of San Francisco about trips on its bikeshare system, we will estimate spatial interaction models that try to capture and explain the variation in the amount of trips on each given route. After visualizing the dataset, we begin with a very simple model and then build complexity progressively by augmenting it with more information, refined measurements, and better modeling approaches. Throughout the chapter, we explore different ways to grasp the predictive performance of each model. We finish with a prediction example that illustrates how these models can be deployed in a real-world application.</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>Content is based on the following references, which are great follow-up's on the topic:</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@fotheringham1989spatial offer a historical overview of spatial interaction models and illustration of use cases.</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@rowe2022 provide a good overview of the existing limitations and opportunities of spatial interaction modelling.</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@gds_ua17, an online short course on R for Geographic Data Science and Urban Analytics. In particular, the section on <span class="co">[</span><span class="ot">mapping flows</span><span class="co">](https://github.com/alexsingleton/GDS_UA_2017/tree/master/Mapping_Flows)</span> is specially relevant here.</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The predictive checks section draws heavily from @gelman2006data, in particular Chapters 6 and 7.</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>We will rely on the following libraries in this section, all of them included in @sec-dependencies:</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Data management</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Data management</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty graphics</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Thematic maps</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add basemaps</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemapR)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation methods</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>In this chapter we will show a slightly different way of managing spatial data in R. Although most of the functionality will be similar to that seen in previous chapters, we will not rely on the "<span class="in">`sf`</span> stack" and we will instead show how to read and manipulate data using the more traditional <span class="in">`sp`</span> stack. Although this approach is being slowly phased out, it is still important to be aware of its existence and its differences with more modern approaches.</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>In this note, we will use data from the city of San Francisco representing bike trips on their public bike share system. The original source is the <span class="co">[</span><span class="ot">SF Open Data portal</span><span class="co">](https://datasf.org/opendata/)</span> and the dataset comprises both the location of each station in the Bay Area as well as information on trips (station of origin to station of destination) undertaken in the system from September 2014 to August 2015 and the following year. Since this note is about modeling and not data preparation, a cleanly reshaped version of the data, together with some additional information, has been created and placed in the <span class="in">`sf_bikes`</span> folder. The data file is named <span class="in">`flows.geojson`</span> and, in case you are interested, the (Python) code required to created from the original files in the SF Data Portal is also available on the <span class="in">`flows_prep.ipynb`</span> <span class="co">[</span><span class="ot">notebook</span><span class="co">](https://github.com/darribas/spa_notes/blob/master/sf_bikes/flows_prep.ipynb)</span>, also in the same folder.</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>Let us then directly load the file with all the information necessary:</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">'./data/sf_bikes/flows.geojson'</span>)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>Note how the interface is slightly different since we are reading a <span class="in">`GeoJSON`</span> file instead of a shapefile.</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>The data contains the geometries of the flows, as calculated from the <span class="co">[</span><span class="ot">Google Maps API</span><span class="co">](https://developers.google.com/maps/)</span>, as well as a series of columns with characteristics of each flow:</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(db)</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>where <span class="in">`orig`</span> and <span class="in">`dest`</span> are the station IDs of the origin and destination, <span class="in">`street/straight_dist`</span> is the distance in metres between stations measured along the street network or as-the-crow-flies, <span class="in">`total_down/up`</span> is the total downhil and climb in the trip, and <span class="in">`tripsXX`</span> contains the amount of trips undertaken in the years of study.</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## "*Seeing*" flows</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>The easiest way to get a quick preview of what the data looks like spatially is to make a simple plot:</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(db<span class="sc">$</span>geometry)</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>Equally, if we want to visualize a single route, we can simply subset the table. For example, to get the shape of the trip from station <span class="in">`39`</span> to station <span class="in">`48`</span>, we can:</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span> </span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(orig <span class="sc">==</span> <span class="dv">39</span> <span class="sc">&amp;</span> dest <span class="sc">==</span> <span class="dv">48</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> .) <span class="sc">+</span> </span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>or, for the most popular route, we can:</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>most_pop <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> </span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(trips15 <span class="sc">==</span> <span class="fu">max</span>(trips15))</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>These however do not reveal a lot: there is no geographical context (*why are there so many routes along the NE?*) and no sense of how volumes of bikers are allocated along different routes. Let us fix those two.</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>The easiest way to bring in geographical context is by overlaying the routes on top of a background map of tiles downloaded from the internet. Let us download this using <span class="in">`basemapR`</span>:</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a><span class="co"># create a bounding box</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>bbox_db <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(db)</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a><span class="co"># download a basemap using ggplot and basemapR</span></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">base_map</span>(bbox_db, <span class="at">increase_zoom =</span> <span class="dv">2</span>, <span class="at">basemap =</span> <span class="st">"positron"</span>) <span class="sc">+</span></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> db, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"transparent"</span>) </span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>Now to combine tiles and routes, we need to pull out the coordinates that make up each line. For the route example above, this would be:</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>xys1 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">st_coordinates</span>(most_pop))</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>Now we can plot the route (note we also dim down the background to focus the attention on flows):</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>::: column-margin</span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple" icon="false"}</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>**Task**</span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>Can you plot the route for the largest climb?</span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">base_map</span>(bbox_db, <span class="at">increase_zoom =</span> <span class="dv">2</span>, <span class="at">basemap =</span> <span class="st">"dark"</span>) <span class="sc">+</span></span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>( <span class="at">data =</span> db, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>( <span class="at">data =</span> xys1, </span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>( <span class="at">x =</span> X, <span class="at">y =</span> Y ), </span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a>             <span class="co">#size = 1,</span></span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"green"</span>,</span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>             <span class="at">lineend =</span><span class="st">'round'</span></span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>Now we can plot all of the lines by using a short <span class="in">`for`</span> loop to build up the table:</span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up shell data.frame</span></span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), </span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), </span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">trips =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Run loop</span></span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(x <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(db)){</span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pull out row</span></span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> db[x, ]</span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract lon/lat coords</span></span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a>  xys <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">st_coordinates</span>(r))</span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(xys) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'lon'</span>, <span class="st">'lat'</span>)</span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Insert trips and id</span></span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a>  xys[<span class="st">'trips'</span>] <span class="ot">&lt;-</span> r<span class="sc">$</span>trips15</span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a>  xys[<span class="st">'id'</span>] <span class="ot">&lt;-</span> x</span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Append them to `lines`</span></span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>  lines <span class="ot">&lt;-</span> <span class="fu">rbind</span>(lines, xys)</span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>Now we can go on and plot all of them:</span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># call basemap</span></span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">base_map</span>(bbox_db, <span class="at">increase_zoom =</span> <span class="dv">2</span>, <span class="at">basemap =</span> <span class="st">"dark"</span>) <span class="sc">+</span></span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> db, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add data</span></span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>( <span class="at">data =</span> lines, </span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x=</span>lon, <span class="at">y=</span>lat, </span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>                 <span class="at">group=</span>id</span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>                 ), </span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"green"</span>,</span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a>             <span class="at">lineend =</span> <span class="st">'round'</span>)</span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>Finally, we can get a sense of the distribution of the flows by associating a color gradient to each flow based on its number of trips:</span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># call basemap</span></span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">base_map</span>(bbox_db, <span class="at">increase_zoom =</span> <span class="dv">2</span>, <span class="at">basemap =</span> <span class="st">"dark"</span>) <span class="sc">+</span></span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> db, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">colour =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add flow data</span></span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>( <span class="at">data =</span> lines, </span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">group =</span> id, <span class="at">colour =</span> trips ), </span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="fu">log1p</span>(lines<span class="sc">$</span>trips <span class="sc">/</span> <span class="fu">max</span>(lines<span class="sc">$</span>trips)),</span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a>             <span class="at">lineend =</span> <span class="st">'round'</span></span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a colour palette</span></span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_gradient</span>(</span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">low=</span><span class="st">'#440154FF'</span>, <span class="at">high=</span><span class="st">'#FDE725FF'</span></span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>()</span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-220"><a href="#cb41-220" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-221"><a href="#cb41-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-222"><a href="#cb41-222" aria-hidden="true" tabindex="-1"></a>Note how we transform the size so it's a proportion of the largest trip and then it is compressed with a logarithm.</span>
<span id="cb41-223"><a href="#cb41-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-224"><a href="#cb41-224" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modelling flows</span></span>
<span id="cb41-225"><a href="#cb41-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-226"><a href="#cb41-226" aria-hidden="true" tabindex="-1"></a>Now we have an idea of the spatial distribution of flows, we can begin to think about modeling them. The core idea in this section is to fit a model that can capture the particular characteristics of our variable of interest (the volume of trips) using a set of predictors that describe the nature of a given flow. We will start from the simplest model and then progressively build complexity until we get to a satisfying point. Along the way, we will be exploring each model using concepts from @gelman2006data such as predictive performance checks<span class="ot">[^05-flows-1]</span> (PPC)</span>
<span id="cb41-227"><a href="#cb41-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-228"><a href="#cb41-228" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-1]: </span>For a more elaborate introduction to PPC, have a look at Chapters 7 and 8.</span>
<span id="cb41-229"><a href="#cb41-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-230"><a href="#cb41-230" aria-hidden="true" tabindex="-1"></a>Before we start running regressions, let us first standardize the predictors so we can interpret the intercept as the average flow when all the predictors take the average value, and so we can interpret the model coefficients as changes in standard deviation units:</span>
<span id="cb41-231"><a href="#cb41-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-234"><a href="#cb41-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-235"><a href="#cb41-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale all the table</span></span>
<span id="cb41-236"><a href="#cb41-236" aria-hidden="true" tabindex="-1"></a>db_std <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), scale))</span>
<span id="cb41-237"><a href="#cb41-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-238"><a href="#cb41-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset trips as we want the original version</span></span>
<span id="cb41-239"><a href="#cb41-239" aria-hidden="true" tabindex="-1"></a>db_std<span class="sc">$</span>trips15 <span class="ot">&lt;-</span> db<span class="sc">$</span>trips15</span>
<span id="cb41-240"><a href="#cb41-240" aria-hidden="true" tabindex="-1"></a>db_std<span class="sc">$</span>trips16 <span class="ot">&lt;-</span> db<span class="sc">$</span>trips16</span>
<span id="cb41-241"><a href="#cb41-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-242"><a href="#cb41-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Reset origin and destination station and express them as factors</span></span>
<span id="cb41-243"><a href="#cb41-243" aria-hidden="true" tabindex="-1"></a>db_std<span class="sc">$</span>orig <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(db<span class="sc">$</span>orig)</span>
<span id="cb41-244"><a href="#cb41-244" aria-hidden="true" tabindex="-1"></a>db_std<span class="sc">$</span>dest <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(db<span class="sc">$</span>dest)</span>
<span id="cb41-245"><a href="#cb41-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-246"><a href="#cb41-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-247"><a href="#cb41-247" aria-hidden="true" tabindex="-1"></a>**Baseline model**</span>
<span id="cb41-248"><a href="#cb41-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-249"><a href="#cb41-249" aria-hidden="true" tabindex="-1"></a>One of the simplest possible models we can fit in this context is a linear model that explains the number of trips as a function of the straight distance between the two stations and total amount of climb and downhill. We will take this as the baseline on which we can further build later:</span>
<span id="cb41-250"><a href="#cb41-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-253"><a href="#cb41-253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-254"><a href="#cb41-254" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="st">'trips15 ~ straight_dist + total_up + total_down'</span>, <span class="at">data=</span>db_std)</span>
<span id="cb41-255"><a href="#cb41-255" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span>
<span id="cb41-256"><a href="#cb41-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-257"><a href="#cb41-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-258"><a href="#cb41-258" aria-hidden="true" tabindex="-1"></a>To explore how good this model is, we will be comparing the predictions the model makes about the number of trips each flow should have with the actual number of trips. A first approach is to simply plot the distribution of both variables:</span>
<span id="cb41-259"><a href="#cb41-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-262"><a href="#cb41-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-263"><a href="#cb41-263" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-264"><a href="#cb41-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-265"><a href="#cb41-265" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-266"><a href="#cb41-266" aria-hidden="true" tabindex="-1"></a>  <span class="at">main=</span><span class="st">''</span></span>
<span id="cb41-267"><a href="#cb41-267" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-268"><a href="#cb41-268" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-269"><a href="#cb41-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-270"><a href="#cb41-270" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="st">'red'</span>,</span>
<span id="cb41-271"><a href="#cb41-271" aria-hidden="true" tabindex="-1"></a>  <span class="at">main=</span><span class="st">''</span></span>
<span id="cb41-272"><a href="#cb41-272" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-273"><a href="#cb41-273" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-274"><a href="#cb41-274" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-275"><a href="#cb41-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>),</span>
<span id="cb41-276"><a href="#cb41-276" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>),</span>
<span id="cb41-277"><a href="#cb41-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd=</span><span class="dv">1</span></span>
<span id="cb41-278"><a href="#cb41-278" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-279"><a href="#cb41-279" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main=</span><span class="st">"Predictive check, point estimates - Baseline model"</span>)</span>
<span id="cb41-280"><a href="#cb41-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-281"><a href="#cb41-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-282"><a href="#cb41-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-283"><a href="#cb41-283" aria-hidden="true" tabindex="-1"></a>The plot makes pretty obvious that our initial model captures very few aspects of the distribution we want to explain. However, we should not get too attached to this plot just yet. What it is showing is the distribution of predicted *point* estimates from our model. Since our model is not deterministic but inferential, there is a certain degree of uncertainty attached to its predictions, and that is completely absent from this plot.</span>
<span id="cb41-284"><a href="#cb41-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-285"><a href="#cb41-285" aria-hidden="true" tabindex="-1"></a>Generally speaking, a given model has two sources of uncertainty: *predictive*, and *inferential*. The former relates to the fact that the equation we fit does not capture all the elements or in the exact form they enter the true data generating process; the latter has to do with the fact that we never get to know the true value of the model parameters only guesses (estimates) subject to error and uncertainty. If you think of our linear model above as</span>
<span id="cb41-286"><a href="#cb41-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-287"><a href="#cb41-287" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-288"><a href="#cb41-288" aria-hidden="true" tabindex="-1"></a>T_{ij} = X_{ij}\beta + \epsilon_{ij}</span>
<span id="cb41-289"><a href="#cb41-289" aria-hidden="true" tabindex="-1"></a>$$ where $T_{ij}$ represents the number of trips undertaken between station $i$ and $j$, $X_{ij}$ is the set of explanatory variables (length, climb, descent, etc.), and $\epsilon_{ij}$ is an error term assumed to be distributed as a normal distribution $N(0, \sigma)$; then predictive uncertainty comes from the fact that there are elements to some extent relevant for $y$ that are not accounted for and thus subsummed into $\epsilon_{ij}$. Inferential uncertainty comes from the fact that we never get to know $\beta$ but only an estimate of it which is also subject to uncertainty itself.</span>
<span id="cb41-290"><a href="#cb41-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-291"><a href="#cb41-291" aria-hidden="true" tabindex="-1"></a>Taking these two sources into consideration means that the black line in the plot above represents only the behaviour of our model we expect if the error term is absent (no predictive uncertainty) and the coefficients are the true estimates (no inferential uncertainty). However, this is not necessarily the case as our estimate for the uncertainty of the error term is certainly not zero, and our estimates for each parameter are also subject to a great deal of inferential variability. We do not know to what extent other outcomes would be just as likely. Predictive checking relates to simulating several feasible scenarios under our model and use those to assess uncertainty and to get a better grasp of the quality of our predictions.</span>
<span id="cb41-292"><a href="#cb41-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-293"><a href="#cb41-293" aria-hidden="true" tabindex="-1"></a>Technically speaking, to do this, we need to build a mechanism to obtain a possible draw from our model and then repeat it several times. The first part of those two steps can be elegantly dealt with by writing a short function that takes a given model and a set of predictors, and produces a possible random draw from such model:</span>
<span id="cb41-294"><a href="#cb41-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-297"><a href="#cb41-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-298"><a href="#cb41-298" aria-hidden="true" tabindex="-1"></a>generate_draw <span class="ot">&lt;-</span> <span class="cf">function</span>(m){</span>
<span id="cb41-299"><a href="#cb41-299" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up predictors matrix</span></span>
<span id="cb41-300"><a href="#cb41-300" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>( m )</span>
<span id="cb41-301"><a href="#cb41-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span id="cb41-302"><a href="#cb41-302" aria-hidden="true" tabindex="-1"></a>  sim_bs <span class="ot">&lt;-</span> <span class="fu">sim</span>( m, <span class="dv">1</span>)</span>
<span id="cb41-303"><a href="#cb41-303" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicted value</span></span>
<span id="cb41-304"><a href="#cb41-304" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> x <span class="sc">%*%</span> sim_bs<span class="sc">@</span>coef[<span class="dv">1</span>, ]</span>
<span id="cb41-305"><a href="#cb41-305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw</span></span>
<span id="cb41-306"><a href="#cb41-306" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>( mu )</span>
<span id="cb41-307"><a href="#cb41-307" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span> <span class="fu">rnorm</span>( n, mu, sim_bs<span class="sc">@</span>sigma[<span class="dv">1</span>])</span>
<span id="cb41-308"><a href="#cb41-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(y_hat)</span>
<span id="cb41-309"><a href="#cb41-309" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-310"><a href="#cb41-310" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-311"><a href="#cb41-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-312"><a href="#cb41-312" aria-hidden="true" tabindex="-1"></a>This function takes a model <span class="in">`m`</span> and the set of covariates <span class="in">`x`</span> used and returns a random realisation of predictions from the model. To get a sense of how this works, we can get and plot a realisation of the model, compared to the expected one and the actual values:</span>
<span id="cb41-313"><a href="#cb41-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-316"><a href="#cb41-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-317"><a href="#cb41-317" aria-hidden="true" tabindex="-1"></a>new_y <span class="ot">&lt;-</span> <span class="fu">generate_draw</span>(m1)</span>
<span id="cb41-318"><a href="#cb41-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-319"><a href="#cb41-319" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-320"><a href="#cb41-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-321"><a href="#cb41-321" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-322"><a href="#cb41-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-323"><a href="#cb41-323" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">max</span>( <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-324"><a href="#cb41-324" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">max</span>( <span class="fu">density</span>( db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-325"><a href="#cb41-325" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb41-326"><a href="#cb41-326" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb41-327"><a href="#cb41-327" aria-hidden="true" tabindex="-1"></a>         ),</span>
<span id="cb41-328"><a href="#cb41-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-329"><a href="#cb41-329" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-330"><a href="#cb41-330" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-331"><a href="#cb41-331" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-332"><a href="#cb41-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-333"><a href="#cb41-333" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-334"><a href="#cb41-334" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-335"><a href="#cb41-335" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-336"><a href="#cb41-336" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-337"><a href="#cb41-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( new_y ), </span>
<span id="cb41-338"><a href="#cb41-338" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'green'</span>,</span>
<span id="cb41-339"><a href="#cb41-339" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-340"><a href="#cb41-340" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-341"><a href="#cb41-341" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-342"><a href="#cb41-342" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-343"><a href="#cb41-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>, <span class="st">'Simulated'</span>),</span>
<span id="cb41-344"><a href="#cb41-344" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>( <span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'green'</span> ),</span>
<span id="cb41-345"><a href="#cb41-345" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-346"><a href="#cb41-346" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-347"><a href="#cb41-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-348"><a href="#cb41-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-349"><a href="#cb41-349" aria-hidden="true" tabindex="-1"></a>Once we have this "draw engine", we can set it to work as many times as we want using a simple <span class="in">`for`</span> loop. In fact, we can directly plot these lines as compared to the expected one and the trip count:</span>
<span id="cb41-350"><a href="#cb41-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-353"><a href="#cb41-353" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-354"><a href="#cb41-354" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-355"><a href="#cb41-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-356"><a href="#cb41-356" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-357"><a href="#cb41-357" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-358"><a href="#cb41-358" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-359"><a href="#cb41-359" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>( db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-360"><a href="#cb41-360" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb41-361"><a href="#cb41-361" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-362"><a href="#cb41-362" aria-hidden="true" tabindex="-1"></a>     ),</span>
<span id="cb41-363"><a href="#cb41-363" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="st">'white'</span>,</span>
<span id="cb41-364"><a href="#cb41-364" aria-hidden="true" tabindex="-1"></a>  <span class="at">main=</span><span class="st">''</span></span>
<span id="cb41-365"><a href="#cb41-365" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-366"><a href="#cb41-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop for realizations</span></span>
<span id="cb41-367"><a href="#cb41-367" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">250</span>){</span>
<span id="cb41-368"><a href="#cb41-368" aria-hidden="true" tabindex="-1"></a>  tmp_y <span class="ot">&lt;-</span> <span class="fu">generate_draw</span>( m1 )</span>
<span id="cb41-369"><a href="#cb41-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>( <span class="fu">density</span>( tmp_y ),</span>
<span id="cb41-370"><a href="#cb41-370" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">'grey'</span>,</span>
<span id="cb41-371"><a href="#cb41-371" aria-hidden="true" tabindex="-1"></a>        <span class="at">lwd =</span> <span class="fl">0.1</span></span>
<span id="cb41-372"><a href="#cb41-372" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-373"><a href="#cb41-373" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-374"><a href="#cb41-374" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb41-375"><a href="#cb41-375" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-376"><a href="#cb41-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m1<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-377"><a href="#cb41-377" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-378"><a href="#cb41-378" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-379"><a href="#cb41-379" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-380"><a href="#cb41-380" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-381"><a href="#cb41-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-382"><a href="#cb41-382" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-383"><a href="#cb41-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-384"><a href="#cb41-384" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-385"><a href="#cb41-385" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-386"><a href="#cb41-386" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-387"><a href="#cb41-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Actual'</span>, <span class="st">'Predicted'</span>, <span class="st">'Simulated (n=250)'</span>),</span>
<span id="cb41-388"><a href="#cb41-388" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'red'</span>, <span class="st">'black'</span>, <span class="st">'grey'</span>),</span>
<span id="cb41-389"><a href="#cb41-389" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-390"><a href="#cb41-390" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-391"><a href="#cb41-391" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main=</span><span class="st">"Predictive check - Baseline model"</span>)</span>
<span id="cb41-392"><a href="#cb41-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-393"><a href="#cb41-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-394"><a href="#cb41-394" aria-hidden="true" tabindex="-1"></a>The plot shows there is a significant mismatch between the fitted values, which are much more concentrated around small positive values, and the realisations of our "inferential engine", which depict a much less concentrated distribution of values. This is likely due to the combination of two different reasons: on the one hand, the accuracy of our estimates may be poor, causing them to jump around a wide range of potential values and hence resulting in very diverse predictions (inferential uncertainty); on the other hand, it may be that the amount of variation we are not able to account for in the model<span class="ot">[^05-flows-2]</span> is so large that the degree of uncertainty contained in the error term of the model is very large, hence resulting in such a flat predictive distribution.</span>
<span id="cb41-395"><a href="#cb41-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-396"><a href="#cb41-396" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-2]: </span>The $R^2$ of our model is around 2%</span>
<span id="cb41-397"><a href="#cb41-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-398"><a href="#cb41-398" aria-hidden="true" tabindex="-1"></a>Keep in mind that the issues discussed in the paragraph above relate to the uncertainty behind our model. This is not to the point predictions derived from them, which are a mechanistic result of the minimisation of the squared residuals and hence are not subject to probability or inference. That allows the model in this case to provide a fitted distribution much more accurate apparently (black line above). However, the lesson to take from the model is that, even if the point predictions (fitted values) are artificially accurate<span class="ot">[^05-flows-3]</span>, our capabilities to infer about the more general underlying process are fairly limited.</span>
<span id="cb41-399"><a href="#cb41-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-400"><a href="#cb41-400" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-3]: </span>which they are not really, in light of the comparison between the black and red lines.</span>
<span id="cb41-401"><a href="#cb41-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-402"><a href="#cb41-402" aria-hidden="true" tabindex="-1"></a>**Improving the model**</span>
<span id="cb41-403"><a href="#cb41-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-404"><a href="#cb41-404" aria-hidden="true" tabindex="-1"></a>The bad news from the previous section is that our initial model is not great at explaining bike trips. The good news is there are several ways in which we can improve this. In this section we will cover three main extensions that exemplify three different routes you can take when enriching and augmenting models in general, and spatial interaction ones in particular<span class="ot">[^05-flows-4]</span>. These three routes are aligned around the following principles:</span>
<span id="cb41-405"><a href="#cb41-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-406"><a href="#cb41-406" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-4]: </span>These principles are general and can be applied to pretty much any modeling exercise you run into. The specific approaches we take in this note relate to spatial interaction models</span>
<span id="cb41-407"><a href="#cb41-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-408"><a href="#cb41-408" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Use better approximations to model your dependent variable.</span>
<span id="cb41-409"><a href="#cb41-409" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Recognize the structure of your data.</span>
<span id="cb41-410"><a href="#cb41-410" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Get better predictors.</span>
<span id="cb41-411"><a href="#cb41-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-412"><a href="#cb41-412" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Use better approximations to model your dependent variable**</span>
<span id="cb41-413"><a href="#cb41-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-414"><a href="#cb41-414" aria-hidden="true" tabindex="-1"></a>Standard OLS regression assumes that the error term and, since the predictors are deterministic, the dependent variable are distributed following a normal (gaussian) distribution. This is usually a good approximation for several phenomena of interest, but maybe not the best one for trips along routes: for one, we know trips cannot be negative, which the normal distribution does not account for<span class="ot">[^05-flows-5]</span>; more subtly, their distribution is not really symmetric but skewed with a very long tail on the right. This is common in variables that represent counts and that is why usually it is more appropriate to fit a model that relies on a distribution different from the normal.</span>
<span id="cb41-415"><a href="#cb41-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-416"><a href="#cb41-416" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-5]: </span>For an illustration of this, consider the amount of probability mass to the left of zero in the predictive checks above.</span>
<span id="cb41-417"><a href="#cb41-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-418"><a href="#cb41-418" aria-hidden="true" tabindex="-1"></a>One of the most common distributions for this cases is the Poisson, which can be incorporated through a general linear model (or GLM). The underlying assumption here is that instead of $T_{ij} \sim N(\mu_{ij}, \sigma)$, our model now follows:</span>
<span id="cb41-419"><a href="#cb41-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-420"><a href="#cb41-420" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-421"><a href="#cb41-421" aria-hidden="true" tabindex="-1"></a>T_{ij} \sim Poisson (\exp^{X_{ij}\beta})</span>
<span id="cb41-422"><a href="#cb41-422" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-423"><a href="#cb41-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-424"><a href="#cb41-424" aria-hidden="true" tabindex="-1"></a>As usual, such a model is easy to run in R:</span>
<span id="cb41-425"><a href="#cb41-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-428"><a href="#cb41-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-429"><a href="#cb41-429" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb41-430"><a href="#cb41-430" aria-hidden="true" tabindex="-1"></a>  <span class="st">'trips15 ~ straight_dist + total_up + total_down'</span>, </span>
<span id="cb41-431"><a href="#cb41-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>db_std,</span>
<span id="cb41-432"><a href="#cb41-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">family=</span>poisson,</span>
<span id="cb41-433"><a href="#cb41-433" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-434"><a href="#cb41-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-435"><a href="#cb41-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-436"><a href="#cb41-436" aria-hidden="true" tabindex="-1"></a>Now let's see how much better, if any, this approach is. To get a quick overview, we can simply plot the point predictions:</span>
<span id="cb41-437"><a href="#cb41-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-440"><a href="#cb41-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-441"><a href="#cb41-441" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-442"><a href="#cb41-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m2<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-443"><a href="#cb41-443" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-444"><a href="#cb41-444" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-445"><a href="#cb41-445" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>( m2<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-446"><a href="#cb41-446" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>(db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-447"><a href="#cb41-447" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb41-448"><a href="#cb41-448" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-449"><a href="#cb41-449" aria-hidden="true" tabindex="-1"></a>   ),</span>
<span id="cb41-450"><a href="#cb41-450" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-451"><a href="#cb41-451" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-452"><a href="#cb41-452" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-453"><a href="#cb41-453" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-454"><a href="#cb41-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-455"><a href="#cb41-455" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-456"><a href="#cb41-456" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-457"><a href="#cb41-457" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-458"><a href="#cb41-458" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-459"><a href="#cb41-459" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-460"><a href="#cb41-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>),</span>
<span id="cb41-461"><a href="#cb41-461" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>),</span>
<span id="cb41-462"><a href="#cb41-462" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-463"><a href="#cb41-463" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-464"><a href="#cb41-464" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="at">main =</span> <span class="st">"Predictive check, point estimates - Poisson model"</span>)</span>
<span id="cb41-465"><a href="#cb41-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-466"><a href="#cb41-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-467"><a href="#cb41-467" aria-hidden="true" tabindex="-1"></a>To incorporate uncertainty to these predictions, we need to tweak our <span class="in">`generate_draw`</span> function so it accommodates the fact that our model is not linear anymore.</span>
<span id="cb41-468"><a href="#cb41-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-471"><a href="#cb41-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-472"><a href="#cb41-472" aria-hidden="true" tabindex="-1"></a>generate_draw_poi <span class="ot">&lt;-</span> <span class="cf">function</span>(m){</span>
<span id="cb41-473"><a href="#cb41-473" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up predictors matrix</span></span>
<span id="cb41-474"><a href="#cb41-474" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>( m )</span>
<span id="cb41-475"><a href="#cb41-475" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span id="cb41-476"><a href="#cb41-476" aria-hidden="true" tabindex="-1"></a>  sim_bs <span class="ot">&lt;-</span> <span class="fu">sim</span>( m, <span class="dv">1</span> )</span>
<span id="cb41-477"><a href="#cb41-477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicted value</span></span>
<span id="cb41-478"><a href="#cb41-478" aria-hidden="true" tabindex="-1"></a>  xb <span class="ot">&lt;-</span> x <span class="sc">%*%</span> sim_bs<span class="sc">@</span>coef[<span class="dv">1</span>, ]</span>
<span id="cb41-479"><a href="#cb41-479" aria-hidden="true" tabindex="-1"></a>  <span class="co">#xb &lt;- x %*% m$coefficients</span></span>
<span id="cb41-480"><a href="#cb41-480" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform using the link function</span></span>
<span id="cb41-481"><a href="#cb41-481" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>( xb )</span>
<span id="cb41-482"><a href="#cb41-482" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Obtain a random realization</span></span>
<span id="cb41-483"><a href="#cb41-483" aria-hidden="true" tabindex="-1"></a>  y_hat <span class="ot">&lt;-</span> <span class="fu">rpois</span>( <span class="at">n =</span> <span class="fu">length</span>( mu ), <span class="at">lambda =</span> mu)</span>
<span id="cb41-484"><a href="#cb41-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(y_hat)</span>
<span id="cb41-485"><a href="#cb41-485" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-486"><a href="#cb41-486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-487"><a href="#cb41-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-488"><a href="#cb41-488" aria-hidden="true" tabindex="-1"></a>And then we can examine both point predictions an uncertainty around them:</span>
<span id="cb41-489"><a href="#cb41-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-490"><a href="#cb41-490" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.fullwidth=TRUE}</span></span>
<span id="cb41-491"><a href="#cb41-491" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-492"><a href="#cb41-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m2<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-493"><a href="#cb41-493" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-494"><a href="#cb41-494" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-495"><a href="#cb41-495" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>( m2<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-496"><a href="#cb41-496" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>( db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-497"><a href="#cb41-497" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb41-498"><a href="#cb41-498" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-499"><a href="#cb41-499" aria-hidden="true" tabindex="-1"></a>   ),</span>
<span id="cb41-500"><a href="#cb41-500" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'white'</span>,</span>
<span id="cb41-501"><a href="#cb41-501" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-502"><a href="#cb41-502" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-503"><a href="#cb41-503" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop for realizations</span></span>
<span id="cb41-504"><a href="#cb41-504" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">250</span>){</span>
<span id="cb41-505"><a href="#cb41-505" aria-hidden="true" tabindex="-1"></a>  tmp_y <span class="ot">&lt;-</span> <span class="fu">generate_draw_poi</span>( m2 )</span>
<span id="cb41-506"><a href="#cb41-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(</span>
<span id="cb41-507"><a href="#cb41-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">density</span>( tmp_y ),</span>
<span id="cb41-508"><a href="#cb41-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">'grey'</span>,</span>
<span id="cb41-509"><a href="#cb41-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd =</span> <span class="fl">0.1</span></span>
<span id="cb41-510"><a href="#cb41-510" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-511"><a href="#cb41-511" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-512"><a href="#cb41-512" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb41-513"><a href="#cb41-513" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-514"><a href="#cb41-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m2<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-515"><a href="#cb41-515" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-516"><a href="#cb41-516" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-517"><a href="#cb41-517" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-518"><a href="#cb41-518" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-519"><a href="#cb41-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-520"><a href="#cb41-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-521"><a href="#cb41-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-522"><a href="#cb41-522" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-523"><a href="#cb41-523" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-524"><a href="#cb41-524" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-525"><a href="#cb41-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>, <span class="st">'Simulated (n=250)'</span>),</span>
<span id="cb41-526"><a href="#cb41-526" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'grey'</span>),</span>
<span id="cb41-527"><a href="#cb41-527" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-528"><a href="#cb41-528" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-529"><a href="#cb41-529" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>( <span class="at">main =</span> <span class="st">"Predictive check - Poisson model"</span>)</span>
<span id="cb41-530"><a href="#cb41-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-531"><a href="#cb41-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-532"><a href="#cb41-532" aria-hidden="true" tabindex="-1"></a>Voila! Although the curve is still a bit off, centered too much to the right of the actual data, our predictive simulation leaves the fitted values right in the middle. This speaks to a better fit of the model to the actual distribution othe original data follow.</span>
<span id="cb41-533"><a href="#cb41-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-534"><a href="#cb41-534" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Recognize the structure of your data**</span>
<span id="cb41-535"><a href="#cb41-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-536"><a href="#cb41-536" aria-hidden="true" tabindex="-1"></a>So far, we've treated our dataset as if it was flat (i.e. comprise of fully independent realizations) when in fact it is not. Most crucially, our baseline model does not account for the fact that every observation in the dataset pertains to a trip between two stations. This means that all the trips from or to the same station probably share elements which likely help explain how many trips are undertaken between stations. For example, think of trips to and from a station located in the famous Embarcadero, a popular tourist spot. Every route to and from there probably has more trips due to the popularity of the area and we are currently not acknowledging it in the model.</span>
<span id="cb41-537"><a href="#cb41-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-538"><a href="#cb41-538" aria-hidden="true" tabindex="-1"></a>A simple way to incorporate these effects into the model is through origin and destination fixed effects. This approach shares elements with both spatial fixed effects and multilevel modeling and essentially consists of including a binary variable for every origin and destination station. In mathematical notation, this equates to:</span>
<span id="cb41-539"><a href="#cb41-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-540"><a href="#cb41-540" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-541"><a href="#cb41-541" aria-hidden="true" tabindex="-1"></a>T_{ij} = X_{ij}\beta + \delta_i + \delta_j + \epsilon_{ij}</span>
<span id="cb41-542"><a href="#cb41-542" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-543"><a href="#cb41-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-544"><a href="#cb41-544" aria-hidden="true" tabindex="-1"></a>where $\delta_i$ and $\delta_j$ are origin and destination station fixed effects<span class="ot">[^05-flows-6]</span>, and the rest is as above. This strategy accounts for all the unobserved heterogeneity associated with the location of the station. Technically speaking, we simply need to introduce <span class="in">`orig`</span> and <span class="in">`dest`</span> in the the model:</span>
<span id="cb41-545"><a href="#cb41-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-546"><a href="#cb41-546" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-6]: </span>In this session, $\delta_i$ and $\delta_j$ are estimated as independent variables so their estimates are similar to interpret to those in $\beta$. An alternative approach could be to model them as random effects in a multilevel framework.</span>
<span id="cb41-547"><a href="#cb41-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-550"><a href="#cb41-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-551"><a href="#cb41-551" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb41-552"><a href="#cb41-552" aria-hidden="true" tabindex="-1"></a>  <span class="st">'trips15 ~ straight_dist + total_up + total_down + orig + dest'</span>, </span>
<span id="cb41-553"><a href="#cb41-553" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> db_std,</span>
<span id="cb41-554"><a href="#cb41-554" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> poisson</span>
<span id="cb41-555"><a href="#cb41-555" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-556"><a href="#cb41-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-557"><a href="#cb41-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-558"><a href="#cb41-558" aria-hidden="true" tabindex="-1"></a>And with our new model, we can have a look at how well it does at predicting the overall number of trips<span class="ot">[^05-flows-7]</span>:</span>
<span id="cb41-559"><a href="#cb41-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-560"><a href="#cb41-560" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-7]: </span>Although, theoretically, we could also include simulations of the model in the plot to get a better sense of the uncertainty behind our model, in practice this seems troublesome. The problems most likely arise from the fact that many of the origin and destination binary variable coefficients are estimated with a great deal of uncertainty. This causes some of the simulation to generate extreme values that, when passed through the exponential term of the Poisson link function, cause problems. If anything, this is testimony of how a simple fixed effect model can sometimes lack accuracy and generate very uncertain estimates. A potential extension to work around these problems could be to fit a multilevel model with two specific levels beyond the trip-level: one for origin and another one for destination stations.</span>
<span id="cb41-561"><a href="#cb41-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-564"><a href="#cb41-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-565"><a href="#cb41-565" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-566"><a href="#cb41-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m3<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-567"><a href="#cb41-567" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15 )),</span>
<span id="cb41-568"><a href="#cb41-568" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-569"><a href="#cb41-569" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>(m3<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-570"><a href="#cb41-570" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>(db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-571"><a href="#cb41-571" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb41-572"><a href="#cb41-572" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-573"><a href="#cb41-573" aria-hidden="true" tabindex="-1"></a>   ),</span>
<span id="cb41-574"><a href="#cb41-574" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-575"><a href="#cb41-575" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-576"><a href="#cb41-576" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-577"><a href="#cb41-577" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-578"><a href="#cb41-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-579"><a href="#cb41-579" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-580"><a href="#cb41-580" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-581"><a href="#cb41-581" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-582"><a href="#cb41-582" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-583"><a href="#cb41-583" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-584"><a href="#cb41-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>),</span>
<span id="cb41-585"><a href="#cb41-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>),</span>
<span id="cb41-586"><a href="#cb41-586" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-587"><a href="#cb41-587" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-588"><a href="#cb41-588" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>( <span class="at">main =</span> <span class="st">"Predictive check - Orig/dest FE Poisson model"</span>)</span>
<span id="cb41-589"><a href="#cb41-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-590"><a href="#cb41-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-591"><a href="#cb41-591" aria-hidden="true" tabindex="-1"></a>That looks significantly better, doesn't it? In fact, our model now better accounts for the long tail where a few routes take a lot of trips. This is likely because the distribution of trips is far from random across stations and our origin and destination fixed effects do a decent job at accounting for that structure. However our model is still notably underpredicting less popular routes and overpredicting routes with above average number of trips. Maybe we should think about moving beyond a simple linear model.</span>
<span id="cb41-592"><a href="#cb41-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-593"><a href="#cb41-593" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Get better predictors**</span>
<span id="cb41-594"><a href="#cb41-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-595"><a href="#cb41-595" aria-hidden="true" tabindex="-1"></a>The final extension is, in principle, always available but, in practice, it can be tricky to implement. The core idea is that your baseline model might not have the best measurement of the phenomena you want to account for. In our example, we can think of the distance between stations. So far, we have been including the distance measured "as the crow flies" between stations. Although in some cases this is a good approximation (particularly when distances are long and likely route taken is as close to straight as possible), in some cases like ours, where the street layout and the presence of elevation probably matter more than the actual final distance pedalled, this is not necessarily a safe assumption.</span>
<span id="cb41-596"><a href="#cb41-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-597"><a href="#cb41-597" aria-hidden="true" tabindex="-1"></a>As an exampe of this approach, we can replace the straight distance measurements for more refined ones based on the Google Maps API routes. This is very easy as all we need to do (once the distances have been calculated!) is to swap <span class="in">`straight_dist`</span> for <span class="in">`street_dist`</span>:</span>
<span id="cb41-598"><a href="#cb41-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-601"><a href="#cb41-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-602"><a href="#cb41-602" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb41-603"><a href="#cb41-603" aria-hidden="true" tabindex="-1"></a>  <span class="st">'trips15 ~ street_dist + total_up + total_down + orig + dest'</span>, </span>
<span id="cb41-604"><a href="#cb41-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> db_std,</span>
<span id="cb41-605"><a href="#cb41-605" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> poisson</span>
<span id="cb41-606"><a href="#cb41-606" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-607"><a href="#cb41-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-608"><a href="#cb41-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-609"><a href="#cb41-609" aria-hidden="true" tabindex="-1"></a>And we can similarly get a sense of our predictive fitting with:</span>
<span id="cb41-610"><a href="#cb41-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-613"><a href="#cb41-613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-614"><a href="#cb41-614" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb41-615"><a href="#cb41-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( m4<span class="sc">$</span>fitted.values ), </span>
<span id="cb41-616"><a href="#cb41-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="fu">max</span>( db_std<span class="sc">$</span>trips15)),</span>
<span id="cb41-617"><a href="#cb41-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb41-618"><a href="#cb41-618" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>(m4<span class="sc">$</span>fitted.values)<span class="sc">$</span>y ), </span>
<span id="cb41-619"><a href="#cb41-619" aria-hidden="true" tabindex="-1"></a>               <span class="fu">max</span>( <span class="fu">density</span>(db_std<span class="sc">$</span>trips15)<span class="sc">$</span>y )</span>
<span id="cb41-620"><a href="#cb41-620" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb41-621"><a href="#cb41-621" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-622"><a href="#cb41-622" aria-hidden="true" tabindex="-1"></a>   ),</span>
<span id="cb41-623"><a href="#cb41-623" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'black'</span>,</span>
<span id="cb41-624"><a href="#cb41-624" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-625"><a href="#cb41-625" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-626"><a href="#cb41-626" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb41-627"><a href="#cb41-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">density</span>( db_std<span class="sc">$</span>trips15 ), </span>
<span id="cb41-628"><a href="#cb41-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">'red'</span>,</span>
<span id="cb41-629"><a href="#cb41-629" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">''</span></span>
<span id="cb41-630"><a href="#cb41-630" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-631"><a href="#cb41-631" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb41-632"><a href="#cb41-632" aria-hidden="true" tabindex="-1"></a>  <span class="st">'topright'</span>, </span>
<span id="cb41-633"><a href="#cb41-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Predicted'</span>, <span class="st">'Actual'</span>),</span>
<span id="cb41-634"><a href="#cb41-634" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'black'</span>, <span class="st">'red'</span>),</span>
<span id="cb41-635"><a href="#cb41-635" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> <span class="dv">1</span></span>
<span id="cb41-636"><a href="#cb41-636" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-637"><a href="#cb41-637" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>( <span class="at">main =</span> <span class="st">"Predictive check - Orig/dest FE Poisson model"</span>)</span>
<span id="cb41-638"><a href="#cb41-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-639"><a href="#cb41-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-640"><a href="#cb41-640" aria-hidden="true" tabindex="-1"></a>Hard to tell any noticeable difference, right? To see if there is any, we can have a look at the estimates obtained:</span>
<span id="cb41-641"><a href="#cb41-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-644"><a href="#cb41-644" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-645"><a href="#cb41-645" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m4)<span class="sc">$</span>coefficients[<span class="st">'street_dist'</span>, ]</span>
<span id="cb41-646"><a href="#cb41-646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-647"><a href="#cb41-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-648"><a href="#cb41-648" aria-hidden="true" tabindex="-1"></a>And compare this to that of the straight distances in the previous model:</span>
<span id="cb41-649"><a href="#cb41-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-652"><a href="#cb41-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-653"><a href="#cb41-653" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m3)<span class="sc">$</span>coefficients[<span class="st">'straight_dist'</span>, ]</span>
<span id="cb41-654"><a href="#cb41-654" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-655"><a href="#cb41-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-656"><a href="#cb41-656" aria-hidden="true" tabindex="-1"></a>As we can see, the differences exist but they are not massive. Let's use this example to learn how to interpret coefficients in a Poisson model<span class="ot">[^05-flows-8]</span>. Effectively, these estimates can be understood as multiplicative effects. Since our model fits</span>
<span id="cb41-657"><a href="#cb41-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-658"><a href="#cb41-658" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-8]: </span>See section 6.2 of @gelman2006data for a similar treatment of these.</span>
<span id="cb41-659"><a href="#cb41-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-660"><a href="#cb41-660" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-661"><a href="#cb41-661" aria-hidden="true" tabindex="-1"></a>T_{ij} \sim Poisson (\exp^{X_{ij}\beta})</span>
<span id="cb41-662"><a href="#cb41-662" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-663"><a href="#cb41-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-664"><a href="#cb41-664" aria-hidden="true" tabindex="-1"></a>we need to transform $\beta$ through an exponential in order to get a sense of the effect of distance on the number of trips. This means that for the street distance, our original estimate is $\beta_{street} = -0.0996$, but this needs to be translated through the exponential into $e^{-0.0996} = 0.906$. In other words, since distance is expressed in standard deviations<span class="ot">[^05-flows-9]</span>, we can expect a 10% decrease in the number of trips for an increase of one standard deviation (about 1Km) in the distance between the stations. This can be compared with $e^{-0.0782} = 0.925$ for the straight distances, or a reduction of about 8% the number of trips for every increase of a standard deviation (about 720m).</span>
<span id="cb41-665"><a href="#cb41-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-666"><a href="#cb41-666" aria-hidden="true" tabindex="-1"></a><span class="ot">[^05-flows-9]: </span>Remember the transformation at the very beginning.</span>
<span id="cb41-667"><a href="#cb41-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-668"><a href="#cb41-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicting flows</span></span>
<span id="cb41-669"><a href="#cb41-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-670"><a href="#cb41-670" aria-hidden="true" tabindex="-1"></a>So far we have put all of our modeling efforts in understanding the model we fit and improving such model so it fits our data as closely as possible. This is essential in any modelling exercise but should be far from a stopping point. Once we're confident our model is a decent representation of the data generating process, we can start exploiting it. In this section, we will cover one specific case that showcases how a fitted model can help: out-of-sample forecasts.</span>
<span id="cb41-671"><a href="#cb41-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-672"><a href="#cb41-672" aria-hidden="true" tabindex="-1"></a>It is August 2015, and you have just started working as a data scientist for the bikeshare company that runs the San Francisco system. You join them as they're planning for the next academic year and, in order to plan their operations (re-allocating vans, station maintenance, etc.), they need to get a sense of how many people are going to be pedalling across the city and, crucially, *where* they are going to be pedalling through. What can you do to help them?</span>
<span id="cb41-673"><a href="#cb41-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-674"><a href="#cb41-674" aria-hidden="true" tabindex="-1"></a>The easiest approach is to say "well, a good guess for how many people will be going between two given stations this coming year is how many went through last year, isn't it?". This is one prediction approach. However, you could see how, even if the same process governs over both datasets (2015 and 2016), each year will probably have some idiosyncracies and thus looking too closely into one year might not give the best possible answer for the next one. Ideally, you want a good stylized synthesis that captures the bits that stay constant over time and thus can be applied in the future and that ignores those aspects that are too particular to a given point in time. That is the rationale behind using a fitted model to obtain predictions.</span>
<span id="cb41-675"><a href="#cb41-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-676"><a href="#cb41-676" aria-hidden="true" tabindex="-1"></a>However good any theory though, the truth is in the pudding. So, to see if a modeling approach is better at producing forecasts than just using the counts from last year, we can put them to a test. The way this is done when evaluating the predictive performance of a model (as this is called in the literature) relies on two basic steps: a) obtain predictions from a given model and b) compare those to the actual values (in our case, with the counts for 2016 in <span class="in">`trips16`</span>) and get a sense of "how off" they are. We have essentially covered a) above; for b), there are several measures to use. We will use one of the most common ones, the root mean squared error (RMSE), which roughly gives a sense of the average difference between a predicted vector and the real deal:</span>
<span id="cb41-677"><a href="#cb41-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-678"><a href="#cb41-678" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-679"><a href="#cb41-679" aria-hidden="true" tabindex="-1"></a>RMSE = \sqrt{ \sum_{ij} (\hat{T_{ij}} - T_{ij})^2}</span>
<span id="cb41-680"><a href="#cb41-680" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-681"><a href="#cb41-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-682"><a href="#cb41-682" aria-hidden="true" tabindex="-1"></a>where $\hat{T_{ij}}$ is the predicted amount of trips between stations $i$ and $j$. RMSE is straightforward in R and, since we will use it a couple of times, let's write a short function to make our lives easier:</span>
<span id="cb41-683"><a href="#cb41-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-686"><a href="#cb41-686" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-687"><a href="#cb41-687" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(t, p){</span>
<span id="cb41-688"><a href="#cb41-688" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> (t <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb41-689"><a href="#cb41-689" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> <span class="fu">mean</span>(se)</span>
<span id="cb41-690"><a href="#cb41-690" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(mse)</span>
<span id="cb41-691"><a href="#cb41-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(rmse)</span>
<span id="cb41-692"><a href="#cb41-692" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-693"><a href="#cb41-693" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-694"><a href="#cb41-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-695"><a href="#cb41-695" aria-hidden="true" tabindex="-1"></a>where <span class="in">`t`</span> stands for the vector of true values, and <span class="in">`p`</span> is the vector of predictions. Let's give it a spin to make sure it works:</span>
<span id="cb41-696"><a href="#cb41-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-699"><a href="#cb41-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-700"><a href="#cb41-700" aria-hidden="true" tabindex="-1"></a>rmse_m4 <span class="ot">&lt;-</span> <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, m4<span class="sc">$</span>fitted.values)</span>
<span id="cb41-701"><a href="#cb41-701" aria-hidden="true" tabindex="-1"></a>rmse_m4</span>
<span id="cb41-702"><a href="#cb41-702" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-703"><a href="#cb41-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-704"><a href="#cb41-704" aria-hidden="true" tabindex="-1"></a>That means that, on average, predictions in our best model <span class="in">`m4`</span> are 256 trips off. Is this good? Bad? Worse? It's hard to say but, being practical, what we can say is whether this better than our alternative. Let us have a look at the RMSE of the other models as well as that of simply plugging in last year's counts:<span class="sc">\[</span>\^05-flows-11<span class="sc">\]</span></span>
<span id="cb41-705"><a href="#cb41-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-706"><a href="#cb41-706" aria-hidden="true" tabindex="-1"></a>::: column-margin</span>
<span id="cb41-707"><a href="#cb41-707" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple" icon="false"}</span>
<span id="cb41-708"><a href="#cb41-708" aria-hidden="true" tabindex="-1"></a>**Task**</span>
<span id="cb41-709"><a href="#cb41-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-710"><a href="#cb41-710" aria-hidden="true" tabindex="-1"></a>Can you create a single plot that displays the distribution of the predicted values of the five different ways to predict trips in 2016 and the actual counts of trips?</span>
<span id="cb41-711"><a href="#cb41-711" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb41-712"><a href="#cb41-712" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb41-713"><a href="#cb41-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-716"><a href="#cb41-716" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-717"><a href="#cb41-717" aria-hidden="true" tabindex="-1"></a>rmses <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb41-718"><a href="#cb41-718" aria-hidden="true" tabindex="-1"></a>  <span class="at">model=</span><span class="fu">c</span>(</span>
<span id="cb41-719"><a href="#cb41-719" aria-hidden="true" tabindex="-1"></a>    <span class="st">'OLS'</span>, </span>
<span id="cb41-720"><a href="#cb41-720" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Poisson'</span>, </span>
<span id="cb41-721"><a href="#cb41-721" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Poisson + FE'</span>, </span>
<span id="cb41-722"><a href="#cb41-722" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Poisson + FE + street dist.'</span>,</span>
<span id="cb41-723"><a href="#cb41-723" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Trips-2015'</span></span>
<span id="cb41-724"><a href="#cb41-724" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb41-725"><a href="#cb41-725" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE=</span><span class="fu">c</span>(</span>
<span id="cb41-726"><a href="#cb41-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, m1<span class="sc">$</span>fitted.values),</span>
<span id="cb41-727"><a href="#cb41-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, m2<span class="sc">$</span>fitted.values),</span>
<span id="cb41-728"><a href="#cb41-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, m3<span class="sc">$</span>fitted.values),</span>
<span id="cb41-729"><a href="#cb41-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, m4<span class="sc">$</span>fitted.values),</span>
<span id="cb41-730"><a href="#cb41-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(db_std<span class="sc">$</span>trips16, db_std<span class="sc">$</span>trips15)</span>
<span id="cb41-731"><a href="#cb41-731" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-732"><a href="#cb41-732" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-733"><a href="#cb41-733" aria-hidden="true" tabindex="-1"></a>rmses</span>
<span id="cb41-734"><a href="#cb41-734" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-735"><a href="#cb41-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-736"><a href="#cb41-736" aria-hidden="true" tabindex="-1"></a>The table is both encouraging and disheartning at the same time. On the one hand, all the modeling techniques covered above behave as we would expect: the baseline model displays the worst predicting power of all, and every improvement (except the street distances!) results in notable decreases of the RMSE. This is good news. However, on the other hand, all of our modelling efforts fall short of given a better guess than simply using the previous year's counts. *Why? Does this mean that we should not pay attention to modeling and inference?* Not really. Generally speaking, a model is as good at predicting as it is able to mimic the underlying process that gave rise to the data in the first place. The results above point to a case where our model is not picking up all the factors that determine the amount of trips undertaken in a give route. This could be improved by enriching the model with more/better predictors, as we have seen above. Also, the example above seems to point to a case where those idiosyncracies in 2015 that the model does not pick up seem to be at work in 2016 as well. This is great news for our prediction efforts this time, but we have no idea why this is the case and, for all that matters, it could change the coming year. Besides the elegant quantification of uncertainty, the true advantage of a modeling approach in this context is that, if well fit, it is able to pick up the fundamentals that apply over and over. This means that, if next year we're not as lucky as this one and previous counts are not good predictors but the variables we used in our model continue to have a role in determining the outcome, the data scientist should be luckier and hit a better prediction.</span>
<span id="cb41-737"><a href="#cb41-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-738"><a href="#cb41-738" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #region --&gt;</span></span>
<span id="cb41-739"><a href="#cb41-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-740"><a href="#cb41-740" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb41-741"><a href="#cb41-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-742"><a href="#cb41-742" aria-hidden="true" tabindex="-1"></a>We will be using again the Madrid AirBnb dataset: <span class="co">&lt;!-- #endregion --&gt;</span></span>
<span id="cb41-743"><a href="#cb41-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-746"><a href="#cb41-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb41-747"><a href="#cb41-747" aria-hidden="true" tabindex="-1"></a>mad_abb <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">'./data/assignment_1_madrid/madrid_abb.gpkg'</span>)</span>
<span id="cb41-748"><a href="#cb41-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb41-749"><a href="#cb41-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-750"><a href="#cb41-750" aria-hidden="true" tabindex="-1"></a>The columns to use here are:</span>
<span id="cb41-751"><a href="#cb41-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-752"><a href="#cb41-752" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`price_usd`</span>: price expressed in USD</span>
<span id="cb41-753"><a href="#cb41-753" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`log1p_price_usd`</span>: logarithm of the price expressed in USD</span>
<span id="cb41-754"><a href="#cb41-754" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`accommodates`</span>: number of people the property accommodates</span>
<span id="cb41-755"><a href="#cb41-755" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`bathrooms`</span>: number of bathrooms the property includes</span>
<span id="cb41-756"><a href="#cb41-756" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`bedrooms`</span>: number of bedrooms the property includes</span>
<span id="cb41-757"><a href="#cb41-757" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`beds`</span>: number of beds the property includes</span>
<span id="cb41-758"><a href="#cb41-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-759"><a href="#cb41-759" aria-hidden="true" tabindex="-1"></a>With these data at hand, accomplish the following challenges:</span>
<span id="cb41-760"><a href="#cb41-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-761"><a href="#cb41-761" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Set up a baseline regression model where you explain the price of a property as a function of its characteristics:</span>
<span id="cb41-762"><a href="#cb41-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-763"><a href="#cb41-763" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-764"><a href="#cb41-764" aria-hidden="true" tabindex="-1"></a>P_i = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb41-765"><a href="#cb41-765" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-766"><a href="#cb41-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-767"><a href="#cb41-767" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Fit a parallel model that uses the log of price as dependent variable:</span>
<span id="cb41-768"><a href="#cb41-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-769"><a href="#cb41-769" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-770"><a href="#cb41-770" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb41-771"><a href="#cb41-771" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb41-772"><a href="#cb41-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-773"><a href="#cb41-773" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Perform a predictive check analysis of both models, discussing how they compare, which one you would prefer, and why</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/05-flows.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>