<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Modelling flows | Spatial Analysis Notes</title>
  <meta name="description" content="Materials for a Spatial Analysis course in R." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Modelling flows | Spatial Analysis Notes" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Materials for a Spatial Analysis course in R." />
  <meta name="github-repo" content="gdsl-ul/san" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Modelling flows | Spatial Analysis Notes" />
  
  <meta name="twitter:description" content="Materials for a Spatial Analysis course in R." />
  

<meta name="author" content="Francisco Rowe &amp; Dani Arribas-Bel" />


<meta name="date" content="2020-02-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="seeing-flows.html"/>
<link rel="next" href="predicting-flows.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Analysis Notes</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Spatial Analysis Notes</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#dependencies"><i class="fa fa-check"></i><b>2.1</b> Dependencies</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#introducing-r"><i class="fa fa-check"></i><b>2.2</b> Introducing R</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#setting-the-working-directory"><i class="fa fa-check"></i><b>2.3</b> Setting the working directory</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#r-scripts-and-notebooks"><i class="fa fa-check"></i><b>2.4</b> R Scripts and Notebooks</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#getting-help"><i class="fa fa-check"></i><b>2.5</b> Getting Help</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#variables-and-objects"><i class="fa fa-check"></i><b>2.6</b> Variables and objects</a><ul>
<li class="chapter" data-level="2.6.1" data-path="intro.html"><a href="intro.html#basic-data-types"><i class="fa fa-check"></i><b>2.6.1</b> Basic Data Types</a></li>
<li class="chapter" data-level="2.6.2" data-path="intro.html"><a href="intro.html#random-variables"><i class="fa fa-check"></i><b>2.6.2</b> Random Variables</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="intro.html"><a href="intro.html#data-frames"><i class="fa fa-check"></i><b>2.7</b> Data Frames</a><ul>
<li class="chapter" data-level="2.7.1" data-path="intro.html"><a href="intro.html#creating-a-data-frame"><i class="fa fa-check"></i><b>2.7.1</b> Creating A Data Frame</a></li>
<li class="chapter" data-level="2.7.2" data-path="intro.html"><a href="intro.html#referencing-data-frames"><i class="fa fa-check"></i><b>2.7.2</b> Referencing Data Frames</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="intro.html"><a href="intro.html#sec_readdata"><i class="fa fa-check"></i><b>2.8</b> Read Data</a><ul>
<li class="chapter" data-level="2.8.1" data-path="intro.html"><a href="intro.html#quickly-inspect-the-data"><i class="fa fa-check"></i><b>2.8.1</b> Quickly inspect the data</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="intro.html"><a href="intro.html#manipulation-data"><i class="fa fa-check"></i><b>2.9</b> Manipulation Data</a><ul>
<li class="chapter" data-level="2.9.1" data-path="intro.html"><a href="intro.html#adding-new-variables"><i class="fa fa-check"></i><b>2.9.1</b> Adding New Variables</a></li>
<li class="chapter" data-level="2.9.2" data-path="intro.html"><a href="intro.html#selecting-variables"><i class="fa fa-check"></i><b>2.9.2</b> Selecting Variables</a></li>
<li class="chapter" data-level="2.9.3" data-path="intro.html"><a href="intro.html#filtering-data"><i class="fa fa-check"></i><b>2.9.3</b> Filtering Data</a></li>
<li class="chapter" data-level="2.9.4" data-path="intro.html"><a href="intro.html#joining-data-drames"><i class="fa fa-check"></i><b>2.9.4</b> Joining Data Drames</a></li>
<li class="chapter" data-level="2.9.5" data-path="intro.html"><a href="intro.html#saving-data"><i class="fa fa-check"></i><b>2.9.5</b> Saving Data</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="intro.html"><a href="intro.html#using-spatial-data-frames"><i class="fa fa-check"></i><b>2.10</b> Using Spatial Data Frames</a><ul>
<li class="chapter" data-level="2.10.1" data-path="intro.html"><a href="intro.html#read-spatial-data"><i class="fa fa-check"></i><b>2.10.1</b> Read Spatial Data</a></li>
<li class="chapter" data-level="2.10.2" data-path="intro.html"><a href="intro.html#basic-mapping"><i class="fa fa-check"></i><b>2.10.2</b> Basic Mapping</a></li>
<li class="chapter" data-level="2.10.3" data-path="intro.html"><a href="intro.html#comparing-geographies"><i class="fa fa-check"></i><b>2.10.3</b> Comparing geographies</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="intro.html"><a href="intro.html#useful-functions"><i class="fa fa-check"></i><b>2.11</b> Useful Functions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="points.html"><a href="points.html"><i class="fa fa-check"></i><b>3</b> Points</a><ul>
<li class="chapter" data-level="3.1" data-path="points.html"><a href="points.html#dependencies-1"><i class="fa fa-check"></i><b>3.1</b> Dependencies</a></li>
<li class="chapter" data-level="3.2" data-path="points.html"><a href="points.html#data"><i class="fa fa-check"></i><b>3.2</b> Data</a></li>
<li class="chapter" data-level="3.3" data-path="points.html"><a href="points.html#kde"><i class="fa fa-check"></i><b>3.3</b> KDE</a><ul>
<li class="chapter" data-level="3.3.1" data-path="points.html"><a href="points.html#one-dimensional-kde"><i class="fa fa-check"></i><b>3.3.1</b> One-dimensional KDE</a></li>
<li class="chapter" data-level="3.3.2" data-path="points.html"><a href="points.html#two-dimensional-spatial-kde"><i class="fa fa-check"></i><b>3.3.2</b> Two-dimensional (spatial) KDE</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="points.html"><a href="points.html#spatial-interpolation"><i class="fa fa-check"></i><b>3.4</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="3.4.1" data-path="points.html"><a href="points.html#inverse-distance-weight-idw-interpolation"><i class="fa fa-check"></i><b>3.4.1</b> Inverse Distance Weight (IDW) interpolation</a></li>
<li class="chapter" data-level="3.4.2" data-path="points.html"><a href="points.html#a-surface-of-housing-prices"><i class="fa fa-check"></i><b>3.4.2</b> A surface of housing prices</a></li>
<li class="chapter" data-level="3.4.3" data-path="points.html"><a href="points.html#what-should-the-next-houses-price-be"><i class="fa fa-check"></i><b>3.4.3</b> <em>“What should the next house’s price be?”</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="flows.html"><a href="flows.html"><i class="fa fa-check"></i><b>4</b> Flows</a></li>
<li class="chapter" data-level="5" data-path="dependencies-2.html"><a href="dependencies-2.html"><i class="fa fa-check"></i><b>5</b> Dependencies</a></li>
<li class="chapter" data-level="6" data-path="data-1.html"><a href="data-1.html"><i class="fa fa-check"></i><b>6</b> Data</a></li>
<li class="chapter" data-level="7" data-path="seeing-flows.html"><a href="seeing-flows.html"><i class="fa fa-check"></i><b>7</b> “<em>Seeing</em>” flows</a></li>
<li class="chapter" data-level="8" data-path="modelling-flows.html"><a href="modelling-flows.html"><i class="fa fa-check"></i><b>8</b> Modelling flows</a><ul>
<li class="chapter" data-level="8.1" data-path="modelling-flows.html"><a href="modelling-flows.html#baseline-model"><i class="fa fa-check"></i><b>8.1</b> Baseline model</a></li>
<li class="chapter" data-level="8.2" data-path="modelling-flows.html"><a href="modelling-flows.html#improving-the-model"><i class="fa fa-check"></i><b>8.2</b> Improving the model</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="predicting-flows.html"><a href="predicting-flows.html"><i class="fa fa-check"></i><b>9</b> Predicting flows</a></li>
<li class="chapter" data-level="10" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>10</b> References</a></li>
<li class="chapter" data-level="11" data-path="spatial-econometrics.html"><a href="spatial-econometrics.html"><i class="fa fa-check"></i><b>11</b> Spatial Econometrics</a></li>
<li class="chapter" data-level="12" data-path="multilevel-models-pt-i.html"><a href="multilevel-models-pt-i.html"><i class="fa fa-check"></i><b>12</b> Multilevel Models (Pt. I)</a></li>
<li class="chapter" data-level="13" data-path="multilevel-models-pt-ii.html"><a href="multilevel-models-pt-ii.html"><i class="fa fa-check"></i><b>13</b> Multilevel Models (Pt. II)</a></li>
<li class="chapter" data-level="14" data-path="gwr.html"><a href="gwr.html"><i class="fa fa-check"></i><b>14</b> GWR</a></li>
<li class="chapter" data-level="15" data-path="space-time-analysis.html"><a href="space-time-analysis.html"><i class="fa fa-check"></i><b>15</b> Space-Time Analysis</a></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Analysis Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="modelling-flows" class="section level1">
<h1><span class="header-section-number">Chapter 8</span> Modelling flows</h1>
<p>Now we have an idea of the spatial distribution of flows, we can begin to think about modeling them. The core idea in this section is to fit a model that can capture the particular characteristics of our variable of interest (the volume of trips) using a set of predictors that describe the nature of a given flow. We will start from the simplest model and then progressively build complexity until we get to a satisfying point. Along the way, we will be exploring each model using concepts from <span class="citation">Gelman and Hill (<a href="#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> such as predictive performance checks<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a> (PPC)</p>
<p>Before we start running regressions, let us first standardize the predictors so we can interpret the intercept as the average flow when all the predictors take the average value, and so we can interpret the model coefficients as changes in standard deviation units:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="modelling-flows.html#cb192-1"></a><span class="co"># Scale all the table</span></span>
<span id="cb192-2"><a href="modelling-flows.html#cb192-2"></a>db_std &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">scale</span>(db<span class="op">@</span>data))</span>
<span id="cb192-3"><a href="modelling-flows.html#cb192-3"></a><span class="co"># Reset trips as we want the original version</span></span>
<span id="cb192-4"><a href="modelling-flows.html#cb192-4"></a>db_std<span class="op">$</span>trips15 &lt;-<span class="st"> </span>db<span class="op">@</span>data<span class="op">$</span>trips15</span>
<span id="cb192-5"><a href="modelling-flows.html#cb192-5"></a>db_std<span class="op">$</span>trips16 &lt;-<span class="st"> </span>db<span class="op">@</span>data<span class="op">$</span>trips16</span>
<span id="cb192-6"><a href="modelling-flows.html#cb192-6"></a><span class="co"># Reset origin and destination station and express them as factors</span></span>
<span id="cb192-7"><a href="modelling-flows.html#cb192-7"></a>db_std<span class="op">$</span>orig &lt;-<span class="st"> </span><span class="kw">as.factor</span>(db<span class="op">@</span>data<span class="op">$</span>orig)</span>
<span id="cb192-8"><a href="modelling-flows.html#cb192-8"></a>db_std<span class="op">$</span>dest &lt;-<span class="st"> </span><span class="kw">as.factor</span>(db<span class="op">@</span>data<span class="op">$</span>dest)</span></code></pre></div>
<div id="baseline-model" class="section level2">
<h2><span class="header-section-number">8.1</span> Baseline model</h2>
<p>One of the simplest possible models we can fit in this context is a linear model that explains the number of trips as a function of the straight distance between the two stations and total amount of climb and downhill. We will take this as the baseline on which we can further build later:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="modelling-flows.html#cb193-1"></a>m1 &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="st">&#39;trips15 ~ straight_dist + total_up + total_down&#39;</span>, <span class="dt">data=</span>db_std)</span>
<span id="cb193-2"><a href="modelling-flows.html#cb193-2"></a><span class="kw">summary</span>(m1)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = &quot;trips15 ~ straight_dist + total_up + total_down&quot;, 
##     data = db_std)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -261.9 -168.3 -102.4   30.8 3527.4 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    182.070      8.110  22.451  &lt; 2e-16 ***
## straight_dist   17.906      9.108   1.966   0.0495 *  
## total_up       -44.100      9.353  -4.715 2.61e-06 ***
## total_down     -20.241      9.229  -2.193   0.0284 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 336.5 on 1718 degrees of freedom
## Multiple R-squared:  0.02196,    Adjusted R-squared:  0.02025 
## F-statistic: 12.86 on 3 and 1718 DF,  p-value: 2.625e-08</code></pre>
<p>To explore how good this model is, we will be comparing the predictions the model makes about the number of trips each flow should have with the actual number of trips. A first approach is to simply plot the distribution of both variables:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="modelling-flows.html#cb195-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values), </span>
<span id="cb195-2"><a href="modelling-flows.html#cb195-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb195-3"><a href="modelling-flows.html#cb195-3"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb195-4"><a href="modelling-flows.html#cb195-4"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb195-5"><a href="modelling-flows.html#cb195-5"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb195-6"><a href="modelling-flows.html#cb195-6"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb195-7"><a href="modelling-flows.html#cb195-7"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb195-8"><a href="modelling-flows.html#cb195-8"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>),</span>
<span id="cb195-9"><a href="modelling-flows.html#cb195-9"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>),</span>
<span id="cb195-10"><a href="modelling-flows.html#cb195-10"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb195-11"><a href="modelling-flows.html#cb195-11"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check, point estimates - Baseline model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>The plot makes pretty obvious that our initial model captures very few aspects of the distribution we want to explain. However, we should not get too attached to this plot just yet. What it is showing is the distribution of predicted <em>point</em> estimates from our model. Since our model is not deterministic but inferential, there is a certain degree of uncertainty attached to its predictions, and that is completely absent from this plot.</p>
<p>Generally speaking, a given model has two sources of uncertainty: <em>predictive</em>, and <em>inferential</em>. The former relates to the fact that the equation we fit does not capture all the elements or in the exact form they enter the true data generating process; the latter has to do with the fact that we never get to know the true value of the model parameters only guesses (estimates) subject to error and uncertainty. If you think of our linear model above as</p>
<p><span class="math display">\[
T_{ij} = X_{ij}\beta + \epsilon_{ij}
\]</span>
where <span class="math inline">\(T_{ij}\)</span> represents the number of trips undertaken between station <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>, <span class="math inline">\(X_{ij}\)</span> is the set of explanatory variables (length, climb, descent, etc.), and <span class="math inline">\(\epsilon_{ij}\)</span> is an error term assumed to be distributed as a normal distribution <span class="math inline">\(N(0, \sigma)\)</span>; then predictive uncertainty comes from the fact that there are elements to some extent relevant for <span class="math inline">\(y\)</span> that are not accounted for and thus subsummed into <span class="math inline">\(\epsilon_{ij}\)</span>. Inferential uncertainty comes from the fact that we never get to know <span class="math inline">\(\beta\)</span> but only an estimate of it which is also subject to uncertainty itself.</p>
<p>Taking these two sources into consideration means that the black line in the plot above represents only the behaviour of our model we expect if the error term is absent (no predictive uncertainty) and the coefficients are the true estimates (no inferential uncertainty). However, this is not necessarily the case as our estimate for the uncertainty of the error term is certainly not zero, and our estimates for each parameter are also subject to a great deal of inferential variability. we do not know to what extent other outcomes would be just as likely. Predictive checking relates to simulating several feasible scenarios under our model and use those to assess uncertainty and to get a better grasp of the quality of our predictions.</p>
<p>Technically speaking, to do this, we need to build a mechanism to obtain a possible draw from our model and then repeat it several times. The first part of those two steps can be elegantly dealt with by writing a short function that takes a given model and a set of predictors, and produces a possible random draw from such model:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="modelling-flows.html#cb196-1"></a>generate_draw &lt;-<span class="st"> </span><span class="cf">function</span>(m){</span>
<span id="cb196-2"><a href="modelling-flows.html#cb196-2"></a>  <span class="co"># Set up predictors matrix</span></span>
<span id="cb196-3"><a href="modelling-flows.html#cb196-3"></a>  x &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(m)</span>
<span id="cb196-4"><a href="modelling-flows.html#cb196-4"></a>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span id="cb196-5"><a href="modelling-flows.html#cb196-5"></a>  sim_bs &lt;-<span class="st"> </span><span class="kw">sim</span>(m, <span class="dv">1</span>)</span>
<span id="cb196-6"><a href="modelling-flows.html#cb196-6"></a>  <span class="co"># Predicted value</span></span>
<span id="cb196-7"><a href="modelling-flows.html#cb196-7"></a>  mu &lt;-<span class="st"> </span>x <span class="op">%*%</span><span class="st"> </span>sim_bs<span class="op">@</span>coef[<span class="dv">1</span>, ]</span>
<span id="cb196-8"><a href="modelling-flows.html#cb196-8"></a>  <span class="co"># Draw</span></span>
<span id="cb196-9"><a href="modelling-flows.html#cb196-9"></a>  n &lt;-<span class="st"> </span><span class="kw">length</span>(mu)</span>
<span id="cb196-10"><a href="modelling-flows.html#cb196-10"></a>  y_hat &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, mu, sim_bs<span class="op">@</span>sigma[<span class="dv">1</span>])</span>
<span id="cb196-11"><a href="modelling-flows.html#cb196-11"></a>  <span class="kw">return</span>(y_hat)</span>
<span id="cb196-12"><a href="modelling-flows.html#cb196-12"></a>}</span></code></pre></div>
<p>This function takes a model <code>m</code> and the set of covariates <code>x</code> used and returns a random realization of predictions from the model. To get a sense of how this works, we can get and plot a realization of the model, compared to the expected one and the actual values:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="modelling-flows.html#cb197-1"></a>new_y &lt;-<span class="st"> </span><span class="kw">generate_draw</span>(m1)</span>
<span id="cb197-2"><a href="modelling-flows.html#cb197-2"></a></span>
<span id="cb197-3"><a href="modelling-flows.html#cb197-3"></a><span class="kw">plot</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values), </span>
<span id="cb197-4"><a href="modelling-flows.html#cb197-4"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb197-5"><a href="modelling-flows.html#cb197-5"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb197-6"><a href="modelling-flows.html#cb197-6"></a>                      <span class="kw">max</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb197-7"><a href="modelling-flows.html#cb197-7"></a>                      <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb197-8"><a href="modelling-flows.html#cb197-8"></a>                      )</span>
<span id="cb197-9"><a href="modelling-flows.html#cb197-9"></a>                   )</span>
<span id="cb197-10"><a href="modelling-flows.html#cb197-10"></a>            ),</span>
<span id="cb197-11"><a href="modelling-flows.html#cb197-11"></a>     <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb197-12"><a href="modelling-flows.html#cb197-12"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb197-13"><a href="modelling-flows.html#cb197-13"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb197-14"><a href="modelling-flows.html#cb197-14"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb197-15"><a href="modelling-flows.html#cb197-15"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb197-16"><a href="modelling-flows.html#cb197-16"></a><span class="kw">lines</span>(<span class="kw">density</span>(new_y), </span>
<span id="cb197-17"><a href="modelling-flows.html#cb197-17"></a>      <span class="dt">col=</span><span class="st">&#39;green&#39;</span>,</span>
<span id="cb197-18"><a href="modelling-flows.html#cb197-18"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb197-19"><a href="modelling-flows.html#cb197-19"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb197-20"><a href="modelling-flows.html#cb197-20"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>, <span class="st">&#39;Simulated&#39;</span>),</span>
<span id="cb197-21"><a href="modelling-flows.html#cb197-21"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>),</span>
<span id="cb197-22"><a href="modelling-flows.html#cb197-22"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Once we have this “draw engine”, we can set it to work as many times as we want using a simple <code>for</code> loop. In fact, we can directly plot these lines as compared to the expected one and the trip count:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="modelling-flows.html#cb198-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values), </span>
<span id="cb198-2"><a href="modelling-flows.html#cb198-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb198-3"><a href="modelling-flows.html#cb198-3"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb198-4"><a href="modelling-flows.html#cb198-4"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb198-5"><a href="modelling-flows.html#cb198-5"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb198-6"><a href="modelling-flows.html#cb198-6"></a>                  )</span>
<span id="cb198-7"><a href="modelling-flows.html#cb198-7"></a>               )</span>
<span id="cb198-8"><a href="modelling-flows.html#cb198-8"></a>        ),</span>
<span id="cb198-9"><a href="modelling-flows.html#cb198-9"></a>     <span class="dt">col=</span><span class="st">&#39;white&#39;</span>,</span>
<span id="cb198-10"><a href="modelling-flows.html#cb198-10"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb198-11"><a href="modelling-flows.html#cb198-11"></a><span class="co"># Loop for realizations</span></span>
<span id="cb198-12"><a href="modelling-flows.html#cb198-12"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">250</span>){</span>
<span id="cb198-13"><a href="modelling-flows.html#cb198-13"></a>  tmp_y &lt;-<span class="st"> </span><span class="kw">generate_draw</span>(m1)</span>
<span id="cb198-14"><a href="modelling-flows.html#cb198-14"></a>  <span class="kw">lines</span>(<span class="kw">density</span>(tmp_y),</span>
<span id="cb198-15"><a href="modelling-flows.html#cb198-15"></a>        <span class="dt">col=</span><span class="st">&#39;grey&#39;</span>,</span>
<span id="cb198-16"><a href="modelling-flows.html#cb198-16"></a>        <span class="dt">lwd=</span><span class="fl">0.1</span></span>
<span id="cb198-17"><a href="modelling-flows.html#cb198-17"></a>        )</span>
<span id="cb198-18"><a href="modelling-flows.html#cb198-18"></a>}</span>
<span id="cb198-19"><a href="modelling-flows.html#cb198-19"></a><span class="co">#</span></span>
<span id="cb198-20"><a href="modelling-flows.html#cb198-20"></a><span class="kw">lines</span>(<span class="kw">density</span>(m1<span class="op">$</span>fitted.values), </span>
<span id="cb198-21"><a href="modelling-flows.html#cb198-21"></a>      <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb198-22"><a href="modelling-flows.html#cb198-22"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb198-23"><a href="modelling-flows.html#cb198-23"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb198-24"><a href="modelling-flows.html#cb198-24"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb198-25"><a href="modelling-flows.html#cb198-25"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb198-26"><a href="modelling-flows.html#cb198-26"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb198-27"><a href="modelling-flows.html#cb198-27"></a>       <span class="kw">c</span>(<span class="st">&#39;Actual&#39;</span>, <span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Simulated (n=250)&#39;</span>),</span>
<span id="cb198-28"><a href="modelling-flows.html#cb198-28"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;red&#39;</span>, <span class="st">&#39;black&#39;</span>, <span class="st">&#39;grey&#39;</span>),</span>
<span id="cb198-29"><a href="modelling-flows.html#cb198-29"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb198-30"><a href="modelling-flows.html#cb198-30"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check - Baseline model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>The plot shows there is a significant mismatch between the fitted values, which are much more concentrated around small positive values, and the realizations of our “inferential engine”, which depict a much less concentrated distribution of values. This is likely due to the combination of two different reasons: on the one hand, the accuracy of our estimates may be poor, causing them to jump around a wide range of potential values and hence resulting in very diverse predictions (inferential uncertainty); on the other hand, it may be that the amount of variation we are not able to account for in the model<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a> is so large that the degree of uncertainty contained in the error term of the model is very large, hence resulting in such a flat predictive distribution.</p>
<p>It is important to keep in mind that the issues discussed in the paragraph above relate only to the uncertainty behind our model, not to the point predictions derived from them, which are a mechanistic result of the minimization of the squared residuals and hence are not subject to probability or inference. That allows them in this case to provide a fitted distribution much more accurate apparently (black line above). However, the lesson to take from this model is that, even if the point predictions (fitted values) are artificially accurate<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>, our capabilities to infer about the more general underlying process are fairly limited.</p>
</div>
<div id="improving-the-model" class="section level2">
<h2><span class="header-section-number">8.2</span> Improving the model</h2>
<p>The bad news from the previous section is that our initial model is not great at explaining bike trips. The good news is there are several ways in which we can improve this. In this section we will cover three main extensions that exemplify three different routes you can take when enriching and augmenting models in general, and spatial interaction ones in particular<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>. These three routes are aligned around the following principles:</p>
<ol style="list-style-type: decimal">
<li>Use better approximations to model your dependent variable.</li>
<li>Recognize the structure of your data.</li>
<li>Get better predictors.</li>
</ol>
<ul>
<li><strong>Use better approximations to model your dependent variable</strong></li>
</ul>
<p>Standard OLS regression assumes that the error term and, since the predictors are deterministic, the dependent variable are distributed following a normal (gaussian) distribution. This is usually a good approximation for several phenomena of interest, but maybe not the best one for trips along routes: for one, we know trips cannot be negative, which the normal distribution does not account for<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a>; more subtly, their distribution is not really symmetric but skewed with a very long tail on the right. This is common in variables that represent counts and that is why usually it is more appropriate to fit a model that relies on a distribution different from the normal.</p>
<p>One of the most common distributions for this cases is the Poisson, which can be incorporated through a general linear model (or GLM). The underlying assumption here is that instead of <span class="math inline">\(T_{ij} \sim N(\mu_{ij}, \sigma)\)</span>, our model now follows:</p>
<p><span class="math display">\[
T_{ij} \sim Poisson (\exp^{X_{ij}\beta})
\]</span></p>
<p>As usual, such a model is easy to run in R:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="modelling-flows.html#cb199-1"></a>m2 &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="st">&#39;trips15 ~ straight_dist + total_up + total_down&#39;</span>, </span>
<span id="cb199-2"><a href="modelling-flows.html#cb199-2"></a>          <span class="dt">data=</span>db_std,</span>
<span id="cb199-3"><a href="modelling-flows.html#cb199-3"></a>          <span class="dt">family=</span>poisson,</span>
<span id="cb199-4"><a href="modelling-flows.html#cb199-4"></a>          )</span></code></pre></div>
<p>Now let’s see how much better, if any, this approach is. To get a quick overview, we can simply plot the point predictions:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="modelling-flows.html#cb200-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m2<span class="op">$</span>fitted.values), </span>
<span id="cb200-2"><a href="modelling-flows.html#cb200-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb200-3"><a href="modelling-flows.html#cb200-3"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb200-4"><a href="modelling-flows.html#cb200-4"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(m2<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb200-5"><a href="modelling-flows.html#cb200-5"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb200-6"><a href="modelling-flows.html#cb200-6"></a>                  )</span>
<span id="cb200-7"><a href="modelling-flows.html#cb200-7"></a>               )</span>
<span id="cb200-8"><a href="modelling-flows.html#cb200-8"></a>      ),</span>
<span id="cb200-9"><a href="modelling-flows.html#cb200-9"></a>     <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb200-10"><a href="modelling-flows.html#cb200-10"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb200-11"><a href="modelling-flows.html#cb200-11"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb200-12"><a href="modelling-flows.html#cb200-12"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb200-13"><a href="modelling-flows.html#cb200-13"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb200-14"><a href="modelling-flows.html#cb200-14"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb200-15"><a href="modelling-flows.html#cb200-15"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>),</span>
<span id="cb200-16"><a href="modelling-flows.html#cb200-16"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>),</span>
<span id="cb200-17"><a href="modelling-flows.html#cb200-17"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb200-18"><a href="modelling-flows.html#cb200-18"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check, point estimates - Poisson model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>To incorporate uncertainty to these predictions, we need to tweak our <code>generate_draw</code> function so it accommodates the fact that our model is not linear anymore.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="modelling-flows.html#cb201-1"></a>generate_draw_poi &lt;-<span class="st"> </span><span class="cf">function</span>(m){</span>
<span id="cb201-2"><a href="modelling-flows.html#cb201-2"></a>  <span class="co"># Set up predictors matrix</span></span>
<span id="cb201-3"><a href="modelling-flows.html#cb201-3"></a>  x &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(m)</span>
<span id="cb201-4"><a href="modelling-flows.html#cb201-4"></a>  <span class="co"># Obtain draws of parameters (inferential uncertainty)</span></span>
<span id="cb201-5"><a href="modelling-flows.html#cb201-5"></a>  sim_bs &lt;-<span class="st"> </span><span class="kw">sim</span>(m, <span class="dv">1</span>)</span>
<span id="cb201-6"><a href="modelling-flows.html#cb201-6"></a>  <span class="co"># Predicted value</span></span>
<span id="cb201-7"><a href="modelling-flows.html#cb201-7"></a>  xb &lt;-<span class="st"> </span>x <span class="op">%*%</span><span class="st"> </span>sim_bs<span class="op">@</span>coef[<span class="dv">1</span>, ]</span>
<span id="cb201-8"><a href="modelling-flows.html#cb201-8"></a>  <span class="co">#xb &lt;- x %*% m$coefficients</span></span>
<span id="cb201-9"><a href="modelling-flows.html#cb201-9"></a>  <span class="co"># Transform using the link function</span></span>
<span id="cb201-10"><a href="modelling-flows.html#cb201-10"></a>  mu &lt;-<span class="st"> </span><span class="kw">exp</span>(xb)</span>
<span id="cb201-11"><a href="modelling-flows.html#cb201-11"></a>  <span class="co"># Obtain a random realization</span></span>
<span id="cb201-12"><a href="modelling-flows.html#cb201-12"></a>  y_hat &lt;-<span class="st"> </span><span class="kw">rpois</span>(<span class="dt">n=</span><span class="kw">length</span>(mu), <span class="dt">lambda=</span>mu)</span>
<span id="cb201-13"><a href="modelling-flows.html#cb201-13"></a>  <span class="kw">return</span>(y_hat)</span>
<span id="cb201-14"><a href="modelling-flows.html#cb201-14"></a>}</span></code></pre></div>
<p>And then we can examine both point predictions an uncertainty around them:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="modelling-flows.html#cb202-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m2<span class="op">$</span>fitted.values), </span>
<span id="cb202-2"><a href="modelling-flows.html#cb202-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb202-3"><a href="modelling-flows.html#cb202-3"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb202-4"><a href="modelling-flows.html#cb202-4"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(m2<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb202-5"><a href="modelling-flows.html#cb202-5"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb202-6"><a href="modelling-flows.html#cb202-6"></a>                  )</span>
<span id="cb202-7"><a href="modelling-flows.html#cb202-7"></a>               )</span>
<span id="cb202-8"><a href="modelling-flows.html#cb202-8"></a>      ),</span>
<span id="cb202-9"><a href="modelling-flows.html#cb202-9"></a>     <span class="dt">col=</span><span class="st">&#39;white&#39;</span>,</span>
<span id="cb202-10"><a href="modelling-flows.html#cb202-10"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb202-11"><a href="modelling-flows.html#cb202-11"></a><span class="co"># Loop for realizations</span></span>
<span id="cb202-12"><a href="modelling-flows.html#cb202-12"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">250</span>){</span>
<span id="cb202-13"><a href="modelling-flows.html#cb202-13"></a>  tmp_y &lt;-<span class="st"> </span><span class="kw">generate_draw_poi</span>(m2)</span>
<span id="cb202-14"><a href="modelling-flows.html#cb202-14"></a>  <span class="kw">lines</span>(<span class="kw">density</span>(tmp_y),</span>
<span id="cb202-15"><a href="modelling-flows.html#cb202-15"></a>        <span class="dt">col=</span><span class="st">&#39;grey&#39;</span>,</span>
<span id="cb202-16"><a href="modelling-flows.html#cb202-16"></a>        <span class="dt">lwd=</span><span class="fl">0.1</span></span>
<span id="cb202-17"><a href="modelling-flows.html#cb202-17"></a>        )</span>
<span id="cb202-18"><a href="modelling-flows.html#cb202-18"></a>}</span>
<span id="cb202-19"><a href="modelling-flows.html#cb202-19"></a><span class="co">#</span></span>
<span id="cb202-20"><a href="modelling-flows.html#cb202-20"></a><span class="kw">lines</span>(<span class="kw">density</span>(m2<span class="op">$</span>fitted.values), </span>
<span id="cb202-21"><a href="modelling-flows.html#cb202-21"></a>      <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb202-22"><a href="modelling-flows.html#cb202-22"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb202-23"><a href="modelling-flows.html#cb202-23"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb202-24"><a href="modelling-flows.html#cb202-24"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb202-25"><a href="modelling-flows.html#cb202-25"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb202-26"><a href="modelling-flows.html#cb202-26"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb202-27"><a href="modelling-flows.html#cb202-27"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>, <span class="st">&#39;Simulated (n=250)&#39;</span>),</span>
<span id="cb202-28"><a href="modelling-flows.html#cb202-28"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;grey&#39;</span>),</span>
<span id="cb202-29"><a href="modelling-flows.html#cb202-29"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb202-30"><a href="modelling-flows.html#cb202-30"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check - Poisson model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>Voila! Although the curve is still a bit off, centered too much to the right of the actual data, our predictive simulation leaves the fitted values right in the middle. This speaks to a better fit of the model to the actual distribution othe original data follow.</p>
<ul>
<li><strong>Recognize the structure of your data</strong></li>
</ul>
<p>So far, we’ve treated our dataset as if it was flat (i.e. comprise of fully independent realizations) when in fact it is not. Most crucially, our baseline model does not account for the fact that every observation in the dataset pertains to a trip between two stations. This means that all the trips from or to the same station probably share elements which likely help explain how many trips are undertaken between stations. For example, think of trips to an from a station located in the famous Embarcadero, a popular tourist spot. Every route to and from there probably has more trips due to the popularity of the area and we are currently not acknowledging it in the model.</p>
<p>A simple way to incorporate these effects into the model is through origin and destination fixed effects. This approach shares elements with both spatial fixed effects and multilevel modeling and essentially consists of including a binary variable for every origin and destination station. In mathematical notation, this equates to:</p>
<p><span class="math display">\[
T_{ij} = X_{ij}\beta + \delta_i + \delta_j + \epsilon_{ij}
\]</span></p>
<p>where <span class="math inline">\(\delta_i\)</span> and <span class="math inline">\(\delta_j\)</span> are origin and destination station fixed effects<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>, and the rest is as above. This strategy accounts for all the unobserved heterogeneity associated with the location of the station. Technically speaking, we simply need to introduce <code>orig</code> and <code>dest</code> in the the model:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="modelling-flows.html#cb203-1"></a>m3 &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="st">&#39;trips15 ~ straight_dist + total_up + total_down + orig + dest&#39;</span>, </span>
<span id="cb203-2"><a href="modelling-flows.html#cb203-2"></a>          <span class="dt">data=</span>db_std,</span>
<span id="cb203-3"><a href="modelling-flows.html#cb203-3"></a>          <span class="dt">family=</span>poisson)</span></code></pre></div>
<p>And with our new model, we can have a look at how well it does at predicting the overall number of trips<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="modelling-flows.html#cb204-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m3<span class="op">$</span>fitted.values), </span>
<span id="cb204-2"><a href="modelling-flows.html#cb204-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb204-3"><a href="modelling-flows.html#cb204-3"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb204-4"><a href="modelling-flows.html#cb204-4"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(m3<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb204-5"><a href="modelling-flows.html#cb204-5"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb204-6"><a href="modelling-flows.html#cb204-6"></a>                  )</span>
<span id="cb204-7"><a href="modelling-flows.html#cb204-7"></a>               )</span>
<span id="cb204-8"><a href="modelling-flows.html#cb204-8"></a>      ),</span>
<span id="cb204-9"><a href="modelling-flows.html#cb204-9"></a>     <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb204-10"><a href="modelling-flows.html#cb204-10"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb204-11"><a href="modelling-flows.html#cb204-11"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb204-12"><a href="modelling-flows.html#cb204-12"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb204-13"><a href="modelling-flows.html#cb204-13"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb204-14"><a href="modelling-flows.html#cb204-14"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb204-15"><a href="modelling-flows.html#cb204-15"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>),</span>
<span id="cb204-16"><a href="modelling-flows.html#cb204-16"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>),</span>
<span id="cb204-17"><a href="modelling-flows.html#cb204-17"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb204-18"><a href="modelling-flows.html#cb204-18"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check - Orig/dest FE Poisson model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>That looks significantly better, doesn’t it? In fact, our model now better accounts for the long tail where a few routes take a lot of trips. This is likely because the distribution of trips is far from random across stations and our origin and destination fixed effects do a decent job at accounting for that structure. However our model is still notably underpredicting less popular routes and overpredicting routes with above average number of trips. Maybe we should think about moving beyond a simple linear model.</p>
<ul>
<li><strong>Get better predictors</strong></li>
</ul>
<p>The final extension is, in principle, always available but, in practice, it can be tricky to implement. The core idea is that your baseline model might not have the best measurement of the phenomena you want to account for. In our example, we can think of the distance between stations. So far, we have been including the distance measured “as the crow flies” between stations. Although in some cases this is a good approximation (particularly when distances are long and likely route taken is as close to straight as possible), in some cases like ours, where the street layout and the presence of elevation probably matter more than the actual final distance pedalled, this is not necessarily a safe assumption.</p>
<p>As an exampe of this approach, we can replace the straight distance measurements for more refined ones based on the Google Maps API routes. This is very easy as all we need to do (once the distances have been calculated!) is to swap <code>straight_dist</code> for <code>street_dist</code>:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="modelling-flows.html#cb205-1"></a>m4 &lt;-<span class="st"> </span><span class="kw">glm</span>(<span class="st">&#39;trips15 ~ street_dist + total_up + total_down + orig + dest&#39;</span>, </span>
<span id="cb205-2"><a href="modelling-flows.html#cb205-2"></a>          <span class="dt">data=</span>db_std,</span>
<span id="cb205-3"><a href="modelling-flows.html#cb205-3"></a>          <span class="dt">family=</span>poisson)</span></code></pre></div>
<p>And we can similarly get a sense of our predictive fitting with:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="modelling-flows.html#cb206-1"></a><span class="kw">plot</span>(<span class="kw">density</span>(m4<span class="op">$</span>fitted.values), </span>
<span id="cb206-2"><a href="modelling-flows.html#cb206-2"></a>     <span class="dt">xlim=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">100</span>, <span class="kw">max</span>(db_std<span class="op">$</span>trips15)),</span>
<span id="cb206-3"><a href="modelling-flows.html#cb206-3"></a>     <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(<span class="kw">c</span>(</span>
<span id="cb206-4"><a href="modelling-flows.html#cb206-4"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(m4<span class="op">$</span>fitted.values)<span class="op">$</span>y), </span>
<span id="cb206-5"><a href="modelling-flows.html#cb206-5"></a>                  <span class="kw">max</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15)<span class="op">$</span>y)</span>
<span id="cb206-6"><a href="modelling-flows.html#cb206-6"></a>                  )</span>
<span id="cb206-7"><a href="modelling-flows.html#cb206-7"></a>               )</span>
<span id="cb206-8"><a href="modelling-flows.html#cb206-8"></a>      ),</span>
<span id="cb206-9"><a href="modelling-flows.html#cb206-9"></a>     <span class="dt">col=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb206-10"><a href="modelling-flows.html#cb206-10"></a>     <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb206-11"><a href="modelling-flows.html#cb206-11"></a><span class="kw">lines</span>(<span class="kw">density</span>(db_std<span class="op">$</span>trips15), </span>
<span id="cb206-12"><a href="modelling-flows.html#cb206-12"></a>      <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</span>
<span id="cb206-13"><a href="modelling-flows.html#cb206-13"></a>      <span class="dt">main=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb206-14"><a href="modelling-flows.html#cb206-14"></a><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, </span>
<span id="cb206-15"><a href="modelling-flows.html#cb206-15"></a>       <span class="kw">c</span>(<span class="st">&#39;Predicted&#39;</span>, <span class="st">&#39;Actual&#39;</span>),</span>
<span id="cb206-16"><a href="modelling-flows.html#cb206-16"></a>       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;red&#39;</span>),</span>
<span id="cb206-17"><a href="modelling-flows.html#cb206-17"></a>       <span class="dt">lwd=</span><span class="dv">1</span>)</span>
<span id="cb206-18"><a href="modelling-flows.html#cb206-18"></a><span class="kw">title</span>(<span class="dt">main=</span><span class="st">&quot;Predictive check - Orig/dest FE Poisson model&quot;</span>)</span></code></pre></div>
<p><img src="03-flows_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<p>Hard to tell any noticeable difference, right? To see if there is any, we can have a look at the estimates obtained:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="modelling-flows.html#cb207-1"></a><span class="kw">summary</span>(m4)<span class="op">$</span>coefficients[<span class="st">&#39;street_dist&#39;</span>, ]</span></code></pre></div>
<pre><code>##       Estimate     Std. Error        z value       Pr(&gt;|z|) 
##  -9.961619e-02   2.688731e-03  -3.704952e+01  1.828096e-300</code></pre>
<p>And compare this to that of the straight distances in the previous model:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="modelling-flows.html#cb209-1"></a><span class="kw">summary</span>(m3)<span class="op">$</span>coefficients[<span class="st">&#39;straight_dist&#39;</span>, ]</span></code></pre></div>
<pre><code>##       Estimate     Std. Error        z value       Pr(&gt;|z|) 
##  -7.820014e-02   2.683052e-03  -2.914596e+01  9.399407e-187</code></pre>
<p>As we can see, the differences exist but ar not massive. Let’s use this example to learn how to interpret coefficients in a Poisson model<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>. Effectively, these estimates can be understood as multiplicative effects. Since our model fits</p>
<p><span class="math display">\[
T_{ij} \sim Poisson (\exp^{X_{ij}\beta})
\]</span></p>
<p>we need to transform <span class="math inline">\(\beta\)</span> through an exponential in order to get a sense of the effect of distance on the number of trips. This means that for the street distance, our original estimate is <span class="math inline">\(\beta_{street} = -0.0996\)</span>, but this needs to be translated through the exponential into <span class="math inline">\(e^{-0.0996} = 0.906\)</span>. In other words, since distance is expressed in standard deviations<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>, we can expect a 10% decrease in the number of trips for an increase of one standard deviation (about 1Km) in the distance between the stations. This can be compared with <span class="math inline">\(e^{-0.0782} = 0.925\)</span> for the straight distances, or a reduction of about 8% the number of trips for every increase of a standard deviation (about 720m).</p>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-gelman2006data">
<p>Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="15">
<li id="fn15"><p>For a more elaborate introduction to PPC, have a look at Chapters 7 and 8.<a href="modelling-flows.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p>The <span class="math inline">\(R^2\)</span> of our model is around 2%<a href="modelling-flows.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p>which they are not really, in light of the comparison between the black and red lines.<a href="modelling-flows.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p>These principles are general and can be applied to pretty much any modeling exercise you run into. The specific approaches we take in this note relate to spatial interaction models<a href="modelling-flows.html#fnref18" class="footnote-back">↩︎</a></p></li>
<li id="fn19"><p>For an illustration of this, consider the amount of probability mass to the left of zero in the predictive checks above.<a href="modelling-flows.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p>In this session, <span class="math inline">\(\delta_i\)</span> and <span class="math inline">\(\delta_j\)</span> are estimated as independent variables so their estimates are similar to interpret to those in <span class="math inline">\(\beta\)</span>. An alternative approach could be to model them as random effects in a multilevel framework.<a href="modelling-flows.html#fnref20" class="footnote-back">↩︎</a></p></li>
<li id="fn21"><p>Although, theoretically, we could also include simulations of the model in the plot to get a better sense of the uncertainty behind our model, in practice this seems troublesome. The problems most likely arise from the fact that many of the origin and destination binary variable coefficients are estimated with a great deal of uncertainty. This causes some of the simulation to generate extreme values that, when passed through the exponential term of the Poisson link function, cause problems. If anything, this is testimony of how a simple fixed effect model can sometimes lack accuracy and generate very uncertain estimates. A potential extension to work around these problems could be to fit a multilevel model with two specific levels beyond the trip-level: one for origin and another one for destination stations.<a href="modelling-flows.html#fnref21" class="footnote-back">↩︎</a></p></li>
<li id="fn22"><p>See section 6.2 of <span class="citation">Gelman and Hill (<a href="#ref-gelman2006data" role="doc-biblioref">2006</a>)</span> for a similar treatment of these.<a href="modelling-flows.html#fnref22" class="footnote-back">↩︎</a></p></li>
<li id="fn23"><p>Remember the transformation at the very beginning.<a href="modelling-flows.html#fnref23" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="seeing-flows.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="predicting-flows.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/03-flows.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["spatial_analysis_notes.pdf", "spatial_analysis_notes.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
