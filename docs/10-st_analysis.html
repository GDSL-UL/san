<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>10&nbsp; Spatio-Temporal Analysis – Spatial Modelling for Data Scientists</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./11-datasets.html" rel="next">
<link href="./09-gwr.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-3d62d204ba1604a696ce2d8f1e6896bb.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-050f1b1f236d8b339ca4f69fc358516a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10-st_analysis.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatio-Temporal Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Modelling for Data Scientists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/GDSL-UL/san" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-spatial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Spatial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spatial Data Wrangling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Point Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-flows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-spatial-econometrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-multilevel-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-multilevel-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-gwr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically Weighted Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-st_analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatio-Temporal Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Data Sets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#dependencies" id="toc-dependencies" class="nav-link active" data-scroll-target="#dependencies"><span class="header-section-number">10.1</span> Dependencies</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">10.2</span> Data</a></li>
  <li>
<a href="#why-spatio-temporal-analysis" id="toc-why-spatio-temporal-analysis" class="nav-link" data-scroll-target="#why-spatio-temporal-analysis"><span class="header-section-number">10.3</span> Why Spatio-Temporal Analysis?</a>
  <ul class="collapse">
<li><a href="#spatio-temporal-data-structures" id="toc-spatio-temporal-data-structures" class="nav-link" data-scroll-target="#spatio-temporal-data-structures"><span class="header-section-number">10.3.1</span> Spatio-temporal Data Structures</a></li>
  </ul>
</li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">10.4</span> Data Wrangling</a></li>
  <li>
<a href="#exploring-spatio-temporal-data" id="toc-exploring-spatio-temporal-data" class="nav-link" data-scroll-target="#exploring-spatio-temporal-data"><span class="header-section-number">10.5</span> Exploring Spatio-Temporal Data</a>
  <ul class="collapse">
<li><a href="#visualisation" id="toc-visualisation" class="nav-link" data-scroll-target="#visualisation"><span class="header-section-number">10.5.1</span> Visualisation</a></li>
  <li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis"><span class="header-section-number">10.5.2</span> Exploratory Analysis</a></li>
  </ul>
</li>
  <li>
<a href="#spatio-temporal-data-modelling" id="toc-spatio-temporal-data-modelling" class="nav-link" data-scroll-target="#spatio-temporal-data-modelling"><span class="header-section-number">10.6</span> Spatio-Temporal Data Modelling</a>
  <ul class="collapse">
<li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition"><span class="header-section-number">10.6.1</span> Intuition</a></li>
  <li><a href="#fitting-spatio-temporal-models" id="toc-fitting-spatio-temporal-models" class="nav-link" data-scroll-target="#fitting-spatio-temporal-models"><span class="header-section-number">10.6.2</span> Fitting Spatio-Temporal Models</a></li>
  </ul>
</li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">10.7</span> Questions</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/10-st_analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-chp10" class="quarto-section-identifier"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatio-Temporal Analysis</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>This chapter provides an introduction to the complexities of spatio-temporal data and modelling. For modelling, we consider the Fixed Rank Kriging (FRK) framework developed by <span class="citation" data-cites="cressie2008fixed">Cressie and Johannesson (<a href="references.html#ref-cressie2008fixed" role="doc-biblioref">2008</a>)</span>. It enables constructing a spatial random effects model on a discretised spatial domain. Key advantages of this approach comprise the capacity to: (1) work with large data sets, (2) be scaled up; (3) generate predictions based on sparse linear algebraic techniques, and (4) produce fine-scale resolution uncertainty estimates.</p>
<p>The content of this chapter is based on:</p>
<ul>
<li><p><span class="citation" data-cites="wikle2019spatio">Wikle, Zammit-Mangion, and Cressie (<a href="references.html#ref-wikle2019spatio" role="doc-biblioref">2019</a>)</span>, a recently published book which provides a good overview of existing statistical approaches to spatio-temporal modelling and R packages.</p></li>
<li><p><span class="citation" data-cites="zammit2017frk">Zammit-Mangion and Cressie (<a href="references.html#ref-zammit2017frk" role="doc-biblioref">2017</a>)</span>, who introduce the statistical framework and R package for modelling spatio-temporal used in this Chapter.</p></li>
</ul>
<section id="dependencies" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="dependencies">
<span class="header-section-number">10.1</span> Dependencies</h2>
<p>This chapter uses the following libraries:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># Nice tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span> </span>
<span><span class="co"># Spatial objects conversion</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span> </span>
<span><span class="co"># Thematic maps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span> </span>
<span><span class="co"># Nice colour schemes</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span> </span>
<span><span class="co"># Obtain correlation coefficients</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/taiyun/corrplot">corrplot</a></span><span class="op">)</span></span>
<span><span class="co"># Highlight data on plots</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yutannihilation.github.io/gghighlight/">gghighlight</a></span><span class="op">)</span></span>
<span><span class="co"># Analysing spatio-temporal data</span></span>
<span><span class="co">#library(STRbook)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/spacetime">spacetime</a></span><span class="op">)</span></span>
<span><span class="co"># Date parsing and manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span>
<span><span class="co"># Applied statistics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span></span>
<span><span class="co"># Statistical tests for linear regression models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span>
<span><span class="co"># Fit spatial random effects models</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://andrewzm.github.io/FRK/">FRK</a></span><span class="op">)</span></span>
<span><span class="co"># Exportable regression tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jtools.jacob-long.com">jtools</a></span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="data" class="level2 page-columns page-full" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="data">
<span class="header-section-number">10.2</span> Data</h2>
<p>For this chapter, we will use data on:</p>
<ul>
<li><p>COVID-19 confirmed cases from 30th January, 2020 to 21st April, 2020 from Public Health England via the <a href="https://coronavirus.data.gov.uk">GOV.UK dashboard</a>;</p></li>
<li><p>resident population characteristics from the 2011 census, available from the <a href="https://www.nomisweb.co.uk/home/census2001.asp">Office of National Statistics</a>; and,</p></li>
<li><p>2019 Index of Multiple Deprivation (IMD) data from <a href="https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019">GOV.UK</a> and published by the Ministry of Housing, Communities &amp; Local Government. The data are at the ONS Upper Tier Local Authority (UTLA) level - also known as <a href="https://geoportal.statistics.gov.uk">Counties and Unitary Authorities</a>.</p></li>
</ul>
<p>For a full list of the variables included in the data sets used in this chapter, see the readme file in the sta data folder.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Before we get our hands on the data, there are some important concepts that need to be introduced. They provide a useful framework to understand the complex structure of spatio-temporal data. Let’s start by first highlighling the importance of spatio-temporal analysis.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Read the file in R by executing <code>read_tsv("data/sta/readme.txt")</code>. Ensure the library readr is installed before running read_tsv.</p></div></div></section><section id="why-spatio-temporal-analysis" class="level2" data-number="10.3"><h2 data-number="10.3" class="anchored" data-anchor-id="why-spatio-temporal-analysis">
<span class="header-section-number">10.3</span> Why Spatio-Temporal Analysis?</h2>
<p>Investigating the spatial patterns of human processes as we have done so far in this book only offers a partial incomplete representation of these processes. It does not allow understanding of the temporal evolution of these processes. Human processes evolve in space and time. Human mobility is a inherent geographical process which changes over the course of the day, with peaks at rush hours and high concentration towards employment, education and retail centres. Exposure to air pollution changes with local climatic conditions, and emission and concentration of atmospheric pollutants which fluctuate over time. The rate of disease spread varies over space and may significantly change over time as we have seen during the current outbreak, with flattened or rapid declining trends in Australia, New Zealand and South Korea but fast proliferation in the United Kingdom and the United States. Only by considering time and space together we can address how geographic entities change over time and why they change. A large part of how and why of such change occurs is due to interactions across space and time, and multiple processes. It is essential to understand the past to inform our understanding of the present and make predictions about the future.</p>
<section id="spatio-temporal-data-structures" class="level3" data-number="10.3.1"><h3 data-number="10.3.1" class="anchored" data-anchor-id="spatio-temporal-data-structures">
<span class="header-section-number">10.3.1</span> Spatio-temporal Data Structures</h3>
<p>A first key element is to understand the structure of spatio-temporal data. Spatio-temporal data incorporate two dimensions. At one end, we have the temporal dimension. In quantitative analysis, time-series data are used to capture geographical processes at regular or irregular intervals; that is, in a continuous (daily) or discrete (only when a event occurs) temporal scale. At another end, we have the spatial dimension. We often use spatial data as temporal aggregations or temporally frozen states (or ‘snapshots’) of a geographical process - this is what we have done so far. Recall that spatial data can be capture in different geographical units, such as areal or lattice, points, flows or trajectories - refer to the introductory lecture in Week 1. Relatively few ways exist to formally integrate temporal and spatial data in consistent analytical framework. Two notable exceptions in R are the packages <code>TraMiner</code> <span class="citation" data-cites="gabadinho2009mining">(<a href="references.html#ref-gabadinho2009mining" role="doc-biblioref">Gabadinho et al. 2009</a>)</span> and <code>spacetime</code> <span class="citation" data-cites="pebesma2012spacetime">(<a href="references.html#ref-pebesma2012spacetime" role="doc-biblioref">Pebesma et al. 2012</a>)</span>. We use the class definitions defined in the R package <code>spacetime</code>. These classes extend those used for spatial data in <code>sp</code> and time-series data in <code>xts</code>. Next a brief introduction to concepts that facilitate thinking about spatio-temporal data structures.</p>
<section id="type-of-table" class="level4" data-number="10.3.1.1"><h4 data-number="10.3.1.1" class="anchored" data-anchor-id="type-of-table">
<span class="header-section-number">10.3.1.1</span> Type of Table</h4>
<p>Spatio-temporal data can be conceptualised as three main different types of tables:</p>
<ul>
<li><p>time-wide: a table in which columns correspond to different time points</p></li>
<li><p>space-wide: a table in which columns correspond to different spatial location</p></li>
<li><p>long formats: a table in which each row-column pair corresponds to a specific time and spatial location (or space coordinate)</p></li>
</ul>
<blockquote class="blockquote">
<p>Note that data in long format are space inefficient because spatial coordinates and time attributes are required for each data point. Yet, data in this format are relatively easy to manipulate via packages such as <code>dplyr</code> and <code>tidyr</code>, and visualise using <code>ggplot2</code>. These packages are designed to work with data in long format.</p>
</blockquote>
</section><section id="type-of-spatio-temporal-object" class="level4" data-number="10.3.1.2"><h4 data-number="10.3.1.2" class="anchored" data-anchor-id="type-of-spatio-temporal-object">
<span class="header-section-number">10.3.1.2</span> Type of Spatio-Temporal Object</h4>
<p>To integrate spatio-temporal data, spatio-temporal objects are needed. We consider four different spatio-temporal frames (STFs) or objects which can be defined via the package <code>spacetime</code>:</p>
<ul>
<li><p>Full grid (STF): an object containing data on all possible locations in all time points in a sequence of data;</p></li>
<li><p>Sparse grid (STS): an object similar to STF but only containing non-missing space-time data combinations;</p></li>
<li><p>Irregular (STI): an object with an irregular space-time data structure, where each point is allocated a spatial coordinate and a time stamp;</p></li>
<li><p>Simple Trajectories (STT): an object containig a sequence of space-time points that form trajectories.</p></li>
</ul>
<p>More details on these spatio-temporal structures, construction and manipulation, see <span class="citation" data-cites="pebesma2012spacetime">Pebesma et al. (<a href="references.html#ref-pebesma2012spacetime" role="doc-biblioref">2012</a>)</span>. Enough theory, let’s code!</p>
</section></section></section><section id="data-wrangling" class="level2" data-number="10.4"><h2 data-number="10.4" class="anchored" data-anchor-id="data-wrangling">
<span class="header-section-number">10.4</span> Data Wrangling</h2>
<p>This section illustrates the complexities of handling spatio-temporal data. It discusses good practices in data manipulation and construction of a Space Time Irregular Data Frame (STIDF) object. Three key requirements to define a STFDF object are:</p>
<ol type="1">
<li><p>Have a data frame in long format i.e.&nbsp;a location-time pair data frame</p></li>
<li><p>Define a time stamp</p></li>
<li><p>Construct the spatio-temporal object of class STIDF by indicating the spatial and temporal coordinates</p></li>
</ol>
<p>Let’s now read all the required data. While we can have all data in a single data frame, you will find helpful to have separate data objects to identify:</p>
<ul>
<li><p>spatial locations</p></li>
<li><p>temporal units</p></li>
<li><p>data</p></li>
</ul>
<p>These data objects correspond to <code>locs</code>, <code>time</code>, and <code>covid19</code> and <code>censusimd</code> below. Throughout the chapter you will notice that we switch between the various data frames when convinient, depending on the operation.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># clear workspace</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read ONS UTLA shapefile</span></span>
<span><span class="va">utla_shp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/sta/ons_utla.shp"</span><span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `ons_utla' from data source 
  `/Users/franciscorowe/Library/CloudStorage/Dropbox/Francisco/uol/teaching/envs453/202526/san/data/sta/ons_utla.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 150 features and 11 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 134112.4 ymin: 11429.67 xmax: 655653.8 ymax: 657536
Projected CRS: Transverse_Mercator</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create table of locations</span></span>
<span><span class="va">locs</span> <span class="op">&lt;-</span> <span class="va">utla_shp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">objct</span>, <span class="va">cty19c</span>, <span class="va">ctyu19nm</span>, <span class="va">long</span>, <span class="va">lat</span>, <span class="va">st_rs</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># read time data frame</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/sta/reporting_dates.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read COVID-19 data in long format</span></span>
<span><span class="va">covid19</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/sta/covid19_cases.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read census and IMD data</span></span>
<span><span class="va">censusimd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/sta/2011census_2019imd_utla.csv"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If we explore the structure of the data via <code>head</code> and <code>str</code>, we can see we have data on daily and cumulative new COVID-19 cases for 150 spatial units (i.e.&nbsp;UTLAs) over 71 time points from January 30th to April 21st. We also have census and IMD data for a range of attributes.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">covid19</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  Area.name            Area.code Area.type     date       Daily.lab.confirmed.…¹
  &lt;chr&gt;                &lt;chr&gt;     &lt;chr&gt;         &lt;date&gt;                      &lt;dbl&gt;
1 Barking and Dagenham E09000002 Upper tier l… 2020-01-30                      0
2 Barnet               E09000003 Upper tier l… 2020-01-30                      0
3 Barnsley             E08000016 Upper tier l… 2020-01-30                      0
# ℹ abbreviated name: ¹​Daily.lab.confirmed.cases
# ℹ 1 more variable: Cumulative.lab.confirmed.cases &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Once we have understood the structure of the data, we first need to confirm if the <code>covid19</code> data are in wide or long format. Luckily they are in long format; otherwise, we would have needed to transform the data from wide to long format. Useful functions to achieve this include <code>pivot_longer</code> (<code>pivot_longer</code>) which has superseded <code>gather</code> (<code>spread</code>) in the <code>tidyr</code> package. Note that the <code>covid19</code> data frame has 10,650 observations (i.e.&nbsp;rows); that is, 150 UTLAs * 71 daily observations.</p>
<p>We then define a regular time stamp for our temporal data. We use the <code>lubridate</code> package to do this. A key advantage of <code>lubridate</code> is that it automatically recognises the common separators used when recording dates (“-”, “/”, “.”, and ““). As a result, you only need to focus on specifying the order of the date elements to determine the parsing function applied. Below we check the structure of our time data, define a time stamp and create separate variables for days, weeks, months and year.</p>
<blockquote class="blockquote">
<p>Note that working with dates can be a complex task. A good discussion of these complexities is provided <a href="http://uc-r.github.io/dates/#convert_date">here</a>.</p>
</blockquote>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># check the time structure used for reporting covid cases</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span>, <span class="fl">5</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-01-30" "2020-01-30" "2020-01-30" "2020-01-30" "2020-01-30"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># parsing data into a time stamp</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Date"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># separate date variable into day,week, month and year variables</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html">day</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">week</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html">week</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="co"># week of the year</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Once defined the time stamp, we need to add the spatial information contained in our shapefile to create a spatio-temporal data frame.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># join dfs</span></span>
<span><span class="va">covid19_spt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">utla_shp</span>, <span class="va">covid19</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ctyu19nm"</span> <span class="op">=</span> <span class="st">"Area.name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We now have all the components to build a spatio-temporal object of class STIDF using <code>STIDF</code> from the <code>spacetime</code> package:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># identifying spatial fields</span></span>
<span><span class="va">spat_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">covid19_spt</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">bng_e</span>, <span class="va">bng_n</span>, <span class="va">Area.code</span>, <span class="va">Area.type</span>, <span class="va">Daily.lab.confirmed.cases</span>, <span class="va">Cumulative.lab.confirmed.cases</span>, <span class="va">date</span>, <span class="va">day</span>, <span class="va">week</span>, <span class="va">month</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span>, Class <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identifying temporal fields</span></span>
<span><span class="va">temp_part</span> <span class="op">&lt;-</span> <span class="va">covid19_spt</span><span class="op">$</span><span class="va">date</span></span>
<span></span>
<span><span class="co"># identifying data</span></span>
<span><span class="va">covid19_data</span> <span class="op">&lt;-</span> <span class="va">covid19_spt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Area.code</span>, <span class="va">Area.type</span>, <span class="va">date</span>, <span class="va">Daily.lab.confirmed.cases</span>, <span class="va">Cumulative.lab.confirmed.cases</span>, <span class="va">day</span>, <span class="va">week</span>, <span class="va">month</span>, <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># construct STIDF object</span></span>
<span><span class="va">covid19_stobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spacetime/man/STIDF-class.html">STIDF</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">spat_part</span>, <span class="co"># spatial fields</span></span>
<span>                time <span class="op">=</span> <span class="va">temp_part</span>, <span class="co"># time fields</span></span>
<span>                data <span class="op">=</span> <span class="va">covid19_data</span><span class="op">)</span> <span class="co"># data</span></span>
<span>                </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">covid19_stobj</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "STIDF"
attr(,"package")
[1] "spacetime"</code></pre>
</div>
</div>
<p>We now add census and IMD variables. For the purposes of this Chapter, we only add total population and long-term sick or disabled population counts. You can add more variables by adding their names in the <code>select</code> function.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># select pop data</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="va">censusimd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"UTLA19NM"</span>, <span class="st">"Residents"</span>, <span class="st">"Longterm_sick_or_disabled"</span><span class="op">)</span></span>
<span><span class="co"># join dfs</span></span>
<span><span class="va">covid19_spt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">covid19_spt</span>, <span class="va">pop</span>,</span>
<span>                         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ctyu19nm"</span> <span class="op">=</span> <span class="st">"UTLA19NM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covid19</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">covid19</span>, <span class="va">pop</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Area.name"</span> <span class="op">=</span> <span class="st">"UTLA19NM"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="exploring-spatio-temporal-data" class="level2" data-number="10.5"><h2 data-number="10.5" class="anchored" data-anchor-id="exploring-spatio-temporal-data">
<span class="header-section-number">10.5</span> Exploring Spatio-Temporal Data</h2>
<p>We now have all the required data in place. In this section various methods of data visualisation are illustrated before key dimensions of the data are explored. Both of these types of exploration can be challenging as one or more dimensions in space and one in time need to be interrogated.</p>
<section id="visualisation" class="level3" data-number="10.5.1"><h3 data-number="10.5.1" class="anchored" data-anchor-id="visualisation">
<span class="header-section-number">10.5.1</span> Visualisation</h3>
<p>In the context spatio-temporal data, a first challenge is data visualization. Visualising more than two dimensions of spatio-temporal data, so it is helpful to slice or aggregate the data over a dimension, use color, or build animations through time. Before exploring the data, we need to define our key variable of interest; that is, the number of confirmed COVID-19 cases per 100,000 people. We also compute the cumulative number of confirmed COVID-19 cases per 100,000 people as it may be handy in some analyses.</p>
<p>Fisrt create variable to be analysed:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rate of new covid-19 infection</span></span>
<span><span class="va">covid19_spt</span><span class="op">$</span><span class="va">n_covid19_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="va">covid19_spt</span><span class="op">$</span><span class="va">Daily.lab.confirmed.cases</span> <span class="op">/</span> <span class="va">covid19_spt</span><span class="op">$</span><span class="va">Residents</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100000</span><span class="op">)</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">n_covid19_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">Daily.lab.confirmed.cases</span> <span class="op">/</span> <span class="va">covid19</span><span class="op">$</span><span class="va">Residents</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100000</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># risk of cumulative covid-19 infection</span></span>
<span><span class="va">covid19_spt</span><span class="op">$</span><span class="va">c_covid19_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="va">covid19_spt</span><span class="op">$</span><span class="va">Cumulative.lab.confirmed.cases</span> <span class="op">/</span> <span class="va">covid19_spt</span><span class="op">$</span><span class="va">Residents</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100000</span><span class="op">)</span></span>
<span><span class="va">covid19</span><span class="op">$</span><span class="va">c_covid19_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="op">(</span><span class="va">covid19</span><span class="op">$</span><span class="va">Cumulative.lab.confirmed.cases</span> <span class="op">/</span> <span class="va">covid19</span><span class="op">$</span><span class="va">Residents</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100000</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="spatial-plots" class="level4" data-number="10.5.1.1"><h4 data-number="10.5.1.1" class="anchored" data-anchor-id="spatial-plots">
<span class="header-section-number">10.5.1.1</span> Spatial Plots</h4>
<p>One way to visualise the data is using spatial plots; that is, snapshots of a geographic process for a given time period. Data can be mapped in different ways using clorepleth, countour or surface plots. The key aim of these maps is to understand how the overall extent of spatial variation and local patterns of spatial concentration change over time. Below we visualise the weekly number of confirmed COVID-19 cases per 100,000 people.</p>
<blockquote class="blockquote">
<p>Note that Weeks range from 5 to 16 as they refer to calendar weeks. Calendar week 5 is when the first COVID-19 case in England was reported.</p>
</blockquote>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create data frame for new cases by week</span></span>
<span><span class="va">daycases_week</span> <span class="op">&lt;-</span> <span class="va">covid19_spt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">week</span>, <span class="va">ctyu19nm</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">cty19c</span><span class="op">)</span>, </span>
<span>           <span class="va">Residents</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n_daycases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Daily.lab.confirmed.cases</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># weekly rate of new covid-19 infection</span></span>
<span><span class="va">daycases_week</span><span class="op">$</span><span class="va">wn_covid19_r</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">daycases_week</span><span class="op">$</span><span class="va">n_daycases</span> <span class="op">/</span> <span class="va">daycases_week</span><span class="op">$</span><span class="va">Residents</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100000</span></span>
<span></span>
<span><span class="co"># map</span></span>
<span><span class="va">legend_title</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Cumulative Cases per 100,000 Population"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">daycases_week</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"wn_covid19_r"</span>, title <span class="op">=</span> <span class="va">legend_title</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">magma</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, style <span class="op">=</span><span class="st">"cont"</span>, legend.hist<span class="op">=</span><span class="cn">FALSE</span>, legend.is.portrait<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_facets.html">tm_facets</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"week"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span>, lwd <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>  <span class="op">+</span> <span class="co"># add borders +</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>bg.color <span class="op">=</span> <span class="st">"white"</span>, <span class="co"># change background colour</span></span>
<span>            legend.outside <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># legend outside</span></span>
<span>            legend.outside.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>            legend.stack <span class="op">=</span> <span class="st">"horizontal"</span>,</span>
<span>            legend.title.size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>            legend.width <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            legend.height <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            panel.label.size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>            main.title <span class="op">=</span> <span class="st">"New COVID-19 Cases by Calendar Week, UTLA, England"</span><span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The series of maps reveal a stable pattern of low reported cases from calendar weeks 5 to 11. From week 12 a number of hot spots emerged, notably in London, Birmingham, Cumbria and subsequently around Liverpool. The intensity of new cases seem to have started to decline from week 15; yet, it is important to note that week 16 display reported cases for only two days.</p>
</section><section id="time-series-plots" class="level4" data-number="10.5.1.2"><h4 data-number="10.5.1.2" class="anchored" data-anchor-id="time-series-plots">
<span class="header-section-number">10.5.1.2</span> Time-Series Plots</h4>
<p>Time-series plots can be used to capture a different dimension of the process in analysis. They can be used to better understand changes in an observation location, an aggregation of observations, or multiple locations simultaneously over time. We plot the cumulative number of COVID-19 cases per 100,000 people for UTLAs reporting over 310 cases. The plots identify the UTLAs in London, Newcastle and Sheffield reporting the largest numbers of COVID-19 cases. The plots also reveal that there has been a steady increase in the number of cases, with some differences. While cases have steadily increase in Brent and Southwark since mid March, the rise has been more sudden in Sunderland. The plots also reveal a possible case of misreporting in Sutton towards the end of the series.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">covid19_spt</span>,</span>
<span>            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">c_covid19_r</span>,</span>
<span>                          group <span class="op">=</span> <span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tsp</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://yutannihilation.github.io/gghighlight/reference/gghighlight.html">gghighlight</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">c_covid19_r</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">310</span>, use_direct_label <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span>, x<span class="op">=</span><span class="st">"Date"</span>, y<span class="op">=</span><span class="st">"Cumulative Cases per 100,000"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.subtitle<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span>, face<span class="op">=</span><span class="st">"plain"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">ctyu19nm</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section><section id="hovmöller-plots" class="level4" data-number="10.5.1.3"><h4 data-number="10.5.1.3" class="anchored" data-anchor-id="hovmöller-plots">
<span class="header-section-number">10.5.1.3</span> Hovmöller Plots</h4>
<p>An alternative visualisation is a Hovmöller plot - sometimes known as heatmap. It is a two-dimensional space-time representation in which space is collapsed onto one dimension against time. Hovmöller plots can easily be generated if the data are arranged on a space-time grid; however, this is rarely the case. Luckily we have <code>ggplot</code>! which can do magic rearranging the data as needed. Below we produce a Hovmöller plot for UTLAs with resident populations over 260,000. The plot makes clear that the critical period of COVID-19 spread has been during April despite the implementation of a series of social distancing measures by the government.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">covid19_spt</span>, <span class="va">Residents</span> <span class="op">&gt;</span> <span class="fl">260000</span><span class="op">)</span>, </span>
<span>           mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">date</span>, y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">ctyu19nm</span>, <span class="va">c_covid19_r</span><span class="op">)</span>, fill<span class="op">=</span> <span class="va">c_covid19_r</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"New Cases per 100,000"</span>, option <span class="op">=</span><span class="st">"plasma"</span>, begin <span class="op">=</span> <span class="fl">0</span>, end <span class="op">=</span> <span class="fl">1</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span>, x<span class="op">=</span><span class="st">"Date"</span>, y<span class="op">=</span><span class="st">"Upper Tier Authority Area"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span>, face<span class="op">=</span><span class="st">"plain"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">5</span>, <span class="st">"cm"</span><span class="op">)</span>, legend.key.height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section><section id="interactive-plots" class="level4" data-number="10.5.1.4"><h4 data-number="10.5.1.4" class="anchored" data-anchor-id="interactive-plots">
<span class="header-section-number">10.5.1.4</span> Interactive Plots</h4>
<p>Interactive visualisations comprise very effective ways to understand spatio-temporal data and they are now fairly accessible. Interactive visualisations allow for a more data-immersive experience, and enable exploration of the data without having to resort to scripting. Here is when the use of <code>tmap</code> shines as it does not only enables easily creating nice static maps but also interactive maps! Below an interactive map for a time snapshot of the data (i.e.&nbsp;<code>2020-04-14</code>) is produced, but with a bit of work layers can be added to display multiple temporal slices of the data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># map</span></span>
<span><span class="va">legend_title</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Cumulative Cases per 100,000 Population"</span><span class="op">)</span></span>
<span><span class="va">imap</span> <span class="op">=</span> <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">covid19_spt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ctyu19nm"</span>, <span class="st">"date"</span>, <span class="st">"c_covid19_r"</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="st">"2020-04-14"</span><span class="op">)</span>, labels <span class="op">=</span> <span class="st">"Area.name"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_fill</a></span><span class="op">(</span><span class="st">"c_covid19_r"</span>, title <span class="op">=</span> <span class="va">legend_title</span>, palette <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">magma</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span>, style <span class="op">=</span><span class="st">"cont"</span>, legend.is.portrait<span class="op">=</span><span class="cn">FALSE</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_polygons.html">tm_borders</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">#tm_text("ctyu19nm", size = .4) +</span></span>
<span>  <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html">tm_layout</a></span><span class="op">(</span>bg.color <span class="op">=</span> <span class="st">"white"</span>, <span class="co"># change background colour</span></span>
<span>            legend.outside <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># legend outside</span></span>
<span>            legend.title.size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>            legend.width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── tmap v3 code detected ───────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[v3-&gt;v4] `tm_fill()`: instead of `style = "cont"`, use fill.scale =
`tm_scale_continuous()`.
ℹ Migrate the argument(s) 'palette' (rename to 'values') to
  'tm_scale_continuous(&lt;HERE&gt;)'
[v3-&gt;v4] `tm_fill()`: use `fill_alpha` instead of `alpha`.
[v3-&gt;v4] `tm_fill()`: migrate the argument(s) related to the legend of the
visual variable `fill` namely 'title', 'legend.is.portrait' (rename to
'orientation') to 'fill.legend = tm_legend(&lt;HERE&gt;)'</code></pre>
</div>
</div>
<p>To view the map on your local machines, execute the code chunk below removing the <code>#</code> sign.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#tmap_mode("view")</span></span>
<span><span class="co">#imap</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Alternative data visualisation tools are animations, telliscope and shiny. Animations can be constructed by plotting spatial data frame-by-frame, and then stringing them together in sequence. A useful R packages <code>gganimate</code> and <code>tmap</code>! See <span class="citation" data-cites="lovelace2019">Lovelace, Nowosad, and Muenchow (<a href="references.html#ref-lovelace2019" role="doc-biblioref">2019</a>)</span>. Note that the creation of animations may require external dependencies; hence, they have been included here. Both <code>telliscope</code> and <code>shiny</code> are useful ways for visualising large spatio-temporal data sets in an interactive ways. Some effort is required to deploy these tools.</p>
</section></section><section id="exploratory-analysis" class="level3" data-number="10.5.2"><h3 data-number="10.5.2" class="anchored" data-anchor-id="exploratory-analysis">
<span class="header-section-number">10.5.2</span> Exploratory Analysis</h3>
<p>In addition to visualising data, we often want to obtain numerical summaries of the data. Again, innovative ways to reduce the inherent dimensionality of the data and examine dependence structures and potential relationships in time and space are needed. We consider visualisations of empirical spatial and temporal means, dependence structures and some basic time-series analysis.</p>
<section id="means" class="level4" data-number="10.5.2.1"><h4 data-number="10.5.2.1" class="anchored" data-anchor-id="means">
<span class="header-section-number">10.5.2.1</span> Means</h4>
<p><strong>Empirical Spatial Mean</strong></p>
<p>The empirical spatial mean for a data set can be obtained by averaging over time points for one location. In our case, we can compute the empirical spatial mean by averaging the daily rate of new COVID-19 cases for UTLAs between January 30th and April 21st. It reveals that Brent, Southwark and Sunderland report an average daily infection rate of over 5 new cases per 100,000 people, whereas Rutland and Isle of Wight display an average of less than 1.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># compute empirical spatial mean</span></span>
<span><span class="va">sp_av</span> <span class="op">&lt;-</span> <span class="va">covid19_spt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ctyu19nm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># group by spatial unit</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sp_mu_emp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">n_covid19_r</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot empirical spatial mean</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">sp_av</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">ctyu19nm</span>, <span class="va">sp_mu_emp</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">sp_mu_emp</span><span class="op">)</span> , fill <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span>, x<span class="op">=</span><span class="st">"Average New Cases per 100,000"</span>, y<span class="op">=</span><span class="st">"Upper Tier Authority Area"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span>, face<span class="op">=</span><span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p><strong>Empirical Temporal Mean</strong></p>
<p>The empirical temporal mean for a data set can be obtained by averaging across spatial locations for a time point. In our case, we can compute the empirical temporal mean by averaging the rate of new COVID-19 cases over UTLAs by day. The empirical temporal mean is plotted below revealing a peak of 8.32 number of new cases per 100,000 people the 7th of April, steadily decreasing to 0.35 for the last reporting observation in our data; that is, April 21st.</p>
<blockquote class="blockquote">
<p>Note the empirical temporal mean is smoothed via local polynomial regression fitting; hence below zero values are reported between February and March.</p>
</blockquote>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># compute temporal mean</span></span>
<span><span class="va">tm_av</span> <span class="op">&lt;-</span> <span class="va">covid19</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>tm_mu_emp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">n_covid19_r</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot temporal mean + trends for all spatial units</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">covid19</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span><span class="va">date</span>, y <span class="op">=</span> <span class="va">n_covid19_r</span>,</span>
<span>                          group <span class="op">=</span> <span class="va">Area.name</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"gray80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">tm_av</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span><span class="va">date</span>, y <span class="op">=</span> <span class="va">tm_mu_emp</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>              se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">" "</span><span class="op">)</span>, x<span class="op">=</span><span class="st">"Date"</span>, y<span class="op">=</span><span class="st">"Cumulative Cases per 100,000"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.subtitle<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">18</span>, face<span class="op">=</span><span class="st">"plain"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section><section id="dependence" class="level4" data-number="10.5.2.2"><h4 data-number="10.5.2.2" class="anchored" data-anchor-id="dependence">
<span class="header-section-number">10.5.2.2</span> Dependence</h4>
<p><strong>Spatial Dependence</strong></p>
<p>As we know spatial dependence refers to the spatial relationship of a variable’s values for a pairs of locations at a certain distance apart, so that are more similar (or less similar) than expected for randomly associated pairs of observations. Patterns of spatial dependence may change over time. In the case of a disease outbreak patterns of spatial dependence can change very quickly as new cases emerge and social distancing measures are implemented. <a href="06-spatial-econometrics.html" class="quarto-xref"><span>Chapter 6</span></a> illustrates how to measure spatial dependence in the context of spatial data.</p>
<blockquote class="blockquote">
<p>Challenge 1: Measure how spatial dependence change over time. Hint: compute the Moran’s I on the rate of new COVID-19 cases (i.e.&nbsp;<code>n_covid19_r</code> in the <code>covid19</code> data frame) at multiple time points.</p>
</blockquote>
<blockquote class="blockquote">
<p>Note: recall that the problem of ignoring the dependence in the errors when doing OLS regression is that the resulting standard errors and prediction standard errors are inappropriate. In the case of positive dependence, which is the most common case in spatio-temporal data (recall Tobler’s law), the standard errors and prediction standard errors are underestimated. This is if dependence is ignored, resulting in a false sense of how good the estimates and predictions really are.</p>
</blockquote>
<p><strong>Temporal Dependence</strong></p>
<p>As for spatial data, dependence can also exists in temporal data. Temporal dependence or temporal autocorrelation exists when a variable’s value at time <span class="math inline">\(t\)</span> is dependent on its value(s) at <span class="math inline">\(t-1\)</span>. More recent observations are often expected to have a greater influence on present observations. A key difference between temporal and spatial dependence is that temporal dependence is unidirectional (i.e.&nbsp;past observations can only affect present or future observations but not inversely), while spatial dependence is multidirectional (i.e.&nbsp;an observation in a spatial unit can influence and be influenced by observations in multiple spatial units).</p>
<p>Before measuring the temporal dependence is our time-series, a time-series object needs to be created with a time stamp and given cycle frequency. A cycle frequency refers to when a seasonal pattern is repeated. We consider a time series of the total number of new COVID-19 cases per 100,000 (i.e.&nbsp;we sum cases over UTLAs by day) and the frequency set to 7 to reflect weekly cycles. So we end up with a data frame of length 71.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create a time series object</span></span>
<span><span class="va">total_cnt</span> <span class="op">&lt;-</span> <span class="va">covid19</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>new_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_covid19_r</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">total_cases_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="va">total_cnt</span><span class="op">$</span><span class="va">new_cases</span>, </span>
<span>                     start <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     frequency <span class="op">=</span><span class="fl">7</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>There are various ways to test for temporal autocorrelation. An easy way is to compute the correlation coefficient between a time series measured at time <span class="math inline">\(t\)</span> and its lag measured at time <span class="math inline">\(t-1\)</span>. Below we measure the temporal autocorrelation in the rate of new COVID-19 cases per 100,000 people. A correlation of 0.97 is returned indicating high positive autocorrelation; that is, high (low) past numbers of new COVID-19 cases per 100,000 people tend to correlate with higher (lower) present numbers of new COVID-19 cases. The Durbin-Watson test is often used to test for autocorrelation in regression models.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># create lag term t-1</span></span>
<span><span class="va">lag_new_cases</span> <span class="op">&lt;-</span> <span class="va">total_cnt</span><span class="op">$</span><span class="va">new_cases</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">total_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">total_cnt</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">70</span>,<span class="op">]</span>, <span class="va">lag_new_cases</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">total_cnt</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>              new_cases lag_new_cases
new_cases      1.000000      0.974284
lag_new_cases  0.974284      1.000000</code></pre>
</div>
</div>
<p><strong>Time Series Components</strong></p>
<p>In addition to temporal autocorrelation, critical to the analysis of time-series are its constituent components. A time-series is generally defined by three key components:</p>
<ul>
<li><p>Trend: A trend exists when there is a long-term increase or decrease in the data.</p></li>
<li><p>Seasonal: A seasonal pattern exists when a time series is affected by seasonal factors and is of a fixed and known frequency. Seasonal cycles can occur at various time intervals such as the time of the day or the time of the year.</p></li>
<li><p>Cyclic (random): A cycle exists when the data exhibit rises and falls that are not of a fixed frequency.</p></li>
</ul>
<p>To understand and model a time series, these components need to be identified and appropriately incorporated into a regression model. We illustrate these components by decomposing our time series for total COVID-19 cases below. The top plot shows the observed data. Subsequent plots display the trend, seasonal and random components of the total number of COVID-19 cases on a weekly periodicity. They reveal a clear inverted U-shape trend and seasonal pattern. This idea that we can decompose data to extract information and understand temporal processes is key to understand the concept of basis functions to model spatio-temporal data, which will be introduced in the next section.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># decompose time series</span></span>
<span><span class="va">dec_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/decompose.html">decompose</a></span><span class="op">(</span><span class="va">total_cases_ts</span><span class="op">)</span></span>
<span><span class="co"># plot time series components</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">dec_ts</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For a good introduction to time-series analysis in R, refer to <span class="citation" data-cites="hyndman2018forecasting">Hyndman and Athanasopoulos (<a href="references.html#ref-hyndman2018forecasting" role="doc-biblioref">2018</a>)</span> and <a href="https://www.datacamp.com/courses/forecasting-using-r">DataCamp</a>.</p>
</section></section></section><section id="spatio-temporal-data-modelling" class="level2" data-number="10.6"><h2 data-number="10.6" class="anchored" data-anchor-id="spatio-temporal-data-modelling">
<span class="header-section-number">10.6</span> Spatio-Temporal Data Modelling</h2>
<p>Having some understanding of the spatio-temporal patterns of COVID-19 spread through data exploration, we are ready to start further examining structural relationships between the rate of new infections and local contextual factors via regression modelling across UTLAs. Specifically we consider the number of new cases per 100,000 people to capture the rate of new infections and only one contextual factor; that is, the share of population suffering from long-term sickness or disabled. We will consider some basic statistical models, of the form of linear regression and generalized linear models, to account for spatio-temporal dependencies in the data. Note that we do not consider more complex structures based on hierarchical models or spatio-temporal weighted regression models which would be the natural step moving forward.</p>
<p>As any modelling approach, spatio-temporal statistical modelling has three principal goals:</p>
<ol type="1">
<li><p>predicting values of a given outcome variable at some location in space within the time span of the observations and offering information about the uncertainty of those predictions;</p></li>
<li><p>performing statistical inference about the influence of predictors on an outcome variable in the presence of spatio-temporal dependence; and,</p></li>
<li><p>forecasting future values of an outcome variable at some location, offering information about the uncertainty of the forecast.</p></li>
</ol>
<section id="intuition" class="level3" data-number="10.6.1"><h3 data-number="10.6.1" class="anchored" data-anchor-id="intuition">
<span class="header-section-number">10.6.1</span> Intuition</h3>
<p>The key idea on what follows is to use a basic statistical regression model to understand the relationship between the share of new COVID-19 infections and the share of population suffering from long-term illness, accounting for spatio-temporal dependencies. We will consider what is known as a trend-surface regression model which assumes that spatio-temporal dependencies can be accounted for by “trend” components and incorporate as predictors in the model. Formally we consider the regression model below which seeks to account for spatial and temporal trends.</p>
<p><span class="math display">\[y(s_{i}, t_{j}) = \beta_{0} + \beta_{k}x(s_{i}, t_{j}) + e(s_{i}, t_{j})\]</span></p>
<p>where <span class="math inline">\(\beta_{0}\)</span> is the intercept and <span class="math inline">\(\beta_{k}\)</span> represents a set of regression coefficients associated with <span class="math inline">\(x(s_{i}, t_{j})\)</span>; the <span class="math inline">\(k\)</span> indicates the number of covariates at spatial location <span class="math inline">\(s_{i}\)</span> and time <span class="math inline">\(t_{j}\)</span>; <span class="math inline">\(e\)</span> represents the regression errors which are assumed to follow a normal distribution. The key difference to aproaches considered in previous chapters is the incorporation of space and time together. As we learnt from the previous section, this has implications are we now have two sources of dependence: spatial and temporal autocorrelation, as well as seasonal and trend components. This has implications for modelling as we now need to account for all of these components if we are to establish any relationship between <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>.</p>
<p>A key implication is how we consider the set of covariates represented by <span class="math inline">\(x\)</span>. Three key types can be identified:</p>
<ul>
<li><p>spatial-variant, temporal-invariant covariates: these are attributes which may vary across space but be temporally invariant, such as geographical distances;</p></li>
<li><p>spatial-invariant, temporal-variant covariates: these are attributes which do not vary across space but change over time; and,</p></li>
<li><p>spatial-variant, temporal-variant covariates: these are attributes which vary over both space and time;</p></li>
</ul>
<blockquote class="blockquote">
<p>Note that what is variant or invariant will depend on the spatial and temporal scale of the analysis.</p>
</blockquote>
<p>We can also consider spatio-temporal “basis functions”. Note that this is an important concept for the rest of the Chapter. What are basis functions then? If you think that spatio-temporal data represent a complex set of curves or surfaces in space, basis functions represent the components into which this set of curves can be decomposed. In this sense, basis functions operate in a similar fashion as the decomposition of time series considered above i.e.&nbsp;time series data can be decomposed into a trend, seasonal and random components and their sum can be used to represent the observed temporal trajectory. Basis functions offer an effective way to incorporate spatio-temporal dependencies. Thus, basis functions have the key goal of accounting for spatio-temporal dependencies as spatial weight matrices or temporal lags help accounting spatial autocorrelation in spatial models and temporal autocorrelation in time series analysis.</p>
<p>As standard regression coefficients, basis functions are related to <span class="math inline">\(y\)</span> via coefficients (or weights). The difference is that we typically assume that basis functions are known while coefficients are random. Examples of basis functions include polynomials, splines, wavelets, sines and cosines so various linear combinations that can be used to infer potential spatio-temporal dependencies in the data. This is similar to deep learning models in which cases you provide, for example, an image and the model provides a classification of pixels. But you normally do not know what the classification represents (hence they are known as black boxes!) so further analysis on the classification is needed to understand what the model has attempted to capture. Basically basis functions are smoother functions to represent the observed data, and their objective to capture the spatial and temporal variability in the data as well as their dependence.</p>
<p>For our application, we start by considering a basic OLS regression model with the following basis functions to account spatial-temporal structures:</p>
<ul>
<li>overall mean;</li>
<li>linear in lon-coordinate;</li>
<li>linear in lat-coordinate;</li>
<li>linear time daily trend;</li>
<li>additional spatio-temporal basis functions which are presented below; and,</li>
</ul>
<p>These basis functions are incorporated as independent variables in the regression model. Additionally, we also include the share of population suffering from long-term illness as we know it is highly correlated to the cumulative number of COVID-19 cases. The share of population suffering long-term illness is incorporated as a spatial-variant, temporal-invariant covariates given that rely in 2011 census data.</p>
</section><section id="fitting-spatio-temporal-models" class="level3" data-number="10.6.2"><h3 data-number="10.6.2" class="anchored" data-anchor-id="fitting-spatio-temporal-models">
<span class="header-section-number">10.6.2</span> Fitting Spatio-Temporal Models</h3>
<p>As indicated at the start of this Chapter, we use the FRK framework developed by <span class="citation" data-cites="cressie2008fixed">Cressie and Johannesson (<a href="references.html#ref-cressie2008fixed" role="doc-biblioref">2008</a>)</span>. It provides a scalable, relies on the use a spatial random effects model (with which we have some familiarity) and can be easily implemented in R by the use of the <code>FRK</code> package <span class="citation" data-cites="zammit2017frk">(<a href="references.html#ref-zammit2017frk" role="doc-biblioref">Zammit-Mangion and Cressie 2017</a>)</span>. In this framework, a spatially correlated errors can be decomposed using a linear combination of spatial basis functions, effectively addressing issues of spatial-temporal dependence and nonstationarity. The specification of spatio-temporal basis functions is a key component of the model and they can be generated automatically or by the user via the <code>FRK</code> package. We will use the automatically generated functions. While as we will notice they are difficult to interpret, user generated functions require greater understanding of the spatio-temporal structure of COVID-19 which is beyond the scope of this Chapter.</p>
<p><strong>Prepare Data</strong></p>
<p>The first step to create a data frame with the variables that we will consider for the analysis. We first remove the geometries to convert <code>covid19_spt</code> from a simple feature object to a data frame and then compute the share of long-term illness population.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remove geometries</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">covid19_spt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co"># share of population in long-term illness </span></span>
<span><span class="va">covid19_spt</span> <span class="op">&lt;-</span> <span class="va">covid19_spt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span> lt_illness <span class="op">=</span> <span class="va">Longterm_sick_or_disabled</span> <span class="op">/</span> <span class="va">Residents</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Construct Basis Functions</strong></p>
<p>We now build the set of basis functions. The can be constructed by using the function <code>auto_basis</code> from the <code>FRK</code> package. The function takes as arguments: data, nres (which is the number of “resolutions” or aggregation to construct); and type of basis function to use. We consider a single resolution of the default Gaussian radial basis function.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># build basis functions</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://andrewzm.github.io/FRK/reference/auto_basis.html">auto_basis</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">covid19_spt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>,<span class="st">"lat"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                       <span class="fu"><a href="https://edzer.github.io/sp/reference/SpatialPoints.html">SpatialPoints</a></span><span class="op">(</span><span class="op">)</span>,           <span class="co"># To sp obj</span></span>
<span>                nres <span class="op">=</span> <span class="fl">1</span>,                         <span class="co"># One resolution</span></span>
<span>                type <span class="op">=</span> <span class="st">"Gaussian"</span><span class="op">)</span>                <span class="co"># Gaussian BFs</span></span>
<span><span class="co"># basis functions evaluated at data locations are then the covariates</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://andrewzm.github.io/FRK/reference/eval_basis.html">eval_basis</a></span><span class="op">(</span>basis <span class="op">=</span> <span class="va">G</span>,                       <span class="co"># basis functions</span></span>
<span>                s <span class="op">=</span> <span class="va">covid19_spt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>,<span class="st">"lat"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>            <span class="co"># conv. to matrix</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span>                                 <span class="co"># conv. to matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="co"># assign column names</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Add Basis Functions to Data Frame</strong></p>
<p>We then prepare a data frame for the regression model, adding the weights extracted from the basis functions. These weights enter as covariates in our model. Note that the resulting number of basis functions is nine. Explore by executing <code>colnames(S)</code>. Below we select only relevant variables for our model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># selecting variables</span></span>
<span><span class="va">reg_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">covid19_spt</span>, <span class="va">S</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ctyu19nm</span>, <span class="va">n_covid19_r</span>, <span class="va">long</span>, <span class="va">lat</span>, <span class="va">date</span>, <span class="va">lt_illness</span>, <span class="va">B1</span><span class="op">:</span><span class="va">B9</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Fit Linear Regression</strong></p>
<p>We now fit a linear model using <code>lm</code> including as covariates longitude, latitude, day, share of long-term ill population and the nine basis functions.</p>
<blockquote class="blockquote">
<p>Recall that latitude refers to north/south from the equator and longitude refers to west/east from Greenwich. Further up north means a higher latitude score. Further west means higher longitude score. Scores for Liverpool (53.4084° N, 2.9916° W) are thus higher than for London (51.5074° N, 0.1278° W). This will be helpful for interpretation.</p>
</blockquote>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">eq1</span> <span class="op">&lt;-</span> <span class="va">n_covid19_r</span> <span class="op">~</span> <span class="va">long</span> <span class="op">+</span> <span class="va">lat</span> <span class="op">+</span> <span class="va">date</span> <span class="op">+</span> <span class="va">lt_illness</span> <span class="op">+</span> <span class="va">.</span></span>
<span><span class="va">lm_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">eq1</span>, </span>
<span>           data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="op">-</span><span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lm_m</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = eq1, data = dplyr::select(reg_df, -ctyu19nm))

Residuals:
    Min      1Q  Median      3Q     Max 
-7.9726 -1.6679 -0.4867  1.1702 22.5346 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -2.082e+03  2.839e+01 -73.354  &lt; 2e-16 ***
long        -1.932e+00  3.620e-01  -5.336  9.7e-08 ***
lat          3.390e+00  3.266e-01  10.380  &lt; 2e-16 ***
date         1.033e-01  1.245e-03  82.958  &lt; 2e-16 ***
lt_illness   3.276e+01  3.541e+00   9.250  &lt; 2e-16 ***
B1           7.556e+00  3.157e+00   2.393   0.0167 *  
B2           1.898e+00  1.409e+00   1.347   0.1780    
B3           1.750e+01  1.978e+00   8.847  &lt; 2e-16 ***
B4          -2.022e+00  2.742e+00  -0.737   0.4609    
B5           2.207e+00  2.233e+00   0.989   0.3229    
B6          -9.814e-01  2.498e+00  -0.393   0.6945    
B7          -2.031e-01  3.687e+00  -0.055   0.9561    
B8          -2.234e+00  2.801e+00  -0.797   0.4252    
B9           1.877e+00  2.543e+00   0.738   0.4604    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.842 on 10636 degrees of freedom
Multiple R-squared:  0.4169,    Adjusted R-squared:  0.4162 
F-statistic:   585 on 13 and 10636 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Coefficients for explicitly specified spatial and temporal variables and the share of long-term ill population are all statistically significant. The interpretation of the regression coefficients is as usual; that is, one unit increase in a covariate relates to one unit increase in the dependent variable. For instance, the coefficient for long-term illness population indicates that UTLAs with a larger share of long-term ill population in one percentage point tend to have 328 more new COVID-19 cases per 100,000 people! on average. The coefficient for date reveals a strong positive temporal dependence with an average increase in the number of new cases per 100,000 people over time. The coefficient for latitude indicates as we move north the number of new COVID-19 cases per 100,000 people tends to be higher but lower if we move west.</p>
<p>While overall the model provides some understanding of the spatio-temporal structure of the spread of COVID-19, the overall fit of the model is relatively poor. The <span class="math inline">\(R^{2}\)</span> reveals that the model explains only 4.2% of the variability of the spread of COVID-19 cases, reflecting the complexity of modelling spatio-temporal processes. Also, except for two, the coefficients associated to the basis functions are statistically insignificant. A key issue that we have ignored so far is the fact that our dependent variable is a count and is highly skewed - refer back to Section [8.4 Exploratory Analysis].</p>
<blockquote class="blockquote">
<p>Challenge 2: Explore a model with only spatial components (i.e.&nbsp;<code>long</code> and <code>lat</code>) or only temporal components (<code>day</code>). What model returns the largest <span class="math inline">\(R^{2}\)</span>?</p>
</blockquote>
<p><strong>Poisson Regression</strong></p>
<p>A Poisson regression model provides a more appropriate framework to address these issues. We do this fitting a general linear model (or GLM) specifying the family function to be a Poisson.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># estimate a poisson model</span></span>
<span><span class="va">poisson_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">eq1</span>,</span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span><span class="st">"log"</span><span class="op">)</span>, <span class="co"># Poisson + log link</span></span>
<span>                data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="op">-</span><span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">poisson_m1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = eq1, family = poisson("log"), data = dplyr::select(reg_df, 
    -ctyu19nm))

Coefficients:
              Estimate Std. Error  z value Pr(&gt;|z|)    
(Intercept) -1.027e+03  8.168e+00 -125.699  &lt; 2e-16 ***
long        -8.534e-01  9.080e-02   -9.399  &lt; 2e-16 ***
lat          1.456e+00  7.617e-02   19.115  &lt; 2e-16 ***
date         5.153e-02  3.871e-04  133.121  &lt; 2e-16 ***
lt_illness   1.166e+01  7.701e-01   15.139  &lt; 2e-16 ***
B1           3.418e+00  8.005e-01    4.270 1.96e-05 ***
B2           4.414e-01  3.249e-01    1.359  0.17421    
B3           8.531e+00  5.480e-01   15.568  &lt; 2e-16 ***
B4          -7.129e-01  5.865e-01   -1.215  0.22418    
B5           1.639e+00  5.048e-01    3.246  0.00117 ** 
B6          -1.282e+00  5.618e-01   -2.283  0.02245 *  
B7          -3.572e-01  8.411e-01   -0.425  0.67102    
B8          -1.003e+00  6.262e-01   -1.602  0.10917    
B9           1.655e+00  6.268e-01    2.640  0.00829 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 51245  on 10649  degrees of freedom
Residual deviance: 24458  on 10636  degrees of freedom
AIC: 42364

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>The Poisson model seems to provide a more appropriate functional forms to identify the strength of the relationship between new COVID-19 cases and spatio-temporal dependencies as captured by a greater number (relative to the linear model) of basis functions coefficients becoming statistically significant. Yet, the Poisson model assumes that the mean and variance of the COVID-19 cases is the same. But, given the distribution of our dependent variable, its variance is likely to be greater than the mean. That means the data exhibit “overdispersion”. How do we know this? An estimate of the dispersion is given by the ratio of the deviance to the total degrees of freedom (the number of data points minus the number of covariates). In this case the dispersion estimate is:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poisson_m1</span><span class="op">$</span><span class="va">deviance</span> <span class="op">/</span> <span class="va">poisson_m1</span><span class="op">$</span><span class="va">df.residual</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.29953</code></pre>
</div>
</div>
<p>which is clearly greater than 1! i.e.&nbsp;the data are overdispersed.</p>
<p><strong>Quasipoisson Regression</strong></p>
<p>An approach to account for overdispersion is to use quasipoisson when calling <code>glm</code>. The quasi-Poisson model assumes that the variance is proportional to the mean, and that the constant of the proportionality is the over-dispersion parameter. This model corrects the standard error of the estimated coefficients. So only p-values and t values are affected. No changes are recorded in terms of residual deviance (24458) and median of deviance residuals (-0.6993), compared to the standard Poisson model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># estimate a quasipoisson model</span></span>
<span><span class="va">qpoisson_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">eq1</span>,</span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">quasipoisson</a></span><span class="op">(</span><span class="st">"log"</span><span class="op">)</span>, <span class="co"># QuasiPoisson + log link</span></span>
<span>                data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="op">-</span><span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">qpoisson_m1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = eq1, family = quasipoisson("log"), data = dplyr::select(reg_df, 
    -ctyu19nm))

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.027e+03  1.215e+01 -84.490  &lt; 2e-16 ***
long        -8.534e-01  1.351e-01  -6.318 2.76e-10 ***
lat          1.456e+00  1.133e-01  12.848  &lt; 2e-16 ***
date         5.153e-02  5.759e-04  89.478  &lt; 2e-16 ***
lt_illness   1.166e+01  1.146e+00  10.176  &lt; 2e-16 ***
B1           3.418e+00  1.191e+00   2.870  0.00411 ** 
B2           4.414e-01  4.833e-01   0.913  0.36109    
B3           8.531e+00  8.153e-01  10.464  &lt; 2e-16 ***
B4          -7.129e-01  8.726e-01  -0.817  0.41395    
B5           1.639e+00  7.510e-01   2.182  0.02915 *  
B6          -1.282e+00  8.358e-01  -1.534  0.12499    
B7          -3.572e-01  1.251e+00  -0.286  0.77526    
B8          -1.003e+00  9.316e-01  -1.077  0.28162    
B9           1.655e+00  9.325e-01   1.774  0.07603 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for quasipoisson family taken to be 2.213379)

    Null deviance: 51245  on 10649  degrees of freedom
Residual deviance: 24458  on 10636  degrees of freedom
AIC: NA

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p><strong>Negative Binomial Regression</strong></p>
<p>An alternative approach to deal with overdispersion is the Negative Binomial Model (NBM). This models relaxes the assumption of equality between the mean and variance. We estimate a NBM by using the function <code>glm.nb</code> from the <code>MASS</code> package.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># estimate a negative binomial model</span></span>
<span><span class="va">nb_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">eq1</span>, </span>
<span>       data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="op">-</span><span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nb_m1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = eq1, data = dplyr::select(reg_df, -ctyu19nm), 
    init.theta = 1.493089258, link = log)

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.540e+03  1.596e+01 -96.459  &lt; 2e-16 ***
long        -8.402e-01  1.650e-01  -5.090 3.57e-07 ***
lat          1.604e+00  1.456e-01  11.021  &lt; 2e-16 ***
date         7.901e-02  7.522e-04 105.030  &lt; 2e-16 ***
lt_illness   1.440e+01  1.534e+00   9.387  &lt; 2e-16 ***
B1           5.121e+00  1.460e+00   3.508 0.000452 ***
B2           1.622e-01  6.177e-01   0.263 0.792897    
B3           9.502e+00  9.469e-01  10.035  &lt; 2e-16 ***
B4          -2.054e+00  1.183e+00  -1.736 0.082590 .  
B5           2.461e+00  9.802e-01   2.510 0.012059 *  
B6          -1.095e+00  1.089e+00  -1.005 0.314895    
B7           6.486e-01  1.642e+00   0.395 0.692877    
B8          -1.143e+00  1.225e+00  -0.933 0.350789    
B9           1.068e+00  1.169e+00   0.914 0.360917    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.4931) family taken to be 1)

    Null deviance: 22092.1  on 10649  degrees of freedom
Residual deviance:  8374.3  on 10636  degrees of freedom
AIC: 34057

Number of Fisher Scoring iterations: 1

              Theta:  1.4931 
          Std. Err.:  0.0361 

 2 x log-likelihood:  -34027.2980 </code></pre>
</div>
</div>
<p>The NBM leads to a significant reduction in residual deviance from 24,458 returned by the Poisson model to only 8,374. It points to a major improvement in explaining the spatio-temporal variability in the spread of COVID-19</p>
<p><strong>Including Interactions</strong></p>
<p>Yet, we may further refine our model based on a different strategy. Let’s try running a NBM including interaction terms between spatial and temporal terms (i.e.&nbsp;longitude, latitude and date). We can do this by estimating the following model <code>c_covid19_r ~ (long + lat + date)^2 + lt_illness + .</code></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># new model specification</span></span>
<span><span class="va">eq2</span> <span class="op">&lt;-</span> <span class="va">n_covid19_r</span> <span class="op">~</span> <span class="op">(</span><span class="va">long</span> <span class="op">+</span> <span class="va">lat</span> <span class="op">+</span> <span class="va">date</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">lt_illness</span> <span class="op">+</span> <span class="va">.</span></span>
<span><span class="co"># estimate a negative binomial model</span></span>
<span><span class="va">nb_m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">glm.nb</a></span><span class="op">(</span><span class="va">eq2</span>, </span>
<span>       data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="op">-</span><span class="va">ctyu19nm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nb_m2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = eq2, data = dplyr::select(reg_df, -ctyu19nm), 
    init.theta = 1.56089592, link = log)

Coefficients:
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  4.797e+03  6.955e+02   6.897 5.32e-12 ***
long        -4.509e+01  1.559e+01  -2.892  0.00382 ** 
lat         -1.185e+02  1.342e+01  -8.827  &lt; 2e-16 ***
date        -2.754e-01  3.788e-02  -7.270 3.61e-13 ***
lt_illness   1.329e+01  1.522e+00   8.734  &lt; 2e-16 ***
B1           1.155e+01  1.571e+00   7.354 1.92e-13 ***
B2          -4.181e-01  6.212e-01  -0.673  0.50095    
B3           2.062e+01  1.408e+00  14.644  &lt; 2e-16 ***
B4          -6.669e+00  1.256e+00  -5.311 1.09e-07 ***
B5           9.446e+00  1.170e+00   8.071 6.96e-16 ***
B6          -1.050e+01  1.398e+00  -7.509 5.96e-14 ***
B7           2.309e+01  2.626e+00   8.793  &lt; 2e-16 ***
B8          -5.111e+00  1.279e+00  -3.995 6.48e-05 ***
B9           1.139e+00  1.159e+00   0.983  0.32575    
long:lat     1.574e+00  1.462e-01  10.763  &lt; 2e-16 ***
long:date   -1.937e-03  7.525e-04  -2.574  0.01005 *  
lat:date     6.713e-03  7.309e-04   9.185  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(1.5609) family taken to be 1)

    Null deviance: 22557.0  on 10649  degrees of freedom
Residual deviance:  8352.3  on 10633  degrees of freedom
AIC: 33849

Number of Fisher Scoring iterations: 1

              Theta:  1.5609 
          Std. Err.:  0.0383 

 2 x log-likelihood:  -33813.3960 </code></pre>
</div>
</div>
<p>This model leads to a slightly better model by returning a small reduction in the residual deviance and AIC score. Interestingly it also returns highly statistically significant coefficients for all three interaction terms between longitude and latitude (<code>long:lat</code>), longitude and date (<code>long:date</code>), and latitude and date (<code>lat:date</code>). The first indicates that as we move one degree north and west, the number of new cases tend to increase in 2 cases. The second indicates that UTLAs located further north of England tend to record a smaller number of cases over time. The third indicates that UTLAs on the west of England tend to report a much higher number of cases as time passes.</p>
<p>You can report the output for all models estimated above by executing (after removing <code>#</code>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># export_summs(lm_m, poisson_m, qpoisson_m1, nb_m1, nb_m2)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note that you may need to install the <code>huxtable</code> package.</p>
<section id="model-comparision" class="level4" data-number="10.6.2.1"><h4 data-number="10.6.2.1" class="anchored" data-anchor-id="model-comparision">
<span class="header-section-number">10.6.2.1</span> Model Comparision</h4>
<p>To compare regression models based on different specifications and assumptions, like those reported above, you may want to consider the cross-validation approach used in <a href="05-flows.html" class="quarto-xref"><span>Chapter 5</span></a>. An alternative approach if you would like to get a quick sense of model fit is to explore the correlation between observed and predicted values of the dependent variable. For our models, we can achieve this by executing:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># computing predictions for all models</span></span>
<span><span class="va">lm_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_m</span><span class="op">)</span></span>
<span><span class="va">poisson_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">poisson_m1</span><span class="op">)</span></span>
<span><span class="va">nb1_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">nb_m1</span><span class="op">)</span></span>
<span><span class="va">nb2_cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">nb_m2</span><span class="op">)</span></span>
<span><span class="va">reg_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">reg_df</span>, <span class="va">lm_cnt</span>, <span class="va">poisson_cnt</span>, <span class="va">nb1_cnt</span>, <span class="va">nb2_cnt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># computing correlation coefficients</span></span>
<span><span class="va">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">reg_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n_covid19_r"</span>, <span class="st">"lm_cnt"</span>, <span class="st">"poisson_cnt"</span>, <span class="st">"nb1_cnt"</span>, <span class="st">"nb2_cnt"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>              use<span class="op">=</span><span class="st">"complete.obs"</span>, </span>
<span>              method<span class="op">=</span><span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># significance test</span></span>
<span><span class="va">sig1</span> <span class="op">&lt;-</span> <span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/cor.mtest.html">cor.mtest</a></span><span class="op">(</span><span class="va">reg_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"n_covid19_r"</span>, <span class="st">"lm_cnt"</span>, <span class="st">"poisson_cnt"</span>, <span class="st">"nb1_cnt"</span>, <span class="st">"nb2_cnt"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                            conf.level <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a correlogram</span></span>
<span><span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.mixed.html">corrplot.mixed</a></span><span class="op">(</span><span class="va">cormat</span>,</span>
<span>                         number.cex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                         tl.pos <span class="op">=</span> <span class="st">"d"</span>,</span>
<span>                         tl.cex <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="10-st_analysis_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>All the models do a relatively job at predicting the observed count of new COVID-19 cases. They display correlation coefficients of 0.64/5 and high degree of correlation between them. These models will provide a good starting point for the assignment. There are a potentially few easy ways to make some considerable improvement.</p>
<ul>
<li>
<em>Option 1</em> Remove all zeros from the dependent variable <code>n_covid19_r</code>. They are likely to be affecting the ability of the model to predict positive values which are of main interest if we want to understand the spatio-temporal patterns of the outbreak.</li>
<li>
<em>Option 2</em> Remove all zeros from the dependent variable and additionally use its log for the regression model.</li>
<li>
<em>Option 3</em> Include more explanatory variables. Look for factors which can explain the spatial-temporal variability of the current COVID-19 outbreak. Look for hypotheses / anecdotal evidence from the newspapers and social media.</li>
<li>
<em>Option 4</em> Check for collinearity. Collinearity is likely to be an issue given the way basis functions are created. Checking for collinearity of course will not improve the fit of the existing model but it is important to remove collinear terms if statistical inference is a key goal - which in this case is. Over to you now!</li>
</ul></section></section></section><section id="questions" class="level2" data-number="10.7"><h2 data-number="10.7" class="anchored" data-anchor-id="questions">
<span class="header-section-number">10.7</span> Questions</h2>
<p>We will continue to use the COVID-19 dataset. Please see <a href="11-datasets.html" class="quarto-xref"><span>Chapter 11</span></a> for details on the data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `covid19_eng' from data source 
  `/Users/franciscorowe/Library/CloudStorage/Dropbox/Francisco/uol/teaching/envs453/202526/san/data/assignment_2_covid/covid19_eng.gpkg' 
  using driver `GPKG'
Simple feature collection with 149 features and 507 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 134112.4 ymin: 11429.67 xmax: 655653.8 ymax: 657536
Projected CRS: OSGB36 / British National Grid</code></pre>
</div>
</div>
<p>Using these data, you are required to address the following challenges:</p>
<ul>
<li><p>Create a spatio-temporal visualisation.</p></li>
<li><p>Fit a ST model to assess changes over space and time.</p></li>
</ul>
<p>Analyse and discuss:</p>
<ol type="1">
<li>Do the results for your GWR and ST results differ: How do regression coefficients vary across space? Is this variation statistically significant?</li>
<li>Does the ST model indicate significant variations over time? How?</li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-cressie2008fixed" class="csl-entry" role="listitem">
Cressie, Noel, and Gardar Johannesson. 2008. <span>“Fixed Rank Kriging for Very Large Spatial Data Sets.”</span> <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 70 (1): 209–26.
</div>
<div id="ref-gabadinho2009mining" class="csl-entry" role="listitem">
Gabadinho, Alexis, Gilbert Ritschard, Matthias Studer, and Nicolas S Müller. 2009. <span>“Mining Sequence Data in r with the TraMineR Package: A User’s Guide.”</span> <em>Geneva: Department of Econometrics and Laboratory of Demography, University of Geneva</em>.
</div>
<div id="ref-hyndman2018forecasting" class="csl-entry" role="listitem">
Hyndman, Rob J, and George Athanasopoulos. 2018. <em>Forecasting: Principles and Practice</em>. OTexts.
</div>
<div id="ref-lovelace2019" class="csl-entry" role="listitem">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with r</em>. Chapman; Hall/CRC. <a href="https://doi.org/10.1201/9780203730058">https://doi.org/10.1201/9780203730058</a>.
</div>
<div id="ref-pebesma2012spacetime" class="csl-entry" role="listitem">
Pebesma, Edzer et al. 2012. <span>“Spacetime: Spatio-Temporal Data in r.”</span> <em>Journal of Statistical Software</em> 51 (7): 1–30.
</div>
<div id="ref-wikle2019spatio" class="csl-entry" role="listitem">
Wikle, Christopher K, Andrew Zammit-Mangion, and Noel Cressie. 2019. <em>Spatio-Temporal Statistics with r</em>. CRC Press.
</div>
<div id="ref-zammit2017frk" class="csl-entry" role="listitem">
Zammit-Mangion, Andrew, and Noel Cressie. 2017. <span>“FRK: An r Package for Spatial and Spatio-Temporal Prediction with Large Datasets.”</span> <em>arXiv Preprint arXiv:1705.08105</em>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/gdsl-ul\.github\.io\/san\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./09-gwr.html" class="pagination-link" aria-label="Geographically Weighted Regression">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically Weighted Regression</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./11-datasets.html" class="pagination-link" aria-label="Data Sets">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Data Sets</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatio-Temporal Analysis {#sec-chp10}</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>This chapter provides an introduction to the complexities of spatio-temporal data and modelling. For modelling, we consider the Fixed Rank Kriging (FRK) framework developed by @cressie2008fixed. It enables constructing a spatial random effects model on a discretised spatial domain. Key advantages of this approach comprise the capacity to: (1) work with large data sets, (2) be scaled up; (3) generate predictions based on sparse linear algebraic techniques, and (4) produce fine-scale resolution uncertainty estimates.</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>The content of this chapter is based on:</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@wikle2019spatio, a recently published book which provides a good overview of existing statistical approaches to spatio-temporal modelling and R packages.</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@zammit2017frk, who introduce the statistical framework and R package for modelling spatio-temporal used in this Chapter.</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>This chapter uses the following libraries:</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message = FALSE, warning=FALSE}</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Data manipulation, transformation and visualisation</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Nice tables</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple features (a standardised way to encode vector data ie. points, lines, polygons)</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) </span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial objects conversion</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) </span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Thematic maps</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap) </span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Nice colour schemes</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain correlation coefficients</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight data on plots</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gghighlight)</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Analysing spatio-temporal data</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="co">#library(STRbook)</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spacetime)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Date parsing and manipulation</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Applied statistics</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical tests for linear regression models</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit spatial random effects models</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FRK)</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Exportable regression tables</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>For this chapter, we will use data on:</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>COVID-19 confirmed cases from 30th January, 2020 to 21st April, 2020 from Public Health England via the <span class="co">[</span><span class="ot">GOV.UK dashboard</span><span class="co">](https://coronavirus.data.gov.uk)</span>;</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>resident population characteristics from the 2011 census, available from the <span class="co">[</span><span class="ot">Office of National Statistics</span><span class="co">](https://www.nomisweb.co.uk/home/census2001.asp)</span>; and,</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>2019 Index of Multiple Deprivation (IMD) data from <span class="co">[</span><span class="ot">GOV.UK</span><span class="co">](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019)</span> and published by the Ministry of Housing, Communities &amp; Local Government. The data are at the ONS Upper Tier Local Authority (UTLA) level - also known as <span class="co">[</span><span class="ot">Counties and Unitary Authorities</span><span class="co">](https://geoportal.statistics.gov.uk)</span>.</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>For a full list of the variables included in the data sets used in this chapter, see the readme file in the sta data folder.<span class="ot">[^10-st_analysis-1]</span>. Before we get our hands on the data, there are some important concepts that need to be introduced. They provide a useful framework to understand the complex structure of spatio-temporal data. Let's start by first highlighling the importance of spatio-temporal analysis.</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a><span class="ot">[^10-st_analysis-1]: </span>Read the file in R by executing <span class="in">`read_tsv("data/sta/readme.txt")`</span>. Ensure the library readr is installed before running read_tsv.</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Spatio-Temporal Analysis?</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>Investigating the spatial patterns of human processes as we have done so far in this book only offers a partial incomplete representation of these processes. It does not allow understanding of the temporal evolution of these processes. Human processes evolve in space and time. Human mobility is a inherent geographical process which changes over the course of the day, with peaks at rush hours and high concentration towards employment, education and retail centres. Exposure to air pollution changes with local climatic conditions, and emission and concentration of atmospheric pollutants which fluctuate over time. The rate of disease spread varies over space and may significantly change over time as we have seen during the current outbreak, with flattened or rapid declining trends in Australia, New Zealand and South Korea but fast proliferation in the United Kingdom and the United States. Only by considering time and space together we can address how geographic entities change over time and why they change. A large part of how and why of such change occurs is due to interactions across space and time, and multiple processes. It is essential to understand the past to inform our understanding of the present and make predictions about the future.</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spatio-temporal Data Structures</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>A first key element is to understand the structure of spatio-temporal data. Spatio-temporal data incorporate two dimensions. At one end, we have the temporal dimension. In quantitative analysis, time-series data are used to capture geographical processes at regular or irregular intervals; that is, in a continuous (daily) or discrete (only when a event occurs) temporal scale. At another end, we have the spatial dimension. We often use spatial data as temporal aggregations or temporally frozen states (or 'snapshots') of a geographical process - this is what we have done so far. Recall that spatial data can be capture in different geographical units, such as areal or lattice, points, flows or trajectories - refer to the introductory lecture in Week 1. Relatively few ways exist to formally integrate temporal and spatial data in consistent analytical framework. Two notable exceptions in R are the packages <span class="in">`TraMiner`</span> <span class="co">[</span><span class="ot">@gabadinho2009mining</span><span class="co">]</span> and <span class="in">`spacetime`</span> <span class="co">[</span><span class="ot">@pebesma2012spacetime</span><span class="co">]</span>. We use the class definitions defined in the R package <span class="in">`spacetime`</span>. These classes extend those used for spatial data in <span class="in">`sp`</span> and time-series data in <span class="in">`xts`</span>. Next a brief introduction to concepts that facilitate thinking about spatio-temporal data structures.</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Type of Table</span></span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>Spatio-temporal data can be conceptualised as three main different types of tables:</span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>time-wide: a table in which columns correspond to different time points</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>space-wide: a table in which columns correspond to different spatial location</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>long formats: a table in which each row-column pair corresponds to a specific time and spatial location (or space coordinate)</span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note that data in long format are space inefficient because spatial coordinates and time attributes are required for each data point. Yet, data in this format are relatively easy to manipulate via packages such as </span><span class="in">`dplyr`</span><span class="at"> and </span><span class="in">`tidyr`</span><span class="at">, and visualise using </span><span class="in">`ggplot2`</span><span class="at">. These packages are designed to work with data in long format.</span></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Type of Spatio-Temporal Object</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>To integrate spatio-temporal data, spatio-temporal objects are needed. We consider four different spatio-temporal frames (STFs) or objects which can be defined via the package <span class="in">`spacetime`</span>:</span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Full grid (STF): an object containing data on all possible locations in all time points in a sequence of data;</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Sparse grid (STS): an object similar to STF but only containing non-missing space-time data combinations;</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Irregular (STI): an object with an irregular space-time data structure, where each point is allocated a spatial coordinate and a time stamp;</span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Simple Trajectories (STT): an object containig a sequence of space-time points that form trajectories.</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>More details on these spatio-temporal structures, construction and manipulation, see @pebesma2012spacetime. Enough theory, let's code!</span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Wrangling</span></span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a>This section illustrates the complexities of handling spatio-temporal data. It discusses good practices in data manipulation and construction of a Space Time Irregular Data Frame (STIDF) object. Three key requirements to define a STFDF object are:</span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Have a data frame in long format i.e. a location-time pair data frame</span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Define a time stamp</span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Construct the spatio-temporal object of class STIDF by indicating the spatial and temporal coordinates</span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>Let's now read all the required data. While we can have all data in a single data frame, you will find helpful to have separate data objects to identify:</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>spatial locations</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>temporal units</span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>data</span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a>These data objects correspond to <span class="in">`locs`</span>, <span class="in">`time`</span>, and <span class="in">`covid19`</span> and <span class="in">`censusimd`</span> below. Throughout the chapter you will notice that we switch between the various data frames when convinient, depending on the operation.</span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning = FALSE, message=FALSE}</span></span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a><span class="co"># clear workspace</span></span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a><span class="co"># read ONS UTLA shapefile</span></span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>utla_shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/sta/ons_utla.shp"</span>) </span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a><span class="co"># create table of locations</span></span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>locs <span class="ot">&lt;-</span> utla_shp <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(objct, cty19c, ctyu19nm, long, lat, st_rs) </span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a><span class="co"># read time data frame</span></span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sta/reporting_dates.csv"</span>)</span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a><span class="co"># read COVID-19 data in long format</span></span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a>covid19 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sta/covid19_cases.csv"</span>)</span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a><span class="co"># read census and IMD data</span></span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>censusimd <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sta/2011census_2019imd_utla.csv"</span>)</span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-136"><a href="#cb50-136" aria-hidden="true" tabindex="-1"></a>If we explore the structure of the data via <span class="in">`head`</span> and <span class="in">`str`</span>, we can see we have data on daily and cumulative new COVID-19 cases for 150 spatial units (i.e. UTLAs) over 71 time points from January 30th to April 21st. We also have census and IMD data for a range of attributes.</span>
<span id="cb50-137"><a href="#cb50-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(covid19, <span class="dv">3</span>)</span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a>Once we have understood the structure of the data, we first need to confirm if the <span class="in">`covid19`</span> data are in wide or long format. Luckily they are in long format; otherwise, we would have needed to transform the data from wide to long format. Useful functions to achieve this include <span class="in">`pivot_longer`</span> (<span class="in">`pivot_longer`</span>) which has superseded <span class="in">`gather`</span> (<span class="in">`spread`</span>) in the <span class="in">`tidyr`</span> package. Note that the <span class="in">`covid19`</span> data frame has 10,650 observations (i.e. rows); that is, 150 UTLAs <span class="sc">\*</span> 71 daily observations.</span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>We then define a regular time stamp for our temporal data. We use the <span class="in">`lubridate`</span> package to do this. A key advantage of <span class="in">`lubridate`</span> is that it automatically recognises the common separators used when recording dates ("-", "/", ".", and ""). As a result, you only need to focus on specifying the order of the date elements to determine the parsing function applied. Below we check the structure of our time data, define a time stamp and create separate variables for days, weeks, months and year.</span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-148"><a href="#cb50-148" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note that working with dates can be a complex task. A good discussion of these complexities is provided </span><span class="co">[</span><span class="ot">here</span><span class="co">](http://uc-r.github.io/dates/#convert_date)</span><span class="at">.</span></span>
<span id="cb50-149"><a href="#cb50-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-152"><a href="#cb50-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-153"><a href="#cb50-153" aria-hidden="true" tabindex="-1"></a><span class="co"># check the time structure used for reporting covid cases</span></span>
<span id="cb50-154"><a href="#cb50-154" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(covid19<span class="sc">$</span>date, <span class="dv">5</span>)</span>
<span id="cb50-155"><a href="#cb50-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-156"><a href="#cb50-156" aria-hidden="true" tabindex="-1"></a><span class="co"># parsing data into a time stamp</span></span>
<span id="cb50-157"><a href="#cb50-157" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">ymd</span>(covid19<span class="sc">$</span>date)</span>
<span id="cb50-158"><a href="#cb50-158" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(covid19<span class="sc">$</span>date)</span>
<span id="cb50-159"><a href="#cb50-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-160"><a href="#cb50-160" aria-hidden="true" tabindex="-1"></a><span class="co"># separate date variable into day,week, month and year variables</span></span>
<span id="cb50-161"><a href="#cb50-161" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>day <span class="ot">&lt;-</span> <span class="fu">day</span>(covid19<span class="sc">$</span>date)</span>
<span id="cb50-162"><a href="#cb50-162" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>week <span class="ot">&lt;-</span> <span class="fu">week</span>(covid19<span class="sc">$</span>date) <span class="co"># week of the year</span></span>
<span id="cb50-163"><a href="#cb50-163" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>month <span class="ot">&lt;-</span> <span class="fu">month</span>(covid19<span class="sc">$</span>date)</span>
<span id="cb50-164"><a href="#cb50-164" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="fu">year</span>(covid19<span class="sc">$</span>date)</span>
<span id="cb50-165"><a href="#cb50-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-166"><a href="#cb50-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-167"><a href="#cb50-167" aria-hidden="true" tabindex="-1"></a>Once defined the time stamp, we need to add the spatial information contained in our shapefile to create a spatio-temporal data frame.</span>
<span id="cb50-168"><a href="#cb50-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-169"><a href="#cb50-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb50-170"><a href="#cb50-170" aria-hidden="true" tabindex="-1"></a><span class="co"># join dfs</span></span>
<span id="cb50-171"><a href="#cb50-171" aria-hidden="true" tabindex="-1"></a>covid19_spt <span class="ot">&lt;-</span> <span class="fu">left_join</span>(utla_shp, covid19, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ctyu19nm"</span> <span class="ot">=</span> <span class="st">"Area.name"</span>))</span>
<span id="cb50-172"><a href="#cb50-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-173"><a href="#cb50-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-174"><a href="#cb50-174" aria-hidden="true" tabindex="-1"></a>We now have all the components to build a spatio-temporal object of class STIDF using <span class="in">`STIDF`</span> from the <span class="in">`spacetime`</span> package:</span>
<span id="cb50-175"><a href="#cb50-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-178"><a href="#cb50-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-179"><a href="#cb50-179" aria-hidden="true" tabindex="-1"></a><span class="co"># identifying spatial fields</span></span>
<span id="cb50-180"><a href="#cb50-180" aria-hidden="true" tabindex="-1"></a>spat_part <span class="ot">&lt;-</span> <span class="fu">as</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(covid19_spt, <span class="sc">-</span><span class="fu">c</span>(bng_e, bng_n, Area.code, Area.type, Daily.lab.confirmed.cases, Cumulative.lab.confirmed.cases, date, day, week, month, year)), <span class="at">Class =</span> <span class="st">"Spatial"</span>)</span>
<span id="cb50-181"><a href="#cb50-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-182"><a href="#cb50-182" aria-hidden="true" tabindex="-1"></a><span class="co"># identifying temporal fields</span></span>
<span id="cb50-183"><a href="#cb50-183" aria-hidden="true" tabindex="-1"></a>temp_part <span class="ot">&lt;-</span> covid19_spt<span class="sc">$</span>date</span>
<span id="cb50-184"><a href="#cb50-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-185"><a href="#cb50-185" aria-hidden="true" tabindex="-1"></a><span class="co"># identifying data</span></span>
<span id="cb50-186"><a href="#cb50-186" aria-hidden="true" tabindex="-1"></a>covid19_data <span class="ot">&lt;-</span> covid19_spt <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Area.code, Area.type, date, Daily.lab.confirmed.cases, Cumulative.lab.confirmed.cases, day, week, month, year)) <span class="sc">%&gt;%</span></span>
<span id="cb50-187"><a href="#cb50-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb50-188"><a href="#cb50-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-189"><a href="#cb50-189" aria-hidden="true" tabindex="-1"></a><span class="co"># construct STIDF object</span></span>
<span id="cb50-190"><a href="#cb50-190" aria-hidden="true" tabindex="-1"></a>covid19_stobj <span class="ot">&lt;-</span> <span class="fu">STIDF</span>(<span class="at">sp =</span> spat_part, <span class="co"># spatial fields</span></span>
<span id="cb50-191"><a href="#cb50-191" aria-hidden="true" tabindex="-1"></a>                <span class="at">time =</span> temp_part, <span class="co"># time fields</span></span>
<span id="cb50-192"><a href="#cb50-192" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> covid19_data) <span class="co"># data</span></span>
<span id="cb50-193"><a href="#cb50-193" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb50-194"><a href="#cb50-194" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(covid19_stobj)</span>
<span id="cb50-195"><a href="#cb50-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-196"><a href="#cb50-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-197"><a href="#cb50-197" aria-hidden="true" tabindex="-1"></a>We now add census and IMD variables. For the purposes of this Chapter, we only add total population and long-term sick or disabled population counts. You can add more variables by adding their names in the <span class="in">`select`</span> function.</span>
<span id="cb50-198"><a href="#cb50-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-199"><a href="#cb50-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb50-200"><a href="#cb50-200" aria-hidden="true" tabindex="-1"></a><span class="co"># select pop data</span></span>
<span id="cb50-201"><a href="#cb50-201" aria-hidden="true" tabindex="-1"></a>pop <span class="ot">&lt;-</span> censusimd <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">"UTLA19NM"</span>, <span class="st">"Residents"</span>, <span class="st">"Longterm_sick_or_disabled"</span>)</span>
<span id="cb50-202"><a href="#cb50-202" aria-hidden="true" tabindex="-1"></a><span class="co"># join dfs</span></span>
<span id="cb50-203"><a href="#cb50-203" aria-hidden="true" tabindex="-1"></a>covid19_spt <span class="ot">&lt;-</span> <span class="fu">left_join</span>(covid19_spt, pop,</span>
<span id="cb50-204"><a href="#cb50-204" aria-hidden="true" tabindex="-1"></a>                         <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ctyu19nm"</span> <span class="ot">=</span> <span class="st">"UTLA19NM"</span>))</span>
<span id="cb50-205"><a href="#cb50-205" aria-hidden="true" tabindex="-1"></a>covid19 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(covid19, pop, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Area.name"</span> <span class="ot">=</span> <span class="st">"UTLA19NM"</span>))</span>
<span id="cb50-206"><a href="#cb50-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-207"><a href="#cb50-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-208"><a href="#cb50-208" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploring Spatio-Temporal Data</span></span>
<span id="cb50-209"><a href="#cb50-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-210"><a href="#cb50-210" aria-hidden="true" tabindex="-1"></a>We now have all the required data in place. In this section various methods of data visualisation are illustrated before key dimensions of the data are explored. Both of these types of exploration can be challenging as one or more dimensions in space and one in time need to be interrogated.</span>
<span id="cb50-211"><a href="#cb50-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-212"><a href="#cb50-212" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualisation</span></span>
<span id="cb50-213"><a href="#cb50-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-214"><a href="#cb50-214" aria-hidden="true" tabindex="-1"></a>In the context spatio-temporal data, a first challenge is data visualization. Visualising more than two dimensions of spatio-temporal data, so it is helpful to slice or aggregate the data over a dimension, use color, or build animations through time. Before exploring the data, we need to define our key variable of interest; that is, the number of confirmed COVID-19 cases per 100,000 people. We also compute the cumulative number of confirmed COVID-19 cases per 100,000 people as it may be handy in some analyses.</span>
<span id="cb50-215"><a href="#cb50-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-216"><a href="#cb50-216" aria-hidden="true" tabindex="-1"></a>Fisrt create variable to be analysed:</span>
<span id="cb50-217"><a href="#cb50-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-220"><a href="#cb50-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-221"><a href="#cb50-221" aria-hidden="true" tabindex="-1"></a><span class="co"># rate of new covid-19 infection</span></span>
<span id="cb50-222"><a href="#cb50-222" aria-hidden="true" tabindex="-1"></a>covid19_spt<span class="sc">$</span>n_covid19_r <span class="ot">&lt;-</span> <span class="fu">round</span>( (covid19_spt<span class="sc">$</span>Daily.lab.confirmed.cases <span class="sc">/</span> covid19_spt<span class="sc">$</span>Residents) <span class="sc">*</span> <span class="dv">100000</span>)</span>
<span id="cb50-223"><a href="#cb50-223" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>n_covid19_r <span class="ot">&lt;-</span> <span class="fu">round</span>( (covid19<span class="sc">$</span>Daily.lab.confirmed.cases <span class="sc">/</span> covid19<span class="sc">$</span>Residents) <span class="sc">*</span> <span class="dv">100000</span> )</span>
<span id="cb50-224"><a href="#cb50-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-225"><a href="#cb50-225" aria-hidden="true" tabindex="-1"></a><span class="co"># risk of cumulative covid-19 infection</span></span>
<span id="cb50-226"><a href="#cb50-226" aria-hidden="true" tabindex="-1"></a>covid19_spt<span class="sc">$</span>c_covid19_r <span class="ot">&lt;-</span> <span class="fu">round</span>( (covid19_spt<span class="sc">$</span>Cumulative.lab.confirmed.cases <span class="sc">/</span> covid19_spt<span class="sc">$</span>Residents) <span class="sc">*</span> <span class="dv">100000</span>)</span>
<span id="cb50-227"><a href="#cb50-227" aria-hidden="true" tabindex="-1"></a>covid19<span class="sc">$</span>c_covid19_r <span class="ot">&lt;-</span> <span class="fu">round</span>( (covid19<span class="sc">$</span>Cumulative.lab.confirmed.cases <span class="sc">/</span> covid19<span class="sc">$</span>Residents) <span class="sc">*</span> <span class="dv">100000</span>)</span>
<span id="cb50-228"><a href="#cb50-228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-229"><a href="#cb50-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-230"><a href="#cb50-230" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Spatial Plots</span></span>
<span id="cb50-231"><a href="#cb50-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-232"><a href="#cb50-232" aria-hidden="true" tabindex="-1"></a>One way to visualise the data is using spatial plots; that is, snapshots of a geographic process for a given time period. Data can be mapped in different ways using clorepleth, countour or surface plots. The key aim of these maps is to understand how the overall extent of spatial variation and local patterns of spatial concentration change over time. Below we visualise the weekly number of confirmed COVID-19 cases per 100,000 people.</span>
<span id="cb50-233"><a href="#cb50-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-234"><a href="#cb50-234" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note that Weeks range from 5 to 16 as they refer to calendar weeks. Calendar week 5 is when the first COVID-19 case in England was reported.</span></span>
<span id="cb50-235"><a href="#cb50-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-236"><a href="#cb50-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 12, fig.height = 12}</span></span>
<span id="cb50-237"><a href="#cb50-237" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb50-238"><a href="#cb50-238" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame for new cases by week</span></span>
<span id="cb50-239"><a href="#cb50-239" aria-hidden="true" tabindex="-1"></a>daycases_week <span class="ot">&lt;-</span> covid19_spt <span class="sc">%&gt;%</span> </span>
<span id="cb50-240"><a href="#cb50-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week, ctyu19nm, </span>
<span id="cb50-241"><a href="#cb50-241" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.character</span>(cty19c), </span>
<span id="cb50-242"><a href="#cb50-242" aria-hidden="true" tabindex="-1"></a>           Residents) <span class="sc">%&gt;%</span></span>
<span id="cb50-243"><a href="#cb50-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_daycases =</span> <span class="fu">sum</span>(Daily.lab.confirmed.cases)) </span>
<span id="cb50-244"><a href="#cb50-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-245"><a href="#cb50-245" aria-hidden="true" tabindex="-1"></a><span class="co"># weekly rate of new covid-19 infection</span></span>
<span id="cb50-246"><a href="#cb50-246" aria-hidden="true" tabindex="-1"></a>daycases_week<span class="sc">$</span>wn_covid19_r <span class="ot">&lt;-</span> (daycases_week<span class="sc">$</span>n_daycases <span class="sc">/</span> daycases_week<span class="sc">$</span>Residents) <span class="sc">*</span> <span class="dv">100000</span></span>
<span id="cb50-247"><a href="#cb50-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-248"><a href="#cb50-248" aria-hidden="true" tabindex="-1"></a><span class="co"># map</span></span>
<span id="cb50-249"><a href="#cb50-249" aria-hidden="true" tabindex="-1"></a>legend_title <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"Cumulative Cases per 100,000 Population"</span>)</span>
<span id="cb50-250"><a href="#cb50-250" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(daycases_week) <span class="sc">+</span></span>
<span id="cb50-251"><a href="#cb50-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"wn_covid19_r"</span>, <span class="at">title =</span> legend_title, <span class="at">palette =</span> <span class="fu">magma</span>(<span class="dv">256</span>), <span class="at">style =</span><span class="st">"cont"</span>, <span class="at">legend.hist=</span><span class="cn">FALSE</span>, <span class="at">legend.is.portrait=</span><span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-252"><a href="#cb50-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_facets</span>(<span class="at">by =</span> <span class="st">"week"</span>, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb50-253"><a href="#cb50-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> .<span class="dv">1</span>)  <span class="sc">+</span> <span class="co"># add borders +</span></span>
<span id="cb50-254"><a href="#cb50-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">bg.color =</span> <span class="st">"white"</span>, <span class="co"># change background colour</span></span>
<span id="cb50-255"><a href="#cb50-255" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="co"># legend outside</span></span>
<span id="cb50-256"><a href="#cb50-256" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb50-257"><a href="#cb50-257" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.stack =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb50-258"><a href="#cb50-258" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.title.size =</span> <span class="dv">2</span>,</span>
<span id="cb50-259"><a href="#cb50-259" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.width =</span> <span class="dv">1</span>,</span>
<span id="cb50-260"><a href="#cb50-260" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.height =</span> <span class="dv">1</span>,</span>
<span id="cb50-261"><a href="#cb50-261" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.label.size =</span> <span class="dv">3</span>,</span>
<span id="cb50-262"><a href="#cb50-262" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title =</span> <span class="st">"New COVID-19 Cases by Calendar Week, UTLA, England"</span>) </span>
<span id="cb50-263"><a href="#cb50-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-264"><a href="#cb50-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-265"><a href="#cb50-265" aria-hidden="true" tabindex="-1"></a>The series of maps reveal a stable pattern of low reported cases from calendar weeks 5 to 11. From week 12 a number of hot spots emerged, notably in London, Birmingham, Cumbria and subsequently around Liverpool. The intensity of new cases seem to have started to decline from week 15; yet, it is important to note that week 16 display reported cases for only two days.</span>
<span id="cb50-266"><a href="#cb50-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-267"><a href="#cb50-267" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Time-Series Plots</span></span>
<span id="cb50-268"><a href="#cb50-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-269"><a href="#cb50-269" aria-hidden="true" tabindex="-1"></a>Time-series plots can be used to capture a different dimension of the process in analysis. They can be used to better understand changes in an observation location, an aggregation of observations, or multiple locations simultaneously over time. We plot the cumulative number of COVID-19 cases per 100,000 people for UTLAs reporting over 310 cases. The plots identify the UTLAs in London, Newcastle and Sheffield reporting the largest numbers of COVID-19 cases. The plots also reveal that there has been a steady increase in the number of cases, with some differences. While cases have steadily increase in Brent and Southwark since mid March, the rise has been more sudden in Sunderland. The plots also reveal a possible case of misreporting in Sutton towards the end of the series.</span>
<span id="cb50-270"><a href="#cb50-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-271"><a href="#cb50-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 12, fig.height = 12}</span></span>
<span id="cb50-272"><a href="#cb50-272" aria-hidden="true" tabindex="-1"></a>tsp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> covid19_spt,</span>
<span id="cb50-273"><a href="#cb50-273" aria-hidden="true" tabindex="-1"></a>            <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> c_covid19_r,</span>
<span id="cb50-274"><a href="#cb50-274" aria-hidden="true" tabindex="-1"></a>                          <span class="at">group =</span> ctyu19nm))</span>
<span id="cb50-275"><a href="#cb50-275" aria-hidden="true" tabindex="-1"></a>tsp <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span> </span>
<span id="cb50-276"><a href="#cb50-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gghighlight</span>(<span class="fu">max</span>(c_covid19_r) <span class="sc">&gt;</span> <span class="dv">310</span>, <span class="at">use_direct_label =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-277"><a href="#cb50-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title=</span> <span class="fu">paste</span>(<span class="st">" "</span>), <span class="at">x=</span><span class="st">"Date"</span>, <span class="at">y=</span><span class="st">"Cumulative Cases per 100,000"</span>) <span class="sc">+</span></span>
<span id="cb50-278"><a href="#cb50-278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb50-279"><a href="#cb50-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb50-280"><a href="#cb50-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb50-281"><a href="#cb50-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>)) <span class="sc">+</span></span>
<span id="cb50-282"><a href="#cb50-282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>)) <span class="sc">+</span></span>
<span id="cb50-283"><a href="#cb50-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb50-284"><a href="#cb50-284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">20</span>, <span class="at">face=</span><span class="st">"plain"</span>)) <span class="sc">+</span></span>
<span id="cb50-285"><a href="#cb50-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> ctyu19nm)</span>
<span id="cb50-286"><a href="#cb50-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-287"><a href="#cb50-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-288"><a href="#cb50-288" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Hovmöller Plots</span></span>
<span id="cb50-289"><a href="#cb50-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-290"><a href="#cb50-290" aria-hidden="true" tabindex="-1"></a>An alternative visualisation is a Hovmöller plot - sometimes known as heatmap. It is a two-dimensional space-time representation in which space is collapsed onto one dimension against time. Hovmöller plots can easily be generated if the data are arranged on a space-time grid; however, this is rarely the case. Luckily we have <span class="in">`ggplot`</span>! which can do magic rearranging the data as needed. Below we produce a Hovmöller plot for UTLAs with resident populations over 260,000. The plot makes clear that the critical period of COVID-19 spread has been during April despite the implementation of a series of social distancing measures by the government.</span>
<span id="cb50-291"><a href="#cb50-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-292"><a href="#cb50-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 12, fig.height = 12, warning=FALSE, message=FALSE}</span></span>
<span id="cb50-293"><a href="#cb50-293" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(covid19_spt, Residents <span class="sc">&gt;</span> <span class="dv">260000</span>), </span>
<span id="cb50-294"><a href="#cb50-294" aria-hidden="true" tabindex="-1"></a>           <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x=</span> date, <span class="at">y=</span> <span class="fu">reorder</span>(ctyu19nm, c_covid19_r), <span class="at">fill=</span> c_covid19_r)) <span class="sc">+</span></span>
<span id="cb50-295"><a href="#cb50-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb50-296"><a href="#cb50-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">name=</span><span class="st">"New Cases per 100,000"</span>, <span class="at">option =</span><span class="st">"plasma"</span>, <span class="at">begin =</span> <span class="dv">0</span>, <span class="at">end =</span> <span class="dv">1</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb50-297"><a href="#cb50-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb50-298"><a href="#cb50-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span> <span class="fu">paste</span>(<span class="st">" "</span>), <span class="at">x=</span><span class="st">"Date"</span>, <span class="at">y=</span><span class="st">"Upper Tier Authority Area"</span>) <span class="sc">+</span></span>
<span id="cb50-299"><a href="#cb50-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb50-300"><a href="#cb50-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb50-301"><a href="#cb50-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb50-302"><a href="#cb50-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>)) <span class="sc">+</span></span>
<span id="cb50-303"><a href="#cb50-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">20</span>, <span class="at">face=</span><span class="st">"plain"</span>)) <span class="sc">+</span></span>
<span id="cb50-304"><a href="#cb50-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">"cm"</span>), <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>))</span>
<span id="cb50-305"><a href="#cb50-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-306"><a href="#cb50-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-307"><a href="#cb50-307" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Interactive Plots</span></span>
<span id="cb50-308"><a href="#cb50-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-309"><a href="#cb50-309" aria-hidden="true" tabindex="-1"></a>Interactive visualisations comprise very effective ways to understand spatio-temporal data and they are now fairly accessible. Interactive visualisations allow for a more data-immersive experience, and enable exploration of the data without having to resort to scripting. Here is when the use of <span class="in">`tmap`</span> shines as it does not only enables easily creating nice static maps but also interactive maps! Below an interactive map for a time snapshot of the data (i.e. <span class="in">`2020-04-14`</span>) is produced, but with a bit of work layers can be added to display multiple temporal slices of the data.</span>
<span id="cb50-310"><a href="#cb50-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-313"><a href="#cb50-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-314"><a href="#cb50-314" aria-hidden="true" tabindex="-1"></a><span class="co"># map</span></span>
<span id="cb50-315"><a href="#cb50-315" aria-hidden="true" tabindex="-1"></a>legend_title <span class="ot">=</span> <span class="fu">expression</span>(<span class="st">"Cumulative Cases per 100,000 Population"</span>)</span>
<span id="cb50-316"><a href="#cb50-316" aria-hidden="true" tabindex="-1"></a>imap <span class="ot">=</span> <span class="fu">tm_shape</span>(dplyr<span class="sc">::</span><span class="fu">filter</span>(covid19_spt[,<span class="fu">c</span>(<span class="st">"ctyu19nm"</span>, <span class="st">"date"</span>, <span class="st">"c_covid19_r"</span>)], <span class="fu">as.character</span>(date) <span class="sc">==</span> <span class="st">"2020-04-14"</span>), <span class="at">labels =</span> <span class="st">"Area.name"</span>) <span class="sc">+</span></span>
<span id="cb50-317"><a href="#cb50-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="st">"c_covid19_r"</span>, <span class="at">title =</span> legend_title, <span class="at">palette =</span> <span class="fu">magma</span>(<span class="dv">256</span>), <span class="at">style =</span><span class="st">"cont"</span>, <span class="at">legend.is.portrait=</span><span class="cn">FALSE</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb50-318"><a href="#cb50-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_borders</span>(<span class="at">col =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb50-319"><a href="#cb50-319" aria-hidden="true" tabindex="-1"></a>  <span class="co">#tm_text("ctyu19nm", size = .4) +</span></span>
<span id="cb50-320"><a href="#cb50-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">bg.color =</span> <span class="st">"white"</span>, <span class="co"># change background colour</span></span>
<span id="cb50-321"><a href="#cb50-321" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.outside =</span> <span class="cn">TRUE</span>, <span class="co"># legend outside</span></span>
<span id="cb50-322"><a href="#cb50-322" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.title.size =</span> <span class="dv">1</span>,</span>
<span id="cb50-323"><a href="#cb50-323" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.width =</span> <span class="dv">1</span>) </span>
<span id="cb50-324"><a href="#cb50-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-325"><a href="#cb50-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-326"><a href="#cb50-326" aria-hidden="true" tabindex="-1"></a>To view the map on your local machines, execute the code chunk below removing the <span class="in">`#`</span> sign.</span>
<span id="cb50-327"><a href="#cb50-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-330"><a href="#cb50-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-331"><a href="#cb50-331" aria-hidden="true" tabindex="-1"></a><span class="co">#tmap_mode("view")</span></span>
<span id="cb50-332"><a href="#cb50-332" aria-hidden="true" tabindex="-1"></a><span class="co">#imap</span></span>
<span id="cb50-333"><a href="#cb50-333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-334"><a href="#cb50-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-335"><a href="#cb50-335" aria-hidden="true" tabindex="-1"></a>Alternative data visualisation tools are animations, telliscope and shiny. Animations can be constructed by plotting spatial data frame-by-frame, and then stringing them together in sequence. A useful R packages <span class="in">`gganimate`</span> and <span class="in">`tmap`</span>! See @lovelace2019. Note that the creation of animations may require external dependencies; hence, they have been included here. Both <span class="in">`telliscope`</span> and <span class="in">`shiny`</span> are useful ways for visualising large spatio-temporal data sets in an interactive ways. Some effort is required to deploy these tools.</span>
<span id="cb50-336"><a href="#cb50-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-337"><a href="#cb50-337" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exploratory Analysis</span></span>
<span id="cb50-338"><a href="#cb50-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-339"><a href="#cb50-339" aria-hidden="true" tabindex="-1"></a>In addition to visualising data, we often want to obtain numerical summaries of the data. Again, innovative ways to reduce the inherent dimensionality of the data and examine dependence structures and potential relationships in time and space are needed. We consider visualisations of empirical spatial and temporal means, dependence structures and some basic time-series analysis.</span>
<span id="cb50-340"><a href="#cb50-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-341"><a href="#cb50-341" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Means</span></span>
<span id="cb50-342"><a href="#cb50-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-343"><a href="#cb50-343" aria-hidden="true" tabindex="-1"></a>**Empirical Spatial Mean**</span>
<span id="cb50-344"><a href="#cb50-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-345"><a href="#cb50-345" aria-hidden="true" tabindex="-1"></a>The empirical spatial mean for a data set can be obtained by averaging over time points for one location. In our case, we can compute the empirical spatial mean by averaging the daily rate of new COVID-19 cases for UTLAs between January 30th and April 21st. It reveals that Brent, Southwark and Sunderland report an average daily infection rate of over 5 new cases per 100,000 people, whereas Rutland and Isle of Wight display an average of less than 1.</span>
<span id="cb50-346"><a href="#cb50-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-347"><a href="#cb50-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 12, fig.height = 12}</span></span>
<span id="cb50-348"><a href="#cb50-348" aria-hidden="true" tabindex="-1"></a><span class="co"># compute empirical spatial mean</span></span>
<span id="cb50-349"><a href="#cb50-349" aria-hidden="true" tabindex="-1"></a>sp_av <span class="ot">&lt;-</span> covid19_spt <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ctyu19nm) <span class="sc">%&gt;%</span> <span class="co"># group by spatial unit</span></span>
<span id="cb50-350"><a href="#cb50-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sp_mu_emp =</span> <span class="fu">mean</span>(n_covid19_r))</span>
<span id="cb50-351"><a href="#cb50-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-352"><a href="#cb50-352" aria-hidden="true" tabindex="-1"></a><span class="co"># plot empirical spatial mean</span></span>
<span id="cb50-353"><a href="#cb50-353" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>sp_av) <span class="sc">+</span></span>
<span id="cb50-354"><a href="#cb50-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>( <span class="fu">aes</span>( <span class="at">y =</span> <span class="fu">reorder</span>(ctyu19nm, sp_mu_emp), <span class="at">x =</span> sp_mu_emp) , <span class="at">fill =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb50-355"><a href="#cb50-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb50-356"><a href="#cb50-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span> <span class="fu">paste</span>(<span class="st">" "</span>), <span class="at">x=</span><span class="st">"Average New Cases per 100,000"</span>, <span class="at">y=</span><span class="st">"Upper Tier Authority Area"</span>) <span class="sc">+</span></span>
<span id="cb50-357"><a href="#cb50-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb50-358"><a href="#cb50-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">7</span>)) <span class="sc">+</span></span>
<span id="cb50-359"><a href="#cb50-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb50-360"><a href="#cb50-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">20</span>, <span class="at">face=</span><span class="st">"plain"</span>))</span>
<span id="cb50-361"><a href="#cb50-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-362"><a href="#cb50-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-363"><a href="#cb50-363" aria-hidden="true" tabindex="-1"></a>**Empirical Temporal Mean**</span>
<span id="cb50-364"><a href="#cb50-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-365"><a href="#cb50-365" aria-hidden="true" tabindex="-1"></a>The empirical temporal mean for a data set can be obtained by averaging across spatial locations for a time point. In our case, we can compute the empirical temporal mean by averaging the rate of new COVID-19 cases over UTLAs by day. The empirical temporal mean is plotted below revealing a peak of 8.32 number of new cases per 100,000 people the 7th of April, steadily decreasing to 0.35 for the last reporting observation in our data; that is, April 21st.</span>
<span id="cb50-366"><a href="#cb50-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-367"><a href="#cb50-367" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note the empirical temporal mean is smoothed via local polynomial regression fitting; hence below zero values are reported between February and March.</span></span>
<span id="cb50-368"><a href="#cb50-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-369"><a href="#cb50-369" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.width = 12, fig.height = 12, message=FALSE, warning=FALSE}</span></span>
<span id="cb50-370"><a href="#cb50-370" aria-hidden="true" tabindex="-1"></a><span class="co"># compute temporal mean</span></span>
<span id="cb50-371"><a href="#cb50-371" aria-hidden="true" tabindex="-1"></a>tm_av <span class="ot">&lt;-</span> covid19 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb50-372"><a href="#cb50-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">tm_mu_emp =</span> <span class="fu">mean</span>(n_covid19_r))</span>
<span id="cb50-373"><a href="#cb50-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-374"><a href="#cb50-374" aria-hidden="true" tabindex="-1"></a><span class="co"># plot temporal mean + trends for all spatial units</span></span>
<span id="cb50-375"><a href="#cb50-375" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb50-376"><a href="#cb50-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> covid19, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>date, <span class="at">y =</span> n_covid19_r,</span>
<span id="cb50-377"><a href="#cb50-377" aria-hidden="true" tabindex="-1"></a>                          <span class="at">group =</span> Area.name), <span class="at">color =</span> <span class="st">"gray80"</span>) <span class="sc">+</span></span>
<span id="cb50-378"><a href="#cb50-378" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb50-379"><a href="#cb50-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> tm_av, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span>date, <span class="at">y =</span> tm_mu_emp), </span>
<span id="cb50-380"><a href="#cb50-380" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb50-381"><a href="#cb50-381" aria-hidden="true" tabindex="-1"></a>              <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb50-382"><a href="#cb50-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title=</span> <span class="fu">paste</span>(<span class="st">" "</span>), <span class="at">x=</span><span class="st">"Date"</span>, <span class="at">y=</span><span class="st">"Cumulative Cases per 100,000"</span>) <span class="sc">+</span></span>
<span id="cb50-383"><a href="#cb50-383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb50-384"><a href="#cb50-384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>)) <span class="sc">+</span></span>
<span id="cb50-385"><a href="#cb50-385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb50-386"><a href="#cb50-386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb50-387"><a href="#cb50-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb50-388"><a href="#cb50-388" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb50-389"><a href="#cb50-389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">18</span>, <span class="at">face=</span><span class="st">"plain"</span>))</span>
<span id="cb50-390"><a href="#cb50-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-391"><a href="#cb50-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-392"><a href="#cb50-392" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Dependence</span></span>
<span id="cb50-393"><a href="#cb50-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-394"><a href="#cb50-394" aria-hidden="true" tabindex="-1"></a>**Spatial Dependence**</span>
<span id="cb50-395"><a href="#cb50-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-396"><a href="#cb50-396" aria-hidden="true" tabindex="-1"></a>As we know spatial dependence refers to the spatial relationship of a variable's values for a pairs of locations at a certain distance apart, so that are more similar (or less similar) than expected for randomly associated pairs of observations. Patterns of spatial dependence may change over time. In the case of a disease outbreak patterns of spatial dependence can change very quickly as new cases emerge and social distancing measures are implemented. @sec-chp6 illustrates how to measure spatial dependence in the context of spatial data.</span>
<span id="cb50-397"><a href="#cb50-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-398"><a href="#cb50-398" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Challenge 1: Measure how spatial dependence change over time. Hint: compute the Moran's I on the rate of new COVID-19 cases (i.e. </span><span class="in">`n_covid19_r`</span><span class="at"> in the </span><span class="in">`covid19`</span><span class="at"> data frame) at multiple time points.</span></span>
<span id="cb50-399"><a href="#cb50-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-400"><a href="#cb50-400" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note: recall that the problem of ignoring the dependence in the errors when doing OLS regression is that the resulting standard errors and prediction standard errors are inappropriate. In the case of positive dependence, which is the most common case in spatio-temporal data (recall Tobler's law), the standard errors and prediction standard errors are underestimated. This is if dependence is ignored, resulting in a false sense of how good the estimates and predictions really are.</span></span>
<span id="cb50-401"><a href="#cb50-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-402"><a href="#cb50-402" aria-hidden="true" tabindex="-1"></a>**Temporal Dependence**</span>
<span id="cb50-403"><a href="#cb50-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-404"><a href="#cb50-404" aria-hidden="true" tabindex="-1"></a>As for spatial data, dependence can also exists in temporal data. Temporal dependence or temporal autocorrelation exists when a variable's value at time $t$ is dependent on its value(s) at $t-1$. More recent observations are often expected to have a greater influence on present observations. A key difference between temporal and spatial dependence is that temporal dependence is unidirectional (i.e. past observations can only affect present or future observations but not inversely), while spatial dependence is multidirectional (i.e. an observation in a spatial unit can influence and be influenced by observations in multiple spatial units).</span>
<span id="cb50-405"><a href="#cb50-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-406"><a href="#cb50-406" aria-hidden="true" tabindex="-1"></a>Before measuring the temporal dependence is our time-series, a time-series object needs to be created with a time stamp and given cycle frequency. A cycle frequency refers to when a seasonal pattern is repeated. We consider a time series of the total number of new COVID-19 cases per 100,000 (i.e. we sum cases over UTLAs by day) and the frequency set to 7 to reflect weekly cycles. So we end up with a data frame of length 71.</span>
<span id="cb50-407"><a href="#cb50-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-410"><a href="#cb50-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-411"><a href="#cb50-411" aria-hidden="true" tabindex="-1"></a><span class="co"># create a time series object</span></span>
<span id="cb50-412"><a href="#cb50-412" aria-hidden="true" tabindex="-1"></a>total_cnt <span class="ot">&lt;-</span> covid19 <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb50-413"><a href="#cb50-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">new_cases =</span> <span class="fu">sum</span>(n_covid19_r)) </span>
<span id="cb50-414"><a href="#cb50-414" aria-hidden="true" tabindex="-1"></a>total_cases_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(total_cnt<span class="sc">$</span>new_cases, </span>
<span id="cb50-415"><a href="#cb50-415" aria-hidden="true" tabindex="-1"></a>                     <span class="at">start =</span> <span class="dv">1</span>,</span>
<span id="cb50-416"><a href="#cb50-416" aria-hidden="true" tabindex="-1"></a>                     <span class="at">frequency =</span><span class="dv">7</span>)</span>
<span id="cb50-417"><a href="#cb50-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-418"><a href="#cb50-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-419"><a href="#cb50-419" aria-hidden="true" tabindex="-1"></a>There are various ways to test for temporal autocorrelation. An easy way is to compute the correlation coefficient between a time series measured at time $t$ and its lag measured at time $t-1$. Below we measure the temporal autocorrelation in the rate of new COVID-19 cases per 100,000 people. A correlation of 0.97 is returned indicating high positive autocorrelation; that is, high (low) past numbers of new COVID-19 cases per 100,000 people tend to correlate with higher (lower) present numbers of new COVID-19 cases. The Durbin-Watson test is often used to test for autocorrelation in regression models.</span>
<span id="cb50-420"><a href="#cb50-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-423"><a href="#cb50-423" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-424"><a href="#cb50-424" aria-hidden="true" tabindex="-1"></a><span class="co"># create lag term t-1</span></span>
<span id="cb50-425"><a href="#cb50-425" aria-hidden="true" tabindex="-1"></a>lag_new_cases <span class="ot">&lt;-</span> total_cnt<span class="sc">$</span>new_cases[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb50-426"><a href="#cb50-426" aria-hidden="true" tabindex="-1"></a>total_cnt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(total_cnt[<span class="dv">1</span><span class="sc">:</span><span class="dv">70</span>,], lag_new_cases)</span>
<span id="cb50-427"><a href="#cb50-427" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(total_cnt[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb50-428"><a href="#cb50-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-429"><a href="#cb50-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-430"><a href="#cb50-430" aria-hidden="true" tabindex="-1"></a>**Time Series Components**</span>
<span id="cb50-431"><a href="#cb50-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-432"><a href="#cb50-432" aria-hidden="true" tabindex="-1"></a>In addition to temporal autocorrelation, critical to the analysis of time-series are its constituent components. A time-series is generally defined by three key components:</span>
<span id="cb50-433"><a href="#cb50-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-434"><a href="#cb50-434" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Trend: A trend exists when there is a long-term increase or decrease in the data.</span>
<span id="cb50-435"><a href="#cb50-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-436"><a href="#cb50-436" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Seasonal: A seasonal pattern exists when a time series is affected by seasonal factors and is of a fixed and known frequency. Seasonal cycles can occur at various time intervals such as the time of the day or the time of the year.</span>
<span id="cb50-437"><a href="#cb50-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-438"><a href="#cb50-438" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Cyclic (random): A cycle exists when the data exhibit rises and falls that are not of a fixed frequency.</span>
<span id="cb50-439"><a href="#cb50-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-440"><a href="#cb50-440" aria-hidden="true" tabindex="-1"></a>To understand and model a time series, these components need to be identified and appropriately incorporated into a regression model. We illustrate these components by decomposing our time series for total COVID-19 cases below. The top plot shows the observed data. Subsequent plots display the trend, seasonal and random components of the total number of COVID-19 cases on a weekly periodicity. They reveal a clear inverted U-shape trend and seasonal pattern. This idea that we can decompose data to extract information and understand temporal processes is key to understand the concept of basis functions to model spatio-temporal data, which will be introduced in the next section.</span>
<span id="cb50-441"><a href="#cb50-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-444"><a href="#cb50-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-445"><a href="#cb50-445" aria-hidden="true" tabindex="-1"></a><span class="co"># decompose time series</span></span>
<span id="cb50-446"><a href="#cb50-446" aria-hidden="true" tabindex="-1"></a>dec_ts <span class="ot">&lt;-</span> <span class="fu">decompose</span>(total_cases_ts)</span>
<span id="cb50-447"><a href="#cb50-447" aria-hidden="true" tabindex="-1"></a><span class="co"># plot time series components</span></span>
<span id="cb50-448"><a href="#cb50-448" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dec_ts)</span>
<span id="cb50-449"><a href="#cb50-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-450"><a href="#cb50-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-451"><a href="#cb50-451" aria-hidden="true" tabindex="-1"></a>For a good introduction to time-series analysis in R, refer to @hyndman2018forecasting and <span class="co">[</span><span class="ot">DataCamp</span><span class="co">](https://www.datacamp.com/courses/forecasting-using-r)</span>.</span>
<span id="cb50-452"><a href="#cb50-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-453"><a href="#cb50-453" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatio-Temporal Data Modelling</span></span>
<span id="cb50-454"><a href="#cb50-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-455"><a href="#cb50-455" aria-hidden="true" tabindex="-1"></a>Having some understanding of the spatio-temporal patterns of COVID-19 spread through data exploration, we are ready to start further examining structural relationships between the rate of new infections and local contextual factors via regression modelling across UTLAs. Specifically we consider the number of new cases per 100,000 people to capture the rate of new infections and only one contextual factor; that is, the share of population suffering from long-term sickness or disabled. We will consider some basic statistical models, of the form of linear regression and generalized linear models, to account for spatio-temporal dependencies in the data. Note that we do not consider more complex structures based on hierarchical models or spatio-temporal weighted regression models which would be the natural step moving forward.</span>
<span id="cb50-456"><a href="#cb50-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-457"><a href="#cb50-457" aria-hidden="true" tabindex="-1"></a>As any modelling approach, spatio-temporal statistical modelling has three principal goals:</span>
<span id="cb50-458"><a href="#cb50-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-459"><a href="#cb50-459" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>predicting values of a given outcome variable at some location in space within the time span of the observations and offering information about the uncertainty of those predictions;</span>
<span id="cb50-460"><a href="#cb50-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-461"><a href="#cb50-461" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>performing statistical inference about the influence of predictors on an outcome variable in the presence of spatio-temporal dependence; and,</span>
<span id="cb50-462"><a href="#cb50-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-463"><a href="#cb50-463" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>forecasting future values of an outcome variable at some location, offering information about the uncertainty of the forecast.</span>
<span id="cb50-464"><a href="#cb50-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-465"><a href="#cb50-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Intuition</span></span>
<span id="cb50-466"><a href="#cb50-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-467"><a href="#cb50-467" aria-hidden="true" tabindex="-1"></a>The key idea on what follows is to use a basic statistical regression model to understand the relationship between the share of new COVID-19 infections and the share of population suffering from long-term illness, accounting for spatio-temporal dependencies. We will consider what is known as a trend-surface regression model which assumes that spatio-temporal dependencies can be accounted for by "trend" components and incorporate as predictors in the model. Formally we consider the regression model below which seeks to account for spatial and temporal trends.</span>
<span id="cb50-468"><a href="#cb50-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-469"><a href="#cb50-469" aria-hidden="true" tabindex="-1"></a>$$y(s_{i}, t_{j}) = \beta_{0} + \beta_{k}x(s_{i}, t_{j}) + e(s_{i}, t_{j})$$</span>
<span id="cb50-470"><a href="#cb50-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-471"><a href="#cb50-471" aria-hidden="true" tabindex="-1"></a>where $\beta_{0}$ is the intercept and $\beta_{k}$ represents a set of regression coefficients associated with $x(s_{i}, t_{j})$; the $k$ indicates the number of covariates at spatial location $s_{i}$ and time $t_{j}$; $e$ represents the regression errors which are assumed to follow a normal distribution. The key difference to aproaches considered in previous chapters is the incorporation of space and time together. As we learnt from the previous section, this has implications are we now have two sources of dependence: spatial and temporal autocorrelation, as well as seasonal and trend components. This has implications for modelling as we now need to account for all of these components if we are to establish any relationship between $y$ and $x$.</span>
<span id="cb50-472"><a href="#cb50-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-473"><a href="#cb50-473" aria-hidden="true" tabindex="-1"></a>A key implication is how we consider the set of covariates represented by $x$. Three key types can be identified:</span>
<span id="cb50-474"><a href="#cb50-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-475"><a href="#cb50-475" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>spatial-variant, temporal-invariant covariates: these are attributes which may vary across space but be temporally invariant, such as geographical distances;</span>
<span id="cb50-476"><a href="#cb50-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-477"><a href="#cb50-477" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>spatial-invariant, temporal-variant covariates: these are attributes which do not vary across space but change over time; and,</span>
<span id="cb50-478"><a href="#cb50-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-479"><a href="#cb50-479" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>spatial-variant, temporal-variant covariates: these are attributes which vary over both space and time;</span>
<span id="cb50-480"><a href="#cb50-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-481"><a href="#cb50-481" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note that what is variant or invariant will depend on the spatial and temporal scale of the analysis.</span></span>
<span id="cb50-482"><a href="#cb50-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-483"><a href="#cb50-483" aria-hidden="true" tabindex="-1"></a>We can also consider spatio-temporal "basis functions". Note that this is an important concept for the rest of the Chapter. What are basis functions then? If you think that spatio-temporal data represent a complex set of curves or surfaces in space, basis functions represent the components into which this set of curves can be decomposed. In this sense, basis functions operate in a similar fashion as the decomposition of time series considered above i.e. time series data can be decomposed into a trend, seasonal and random components and their sum can be used to represent the observed temporal trajectory. Basis functions offer an effective way to incorporate spatio-temporal dependencies. Thus, basis functions have the key goal of accounting for spatio-temporal dependencies as spatial weight matrices or temporal lags help accounting spatial autocorrelation in spatial models and temporal autocorrelation in time series analysis.</span>
<span id="cb50-484"><a href="#cb50-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-485"><a href="#cb50-485" aria-hidden="true" tabindex="-1"></a>As standard regression coefficients, basis functions are related to $y$ via coefficients (or weights). The difference is that we typically assume that basis functions are known while coefficients are random. Examples of basis functions include polynomials, splines, wavelets, sines and cosines so various linear combinations that can be used to infer potential spatio-temporal dependencies in the data. This is similar to deep learning models in which cases you provide, for example, an image and the model provides a classification of pixels. But you normally do not know what the classification represents (hence they are known as black boxes!) so further analysis on the classification is needed to understand what the model has attempted to capture. Basically basis functions are smoother functions to represent the observed data, and their objective to capture the spatial and temporal variability in the data as well as their dependence.</span>
<span id="cb50-486"><a href="#cb50-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-487"><a href="#cb50-487" aria-hidden="true" tabindex="-1"></a>For our application, we start by considering a basic OLS regression model with the following basis functions to account spatial-temporal structures:</span>
<span id="cb50-488"><a href="#cb50-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-489"><a href="#cb50-489" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>overall mean;</span>
<span id="cb50-490"><a href="#cb50-490" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>linear in lon-coordinate;</span>
<span id="cb50-491"><a href="#cb50-491" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>linear in lat-coordinate;</span>
<span id="cb50-492"><a href="#cb50-492" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>linear time daily trend;</span>
<span id="cb50-493"><a href="#cb50-493" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>additional spatio-temporal basis functions which are presented below; and,</span>
<span id="cb50-494"><a href="#cb50-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-495"><a href="#cb50-495" aria-hidden="true" tabindex="-1"></a>These basis functions are incorporated as independent variables in the regression model. Additionally, we also include the share of population suffering from long-term illness as we know it is highly correlated to the cumulative number of COVID-19 cases. The share of population suffering long-term illness is incorporated as a spatial-variant, temporal-invariant covariates given that rely in 2011 census data.</span>
<span id="cb50-496"><a href="#cb50-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-497"><a href="#cb50-497" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting Spatio-Temporal Models</span></span>
<span id="cb50-498"><a href="#cb50-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-499"><a href="#cb50-499" aria-hidden="true" tabindex="-1"></a>As indicated at the start of this Chapter, we use the FRK framework developed by @cressie2008fixed. It provides a scalable, relies on the use a spatial random effects model (with which we have some familiarity) and can be easily implemented in R by the use of the <span class="in">`FRK`</span> package <span class="co">[</span><span class="ot">@zammit2017frk</span><span class="co">]</span>. In this framework, a spatially correlated errors can be decomposed using a linear combination of spatial basis functions, effectively addressing issues of spatial-temporal dependence and nonstationarity. The specification of spatio-temporal basis functions is a key component of the model and they can be generated automatically or by the user via the <span class="in">`FRK`</span> package. We will use the automatically generated functions. While as we will notice they are difficult to interpret, user generated functions require greater understanding of the spatio-temporal structure of COVID-19 which is beyond the scope of this Chapter.</span>
<span id="cb50-500"><a href="#cb50-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-501"><a href="#cb50-501" aria-hidden="true" tabindex="-1"></a>**Prepare Data**</span>
<span id="cb50-502"><a href="#cb50-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-503"><a href="#cb50-503" aria-hidden="true" tabindex="-1"></a>The first step to create a data frame with the variables that we will consider for the analysis. We first remove the geometries to convert <span class="in">`covid19_spt`</span> from a simple feature object to a data frame and then compute the share of long-term illness population.</span>
<span id="cb50-504"><a href="#cb50-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-507"><a href="#cb50-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-508"><a href="#cb50-508" aria-hidden="true" tabindex="-1"></a><span class="co"># remove geometries</span></span>
<span id="cb50-509"><a href="#cb50-509" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(covid19_spt) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb50-510"><a href="#cb50-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-511"><a href="#cb50-511" aria-hidden="true" tabindex="-1"></a><span class="co"># share of population in long-term illness </span></span>
<span id="cb50-512"><a href="#cb50-512" aria-hidden="true" tabindex="-1"></a>covid19_spt <span class="ot">&lt;-</span> covid19_spt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb50-513"><a href="#cb50-513" aria-hidden="true" tabindex="-1"></a> <span class="at">lt_illness =</span> Longterm_sick_or_disabled <span class="sc">/</span> Residents</span>
<span id="cb50-514"><a href="#cb50-514" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-515"><a href="#cb50-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-516"><a href="#cb50-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-517"><a href="#cb50-517" aria-hidden="true" tabindex="-1"></a>**Construct Basis Functions**</span>
<span id="cb50-518"><a href="#cb50-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-519"><a href="#cb50-519" aria-hidden="true" tabindex="-1"></a>We now build the set of basis functions. The can be constructed by using the function <span class="in">`auto_basis`</span> from the <span class="in">`FRK`</span> package. The function takes as arguments: data, nres (which is the number of "resolutions" or aggregation to construct); and type of basis function to use. We consider a single resolution of the default Gaussian radial basis function.</span>
<span id="cb50-520"><a href="#cb50-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-523"><a href="#cb50-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-524"><a href="#cb50-524" aria-hidden="true" tabindex="-1"></a><span class="co"># build basis functions</span></span>
<span id="cb50-525"><a href="#cb50-525" aria-hidden="true" tabindex="-1"></a>G <span class="ot">&lt;-</span> <span class="fu">auto_basis</span>(<span class="at">data =</span> covid19_spt[,<span class="fu">c</span>(<span class="st">"long"</span>,<span class="st">"lat"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb50-526"><a href="#cb50-526" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">SpatialPoints</span>(),           <span class="co"># To sp obj</span></span>
<span id="cb50-527"><a href="#cb50-527" aria-hidden="true" tabindex="-1"></a>                <span class="at">nres =</span> <span class="dv">1</span>,                         <span class="co"># One resolution</span></span>
<span id="cb50-528"><a href="#cb50-528" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="st">"Gaussian"</span>)                <span class="co"># Gaussian BFs</span></span>
<span id="cb50-529"><a href="#cb50-529" aria-hidden="true" tabindex="-1"></a><span class="co"># basis functions evaluated at data locations are then the covariates</span></span>
<span id="cb50-530"><a href="#cb50-530" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">eval_basis</span>(<span class="at">basis =</span> G,                       <span class="co"># basis functions</span></span>
<span id="cb50-531"><a href="#cb50-531" aria-hidden="true" tabindex="-1"></a>                <span class="at">s =</span> covid19_spt[,<span class="fu">c</span>(<span class="st">"long"</span>,<span class="st">"lat"</span>)] <span class="sc">%&gt;%</span></span>
<span id="cb50-532"><a href="#cb50-532" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">as.matrix</span>()) <span class="sc">%&gt;%</span>            <span class="co"># conv. to matrix</span></span>
<span id="cb50-533"><a href="#cb50-533" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as.matrix</span>()                                 <span class="co"># conv. to matrix</span></span>
<span id="cb50-534"><a href="#cb50-534" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(S) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"B"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(S)) <span class="co"># assign column names</span></span>
<span id="cb50-535"><a href="#cb50-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-536"><a href="#cb50-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-537"><a href="#cb50-537" aria-hidden="true" tabindex="-1"></a>**Add Basis Functions to Data Frame**</span>
<span id="cb50-538"><a href="#cb50-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-539"><a href="#cb50-539" aria-hidden="true" tabindex="-1"></a>We then prepare a data frame for the regression model, adding the weights extracted from the basis functions. These weights enter as covariates in our model. Note that the resulting number of basis functions is nine. Explore by executing <span class="in">`colnames(S)`</span>. Below we select only relevant variables for our model.</span>
<span id="cb50-540"><a href="#cb50-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-543"><a href="#cb50-543" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-544"><a href="#cb50-544" aria-hidden="true" tabindex="-1"></a><span class="co"># selecting variables</span></span>
<span id="cb50-545"><a href="#cb50-545" aria-hidden="true" tabindex="-1"></a>reg_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(covid19_spt, S) <span class="sc">%&gt;%</span></span>
<span id="cb50-546"><a href="#cb50-546" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(ctyu19nm, n_covid19_r, long, lat, date, lt_illness, B1<span class="sc">:</span>B9)</span>
<span id="cb50-547"><a href="#cb50-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-548"><a href="#cb50-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-549"><a href="#cb50-549" aria-hidden="true" tabindex="-1"></a>**Fit Linear Regression**</span>
<span id="cb50-550"><a href="#cb50-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-551"><a href="#cb50-551" aria-hidden="true" tabindex="-1"></a>We now fit a linear model using <span class="in">`lm`</span> including as covariates longitude, latitude, day, share of long-term ill population and the nine basis functions.</span>
<span id="cb50-552"><a href="#cb50-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-553"><a href="#cb50-553" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Recall that latitude refers to north/south from the equator and longitude refers to west/east from Greenwich. Further up north means a higher latitude score. Further west means higher longitude score. Scores for Liverpool (53.4084° N, 2.9916° W) are thus higher than for London (51.5074° N, 0.1278° W). This will be helpful for interpretation.</span></span>
<span id="cb50-554"><a href="#cb50-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-557"><a href="#cb50-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-558"><a href="#cb50-558" aria-hidden="true" tabindex="-1"></a>eq1 <span class="ot">&lt;-</span> n_covid19_r <span class="sc">~</span> long <span class="sc">+</span> lat <span class="sc">+</span> date <span class="sc">+</span> lt_illness <span class="sc">+</span> .</span>
<span id="cb50-559"><a href="#cb50-559" aria-hidden="true" tabindex="-1"></a>lm_m <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> eq1, </span>
<span id="cb50-560"><a href="#cb50-560" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(reg_df, <span class="sc">-</span>ctyu19nm))</span>
<span id="cb50-561"><a href="#cb50-561" aria-hidden="true" tabindex="-1"></a>lm_m <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb50-562"><a href="#cb50-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-563"><a href="#cb50-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-564"><a href="#cb50-564" aria-hidden="true" tabindex="-1"></a>Coefficients for explicitly specified spatial and temporal variables and the share of long-term ill population are all statistically significant. The interpretation of the regression coefficients is as usual; that is, one unit increase in a covariate relates to one unit increase in the dependent variable. For instance, the coefficient for long-term illness population indicates that UTLAs with a larger share of long-term ill population in one percentage point tend to have 328 more new COVID-19 cases per 100,000 people! on average. The coefficient for date reveals a strong positive temporal dependence with an average increase in the number of new cases per 100,000 people over time. The coefficient for latitude indicates as we move north the number of new COVID-19 cases per 100,000 people tends to be higher but lower if we move west.</span>
<span id="cb50-565"><a href="#cb50-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-566"><a href="#cb50-566" aria-hidden="true" tabindex="-1"></a>While overall the model provides some understanding of the spatio-temporal structure of the spread of COVID-19, the overall fit of the model is relatively poor. The $R^{2}$ reveals that the model explains only 4.2% of the variability of the spread of COVID-19 cases, reflecting the complexity of modelling spatio-temporal processes. Also, except for two, the coefficients associated to the basis functions are statistically insignificant. A key issue that we have ignored so far is the fact that our dependent variable is a count and is highly skewed - refer back to Section <span class="sc">\[</span>8.4 Exploratory Analysis<span class="sc">\]</span>.</span>
<span id="cb50-567"><a href="#cb50-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-568"><a href="#cb50-568" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Challenge 2: Explore a model with only spatial components (i.e. </span><span class="in">`long`</span><span class="at"> and </span><span class="in">`lat`</span><span class="at">) or only temporal components (</span><span class="in">`day`</span><span class="at">). What model returns the largest $R^{2}$?</span></span>
<span id="cb50-569"><a href="#cb50-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-570"><a href="#cb50-570" aria-hidden="true" tabindex="-1"></a>**Poisson Regression**</span>
<span id="cb50-571"><a href="#cb50-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-572"><a href="#cb50-572" aria-hidden="true" tabindex="-1"></a>A Poisson regression model provides a more appropriate framework to address these issues. We do this fitting a general linear model (or GLM) specifying the family function to be a Poisson.</span>
<span id="cb50-573"><a href="#cb50-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-576"><a href="#cb50-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-577"><a href="#cb50-577" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate a poisson model</span></span>
<span id="cb50-578"><a href="#cb50-578" aria-hidden="true" tabindex="-1"></a>poisson_m1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(eq1,</span>
<span id="cb50-579"><a href="#cb50-579" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="fu">poisson</span>(<span class="st">"log"</span>), <span class="co"># Poisson + log link</span></span>
<span id="cb50-580"><a href="#cb50-580" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(reg_df, <span class="sc">-</span>ctyu19nm))</span>
<span id="cb50-581"><a href="#cb50-581" aria-hidden="true" tabindex="-1"></a>poisson_m1 <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb50-582"><a href="#cb50-582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-583"><a href="#cb50-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-584"><a href="#cb50-584" aria-hidden="true" tabindex="-1"></a>The Poisson model seems to provide a more appropriate functional forms to identify the strength of the relationship between new COVID-19 cases and spatio-temporal dependencies as captured by a greater number (relative to the linear model) of basis functions coefficients becoming statistically significant. Yet, the Poisson model assumes that the mean and variance of the COVID-19 cases is the same. But, given the distribution of our dependent variable, its variance is likely to be greater than the mean. That means the data exhibit "overdispersion". How do we know this? An estimate of the dispersion is given by the ratio of the deviance to the total degrees of freedom (the number of data points minus the number of covariates). In this case the dispersion estimate is:</span>
<span id="cb50-585"><a href="#cb50-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-588"><a href="#cb50-588" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-589"><a href="#cb50-589" aria-hidden="true" tabindex="-1"></a>poisson_m1<span class="sc">$</span>deviance <span class="sc">/</span> poisson_m1<span class="sc">$</span>df.residual</span>
<span id="cb50-590"><a href="#cb50-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-591"><a href="#cb50-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-592"><a href="#cb50-592" aria-hidden="true" tabindex="-1"></a>which is clearly greater than 1! i.e. the data are overdispersed.</span>
<span id="cb50-593"><a href="#cb50-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-594"><a href="#cb50-594" aria-hidden="true" tabindex="-1"></a>**Quasipoisson Regression**</span>
<span id="cb50-595"><a href="#cb50-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-596"><a href="#cb50-596" aria-hidden="true" tabindex="-1"></a>An approach to account for overdispersion is to use quasipoisson when calling <span class="in">`glm`</span>. The quasi-Poisson model assumes that the variance is proportional to the mean, and that the constant of the proportionality is the over-dispersion parameter. This model corrects the standard error of the estimated coefficients. So only p-values and t values are affected. No changes are recorded in terms of residual deviance (24458) and median of deviance residuals (-0.6993), compared to the standard Poisson model.</span>
<span id="cb50-597"><a href="#cb50-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-600"><a href="#cb50-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-601"><a href="#cb50-601" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate a quasipoisson model</span></span>
<span id="cb50-602"><a href="#cb50-602" aria-hidden="true" tabindex="-1"></a>qpoisson_m1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(eq1,</span>
<span id="cb50-603"><a href="#cb50-603" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> <span class="fu">quasipoisson</span>(<span class="st">"log"</span>), <span class="co"># QuasiPoisson + log link</span></span>
<span id="cb50-604"><a href="#cb50-604" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(reg_df, <span class="sc">-</span>ctyu19nm))</span>
<span id="cb50-605"><a href="#cb50-605" aria-hidden="true" tabindex="-1"></a>qpoisson_m1 <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb50-606"><a href="#cb50-606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-607"><a href="#cb50-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-608"><a href="#cb50-608" aria-hidden="true" tabindex="-1"></a>**Negative Binomial Regression**</span>
<span id="cb50-609"><a href="#cb50-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-610"><a href="#cb50-610" aria-hidden="true" tabindex="-1"></a>An alternative approach to deal with overdispersion is the Negative Binomial Model (NBM). This models relaxes the assumption of equality between the mean and variance. We estimate a NBM by using the function <span class="in">`glm.nb`</span> from the <span class="in">`MASS`</span> package.</span>
<span id="cb50-611"><a href="#cb50-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-612"><a href="#cb50-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb50-613"><a href="#cb50-613" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate a negative binomial model</span></span>
<span id="cb50-614"><a href="#cb50-614" aria-hidden="true" tabindex="-1"></a>nb_m1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(eq1, </span>
<span id="cb50-615"><a href="#cb50-615" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(reg_df, <span class="sc">-</span>ctyu19nm))</span>
<span id="cb50-616"><a href="#cb50-616" aria-hidden="true" tabindex="-1"></a>nb_m1 <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb50-617"><a href="#cb50-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-618"><a href="#cb50-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-619"><a href="#cb50-619" aria-hidden="true" tabindex="-1"></a>The NBM leads to a significant reduction in residual deviance from 24,458 returned by the Poisson model to only 8,374. It points to a major improvement in explaining the spatio-temporal variability in the spread of COVID-19</span>
<span id="cb50-620"><a href="#cb50-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-621"><a href="#cb50-621" aria-hidden="true" tabindex="-1"></a>**Including Interactions**</span>
<span id="cb50-622"><a href="#cb50-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-623"><a href="#cb50-623" aria-hidden="true" tabindex="-1"></a>Yet, we may further refine our model based on a different strategy. Let's try running a NBM including interaction terms between spatial and temporal terms (i.e. longitude, latitude and date). We can do this by estimating the following model <span class="in">`c_covid19_r ~ (long + lat + date)^2 + lt_illness + .`</span></span>
<span id="cb50-624"><a href="#cb50-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-625"><a href="#cb50-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message=FALSE}</span></span>
<span id="cb50-626"><a href="#cb50-626" aria-hidden="true" tabindex="-1"></a><span class="co"># new model specification</span></span>
<span id="cb50-627"><a href="#cb50-627" aria-hidden="true" tabindex="-1"></a>eq2 <span class="ot">&lt;-</span> n_covid19_r <span class="sc">~</span> (long <span class="sc">+</span> lat <span class="sc">+</span> date)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> lt_illness <span class="sc">+</span> .</span>
<span id="cb50-628"><a href="#cb50-628" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate a negative binomial model</span></span>
<span id="cb50-629"><a href="#cb50-629" aria-hidden="true" tabindex="-1"></a>nb_m2 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(eq2, </span>
<span id="cb50-630"><a href="#cb50-630" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(reg_df, <span class="sc">-</span>ctyu19nm))</span>
<span id="cb50-631"><a href="#cb50-631" aria-hidden="true" tabindex="-1"></a>nb_m2 <span class="sc">%&gt;%</span> <span class="fu">summary</span>()</span>
<span id="cb50-632"><a href="#cb50-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-633"><a href="#cb50-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-634"><a href="#cb50-634" aria-hidden="true" tabindex="-1"></a>This model leads to a slightly better model by returning a small reduction in the residual deviance and AIC score. Interestingly it also returns highly statistically significant coefficients for all three interaction terms between longitude and latitude (<span class="in">`long:lat`</span>), longitude and date (<span class="in">`long:date`</span>), and latitude and date (<span class="in">`lat:date`</span>). The first indicates that as we move one degree north and west, the number of new cases tend to increase in 2 cases. The second indicates that UTLAs located further north of England tend to record a smaller number of cases over time. The third indicates that UTLAs on the west of England tend to report a much higher number of cases as time passes.</span>
<span id="cb50-635"><a href="#cb50-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-636"><a href="#cb50-636" aria-hidden="true" tabindex="-1"></a>You can report the output for all models estimated above by executing (after removing <span class="in">`#`</span>):</span>
<span id="cb50-637"><a href="#cb50-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-640"><a href="#cb50-640" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-641"><a href="#cb50-641" aria-hidden="true" tabindex="-1"></a><span class="co"># export_summs(lm_m, poisson_m, qpoisson_m1, nb_m1, nb_m2)</span></span>
<span id="cb50-642"><a href="#cb50-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-643"><a href="#cb50-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-644"><a href="#cb50-644" aria-hidden="true" tabindex="-1"></a>Note that you may need to install the <span class="in">`huxtable`</span> package.</span>
<span id="cb50-645"><a href="#cb50-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-646"><a href="#cb50-646" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Model Comparision</span></span>
<span id="cb50-647"><a href="#cb50-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-648"><a href="#cb50-648" aria-hidden="true" tabindex="-1"></a>To compare regression models based on different specifications and assumptions, like those reported above, you may want to consider the cross-validation approach used in @sec-chp5. An alternative approach if you would like to get a quick sense of model fit is to explore the correlation between observed and predicted values of the dependent variable. For our models, we can achieve this by executing:</span>
<span id="cb50-649"><a href="#cb50-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-652"><a href="#cb50-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-653"><a href="#cb50-653" aria-hidden="true" tabindex="-1"></a><span class="co"># computing predictions for all models</span></span>
<span id="cb50-654"><a href="#cb50-654" aria-hidden="true" tabindex="-1"></a>lm_cnt <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_m)</span>
<span id="cb50-655"><a href="#cb50-655" aria-hidden="true" tabindex="-1"></a>poisson_cnt <span class="ot">&lt;-</span> <span class="fu">predict</span>(poisson_m1)</span>
<span id="cb50-656"><a href="#cb50-656" aria-hidden="true" tabindex="-1"></a>nb1_cnt <span class="ot">&lt;-</span> <span class="fu">predict</span>(nb_m1)</span>
<span id="cb50-657"><a href="#cb50-657" aria-hidden="true" tabindex="-1"></a>nb2_cnt <span class="ot">&lt;-</span> <span class="fu">predict</span>(nb_m2)</span>
<span id="cb50-658"><a href="#cb50-658" aria-hidden="true" tabindex="-1"></a>reg_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(reg_df, lm_cnt, poisson_cnt, nb1_cnt, nb2_cnt)</span>
<span id="cb50-659"><a href="#cb50-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-660"><a href="#cb50-660" aria-hidden="true" tabindex="-1"></a><span class="co"># computing correlation coefficients</span></span>
<span id="cb50-661"><a href="#cb50-661" aria-hidden="true" tabindex="-1"></a>cormat <span class="ot">&lt;-</span> <span class="fu">cor</span>(reg_df[, <span class="fu">c</span>(<span class="st">"n_covid19_r"</span>, <span class="st">"lm_cnt"</span>, <span class="st">"poisson_cnt"</span>, <span class="st">"nb1_cnt"</span>, <span class="st">"nb2_cnt"</span>)], </span>
<span id="cb50-662"><a href="#cb50-662" aria-hidden="true" tabindex="-1"></a>              <span class="at">use=</span><span class="st">"complete.obs"</span>, </span>
<span id="cb50-663"><a href="#cb50-663" aria-hidden="true" tabindex="-1"></a>              <span class="at">method=</span><span class="st">"pearson"</span>)</span>
<span id="cb50-664"><a href="#cb50-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-665"><a href="#cb50-665" aria-hidden="true" tabindex="-1"></a><span class="co"># significance test</span></span>
<span id="cb50-666"><a href="#cb50-666" aria-hidden="true" tabindex="-1"></a>sig1 <span class="ot">&lt;-</span> corrplot<span class="sc">::</span><span class="fu">cor.mtest</span>(reg_df[, <span class="fu">c</span>(<span class="st">"n_covid19_r"</span>, <span class="st">"lm_cnt"</span>, <span class="st">"poisson_cnt"</span>, <span class="st">"nb1_cnt"</span>, <span class="st">"nb2_cnt"</span>)],</span>
<span id="cb50-667"><a href="#cb50-667" aria-hidden="true" tabindex="-1"></a>                            <span class="at">conf.level =</span> .<span class="dv">95</span>)</span>
<span id="cb50-668"><a href="#cb50-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-669"><a href="#cb50-669" aria-hidden="true" tabindex="-1"></a><span class="co"># create a correlogram</span></span>
<span id="cb50-670"><a href="#cb50-670" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot.mixed</span>(cormat,</span>
<span id="cb50-671"><a href="#cb50-671" aria-hidden="true" tabindex="-1"></a>                         <span class="at">number.cex =</span> <span class="dv">1</span>,</span>
<span id="cb50-672"><a href="#cb50-672" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tl.pos =</span> <span class="st">"d"</span>,</span>
<span id="cb50-673"><a href="#cb50-673" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tl.cex =</span> <span class="fl">0.9</span>)</span>
<span id="cb50-674"><a href="#cb50-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-675"><a href="#cb50-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-676"><a href="#cb50-676" aria-hidden="true" tabindex="-1"></a>All the models do a relatively job at predicting the observed count of new COVID-19 cases. They display correlation coefficients of 0.64/5 and high degree of correlation between them. These models will provide a good starting point for the assignment. There are a potentially few easy ways to make some considerable improvement.</span>
<span id="cb50-677"><a href="#cb50-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-678"><a href="#cb50-678" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Option 1* Remove all zeros from the dependent variable <span class="in">`n_covid19_r`</span>. They are likely to be affecting the ability of the model to predict positive values which are of main interest if we want to understand the spatio-temporal patterns of the outbreak.</span>
<span id="cb50-679"><a href="#cb50-679" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Option 2* Remove all zeros from the dependent variable and additionally use its log for the regression model.</span>
<span id="cb50-680"><a href="#cb50-680" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Option 3* Include more explanatory variables. Look for factors which can explain the spatial-temporal variability of the current COVID-19 outbreak. Look for hypotheses / anecdotal evidence from the newspapers and social media.</span>
<span id="cb50-681"><a href="#cb50-681" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Option 4* Check for collinearity. Collinearity is likely to be an issue given the way basis functions are created. Checking for collinearity of course will not improve the fit of the existing model but it is important to remove collinear terms if statistical inference is a key goal - which in this case is. Over to you now!</span>
<span id="cb50-682"><a href="#cb50-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-683"><a href="#cb50-683" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb50-684"><a href="#cb50-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-685"><a href="#cb50-685" aria-hidden="true" tabindex="-1"></a>We will continue to use the COVID-19 dataset. Please see @sec-chp11 for details on the data.</span>
<span id="cb50-686"><a href="#cb50-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-689"><a href="#cb50-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb50-690"><a href="#cb50-690" aria-hidden="true" tabindex="-1"></a>sdf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/assignment_2_covid/covid19_eng.gpkg"</span>)</span>
<span id="cb50-691"><a href="#cb50-691" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb50-692"><a href="#cb50-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-693"><a href="#cb50-693" aria-hidden="true" tabindex="-1"></a>Using these data, you are required to address the following challenges:</span>
<span id="cb50-694"><a href="#cb50-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-695"><a href="#cb50-695" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Create a spatio-temporal visualisation.</span>
<span id="cb50-696"><a href="#cb50-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-697"><a href="#cb50-697" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fit a ST model to assess changes over space and time.</span>
<span id="cb50-698"><a href="#cb50-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-699"><a href="#cb50-699" aria-hidden="true" tabindex="-1"></a>Analyse and discuss:</span>
<span id="cb50-700"><a href="#cb50-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-701"><a href="#cb50-701" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Do the results for your GWR and ST results differ: How do regression coefficients vary across space? Is this variation statistically significant?</span>
<span id="cb50-702"><a href="#cb50-702" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Does the ST model indicate significant variations over time? How?</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/10-st_analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>