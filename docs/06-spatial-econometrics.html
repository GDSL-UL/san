<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Spatial Modelling for Data Scientists - 6&nbsp; Spatial Econometrics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./07-multilevel-01.html" rel="next">
<link href="./05-flows.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06-spatial-econometrics.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Modelling for Data Scientists</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/GDSL-UL/san" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Spatial-Modelling-for-Data-Scientists.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Spatial-Modelling-for-Data-Scientists.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
</div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-spatial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Spatial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Wrangling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-points.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Point Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-flows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-spatial-econometrics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-multilevel-01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-multilevel-02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-gwr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Geographically Weighted Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-st_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Spatio-Temporal Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Data Sets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#dependencies" id="toc-dependencies" class="nav-link active" data-scroll-target="#dependencies"><span class="header-section-number">6.1</span> Dependencies</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">6.2</span> Data</a></li>
  <li><a href="#non-spatial-regression-a-refresh" id="toc-non-spatial-regression-a-refresh" class="nav-link" data-scroll-target="#non-spatial-regression-a-refresh"><span class="header-section-number">6.3</span> Non-spatial regression, a refresh</a></li>
  <li><a href="#spatial-regression-a-very-first-dip" id="toc-spatial-regression-a-very-first-dip" class="nav-link" data-scroll-target="#spatial-regression-a-very-first-dip"><span class="header-section-number">6.4</span> Spatial regression: a (very) first dip</a></li>
  <li><a href="#spatial-heterogeneity" id="toc-spatial-heterogeneity" class="nav-link" data-scroll-target="#spatial-heterogeneity"><span class="header-section-number">6.5</span> Spatial heterogeneity</a></li>
  <li><a href="#spatial-dependence" id="toc-spatial-dependence" class="nav-link" data-scroll-target="#spatial-dependence"><span class="header-section-number">6.6</span> Spatial dependence</a></li>
  <li><a href="#predicting-house-prices" id="toc-predicting-house-prices" class="nav-link" data-scroll-target="#predicting-house-prices"><span class="header-section-number">6.7</span> Predicting house prices</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">6.8</span> Questions</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/06-spatial-econometrics.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-chp6" class="quarto-section-identifier"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Spatial Econometrics</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>This chapter is based on the following references, which are good follow-up’s on the topic:</p>
<ul>
<li>
<a href="https://geographicdata.science/book/notebooks/11_regression.html">Chapter 11</a> of the GDS Book, by <span class="citation" data-cites="reyABwolf">Rey, Arribas-Bel, and Wolf (<a href="#ref-reyABwolf" role="doc-biblioref">2023</a>)</span>.</li>
<li>
<a href="http://darribas.org/sdar_mini/notes/Class_03.html">Session III</a> of <span class="citation" data-cites="arribas2014spatial">Arribas-Bel (<a href="#ref-arribas2014spatial" role="doc-biblioref">2014</a>)</span>. Check the “Related readings” section on the session page for more in-depth discussions.</li>
<li>
<span class="citation" data-cites="anselin2005spatial">Anselin (<a href="#ref-anselin2005spatial" role="doc-biblioref">2007</a>)</span>, freely available to download [<a href="https://dces.wisc.edu/wp-content/uploads/sites/128/2013/08/W14_Anselin2007.pdf"><code>pdf</code></a>].</li>
<li>The second part of this tutorial assumes you have reviewed <a href="https://darribas.org/gds_course/content/bE/concepts_E.html">the Spatial Weights Section</a> of <span class="citation" data-cites="darribas_gds_course">Arribas-Bel (<a href="#ref-darribas_gds_course" role="doc-biblioref">2019</a>)</span>.</li>
</ul>
<section id="dependencies" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="dependencies">
<span class="header-section-number">6.1</span> Dependencies</h2>
<p>We will rely on the following libraries in this section, all of them included in <a href="#sec-dependencies" class="quarto-xref"><span class="quarto-unresolved-ref">sec-dependencies</span></a>:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Data management</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co"># Spatial Data management</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="co"># For all your interpolation needs</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/">gstat</a></span><span class="op">)</span></span>
<span><span class="co"># Spatial regression</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="data">
<span class="header-section-number">6.2</span> Data</h2>
<p>To explore ideas in spatial regression, we will the set of Airbnb properties for San Diego (US), borrowed from the “Geographic Data Science with Python” book (see <a href="https://geographicdata.science/book/data/airbnb/regression_cleaning.html">here</a> for more info on the dataset source). This covers the point location of properties advertised on the Airbnb website in the San Diego region.</p>
<p>Let us load the data:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/abb_sd/regression_db.geojson'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `regression_db' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/uol/teaching/envs453/202324/san/data/abb_sd/regression_db.geojson' 
  using driver `GeoJSON'
Simple feature collection with 6110 features and 19 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -117.2812 ymin: 32.57349 xmax: -116.9553 ymax: 33.08311
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<p>The table contains the followig variables:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "accommodates"       "bathrooms"          "bedrooms"          
 [4] "beds"               "neighborhood"       "pool"              
 [7] "d2balboa"           "coastal"            "price"             
[10] "log_price"          "id"                 "pg_Apartment"      
[13] "pg_Condominium"     "pg_House"           "pg_Other"          
[16] "pg_Townhouse"       "rt_Entire_home.apt" "rt_Private_room"   
[19] "rt_Shared_room"     "geometry"          </code></pre>
</div>
</div>
<p>For most of this chapter, we will be exploring determinants and strategies for modelling the price of a property advertised in AirBnb. To get a first taste of what this means, we can create a plot of prices within the area of San Diego:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-spatial-econometrics_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="non-spatial-regression-a-refresh" class="level2 page-columns page-full" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="non-spatial-regression-a-refresh">
<span class="header-section-number">6.3</span> Non-spatial regression, a refresh</h2>
<p>Before we discuss how to explicitly include space into the linear regression framework, let us show how basic regression can be carried out in R, and how you can interpret the results. By no means is this a formal and complete introduction to regression so, if that is what you are looking for, the first part of <span class="citation" data-cites="gelman2006data">Gelman and Hill (<a href="#ref-gelman2006data" role="doc-biblioref">2006</a>)</span>, in particular chapters 3 and 4, are excellent places to check out.</p>
<p>The core idea of linear regression is to explain the variation in a given (<em>dependent</em>) variable as a linear function of a series of other (<em>explanatory</em>) variables. For example, in our case, we may want to express/explain the price of a property advertised on AirBnb as a function of some of its characteristics, such as the number of people it accommodates, and how many bathrooms, bedrooms and beds it features. At the individual level, we can express this as:</p>
<p><span class="math display">\[
\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<p>where <span class="math inline">\(P_i\)</span> is the price of house <span class="math inline">\(i\)</span>, <span class="math inline">\(Acc_i\)</span>, <span class="math inline">\(Bath_i\)</span>, <span class="math inline">\(Bedr_i\)</span> and <span class="math inline">\(Beds_i\)</span> are the count of people it accommodates, bathrooms, bedrooms and beds that house <span class="math inline">\(i\)</span> has, respectively. The parameters <span class="math inline">\(\beta_{1,2, 3, 4}\)</span> give us information about in which way and to what extent each variable is related to the price, and <span class="math inline">\(\alpha\)</span>, the constant term, is the average house price when all the other variables are zero. The term <span class="math inline">\(\epsilon_i\)</span> is usually referred to as the “error” and captures elements that influence the price of a house but are not accounted for explicitly. We can also express this relation in matrix form, excluding subindices for <span class="math inline">\(i\)</span> as:</p>
<p><span class="math display">\[
\log(P) = \alpha + \beta_1 Acc + \beta_2 Bath + \beta_3 Bedr + \beta_4 Beds + \epsilon
\]</span> where each term can be interpreted in terms of vectors instead of scalars (wit the exception of the parameters <span class="math inline">\((\alpha, \beta_{1, 2, 3, 4})\)</span>, which <em>are</em> scalars). Note we are using the logarithm of the price, since this allows us to interpret the coefficients as roughly the percentage change induced by a unit increase in the explanatory variable of the estimate.</p>
<p>Remember a regression can be seen as a multivariate extension of bivariate correlations. Indeed, one way to interpret the <span class="math inline">\(\beta_k\)</span> coefficients in the equation above is as the degree of correlation between the explanatory variable <span class="math inline">\(k\)</span> and the dependent variable, <em>keeping all the other explanatory variables constant</em>. When you calculate simple bivariate correlations, the coefficient of a variable is picking up the correlation between the variables, but it is also subsuming into it variation associated with other correlated variables –also called confounding factors[^06-spatial-econometrics-1]. Regression allows you to isolate the distinct effect that a single variable has on the dependent one, once we <em>control</em> for those other variables.</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><strong>Task</strong></p>
<p>Assume that new houses tend to be built more often in areas with low deprivation. If that is the case, then <span class="math inline">\(NEW\)</span> and <span class="math inline">\(IMD\)</span> will be correlated with each other (as well as with the price of a house, as we are hypothesizing in this case). If we calculate a simple correlation between <span class="math inline">\(P\)</span> and <span class="math inline">\(IMD\)</span>, the coefficient will represent the degree of association between both variables, but it will also include some of the association between <span class="math inline">\(IMD\)</span> and <span class="math inline">\(NEW\)</span>. That is, part of the obtained correlation coefficient will be due not to the fact that higher prices tend to be found in areas with low IMD, but to the fact that new houses tend to be more expensive. This is because (in this example) new houses tend to be built in areas with low deprivation and simple bivariate correlation cannot account for that.</p>
</div>
</div>
</div>
</div></div><p>Practically speaking, running linear regressions in <code>R</code> is straightforward. For example, to fit the model specified in the equation above, we only need one line of code:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="st">'log_price ~ accommodates + bathrooms + bedrooms + beds'</span>, <span class="va">db</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the command <code>lm</code>, for linear model, and specify the equation we want to fit using a string that relates the dependent variable (the log of the price, <code>log_price</code>) with a set of explanatory ones (<code>accommodates</code>, <code>bathrooms</code>, <code>bedrooms</code>, <code>beds</code>) by using a tilde <code>~</code> that is akin to the <span class="math inline">\(=\)</span> symbol in the mathematical equation above. Since we are using names of variables that are stored in a table, we need to pass the table object (<code>db</code>) as well.</p>
<p>In order to inspect the results of the model, the quickest way is to call <code>summary</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = "log_price ~ accommodates + bathrooms + bedrooms + beds", 
    data = db)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.8486 -0.3234 -0.0095  0.3023  3.3975 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   4.018133   0.013947  288.10   &lt;2e-16 ***
accommodates  0.176851   0.005323   33.23   &lt;2e-16 ***
bathrooms     0.150981   0.012526   12.05   &lt;2e-16 ***
bedrooms      0.111700   0.012537    8.91   &lt;2e-16 ***
beds         -0.076974   0.007927   -9.71   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5366 on 6105 degrees of freedom
Multiple R-squared:  0.5583,    Adjusted R-squared:  0.558 
F-statistic:  1929 on 4 and 6105 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>A full detailed explanation of the output is beyond the scope of the chapter, but we will highlight the relevant bits for our main purpose. This is concentrated on the <code>Coefficients</code> section, which gives us the estimates for the <span class="math inline">\(\beta_k\)</span> coefficients in our model. These estimates are the raw equivalent of the correlation coefficient between each explanatory variable and the dependent one, once the “polluting” effect of the other variables included in the model has been accounted for<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Results are as expected for the most part: houses tend to be significantly more expensive if they accommodate more people (an extra person increases the price by 17.7%, approximately), have more bathrooms (15.1%), or bedrooms (11.2%). Perhaps counter intuitively, an extra bed available seems to decrease the price by about -7.7%. However, keep in mind that this is the case, <em>everything else equal</em>. Hence, more beds per room and bathroom (ie. a more crowded house) is a bit cheaper.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;Keep in mind that regression is no magic. We are only discounting the effect of other confounding factors that we include in the model, not of <em>all</em> potentially confounding factors.</p></div></section><section id="spatial-regression-a-very-first-dip" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="spatial-regression-a-very-first-dip">
<span class="header-section-number">6.4</span> Spatial regression: a (very) first dip</h2>
<p>Spatial regression is about <em>explicitly</em> introducing space or geographical context into the statistical framework of a regression. Conceptually, we want to introduce space into our model whenever we think it plays an important role in the process we are interested in, or when space can act as a reasonable proxy for other factors we cannot but should include in our model. As an example of the former, we can imagine how houses at the seafront are probably more expensive than those in the second row, given their better views. To illustrate the latter, we can think of how the character of a neighborhood is important in determining the price of a house; however, it is very hard to identify and quantify “character” per se, although it might be easier to get at its spatial variation, hence a case of space as a proxy.</p>
<p>Spatial regression is a large field of development in the econometrics and statistics literature. In this brief introduction, we will consider two related but very different processes that give rise to spatial effects: spatial heterogeneity and spatial dependence. For more rigorous treatments of the topics introduced here, the reader is referred to <span class="citation" data-cites="anselin2003spatial">Anselin (<a href="#ref-anselin2003spatial" role="doc-biblioref">2003</a>)</span>, <span class="citation" data-cites="anselin2014modern">Anselin and Rey (<a href="#ref-anselin2014modern" role="doc-biblioref">2014</a>)</span>, and <span class="citation" data-cites="gibbons2014spatial">Gibbons, Overman, and Patacchini (<a href="#ref-gibbons2014spatial" role="doc-biblioref">2014</a>)</span>.</p>
</section><section id="spatial-heterogeneity" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="spatial-heterogeneity">
<span class="header-section-number">6.5</span> Spatial heterogeneity</h2>
<p>Spatial heterogeneity (SH) arises when we cannot safely assume the process we are studying operates under the same “rules” throughout the geography of interest. In other words, we can observe SH when there are effects on the outcome variable that are intrinsically linked to specific locations. A good example of this is the case of seafront houses above: we are trying to model the price of a house and, the fact some houses are located under certain conditions (i.e.&nbsp;by the sea), makes their price behave differently. This somewhat abstract concept of SH can be made operational in a model in several ways. We will explore the following two: spatial fixed-effects (FE); and spatial regimes, which is a generalization of FE.</p>
<p><strong>Spatial FE</strong></p>
<p>Let us consider the house price example from the previous section to introduce a more general illustration that relates to the second motivation for spatial effects (“space as a proxy”). Given we are only including two explanatory variables in the model, it is likely we are missing some important factors that play a role at determining the price at which a house is sold. Some of them, however, are likely to vary systematically over space (e.g.&nbsp;different neighborhood characteristics). If that is the case, we can control for those unobserved factors by using traditional dummy variables but basing their creation on a spatial rule. For example, let us include a binary variable for every neighbourhood, as provided by AirBnB, indicating whether a given house is located within such area (<code>1</code>) or not (<code>0</code>). Neighbourhood membership is expressed on the <code>neighborhood</code> column:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">neighborhood</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-spatial-econometrics_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Mathematically, we are now fitting the following equation:</p>
<p><span class="math display">\[
\log(P_i) = \alpha_r + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<p>where the main difference is that we are now allowing the constant term, <span class="math inline">\(\alpha\)</span>, to vary by neighbourhood <span class="math inline">\(r\)</span>, <span class="math inline">\(\alpha_r\)</span>.</p>
<p>Programmatically, we can fit this model with <code>lm</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Include `-1` to eliminate the constant term and include a dummy for every area</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="st">'log_price ~ neighborhood + accommodates + bathrooms + bedrooms + beds - 1'</span>, </span>
<span>  <span class="va">db</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = "log_price ~ neighborhood + accommodates + bathrooms + bedrooms + beds - 1", 
    data = db)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.4549 -0.2920 -0.0203  0.2741  3.5323 

Coefficients:
                                     Estimate Std. Error t value Pr(&gt;|t|)    
neighborhoodBalboa Park              3.994775   0.036539  109.33   &lt;2e-16 ***
neighborhoodBay Ho                   3.780025   0.086081   43.91   &lt;2e-16 ***
neighborhoodBay Park                 3.941847   0.055788   70.66   &lt;2e-16 ***
neighborhoodCarmel Valley            4.034052   0.062811   64.23   &lt;2e-16 ***
neighborhoodCity Heights West        3.698788   0.065502   56.47   &lt;2e-16 ***
neighborhoodClairemont Mesa          3.658339   0.051438   71.12   &lt;2e-16 ***
neighborhoodCollege Area             3.649859   0.064979   56.17   &lt;2e-16 ***
neighborhoodCore                     4.433447   0.058864   75.32   &lt;2e-16 ***
neighborhoodCortez Hill              4.294790   0.057648   74.50   &lt;2e-16 ***
neighborhoodDel Mar Heights          4.300659   0.060912   70.61   &lt;2e-16 ***
neighborhoodEast Village             4.241146   0.032019  132.46   &lt;2e-16 ***
neighborhoodGaslamp Quarter          4.473863   0.052493   85.23   &lt;2e-16 ***
neighborhoodGrant Hill               4.001481   0.058825   68.02   &lt;2e-16 ***
neighborhoodGrantville               3.664989   0.080168   45.72   &lt;2e-16 ***
neighborhoodKensington               4.073520   0.087322   46.65   &lt;2e-16 ***
neighborhoodLa Jolla                 4.400145   0.026772  164.36   &lt;2e-16 ***
neighborhoodLa Jolla Village         4.066151   0.087263   46.60   &lt;2e-16 ***
neighborhoodLinda Vista              3.817940   0.063128   60.48   &lt;2e-16 ***
neighborhoodLittle Italy             4.390651   0.052433   83.74   &lt;2e-16 ***
neighborhoodLoma Portal              4.034473   0.036173  111.53   &lt;2e-16 ***
neighborhoodMarina                   4.046133   0.052178   77.55   &lt;2e-16 ***
neighborhoodMidtown                  4.032038   0.030280  133.16   &lt;2e-16 ***
neighborhoodMidtown District         4.356943   0.071756   60.72   &lt;2e-16 ***
neighborhoodMira Mesa                3.570523   0.061543   58.02   &lt;2e-16 ***
neighborhoodMission Bay              4.251309   0.023318  182.32   &lt;2e-16 ***
neighborhoodMission Valley           4.012410   0.083766   47.90   &lt;2e-16 ***
neighborhoodMoreno Mission           4.028288   0.063342   63.59   &lt;2e-16 ***
neighborhoodNormal Heights           3.791895   0.054730   69.28   &lt;2e-16 ***
neighborhoodNorth Clairemont         3.498107   0.076432   45.77   &lt;2e-16 ***
neighborhoodNorth Hills              3.959403   0.026823  147.61   &lt;2e-16 ***
neighborhoodNorthwest                3.810201   0.078158   48.75   &lt;2e-16 ***
neighborhoodOcean Beach              4.152695   0.032352  128.36   &lt;2e-16 ***
neighborhoodOld Town                 4.127737   0.046523   88.72   &lt;2e-16 ***
neighborhoodOtay Ranch               3.722902   0.091633   40.63   &lt;2e-16 ***
neighborhoodPacific Beach            4.116749   0.022711  181.27   &lt;2e-16 ***
neighborhoodPark West                4.216829   0.050370   83.72   &lt;2e-16 ***
neighborhoodRancho Bernadino         3.873962   0.080780   47.96   &lt;2e-16 ***
neighborhoodRancho Penasquitos       3.772037   0.068808   54.82   &lt;2e-16 ***
neighborhoodRoseville                4.070468   0.065299   62.34   &lt;2e-16 ***
neighborhoodSan Carlos               3.935042   0.093205   42.22   &lt;2e-16 ***
neighborhoodScripps Ranch            3.641239   0.085190   42.74   &lt;2e-16 ***
neighborhoodSerra Mesa               3.912127   0.066630   58.71   &lt;2e-16 ***
neighborhoodSouth Park               3.987019   0.060141   66.30   &lt;2e-16 ***
neighborhoodUniversity City          3.772504   0.039638   95.17   &lt;2e-16 ***
neighborhoodWest University Heights  4.043161   0.048238   83.82   &lt;2e-16 ***
accommodates                         0.150283   0.005086   29.55   &lt;2e-16 ***
bathrooms                            0.132287   0.011886   11.13   &lt;2e-16 ***
bedrooms                             0.147631   0.011960   12.34   &lt;2e-16 ***
beds                                -0.074622   0.007405  -10.08   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.4971 on 6061 degrees of freedom
Multiple R-squared:  0.9904,    Adjusted R-squared:  0.9904 
F-statistic: 1.28e+04 on 49 and 6061 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Econometrically speaking, what the postcode FE we have introduced imply is that, instead of comparing all house prices across San Diego as equal, we only derive variation from <em>within</em> each postcode. In our particular case, estimating spatial FE in our particular example also gives you an indirect measure of area <em>desirability</em>: since they are simple dummies in a regression explaining the price of a house, their estimate tells us about how much people are willing to pay to live in a given area. We can visualise this “geography of desirability” by plotting the estimates of each fixed effect on a map:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract neighborhood names from coefficients</span></span>
<span><span class="va">nei.names</span> <span class="op">&lt;-</span> <span class="va">m2</span><span class="op">$</span><span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"neighborhood"</span>, <span class="st">""</span><span class="op">)</span></span>
<span><span class="co"># Set up as Data Frame</span></span>
<span><span class="va">nei.fes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  coef <span class="op">=</span> <span class="va">m2</span><span class="op">$</span><span class="va">coefficients</span>,</span>
<span>  nei <span class="op">=</span> <span class="va">nei.names</span>,</span>
<span>  row.names <span class="op">=</span> <span class="va">nei.names</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span></span>
<span>    <span class="va">db</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nei"</span> <span class="op">=</span> <span class="st">"neighborhood"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">nei.fes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">coef</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="06-spatial-econometrics_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see how neighborhoods in the left (west) tend to have higher prices. What we can’t see, but it is represented there if you are familiar with the geography of San Diego, is that the city is bounded by the Pacific ocean on the left, suggesting neighbourhoods by the beach tend to be more expensive.</p>
<p>Remember that the interpretation of a <span class="math inline">\(\beta_k\)</span> coefficient is the effect of variable <span class="math inline">\(k\)</span>, <em>given all the other explanatory variables included remain constant</em>. By including a single variable for each area, we are effectively forcing the model to compare as equal only house prices that share the same value for each variable; in other words, only houses located within the same area. Introducing FE affords you a higher degree of isolation of the effects of the variables you introduce in your model because you can control for unobserved effects that align spatially with the distribution of the FE you introduce (by neighbourhood, in our case).</p>
<p><strong>Spatial regimes</strong></p>
<p>At the core of estimating spatial FEs is the idea that, instead of assuming the dependent variable behaves uniformly over space, there are systematic effects following a geographical pattern that affect its behaviour. In other words, spatial FEs introduce econometrically the notion of spatial heterogeneity. They do this in the simplest possible form: by allowing the constant term to vary geographically. The other elements of the regression are left untouched and hence apply uniformly across space. The idea of spatial regimes (SRs) is to generalize the spatial FE approach to allow not only the constant term to vary but also any other explanatory variable. This implies that the equation we will be estimating is: <span class="math display">\[\log(P_i) = \alpha_r + \beta_{1r} Acc_i + \beta_{2r} Bath_i + \beta_{3r} Bedr_i + \beta_{4r} Beds_i + \epsilon_i\]</span></p>
<p>where we are not only allowing the constant term to vary by region (<span class="math inline">\(\alpha_r\)</span>), but also every other parameter (<span class="math inline">\(\beta_{kr}\)</span>).</p>
<p>Also, given we are going to allow <em>every</em> coefficient to vary by regime, we will need to explicitly set a constant term that we can allow to vary:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span><span class="op">$</span><span class="va">one</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, the estimation leverages the capabilities in model description of R formulas:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># `:` notation implies interaction variables</span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="st">'log_price ~ (one + accommodates + bathrooms + bedrooms + beds):(neighborhood)'</span>, </span>
<span>  <span class="va">db</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = "log_price ~ (one + accommodates + bathrooms + bedrooms + beds):(neighborhood)", 
    data = db)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.5528 -0.2921 -0.0163  0.2586  3.1874 

Coefficients: (1 not defined because of singularities)
                                                  Estimate Std. Error t value
(Intercept)                                       4.012160   0.122261  32.816
one:neighborhoodBalboa Park                       0.128350   0.145826   0.880
one:neighborhoodBay Ho                           -0.202575   0.254393  -0.796
one:neighborhoodBay Park                         -0.272843   0.174512  -1.563
one:neighborhoodCarmel Valley                    -0.063356   0.164404  -0.385
one:neighborhoodCity Heights West                -0.096400   0.205758  -0.469
one:neighborhoodClairemont Mesa                  -0.639595   0.183891  -3.478
one:neighborhoodCollege Area                     -0.185039   0.207335  -0.892
one:neighborhoodCore                              0.416563   0.223962   1.860
one:neighborhoodCortez Hill                       0.309752   0.193169   1.604
one:neighborhoodDel Mar Heights                   0.259677   0.182046   1.426
one:neighborhoodEast Village                      0.205331   0.147158   1.395
one:neighborhoodGaslamp Quarter                  -1.156797   0.282853  -4.090
one:neighborhoodGrant Hill                       -0.077324   0.200580  -0.386
one:neighborhoodGrantville                       -0.355260   0.278718  -1.275
one:neighborhoodKensington                       -0.252743   0.248147  -1.019
one:neighborhoodLa Jolla                          0.380059   0.128014   2.969
one:neighborhoodLa Jolla Village                  0.027119   0.291318   0.093
one:neighborhoodLinda Vista                      -0.448116   0.202151  -2.217
one:neighborhoodLittle Italy                      0.384100   0.188630   2.036
one:neighborhoodLoma Portal                       0.014552   0.148157   0.098
one:neighborhoodMarina                           -0.549055   0.198350  -2.768
one:neighborhoodMidtown                           0.071392   0.134620   0.530
one:neighborhoodMidtown District                 -0.180003   0.219627  -0.820
one:neighborhoodMira Mesa                        -0.596573   0.205262  -2.906
one:neighborhoodMission Bay                       0.399054   0.128693   3.101
one:neighborhoodMission Valley                   -0.249279   0.288450  -0.864
one:neighborhoodMoreno Mission                    0.268901   0.222999   1.206
one:neighborhoodNormal Heights                   -0.253917   0.210697  -1.205
one:neighborhoodNorth Clairemont                 -0.404436   0.221559  -1.825
one:neighborhoodNorth Hills                      -0.103473   0.136994  -0.755
one:neighborhoodNorthwest                         0.198074   0.284402   0.696
one:neighborhoodOcean Beach                       0.192554   0.136493   1.411
one:neighborhoodOld Town                         -0.062746   0.157153  -0.399
one:neighborhoodOtay Ranch                       -0.358005   0.232826  -1.538
one:neighborhoodPacific Beach                     0.113854   0.129413   0.880
one:neighborhoodPark West                         0.154992   0.170398   0.910
one:neighborhoodRancho Bernadino                 -0.019347   0.194468  -0.099
one:neighborhoodRancho Penasquitos               -0.401257   0.163315  -2.457
one:neighborhoodRoseville                         0.120010   0.182676   0.657
one:neighborhoodSan Carlos                       -0.589123   0.284463  -2.071
one:neighborhoodScripps Ranch                    -0.026842   0.215965  -0.124
one:neighborhoodSerra Mesa                       -0.283949   0.207741  -1.367
one:neighborhoodSouth Park                       -0.181786   0.226828  -0.801
one:neighborhoodUniversity City                  -0.298526   0.161655  -1.847
one:neighborhoodWest University Heights                 NA         NA      NA
accommodates:neighborhoodBalboa Park              0.097052   0.024632   3.940
accommodates:neighborhoodBay Ho                  -0.017961   0.089598  -0.200
accommodates:neighborhoodBay Park                 0.155715   0.063773   2.442
accommodates:neighborhoodCarmel Valley            0.151990   0.049440   3.074
accommodates:neighborhoodCity Heights West        0.060303   0.063416   0.951
accommodates:neighborhoodClairemont Mesa          0.260414   0.050425   5.164
accommodates:neighborhoodCollege Area             0.084693   0.053125   1.594
accommodates:neighborhoodCore                     0.106661   0.039204   2.721
accommodates:neighborhoodCortez Hill              0.217358   0.037615   5.779
accommodates:neighborhoodDel Mar Heights          0.075776   0.061335   1.235
accommodates:neighborhoodEast Village             0.162155   0.020465   7.924
accommodates:neighborhoodGaslamp Quarter          0.307007   0.053766   5.710
accommodates:neighborhoodGrant Hill               0.278114   0.056238   4.945
accommodates:neighborhoodGrantville               0.124025   0.075028   1.653
accommodates:neighborhoodKensington               0.063298   0.123887   0.511
accommodates:neighborhoodLa Jolla                 0.119142   0.015162   7.858
accommodates:neighborhoodLa Jolla Village         0.207085   0.111627   1.855
accommodates:neighborhoodLinda Vista              0.172101   0.076208   2.258
accommodates:neighborhoodLittle Italy             0.230108   0.034432   6.683
accommodates:neighborhoodLoma Portal              0.090991   0.034762   2.618
accommodates:neighborhoodMarina                   0.552162   0.045914  12.026
accommodates:neighborhoodMidtown                  0.227617   0.023854   9.542
accommodates:neighborhoodMidtown District         0.179989   0.052007   3.461
accommodates:neighborhoodMira Mesa                0.157603   0.082351   1.914
accommodates:neighborhoodMission Bay              0.085754   0.013455   6.373
accommodates:neighborhoodMission Valley           0.099273   0.134176   0.740
accommodates:neighborhoodMoreno Mission           0.145824   0.060631   2.405
accommodates:neighborhoodNormal Heights           0.237177   0.053060   4.470
accommodates:neighborhoodNorth Clairemont         0.188941   0.084060   2.248
accommodates:neighborhoodNorth Hills              0.143390   0.022069   6.497
accommodates:neighborhoodNorthwest                0.022166   0.069235   0.320
accommodates:neighborhoodOcean Beach              0.113995   0.022845   4.990
accommodates:neighborhoodOld Town                 0.239088   0.042208   5.665
accommodates:neighborhoodOtay Ranch              -0.021530   0.083481  -0.258
accommodates:neighborhoodPacific Beach            0.153379   0.015339   9.999
accommodates:neighborhoodPark West                0.224593   0.045581   4.927
accommodates:neighborhoodRancho Bernadino         0.004730   0.067968   0.070
accommodates:neighborhoodRancho Penasquitos       0.070627   0.060353   1.170
accommodates:neighborhoodRoseville                0.112686   0.060090   1.875
accommodates:neighborhoodSan Carlos              -0.140714   0.087777  -1.603
accommodates:neighborhoodScripps Ranch            0.087078   0.035562   2.449
accommodates:neighborhoodSerra Mesa               0.190589   0.075803   2.514
accommodates:neighborhoodSouth Park               0.206833   0.068093   3.038
accommodates:neighborhoodUniversity City          0.067637   0.030097   2.247
accommodates:neighborhoodWest University Heights  0.124850   0.056034   2.228
bathrooms:neighborhoodBalboa Park                 0.014875   0.073585   0.202
bathrooms:neighborhoodBay Ho                      0.305028   0.225044   1.355
bathrooms:neighborhoodBay Park                    0.065043   0.120545   0.540
bathrooms:neighborhoodCarmel Valley               0.205847   0.065237   3.155
bathrooms:neighborhoodCity Heights West          -0.129465   0.183389  -0.706
bathrooms:neighborhoodClairemont Mesa             0.418033   0.176111   2.374
bathrooms:neighborhoodCollege Area               -0.012095   0.183917  -0.066
bathrooms:neighborhoodCore                        0.464974   0.186634   2.491
bathrooms:neighborhoodCortez Hill                -0.206708   0.101521  -2.036
bathrooms:neighborhoodDel Mar Heights             0.319046   0.096172   3.317
bathrooms:neighborhoodEast Village                0.312707   0.067204   4.653
bathrooms:neighborhoodGaslamp Quarter             1.459299   0.207669   7.027
bathrooms:neighborhoodGrant Hill                  0.040405   0.155867   0.259
bathrooms:neighborhoodGrantville                  0.028466   0.234973   0.121
bathrooms:neighborhoodKensington                  0.146585   0.188987   0.776
bathrooms:neighborhoodLa Jolla                    0.242760   0.026778   9.066
bathrooms:neighborhoodLa Jolla Village           -0.296748   0.326257  -0.910
bathrooms:neighborhoodLinda Vista                 0.170333   0.143441   1.187
bathrooms:neighborhoodLittle Italy                0.035532   0.111044   0.320
bathrooms:neighborhoodLoma Portal                 0.188467   0.082511   2.284
bathrooms:neighborhoodMarina                      0.316509   0.219948   1.439
bathrooms:neighborhoodMidtown                    -0.037771   0.032333  -1.168
bathrooms:neighborhoodMidtown District            0.623515   0.197674   3.154
bathrooms:neighborhoodMira Mesa                   0.215939   0.185982   1.161
bathrooms:neighborhoodMission Bay                 0.176976   0.035418   4.997
bathrooms:neighborhoodMission Valley             -0.009144   0.405637  -0.023
bathrooms:neighborhoodMoreno Mission             -0.208248   0.210241  -0.991
bathrooms:neighborhoodNormal Heights              0.017303   0.201580   0.086
bathrooms:neighborhoodNorth Clairemont           -0.102553   0.212254  -0.483
bathrooms:neighborhoodNorth Hills                 0.098449   0.064065   1.537
bathrooms:neighborhoodNorthwest                  -0.503592   0.255300  -1.973
bathrooms:neighborhoodOcean Beach                 0.082659   0.059578   1.387
bathrooms:neighborhoodOld Town                    0.087046   0.096513   0.902
bathrooms:neighborhoodOtay Ranch                 -0.219480   0.341525  -0.643
bathrooms:neighborhoodPacific Beach               0.116105   0.041006   2.831
bathrooms:neighborhoodPark West                   0.198550   0.107749   1.843
bathrooms:neighborhoodRancho Bernadino            0.365674   0.147799   2.474
bathrooms:neighborhoodRancho Penasquitos          0.320715   0.110007   2.915
bathrooms:neighborhoodRoseville                  -0.053420   0.102487  -0.521
bathrooms:neighborhoodSan Carlos                  0.267797   0.214540   1.248
bathrooms:neighborhoodScripps Ranch              -0.132692   0.169684  -0.782
bathrooms:neighborhoodSerra Mesa                  0.381620   0.197305   1.934
bathrooms:neighborhoodSouth Park                  0.087490   0.196486   0.445
bathrooms:neighborhoodUniversity City             0.138271   0.125198   1.104
bathrooms:neighborhoodWest University Heights     0.042035   0.122097   0.344
bedrooms:neighborhoodBalboa Park                  0.183347   0.065309   2.807
bedrooms:neighborhoodBay Ho                       0.241200   0.170471   1.415
bedrooms:neighborhoodBay Park                     0.214111   0.117198   1.827
bedrooms:neighborhoodCarmel Valley               -0.073928   0.127976  -0.578
bedrooms:neighborhoodCity Heights West            0.272272   0.176859   1.539
bedrooms:neighborhoodClairemont Mesa             -0.046650   0.122263  -0.382
bedrooms:neighborhoodCollege Area                -0.055707   0.108958  -0.511
bedrooms:neighborhoodCore                        -0.069929   0.108896  -0.642
bedrooms:neighborhoodCortez Hill                  0.313288   0.101770   3.078
bedrooms:neighborhoodDel Mar Heights              0.111554   0.097639   1.143
bedrooms:neighborhoodEast Village                 0.088071   0.056654   1.555
bedrooms:neighborhoodGaslamp Quarter             -0.297570   0.090336  -3.294
bedrooms:neighborhoodGrant Hill                   0.091300   0.114501   0.797
bedrooms:neighborhoodGrantville                   0.221461   0.208950   1.060
bedrooms:neighborhoodKensington                   0.450822   0.269641   1.672
bedrooms:neighborhoodLa Jolla                     0.166725   0.035423   4.707
bedrooms:neighborhoodLa Jolla Village             0.845318   0.545842   1.549
bedrooms:neighborhoodLinda Vista                  0.096413   0.171751   0.561
bedrooms:neighborhoodLittle Italy                 0.126794   0.080939   1.567
bedrooms:neighborhoodLoma Portal                  0.172480   0.067268   2.564
bedrooms:neighborhoodMarina                      -0.323085   0.137046  -2.357
bedrooms:neighborhoodMidtown                      0.172711   0.044927   3.844
bedrooms:neighborhoodMidtown District             0.088181   0.134514   0.656
bedrooms:neighborhoodMira Mesa                   -0.029149   0.206406  -0.141
bedrooms:neighborhoodMission Bay                  0.197484   0.032472   6.082
bedrooms:neighborhoodMission Valley               0.393256   0.342308   1.149
bedrooms:neighborhoodMoreno Mission              -0.081003   0.158933  -0.510
bedrooms:neighborhoodNormal Heights               0.199088   0.104514   1.905
bedrooms:neighborhoodNorth Clairemont             0.176509   0.183702   0.961
bedrooms:neighborhoodNorth Hills                  0.283826   0.047159   6.018
bedrooms:neighborhoodNorthwest                    0.411641   0.160558   2.564
bedrooms:neighborhoodOcean Beach                  0.220345   0.055039   4.003
bedrooms:neighborhoodOld Town                     0.209031   0.099966   2.091
bedrooms:neighborhoodOtay Ranch                   0.772212   0.354230   2.180
bedrooms:neighborhoodPacific Beach                0.077503   0.036735   2.110
bedrooms:neighborhoodPark West                   -0.127891   0.110497  -1.157
bedrooms:neighborhoodRancho Bernadino            -0.209594   0.160210  -1.308
bedrooms:neighborhoodRancho Penasquitos           0.107599   0.138183   0.779
bedrooms:neighborhoodRoseville                    0.395961   0.157406   2.516
bedrooms:neighborhoodSan Carlos                   0.239713   0.150420   1.594
bedrooms:neighborhoodScripps Ranch               -0.045580   0.102624  -0.444
bedrooms:neighborhoodSerra Mesa                   0.202756   0.163958   1.237
bedrooms:neighborhoodSouth Park                   0.080548   0.112861   0.714
bedrooms:neighborhoodUniversity City              0.124090   0.120386   1.031
bedrooms:neighborhoodWest University Heights      0.011105   0.095137   0.117
beds:neighborhoodBalboa Park                      0.013322   0.045740   0.291
beds:neighborhoodBay Ho                           0.037070   0.133299   0.278
beds:neighborhoodBay Park                         0.011091   0.108863   0.102
beds:neighborhoodCarmel Valley                    0.086393   0.076151   1.135
beds:neighborhoodCity Heights West                0.076520   0.132072   0.579
beds:neighborhoodClairemont Mesa                 -0.163512   0.090244  -1.812
beds:neighborhoodCollege Area                     0.228165   0.084147   2.712
beds:neighborhoodCore                            -0.080211   0.078673  -1.020
beds:neighborhoodCortez Hill                     -0.039031   0.042752  -0.913
beds:neighborhoodDel Mar Heights                 -0.021375   0.071330  -0.300
beds:neighborhoodEast Village                    -0.174883   0.040811  -4.285
beds:neighborhoodGaslamp Quarter                 -0.064063   0.088752  -0.722
beds:neighborhoodGrant Hill                      -0.178920   0.067398  -2.655
beds:neighborhoodGrantville                      -0.003795   0.126551  -0.030
beds:neighborhoodKensington                      -0.005431   0.175724  -0.031
beds:neighborhoodLa Jolla                        -0.104906   0.022470  -4.669
beds:neighborhoodLa Jolla Village                -0.385895   0.315094  -1.225
beds:neighborhoodLinda Vista                      0.032215   0.073896   0.436
beds:neighborhoodLittle Italy                    -0.145613   0.029817  -4.884
beds:neighborhoodLoma Portal                     -0.013033   0.059097  -0.221
beds:neighborhoodMarina                          -0.210771   0.113913  -1.850
beds:neighborhoodMidtown                         -0.143254   0.036531  -3.921
beds:neighborhoodMidtown District                -0.132655   0.090595  -1.464
beds:neighborhoodMira Mesa                        0.097629   0.113225   0.862
beds:neighborhoodMission Bay                     -0.061315   0.017727  -3.459
beds:neighborhoodMission Valley                   0.073187   0.235760   0.310
beds:neighborhoodMoreno Mission                   0.195918   0.116748   1.678
beds:neighborhoodNormal Heights                  -0.185827   0.062062  -2.994
beds:neighborhoodNorth Clairemont                -0.060468   0.188694  -0.320
beds:neighborhoodNorth Hills                     -0.113150   0.032768  -3.453
beds:neighborhoodNorthwest                        0.116746   0.131088   0.891
beds:neighborhoodOcean Beach                     -0.048848   0.037433  -1.305
beds:neighborhoodOld Town                        -0.158066   0.077352  -2.043
beds:neighborhoodOtay Ranch                       0.071485   0.259986   0.275
beds:neighborhoodPacific Beach                   -0.025064   0.023165  -1.082
beds:neighborhoodPark West                       -0.049627   0.063967  -0.776
beds:neighborhoodRancho Bernadino                 0.270293   0.092164   2.933
beds:neighborhoodRancho Penasquitos               0.011344   0.091156   0.124
beds:neighborhoodRoseville                       -0.085205   0.087365  -0.975
beds:neighborhoodSan Carlos                       0.550169   0.167389   3.287
beds:neighborhoodScripps Ranch                    0.219496   0.122439   1.793
beds:neighborhoodSerra Mesa                      -0.293629   0.189261  -1.551
beds:neighborhoodSouth Park                      -0.020083   0.109799  -0.183
beds:neighborhoodUniversity City                  0.124224   0.062916   1.974
beds:neighborhoodWest University Heights          0.143248   0.096150   1.490
                                                 Pr(&gt;|t|)    
(Intercept)                                       &lt; 2e-16 ***
one:neighborhoodBalboa Park                      0.378810    
one:neighborhoodBay Ho                           0.425887    
one:neighborhoodBay Park                         0.117997    
one:neighborhoodCarmel Valley                    0.699978    
one:neighborhoodCity Heights West                0.639437    
one:neighborhoodClairemont Mesa                  0.000509 ***
one:neighborhoodCollege Area                     0.372180    
one:neighborhoodCore                             0.062939 .  
one:neighborhoodCortez Hill                      0.108871    
one:neighborhoodDel Mar Heights                  0.153795    
one:neighborhoodEast Village                     0.162975    
one:neighborhoodGaslamp Quarter                  4.38e-05 ***
one:neighborhoodGrant Hill                       0.699880    
one:neighborhoodGrantville                       0.202493    
one:neighborhoodKensington                       0.308471    
one:neighborhoodLa Jolla                         0.003001 ** 
one:neighborhoodLa Jolla Village                 0.925835    
one:neighborhoodLinda Vista                      0.026679 *  
one:neighborhoodLittle Italy                     0.041769 *  
one:neighborhoodLoma Portal                      0.921764    
one:neighborhoodMarina                           0.005656 ** 
one:neighborhoodMidtown                          0.595908    
one:neighborhoodMidtown District                 0.412485    
one:neighborhoodMira Mesa                        0.003670 ** 
one:neighborhoodMission Bay                      0.001939 ** 
one:neighborhoodMission Valley                   0.387513    
one:neighborhoodMoreno Mission                   0.227928    
one:neighborhoodNormal Heights                   0.228202    
one:neighborhoodNorth Clairemont                 0.067990 .  
one:neighborhoodNorth Hills                      0.450091    
one:neighborhoodNorthwest                        0.486169    
one:neighborhoodOcean Beach                      0.158381    
one:neighborhoodOld Town                         0.689710    
one:neighborhoodOtay Ranch                       0.124188    
one:neighborhoodPacific Beach                    0.379016    
one:neighborhoodPark West                        0.363079    
one:neighborhoodRancho Bernadino                 0.920756    
one:neighborhoodRancho Penasquitos               0.014041 *  
one:neighborhoodRoseville                        0.511237    
one:neighborhoodSan Carlos                       0.038402 *  
one:neighborhoodScripps Ranch                    0.901090    
one:neighborhoodSerra Mesa                       0.171727    
one:neighborhoodSouth Park                       0.422917    
one:neighborhoodUniversity City                  0.064843 .  
one:neighborhoodWest University Heights                NA    
accommodates:neighborhoodBalboa Park             8.24e-05 ***
accommodates:neighborhoodBay Ho                  0.841129    
accommodates:neighborhoodBay Park                0.014647 *  
accommodates:neighborhoodCarmel Valley           0.002120 ** 
accommodates:neighborhoodCity Heights West       0.341685    
accommodates:neighborhoodClairemont Mesa         2.49e-07 ***
accommodates:neighborhoodCollege Area            0.110943    
accommodates:neighborhoodCore                    0.006535 ** 
accommodates:neighborhoodCortez Hill             7.92e-09 ***
accommodates:neighborhoodDel Mar Heights         0.216716    
accommodates:neighborhoodEast Village            2.74e-15 ***
accommodates:neighborhoodGaslamp Quarter         1.18e-08 ***
accommodates:neighborhoodGrant Hill              7.81e-07 ***
accommodates:neighborhoodGrantville              0.098376 .  
accommodates:neighborhoodKensington              0.609420    
accommodates:neighborhoodLa Jolla                4.61e-15 ***
accommodates:neighborhoodLa Jolla Village        0.063624 .  
accommodates:neighborhoodLinda Vista             0.023963 *  
accommodates:neighborhoodLittle Italy            2.56e-11 ***
accommodates:neighborhoodLoma Portal             0.008879 ** 
accommodates:neighborhoodMarina                   &lt; 2e-16 ***
accommodates:neighborhoodMidtown                  &lt; 2e-16 ***
accommodates:neighborhoodMidtown District        0.000542 ***
accommodates:neighborhoodMira Mesa               0.055697 .  
accommodates:neighborhoodMission Bay             1.99e-10 ***
accommodates:neighborhoodMission Valley          0.459407    
accommodates:neighborhoodMoreno Mission          0.016199 *  
accommodates:neighborhoodNormal Heights          7.97e-06 ***
accommodates:neighborhoodNorth Clairemont        0.024632 *  
accommodates:neighborhoodNorth Hills             8.84e-11 ***
accommodates:neighborhoodNorthwest               0.748867    
accommodates:neighborhoodOcean Beach             6.21e-07 ***
accommodates:neighborhoodOld Town                1.54e-08 ***
accommodates:neighborhoodOtay Ranch              0.796490    
accommodates:neighborhoodPacific Beach            &lt; 2e-16 ***
accommodates:neighborhoodPark West               8.56e-07 ***
accommodates:neighborhoodRancho Bernadino        0.944521    
accommodates:neighborhoodRancho Penasquitos      0.241960    
accommodates:neighborhoodRoseville               0.060803 .  
accommodates:neighborhoodSan Carlos              0.108968    
accommodates:neighborhoodScripps Ranch           0.014369 *  
accommodates:neighborhoodSerra Mesa              0.011955 *  
accommodates:neighborhoodSouth Park              0.002396 ** 
accommodates:neighborhoodUniversity City         0.024659 *  
accommodates:neighborhoodWest University Heights 0.025910 *  
bathrooms:neighborhoodBalboa Park                0.839806    
bathrooms:neighborhoodBay Ho                     0.175338    
bathrooms:neighborhoodBay Park                   0.589509    
bathrooms:neighborhoodCarmel Valley              0.001611 ** 
bathrooms:neighborhoodCity Heights West          0.480243    
bathrooms:neighborhoodClairemont Mesa            0.017643 *  
bathrooms:neighborhoodCollege Area               0.947567    
bathrooms:neighborhoodCore                       0.012753 *  
bathrooms:neighborhoodCortez Hill                0.041784 *  
bathrooms:neighborhoodDel Mar Heights            0.000914 ***
bathrooms:neighborhoodEast Village               3.34e-06 ***
bathrooms:neighborhoodGaslamp Quarter            2.35e-12 ***
bathrooms:neighborhoodGrant Hill                 0.795468    
bathrooms:neighborhoodGrantville                 0.903578    
bathrooms:neighborhoodKensington                 0.437993    
bathrooms:neighborhoodLa Jolla                    &lt; 2e-16 ***
bathrooms:neighborhoodLa Jolla Village           0.363095    
bathrooms:neighborhoodLinda Vista                0.235088    
bathrooms:neighborhoodLittle Italy               0.748992    
bathrooms:neighborhoodLoma Portal                0.022399 *  
bathrooms:neighborhoodMarina                     0.150200    
bathrooms:neighborhoodMidtown                    0.242779    
bathrooms:neighborhoodMidtown District           0.001617 ** 
bathrooms:neighborhoodMira Mesa                  0.245659    
bathrooms:neighborhoodMission Bay                6.00e-07 ***
bathrooms:neighborhoodMission Valley             0.982016    
bathrooms:neighborhoodMoreno Mission             0.321960    
bathrooms:neighborhoodNormal Heights             0.931598    
bathrooms:neighborhoodNorth Clairemont           0.628997    
bathrooms:neighborhoodNorth Hills                0.124417    
bathrooms:neighborhoodNorthwest                  0.048594 *  
bathrooms:neighborhoodOcean Beach                0.165371    
bathrooms:neighborhoodOld Town                   0.367140    
bathrooms:neighborhoodOtay Ranch                 0.520477    
bathrooms:neighborhoodPacific Beach              0.004650 ** 
bathrooms:neighborhoodPark West                  0.065420 .  
bathrooms:neighborhoodRancho Bernadino           0.013384 *  
bathrooms:neighborhoodRancho Penasquitos         0.003566 ** 
bathrooms:neighborhoodRoseville                  0.602221    
bathrooms:neighborhoodSan Carlos                 0.211993    
bathrooms:neighborhoodScripps Ranch              0.434248    
bathrooms:neighborhoodSerra Mesa                 0.053141 .  
bathrooms:neighborhoodSouth Park                 0.656138    
bathrooms:neighborhoodUniversity City            0.269455    
bathrooms:neighborhoodWest University Heights    0.730652    
bedrooms:neighborhoodBalboa Park                 0.005011 ** 
bedrooms:neighborhoodBay Ho                      0.157151    
bedrooms:neighborhoodBay Park                    0.067764 .  
bedrooms:neighborhoodCarmel Valley               0.563507    
bedrooms:neighborhoodCity Heights West           0.123740    
bedrooms:neighborhoodClairemont Mesa             0.702806    
bedrooms:neighborhoodCollege Area                0.609182    
bedrooms:neighborhoodCore                        0.520791    
bedrooms:neighborhoodCortez Hill                 0.002091 ** 
bedrooms:neighborhoodDel Mar Heights             0.253288    
bedrooms:neighborhoodEast Village                0.120105    
bedrooms:neighborhoodGaslamp Quarter             0.000993 ***
bedrooms:neighborhoodGrant Hill                  0.425266    
bedrooms:neighborhoodGrantville                  0.289243    
bedrooms:neighborhoodKensington                  0.094590 .  
bedrooms:neighborhoodLa Jolla                    2.58e-06 ***
bedrooms:neighborhoodLa Jolla Village            0.121520    
bedrooms:neighborhoodLinda Vista                 0.574579    
bedrooms:neighborhoodLittle Italy                0.117274    
bedrooms:neighborhoodLoma Portal                 0.010370 *  
bedrooms:neighborhoodMarina                      0.018431 *  
bedrooms:neighborhoodMidtown                     0.000122 ***
bedrooms:neighborhoodMidtown District            0.512137    
bedrooms:neighborhoodMira Mesa                   0.887701    
bedrooms:neighborhoodMission Bay                 1.26e-09 ***
bedrooms:neighborhoodMission Valley              0.250670    
bedrooms:neighborhoodMoreno Mission              0.610302    
bedrooms:neighborhoodNormal Heights              0.056842 .  
bedrooms:neighborhoodNorth Clairemont            0.336669    
bedrooms:neighborhoodNorth Hills                 1.87e-09 ***
bedrooms:neighborhoodNorthwest                   0.010377 *  
bedrooms:neighborhoodOcean Beach                 6.32e-05 ***
bedrooms:neighborhoodOld Town                    0.036570 *  
bedrooms:neighborhoodOtay Ranch                  0.029299 *  
bedrooms:neighborhoodPacific Beach               0.034919 *  
bedrooms:neighborhoodPark West                   0.247150    
bedrooms:neighborhoodRancho Bernadino            0.190841    
bedrooms:neighborhoodRancho Penasquitos          0.436205    
bedrooms:neighborhoodRoseville                   0.011911 *  
bedrooms:neighborhoodSan Carlos                  0.111073    
bedrooms:neighborhoodScripps Ranch               0.656951    
bedrooms:neighborhoodSerra Mesa                  0.216272    
bedrooms:neighborhoodSouth Park                  0.475443    
bedrooms:neighborhoodUniversity City             0.302694    
bedrooms:neighborhoodWest University Heights     0.907079    
beds:neighborhoodBalboa Park                     0.770871    
beds:neighborhoodBay Ho                          0.780950    
beds:neighborhoodBay Park                        0.918856    
beds:neighborhoodCarmel Valley                   0.256631    
beds:neighborhoodCity Heights West               0.562357    
beds:neighborhoodClairemont Mesa                 0.070055 .  
beds:neighborhoodCollege Area                    0.006717 ** 
beds:neighborhoodCore                            0.307987    
beds:neighborhoodCortez Hill                     0.361302    
beds:neighborhoodDel Mar Heights                 0.764449    
beds:neighborhoodEast Village                    1.86e-05 ***
beds:neighborhoodGaslamp Quarter                 0.470435    
beds:neighborhoodGrant Hill                      0.007960 ** 
beds:neighborhoodGrantville                      0.976078    
beds:neighborhoodKensington                      0.975344    
beds:neighborhoodLa Jolla                        3.10e-06 ***
beds:neighborhoodLa Jolla Village                0.220739    
beds:neighborhoodLinda Vista                     0.662889    
beds:neighborhoodLittle Italy                    1.07e-06 ***
beds:neighborhoodLoma Portal                     0.825463    
beds:neighborhoodMarina                          0.064324 .  
beds:neighborhoodMidtown                         8.90e-05 ***
beds:neighborhoodMidtown District                0.143173    
beds:neighborhoodMira Mesa                       0.388579    
beds:neighborhoodMission Bay                     0.000546 ***
beds:neighborhoodMission Valley                  0.756247    
beds:neighborhoodMoreno Mission                  0.093375 .  
beds:neighborhoodNormal Heights                  0.002763 ** 
beds:neighborhoodNorth Clairemont                0.748634    
beds:neighborhoodNorth Hills                     0.000558 ***
beds:neighborhoodNorthwest                       0.373186    
beds:neighborhoodOcean Beach                     0.191957    
beds:neighborhoodOld Town                        0.041051 *  
beds:neighborhoodOtay Ranch                      0.783359    
beds:neighborhoodPacific Beach                   0.279326    
beds:neighborhoodPark West                       0.437885    
beds:neighborhoodRancho Bernadino                0.003373 ** 
beds:neighborhoodRancho Penasquitos              0.900966    
beds:neighborhoodRoseville                       0.329465    
beds:neighborhoodSan Carlos                      0.001019 ** 
beds:neighborhoodScripps Ranch                   0.073072 .  
beds:neighborhoodSerra Mesa                      0.120848    
beds:neighborhoodSouth Park                      0.854878    
beds:neighborhoodUniversity City                 0.048378 *  
beds:neighborhoodWest University Heights         0.136320    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.478 on 5885 degrees of freedom
Multiple R-squared:  0.6622,    Adjusted R-squared:  0.6494 
F-statistic: 51.51 on 224 and 5885 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>This allows us to get a separate constant term and estimate of the impact of each variable <em>for every neighborhood</em></p>
</section><section id="spatial-dependence" class="level2 page-columns page-full" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="spatial-dependence">
<span class="header-section-number">6.6</span> Spatial dependence</h2>
<p>As we have just discussed, SH is about effects of phenomena that are <em>explicitly linked</em> to geography and that hence cause spatial variation and clustering of values. This encompasses many of the kinds of spatial effects we may be interested in when we fit linear regressions. However, in other cases, our interest is on the effect of the <em>spatial configuration</em> of the observations, and the extent to which that has an effect on the outcome we are considering. For example, we might think that the price of a house not only depends on the number of bathrooms it has but, if we take number of bathrooms as a proxy for size and status, also whether it is surrounded by other houses with many bathrooms. This kind of spatial effect is fundamentally different from SH in that is it not related to inherent characteristics of the geography but relates to the characteristics of the observations in our dataset and, specially, to their spatial arrangement. We call this phenomenon by which the values of observations are related to each other through distance <em>spatial dependence</em> <span class="citation" data-cites="anselin1988spatial">(<a href="#ref-anselin1988spatial" role="doc-biblioref">Anselin 1988</a>)</span>.</p>
<p><strong>Spatial Weights</strong></p>
<p>There are several ways to introduce spatial dependence in an econometric framework, with varying degrees of econometric sophistication <span class="citation" data-cites="anselin2003spatial">(see <a href="#ref-anselin2003spatial" role="doc-biblioref">Anselin 2003</a> for a good overview)</span>. Common to all of them however is the way space is formally encapsulated: through <em>spatial weights matrices (</em><span class="math inline">\(W\)</span>)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> These are <span class="math inline">\(NxN\)</span> matrices with zero diagonals and every <span class="math inline">\(w_{ij}\)</span> cell with a value that represents the degree of spatial connectivity/interaction between observations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>. If they are not connected at all, <span class="math inline">\(w_{ij}=0\)</span>, otherwise <span class="math inline">\(w_{ij}&gt;0\)</span> and we call <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> neighbors. The exact value in the latter case depends on the criterium we use to define neighborhood relations. These matrices also tend to be row-standardized so the sum of each row equals to one.</p>
<div class="no-row-height column-margin column-container"><p><sup>2</sup>&nbsp;If you need to refresh your knowledge on spatial weight matrices, check <a href="https://darribas.org/gds_course/content/bE/concepts_E.html">Block E</a> of <span class="citation" data-cites="darribas_gds_course">Arribas-Bel (<a href="#ref-darribas_gds_course" role="doc-biblioref">2019</a>)</span>; <a href="https://geographicdata.science/book/notebooks/04_spatial_weights.html">Chapter 4</a> of <span class="citation" data-cites="reyABwolf">Rey, Arribas-Bel, and Wolf (<a href="#ref-reyABwolf" role="doc-biblioref">2023</a>)</span>; or the <a href="https://fcorowe.github.io/intro-gds/03-spatial_weights.html">Spatial Weights</a> Section of <span class="citation" data-cites="rowe2022a">Rowe (<a href="#ref-rowe2022a" role="doc-biblioref">2022</a>)</span>.</p></div><p>A related concept to spatial weight matrices is that of <em>spatial lag</em>. This is an operator that multiplies a given variable <span class="math inline">\(y\)</span> by a spatial weight matrix:</p>
<p><span class="math display">\[
y_{lag} = W y
\]</span></p>
<p>If <span class="math inline">\(W\)</span> is row-standardized, <span class="math inline">\(y_{lag}\)</span> is effectively the average value of <span class="math inline">\(y\)</span> in the neighborhood of each observation. The individual notation may help clarify this:</p>
<p><span class="math display">\[
y_{lag-i} = \displaystyle \sum_j w_{ij} y_j
\]</span></p>
<p>where <span class="math inline">\(y_{lag-i}\)</span> is the spatial lag of variable <span class="math inline">\(y\)</span> at location <span class="math inline">\(i\)</span>, and <span class="math inline">\(j\)</span> sums over the entire dataset. If <span class="math inline">\(W\)</span> is row-standardized, <span class="math inline">\(y_{lag-i}\)</span> becomes an average of <span class="math inline">\(y\)</span> weighted by the spatial criterium defined in <span class="math inline">\(W\)</span>.</p>
<p>Given that spatial weights matrices are not the focus of this tutorial, we will stick to a very simple case. Since we are dealing with points, we will use <span class="math inline">\(K\)</span>-nn weights, which take the <span class="math inline">\(k\)</span> nearest neighbors of each observation as neighbors and assign a value of one, assigning everyone else a zero. We will use <span class="math inline">\(k=50\)</span> to get a good degree of variation and sensible results.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create knn list of each house</span></span>
<span><span class="va">hnn</span> <span class="op">&lt;-</span> <span class="va">db</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knearneigh.html">knearneigh</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="co"># Create nb object</span></span>
<span><span class="va">hnb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="va">hnn</span><span class="op">)</span></span>
<span><span class="co"># Create spatial weights matrix (note it row-standardizes by default)</span></span>
<span><span class="va">hknn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">hnb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can inspect the weights created by simply typing the name of the object:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hknn</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Characteristics of weights list object:
Neighbour list object:
Number of regions: 6110 
Number of nonzero links: 305500 
Percentage nonzero weights: 0.8183306 
Average number of links: 50 
Non-symmetric neighbours list

Weights style: W 
Weights constants summary:
     n       nn   S0       S1       S2
W 6110 37332100 6110 220.5032 24924.44</code></pre>
</div>
</div>
<p><strong>Exogenous spatial effects</strong></p>
<p>Let us come back to the house price example we have been working with. So far, we have hypothesized that the price of an AirBnb property in San Diego can be explained using information about its own characteristics, and the neighbourhood it belongs to. However, we can hypothesise that the price of a house is also affected by the characteristics of the houses surrounding it. Considering it as a proxy for larger and more luxurious houses, we will use the number of bathrooms of neighboring houses as an additional explanatory variable. This represents the most straightforward way to introduce spatial dependence in a regression, by considering not only a given explanatory variable, but also its spatial lag.</p>
<p>In our example case, in addition to including the number of bathrooms of the property, we will include its spatial lag. In other words, we will be saying that it is not only the number of bathrooms in a house but also that of the surrounding properties that helps explain the final price at which a house is advertised for. Mathematically, this implies estimating the following model:</p>
<p><span class="math display">\[
\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i+ \beta_5 Bath_{lag-i} + \epsilon_i
\]</span></p>
<p>Let us first compute the spatial lag of <code>bathrooms</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">db</span><span class="op">$</span><span class="va">w_bathrooms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lag.listw.html">lag.listw</a></span><span class="op">(</span><span class="va">hknn</span>, <span class="va">db</span><span class="op">$</span><span class="va">bathrooms</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we can include it in our previous specification. Note that we apply the log to the lag, not the reverse:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  <span class="st">'log_price ~ accommodates + bedrooms + beds + bathrooms + w_bathrooms'</span>,</span>
<span>  <span class="va">db</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = "log_price ~ accommodates + bedrooms + beds + bathrooms + w_bathrooms", 
    data = db)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.8869 -0.3243 -0.0206  0.2931  3.5132 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   3.579448   0.032337 110.692   &lt;2e-16 ***
accommodates  0.173226   0.005233  33.100   &lt;2e-16 ***
bedrooms      0.103116   0.012327   8.365   &lt;2e-16 ***
beds         -0.075071   0.007787  -9.641   &lt;2e-16 ***
bathrooms     0.117268   0.012507   9.376   &lt;2e-16 ***
w_bathrooms   0.353021   0.023572  14.976   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5271 on 6104 degrees of freedom
Multiple R-squared:  0.574, Adjusted R-squared:  0.5736 
F-statistic:  1645 on 5 and 6104 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>As we can see, the lag is not only significative and positive, but its effect seems to be even larger that that of the property itself. Taken literally, this implies that the average number of bathrooms in AirBnb’s nearby has a larger effect on the final price of a given AirBnb than its own number of bathrooms. There are several ways to interpret this. One is that, if we take the spatial lag of bathrooms, as we said above, to be a proxy for the types of houses surrounding a property, this is probably a better predictor of how wealthy an area is than the number of bathrooms of a single property, which is more variable. If we also assume that the area where an AirBnb is located has a bigger effect on price than the number of bathrooms, we can start seeing an answer to the apparent puzzle.</p>
<p><strong>A note on more advanced spatial regression</strong></p>
<p>Introducing a spatial lag of an explanatory variable, as we have just seen, is the most straightforward way of incorporating the notion of spatial dependence in a linear regression framework. It does not require additional changes, it can be estimated with OLS, and the interpretation is rather similar to interpreting non-spatial variables. The field of spatial econometrics however is a much broader one and has produced over the last decades many techniques to deal with spatial effects and spatial dependence in different ways. Although this might be an over simplification, one can say that most of such efforts for the case of a single cross-section are focused on two main variations: the spatial lag and the spatial error model. Both are similar to the case we have seen in that they are based on the introduction of a spatial lag, but they differ in the component of the model they modify and affect.</p>
<p>The spatial lag model introduces a spatial lag of the <em>dependent</em> variable. In the example we have covered, this would translate into:</p>
<p><span class="math display">\[
\log(P_i) = \alpha + \rho \log(P_i) + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<p>Although it might not seem very different from the previous equation, this model violates the exogeneity assumption, crucial for OLS to work.</p>
<p>Equally, the spatial error model includes a spatial lag in the <em>error</em> term of the equation:</p>
<p><span class="math display">\[
\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + u_i
\]</span></p>
<p><span class="math display">\[
u_i = u_{lag-i} + \epsilon_i
\]</span></p>
<p>Again, although similar, one can show this specification violates the assumptions about the error term in a classical OLS model.</p>
<p>Both the spatial lag and error model violate some of the assumptions on which OLS relies and thus render the technique unusable. Much of the efforts have thus focused on coming up with alternative methodologies that allow unbiased, robust, and efficient estimation of such models. A survey of those is beyond the scope of this note, but the interested reader is referred to <span class="citation" data-cites="anselin1988spatial">Anselin (<a href="#ref-anselin1988spatial" role="doc-biblioref">1988</a>)</span>, <span class="citation" data-cites="anselin2003spatial">Anselin (<a href="#ref-anselin2003spatial" role="doc-biblioref">2003</a>)</span>, and <span class="citation" data-cites="anselin2014modern">Anselin and Rey (<a href="#ref-anselin2014modern" role="doc-biblioref">2014</a>)</span> for further reference.</p>
</section><section id="predicting-house-prices" class="level2" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="predicting-house-prices">
<span class="header-section-number">6.7</span> Predicting house prices</h2>
<p>So far, we have seen how to exploit the output of a regression model to evaluate the role different variables play in explaining another one of interest. However, once fit, a model can also be used to obtain predictions of the dependent variable given a new set of values for the explanatory variables. We will finish this session by dipping our toes in predicting with linear models.</p>
<p>The core idea is that once you have estimates for the way in which the explanatory variables can be combined to explain the dependent one, you can plug new values on the explanatory side of the model and combine them following the model estimates to obtain predictions. In the example we have worked with, you can imagine this application would be useful to obtain valuations of a house, given we know its characteristics.</p>
<p>Conceptually, predicting in linear regression models involves using the estimates of the parameters to obtain a value for the dependent variable:</p>
<p><span class="math display">\[
\log(\bar{P_i}) = \bar{\alpha} + \bar{\beta_1} Acc_i^* + \bar{\beta_2} Bath_i^* + \bar{\beta_3} Bedr_i^* + \bar{\beta_4} Beds_i^*
\]</span> where <span class="math inline">\(\log(\bar{P_i})\)</span> is our predicted value, and we include the bar sign to note that it is our estimate obtained from fitting the model. We use the <span class="math inline">\(^*\)</span> sign to note that those can be new values for the explanatory variables, not necessarily those used to fit the model.</p>
<p>Technically speaking, prediction in linear models is relatively streamlined in R. Suppose we are given data for a new house which is to be put on the AirBnb platform. We know it accommodates four people, and has two bedrooms, three beds, and one bathroom. We also know that the surrounding properties have, on average, 1.5 bathrooms. Let us record the data first:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new.house</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  accommodates <span class="op">=</span> <span class="fl">4</span>, </span>
<span>  bedrooms <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  beds <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  bathrooms <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  w_bathrooms <span class="op">=</span> <span class="fl">1.5</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To obtain the prediction for its price, we can use the <code>predict</code> method:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new.price</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m5</span>, <span class="va">new.house</span><span class="op">)</span></span>
<span><span class="va">new.price</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
4.900168 </code></pre>
</div>
</div>
<p>Now remember we were using the log of the price as dependent variable. If we want to recover the actual price of the house, we need to take its exponent:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">new.price</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
134.3123 </code></pre>
</div>
</div>
<p>According to our model, the house would be worth $134.3123448.</p>
<!-- #region -->
</section><section id="questions" class="level2" data-number="6.8"><h2 data-number="6.8" class="anchored" data-anchor-id="questions">
<span class="header-section-number">6.8</span> Questions</h2>
<p>We will be using again the Madrid AirBnb dataset: <!-- #endregion --></p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mad_abb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'./data/assignment_1_madrid/madrid_abb.gpkg'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `madrid_abb' from data source 
  `/Users/franciscorowe/Dropbox/Francisco/uol/teaching/envs453/202324/san/data/assignment_1_madrid/madrid_abb.gpkg' 
  using driver `GPKG'
Simple feature collection with 18399 features and 16 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -3.86391 ymin: 40.33243 xmax: -3.556 ymax: 40.56274
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mad_abb</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "price"           "price_usd"       "log1p_price_usd" "accommodates"   
 [5] "bathrooms_text"  "bathrooms"       "bedrooms"        "beds"           
 [9] "neighbourhood"   "room_type"       "property_type"   "WiFi"           
[13] "Coffee"          "Gym"             "Parking"         "km_to_retiro"   
[17] "geom"           </code></pre>
</div>
</div>
<!-- #region -->
<p>In addition to those we have already seen, the columns to use here are:</p>
<ul>
<li>
<code>neighbourhood</code>: a column with the name of the neighbourhood in which the property is located</li>
</ul>
<p>With this at hand, answer the following questions:</p>
<ol type="1">
<li>Fit a baseline model with only property characteristics explaining the log of price</li>
</ol>
<p><span class="math display">\[
\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<ol start="2" type="1">
<li>Augment the model with fixed effects at the neighbourhood level</li>
</ol>
<p><span class="math display">\[
\log(P_i) = \alpha_r + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i
\]</span></p>
<ol start="3" type="1">
<li>[Optional] Augment the model with spatial regimes at the neighbourhood level:</li>
</ol>
<p><span class="math display">\[
\log(P_i) = \alpha_r + \beta_{r1} Acc_i + \beta_{r2} Bath_i + \beta_{r3} Bedr_i + \beta_{r4} Beds_i + \epsilon_{ri}
\]</span></p>
<ol start="4" type="1">
<li>Fit a model that augments the baseline in 1. with the spatial lag of a variable you consider interesting. Motivate this choice. Note that to complete this, you will need to also generate a spatial weights matrix.</li>
</ol>
<p>In each instance, provide a brief interpretation (no more thana few lines for each) that demonstrates your understanding of theunderlying concepts behind your approach. <!-- #endregion --></p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-anselin1988spatial" class="csl-entry" role="listitem">
Anselin, Luc. 1988. <em>Spatial Econometrics: Methods and Models</em>. Vol. 4. Springer Science &amp; Business Media.
</div>
<div id="ref-anselin2003spatial" class="csl-entry" role="listitem">
———. 2003. <span>“Spatial Externalities, Spatial Multipliers, and Spatial Econometrics.”</span> <em>International Regional Science Review</em> 26 (2): 153–66.
</div>
<div id="ref-anselin2005spatial" class="csl-entry" role="listitem">
———. 2007. <span>“Spatial Regression Analysis in r–a Workbook.”</span> Center for Spatially Integrated Social Science. <a href="http://csiss.org/GISPopSci/workshops/2011/PSU/readings/W15_Anselin2007.pdf">http://csiss.org/GISPopSci/workshops/2011/PSU/readings/W15_Anselin2007.pdf</a>.
</div>
<div id="ref-anselin2014modern" class="csl-entry" role="listitem">
Anselin, Luc, and Sergio J. Rey. 2014. <em>Modern Spatial Econometrics in Practice: A Guide to GeoDa, GeoDaSpace and PySAL</em>. GeoDa Press LLC.
</div>
<div id="ref-arribas2014spatial" class="csl-entry" role="listitem">
Arribas-Bel, Dani. 2014. <span>“Spatial Data, Analysis, and Regression-a Mini Course.”</span> <em>REGION</em> 1 (1): R1. <a href="http://darribas.org/sdar_mini">http://darribas.org/sdar_mini</a>.
</div>
<div id="ref-darribas_gds_course" class="csl-entry" role="listitem">
———. 2019. <span>“A Course on Geographic Data Science.”</span> <em>The Journal of Open Source Education</em> 2 (14). https://doi.org/<a href="https://doi.org/10.21105/jose.00042">https://doi.org/10.21105/jose.00042</a>.
</div>
<div id="ref-gelman2006data" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2006. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.
</div>
<div id="ref-gibbons2014spatial" class="csl-entry" role="listitem">
Gibbons, Stephen, Henry G Overman, and Eleonora Patacchini. 2014. <span>“Spatial Methods.”</span>
</div>
<div id="ref-reyABwolf" class="csl-entry" role="listitem">
Rey, Sergio J., Daniel Arribas-Bel, and Levi J. Wolf. 2023. <em>Geographic Data Science with PySAL and the PyData Stack</em>. CRC press.
</div>
<div id="ref-rowe2022a" class="csl-entry" role="listitem">
Rowe, Francisco. 2022. <span>“Introduction to Geographic Data Science.”</span> <em>Open Science Framework</em>, August. <a href="https://doi.org/10.17605/OSF.IO/VHY2P">https://doi.org/10.17605/OSF.IO/VHY2P</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./05-flows.html" class="pagination-link  aria-label=" interaction="" modelling="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spatial Interaction Modelling</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./07-multilevel-01.html" class="pagination-link" aria-label="<span class='chapter-number'>7</span>&nbsp; <span class='chapter-title'>Multilevel Modelling - Part 1</span>">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multilevel Modelling - Part 1</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial Econometrics {#sec-chp6}</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>This chapter is based on the following references, which are good follow-up's on the topic:</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Chapter 11</span><span class="co">](https://geographicdata.science/book/notebooks/11_regression.html)</span> of the GDS Book, by @reyABwolf.</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">Session III</span><span class="co">](http://darribas.org/sdar_mini/notes/Class_03.html)</span> of @arribas2014spatial. Check the "Related readings" section on the session page for more in-depth discussions.</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>@anselin2005spatial, freely available to download <span class="sc">\[</span><span class="co">[</span><span class="ot">`pdf`</span><span class="co">](https://dces.wisc.edu/wp-content/uploads/sites/128/2013/08/W14_Anselin2007.pdf)</span><span class="sc">\]</span>.</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The second part of this tutorial assumes you have reviewed <span class="co">[</span><span class="ot">the Spatial Weights Section</span><span class="co">](https://darribas.org/gds_course/content/bE/concepts_E.html)</span> of @darribas_gds_course.</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu">## Dependencies</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>We will rely on the following libraries in this section, all of them included in @sec-dependencies:</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Data management</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Data management</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co"># For all your interpolation needs</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial regression</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>To explore ideas in spatial regression, we will the set of Airbnb properties for San Diego (US), borrowed from the "Geographic Data Science with Python" book (see <span class="co">[</span><span class="ot">here</span><span class="co">](https://geographicdata.science/book/data/airbnb/regression_cleaning.html)</span> for more info on the dataset source). This covers the point location of properties advertised on the Airbnb website in the San Diego region.</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>Let us load the data:</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">'data/abb_sd/regression_db.geojson'</span>)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>The table contains the followig variables:</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(db)</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>For most of this chapter, we will be exploring determinants and strategies for modelling the price of a property advertised in AirBnb. To get a first taste of what this means, we can create a plot of prices within the area of San Diego:</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">color =</span> price)) <span class="sc">+</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span> </span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Non-spatial regression, a refresh</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>Before we discuss how to explicitly include space into the linear regression framework, let us show how basic regression can be carried out in R, and how you can interpret the results. By no means is this a formal and complete introduction to regression so, if that is what you are looking for, the first part of @gelman2006data, in particular chapters 3 and 4, are excellent places to check out.</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>The core idea of linear regression is to explain the variation in a given (*dependent*) variable as a linear function of a series of other (*explanatory*) variables. For example, in our case, we may want to express/explain the price of a property advertised on AirBnb as a function of some of its characteristics, such as the number of people it accommodates, and how many bathrooms, bedrooms and beds it features. At the individual level, we can express this as:</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>where $P_i$ is the price of house $i$, $Acc_i$, $Bath_i$, $Bedr_i$ and $Beds_i$ are the count of people it accommodates, bathrooms, bedrooms and beds that house $i$ has, respectively. The parameters $\beta_{1,2, 3, 4}$ give us information about in which way and to what extent each variable is related to the price, and $\alpha$, the constant term, is the average house price when all the other variables are zero. The term $\epsilon_i$ is usually referred to as the "error" and captures elements that influence the price of a house but are not accounted for explicitly. We can also express this relation in matrix form, excluding subindices for $i$ as:</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>\log(P) = \alpha + \beta_1 Acc + \beta_2 Bath + \beta_3 Bedr + \beta_4 Beds + \epsilon</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>$$ where each term can be interpreted in terms of vectors instead of scalars (wit the exception of the parameters $(\alpha, \beta_{1, 2, 3, 4})$, which *are* scalars). Note we are using the logarithm of the price, since this allows us to interpret the coefficients as roughly the percentage change induced by a unit increase in the explanatory variable of the estimate.</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>Remember a regression can be seen as a multivariate extension of bivariate correlations. Indeed, one way to interpret the $\beta_k$ coefficients in the equation above is as the degree of correlation between the explanatory variable $k$ and the dependent variable, *keeping all the other explanatory variables constant*. When you calculate simple bivariate correlations, the coefficient of a variable is picking up the correlation between the variables, but it is also subsuming into it variation associated with other correlated variables --also called confounding factors\[\^06-spatial-econometrics-1\]. Regression allows you to isolate the distinct effect that a single variable has on the dependent one, once we *control* for those other variables.</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>::: column-margin</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip appearance="simple" icon="false"}</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>**Task**</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>Assume that new houses tend to be built more often in areas with low deprivation. If that is the case, then $NEW$ and $IMD$ will be correlated with each other (as well as with the price of a house, as we are hypothesizing in this case). If we calculate a simple correlation between $P$ and $IMD$, the coefficient will represent the degree of association between both variables, but it will also include some of the association between $IMD$ and $NEW$. That is, part of the obtained correlation coefficient will be due not to the fact that higher prices tend to be found in areas with low IMD, but to the fact that new houses tend to be more expensive. This is because (in this example) new houses tend to be built in areas with low deprivation and simple bivariate correlation cannot account for that.</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>Practically speaking, running linear regressions in <span class="in">`R`</span> is straightforward. For example, to fit the model specified in the equation above, we only need one line of code:</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="st">'log_price ~ accommodates + bathrooms + bedrooms + beds'</span>, db)</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>We use the command <span class="in">`lm`</span>, for linear model, and specify the equation we want to fit using a string that relates the dependent variable (the log of the price, <span class="in">`log_price`</span>) with a set of explanatory ones (<span class="in">`accommodates`</span>, <span class="in">`bathrooms`</span>, <span class="in">`bedrooms`</span>, <span class="in">`beds`</span>) by using a tilde <span class="in">`~`</span> that is akin to the $=$ symbol in the mathematical equation above. Since we are using names of variables that are stored in a table, we need to pass the table object (<span class="in">`db`</span>) as well.</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>In order to inspect the results of the model, the quickest way is to call <span class="in">`summary`</span>:</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>A full detailed explanation of the output is beyond the scope of the chapter, but we will highlight the relevant bits for our main purpose. This is concentrated on the <span class="in">`Coefficients`</span> section, which gives us the estimates for the $\beta_k$ coefficients in our model. These estimates are the raw equivalent of the correlation coefficient between each explanatory variable and the dependent one, once the "polluting" effect of the other variables included in the model has been accounted for<span class="ot">[^06-spatial-econometrics-1]</span>. Results are as expected for the most part: houses tend to be significantly more expensive if they accommodate more people (an extra person increases the price by <span class="in">`r round(m1$coefficients[["accommodates"]], 3) * 100`</span>%, approximately), have more bathrooms (<span class="in">`r round(m1$coefficients[["bathrooms"]], 3) * 100`</span>%), or bedrooms (<span class="in">`r round(m1$coefficients[["bedrooms"]], 3) * 100`</span>%). Perhaps counter intuitively, an extra bed available seems to decrease the price by about <span class="in">`r round(m1$coefficients[["beds"]], 3) * 100`</span>%. However, keep in mind that this is the case, *everything else equal*. Hence, more beds per room and bathroom (ie. a more crowded house) is a bit cheaper.</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a><span class="ot">[^06-spatial-econometrics-1]: </span>Keep in mind that regression is no magic. We are only discounting the effect of other confounding factors that we include in the model, not of *all* potentially confounding factors.</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial regression: a (very) first dip</span></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>Spatial regression is about *explicitly* introducing space or geographical context into the statistical framework of a regression. Conceptually, we want to introduce space into our model whenever we think it plays an important role in the process we are interested in, or when space can act as a reasonable proxy for other factors we cannot but should include in our model. As an example of the former, we can imagine how houses at the seafront are probably more expensive than those in the second row, given their better views. To illustrate the latter, we can think of how the character of a neighborhood is important in determining the price of a house; however, it is very hard to identify and quantify "character" per se, although it might be easier to get at its spatial variation, hence a case of space as a proxy.</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>Spatial regression is a large field of development in the econometrics and statistics literature. In this brief introduction, we will consider two related but very different processes that give rise to spatial effects: spatial heterogeneity and spatial dependence. For more rigorous treatments of the topics introduced here, the reader is referred to @anselin2003spatial, @anselin2014modern, and @gibbons2014spatial.</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial heterogeneity</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>Spatial heterogeneity (SH) arises when we cannot safely assume the process we are studying operates under the same "rules" throughout the geography of interest. In other words, we can observe SH when there are effects on the outcome variable that are intrinsically linked to specific locations. A good example of this is the case of seafront houses above: we are trying to model the price of a house and, the fact some houses are located under certain conditions (i.e. by the sea), makes their price behave differently. This somewhat abstract concept of SH can be made operational in a model in several ways. We will explore the following two: spatial fixed-effects (FE); and spatial regimes, which is a generalization of FE.</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>**Spatial FE**</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>Let us consider the house price example from the previous section to introduce a more general illustration that relates to the second motivation for spatial effects ("space as a proxy"). Given we are only including two explanatory variables in the model, it is likely we are missing some important factors that play a role at determining the price at which a house is sold. Some of them, however, are likely to vary systematically over space (e.g. different neighborhood characteristics). If that is the case, we can control for those unobserved factors by using traditional dummy variables but basing their creation on a spatial rule. For example, let us include a binary variable for every neighbourhood, as provided by AirBnB, indicating whether a given house is located within such area (<span class="in">`1`</span>) or not (<span class="in">`0`</span>). Neighbourhood membership is expressed on the <span class="in">`neighborhood`</span> column:</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>db <span class="sc">%&gt;%</span></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">color =</span> neighborhood)) <span class="sc">+</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span> </span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>Mathematically, we are now fitting the following equation:</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha_r + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>where the main difference is that we are now allowing the constant term, $\alpha$, to vary by neighbourhood $r$, $\alpha_r$.</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>Programmatically, we can fit this model with <span class="in">`lm`</span>:</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Include `-1` to eliminate the constant term and include a dummy for every area</span></span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>  <span class="st">'log_price ~ neighborhood + accommodates + bathrooms + bedrooms + beds - 1'</span>, </span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>  db</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>Econometrically speaking, what the postcode FE we have introduced imply is that, instead of comparing all house prices across San Diego as equal, we only derive variation from *within* each postcode. In our particular case, estimating spatial FE in our particular example also gives you an indirect measure of area *desirability*: since they are simple dummies in a regression explaining the price of a house, their estimate tells us about how much people are willing to pay to live in a given area. We can visualise this "geography of desirability" by plotting the estimates of each fixed effect on a map:</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract neighborhood names from coefficients</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>nei.names <span class="ot">&lt;-</span> m2<span class="sc">$</span>coefficients <span class="sc">%&gt;%</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">row.names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace</span>(<span class="st">"neighborhood"</span>, <span class="st">""</span>)</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up as Data Frame</span></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>nei.fes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef =</span> m2<span class="sc">$</span>coefficients,</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>  <span class="at">nei =</span> nei.names,</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> nei.names</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>    db, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"nei"</span> <span class="ot">=</span> <span class="st">"neighborhood"</span>)</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>nei.fes <span class="sc">%&gt;%</span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">color =</span> coef)) <span class="sc">+</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>We can see how neighborhoods in the left (west) tend to have higher prices. What we can't see, but it is represented there if you are familiar with the geography of San Diego, is that the city is bounded by the Pacific ocean on the left, suggesting neighbourhoods by the beach tend to be more expensive.</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>Remember that the interpretation of a $\beta_k$ coefficient is the effect of variable $k$, *given all the other explanatory variables included remain constant*. By including a single variable for each area, we are effectively forcing the model to compare as equal only house prices that share the same value for each variable; in other words, only houses located within the same area. Introducing FE affords you a higher degree of isolation of the effects of the variables you introduce in your model because you can control for unobserved effects that align spatially with the distribution of the FE you introduce (by neighbourhood, in our case).</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>**Spatial regimes**</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>At the core of estimating spatial FEs is the idea that, instead of assuming the dependent variable behaves uniformly over space, there are systematic effects following a geographical pattern that affect its behaviour. In other words, spatial FEs introduce econometrically the notion of spatial heterogeneity. They do this in the simplest possible form: by allowing the constant term to vary geographically. The other elements of the regression are left untouched and hence apply uniformly across space. The idea of spatial regimes (SRs) is to generalize the spatial FE approach to allow not only the constant term to vary but also any other explanatory variable. This implies that the equation we will be estimating is: $$\log(P_i) = \alpha_r + \beta_{1r} Acc_i + \beta_{2r} Bath_i + \beta_{3r} Bedr_i + \beta_{4r} Beds_i + \epsilon_i$$</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>where we are not only allowing the constant term to vary by region ($\alpha_r$), but also every other parameter ($\beta_{kr}$).</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>Also, given we are going to allow *every* coefficient to vary by regime, we will need to explicitly set a constant term that we can allow to vary:</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>one <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>Then, the estimation leverages the capabilities in model description of R formulas:</span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a><span class="co"># `:` notation implies interaction variables</span></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>  <span class="st">'log_price ~ (one + accommodates + bathrooms + bedrooms + beds):(neighborhood)'</span>, </span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>  db</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m3)</span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>This allows us to get a separate constant term and estimate of the impact of each variable *for every neighborhood*</span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial dependence</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>As we have just discussed, SH is about effects of phenomena that are *explicitly linked* to geography and that hence cause spatial variation and clustering of values. This encompasses many of the kinds of spatial effects we may be interested in when we fit linear regressions. However, in other cases, our interest is on the effect of the *spatial configuration* of the observations, and the extent to which that has an effect on the outcome we are considering. For example, we might think that the price of a house not only depends on the number of bathrooms it has but, if we take number of bathrooms as a proxy for size and status, also whether it is surrounded by other houses with many bathrooms. This kind of spatial effect is fundamentally different from SH in that is it not related to inherent characteristics of the geography but relates to the characteristics of the observations in our dataset and, specially, to their spatial arrangement. We call this phenomenon by which the values of observations are related to each other through distance *spatial dependence* <span class="co">[</span><span class="ot">@anselin1988spatial</span><span class="co">]</span>.</span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>**Spatial Weights**</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>There are several ways to introduce spatial dependence in an econometric framework, with varying degrees of econometric sophistication <span class="co">[</span><span class="ot">see @anselin2003spatial for a good overview</span><span class="co">]</span>. Common to all of them however is the way space is formally encapsulated: through *spatial weights matrices (*$W$)<span class="ot">[^06-spatial-econometrics-2]</span> These are $NxN$ matrices with zero diagonals and every $w_{ij}$ cell with a value that represents the degree of spatial connectivity/interaction between observations $i$ and $j$. If they are not connected at all, $w_{ij}=0$, otherwise $w_{ij}&gt;0$ and we call $i$ and $j$ neighbors. The exact value in the latter case depends on the criterium we use to define neighborhood relations. These matrices also tend to be row-standardized so the sum of each row equals to one.</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a><span class="ot">[^06-spatial-econometrics-2]: </span>If you need to refresh your knowledge on spatial weight matrices, check <span class="co">[</span><span class="ot">Block E</span><span class="co">](https://darribas.org/gds_course/content/bE/concepts_E.html)</span> of @darribas_gds_course; <span class="co">[</span><span class="ot">Chapter 4</span><span class="co">](https://geographicdata.science/book/notebooks/04_spatial_weights.html)</span> of @reyABwolf; or the <span class="co">[</span><span class="ot">Spatial Weights</span><span class="co">](https://fcorowe.github.io/intro-gds/03-spatial_weights.html)</span> Section of @rowe2022a.</span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>A related concept to spatial weight matrices is that of *spatial lag*. This is an operator that multiplies a given variable $y$ by a spatial weight matrix:</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>y_{lag} = W y</span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>If $W$ is row-standardized, $y_{lag}$ is effectively the average value of $y$ in the neighborhood of each observation. The individual notation may help clarify this:</span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>y_{lag-i} = \displaystyle \sum_j w_{ij} y_j</span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>where $y_{lag-i}$ is the spatial lag of variable $y$ at location $i$, and $j$ sums over the entire dataset. If $W$ is row-standardized, $y_{lag-i}$ becomes an average of $y$ weighted by the spatial criterium defined in $W$.</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>Given that spatial weights matrices are not the focus of this tutorial, we will stick to a very simple case. Since we are dealing with points, we will use $K$-nn weights, which take the $k$ nearest neighbors of each observation as neighbors and assign a value of one, assigning everyone else a zero. We will use $k=50$ to get a good degree of variation and sensible results.</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Create knn list of each house</span></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>hnn <span class="ot">&lt;-</span> db <span class="sc">%&gt;%</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">knearneigh</span>(<span class="at">k =</span> <span class="dv">50</span>)</span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Create nb object</span></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>hnb <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(hnn)</span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a><span class="co"># Create spatial weights matrix (note it row-standardizes by default)</span></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>hknn <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(hnb)</span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>We can inspect the weights created by simply typing the name of the object:</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a>hknn</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a>**Exogenous spatial effects**</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a>Let us come back to the house price example we have been working with. So far, we have hypothesized that the price of an AirBnb property in San Diego can be explained using information about its own characteristics, and the neighbourhood it belongs to. However, we can hypothesise that the price of a house is also affected by the characteristics of the houses surrounding it. Considering it as a proxy for larger and more luxurious houses, we will use the number of bathrooms of neighboring houses as an additional explanatory variable. This represents the most straightforward way to introduce spatial dependence in a regression, by considering not only a given explanatory variable, but also its spatial lag.</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>In our example case, in addition to including the number of bathrooms of the property, we will include its spatial lag. In other words, we will be saying that it is not only the number of bathrooms in a house but also that of the surrounding properties that helps explain the final price at which a house is advertised for. Mathematically, this implies estimating the following model:</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i+ \beta_5 Bath_{lag-i} + \epsilon_i</span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>Let us first compute the spatial lag of <span class="in">`bathrooms`</span>:</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>db<span class="sc">$</span>w_bathrooms <span class="ot">&lt;-</span> <span class="fu">lag.listw</span>(hknn, db<span class="sc">$</span>bathrooms)</span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a>And then we can include it in our previous specification. Note that we apply the log to the lag, not the reverse:</span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a>  <span class="st">'log_price ~ accommodates + bedrooms + beds + bathrooms + w_bathrooms'</span>,</span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>  db</span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m5)</span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>As we can see, the lag is not only significative and positive, but its effect seems to be even larger that that of the property itself. Taken literally, this implies that the average number of bathrooms in AirBnb's nearby has a larger effect on the final price of a given AirBnb than its own number of bathrooms. There are several ways to interpret this. One is that, if we take the spatial lag of bathrooms, as we said above, to be a proxy for the types of houses surrounding a property, this is probably a better predictor of how wealthy an area is than the number of bathrooms of a single property, which is more variable. If we also assume that the area where an AirBnb is located has a bigger effect on price than the number of bathrooms, we can start seeing an answer to the apparent puzzle.</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>**A note on more advanced spatial regression**</span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>Introducing a spatial lag of an explanatory variable, as we have just seen, is the most straightforward way of incorporating the notion of spatial dependence in a linear regression framework. It does not require additional changes, it can be estimated with OLS, and the interpretation is rather similar to interpreting non-spatial variables. The field of spatial econometrics however is a much broader one and has produced over the last decades many techniques to deal with spatial effects and spatial dependence in different ways. Although this might be an over simplification, one can say that most of such efforts for the case of a single cross-section are focused on two main variations: the spatial lag and the spatial error model. Both are similar to the case we have seen in that they are based on the introduction of a spatial lag, but they differ in the component of the model they modify and affect.</span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>The spatial lag model introduces a spatial lag of the *dependent* variable. In the example we have covered, this would translate into:</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \rho \log(P_i) + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>Although it might not seem very different from the previous equation, this model violates the exogeneity assumption, crucial for OLS to work.</span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>Equally, the spatial error model includes a spatial lag in the *error* term of the equation:</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + u_i</span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>u_i = u_{lag-i} + \epsilon_i</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>Again, although similar, one can show this specification violates the assumptions about the error term in a classical OLS model.</span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>Both the spatial lag and error model violate some of the assumptions on which OLS relies and thus render the technique unusable. Much of the efforts have thus focused on coming up with alternative methodologies that allow unbiased, robust, and efficient estimation of such models. A survey of those is beyond the scope of this note, but the interested reader is referred to @anselin1988spatial, @anselin2003spatial, and @anselin2014modern for further reference.</span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicting house prices</span></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>So far, we have seen how to exploit the output of a regression model to evaluate the role different variables play in explaining another one of interest. However, once fit, a model can also be used to obtain predictions of the dependent variable given a new set of values for the explanatory variables. We will finish this session by dipping our toes in predicting with linear models.</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>The core idea is that once you have estimates for the way in which the explanatory variables can be combined to explain the dependent one, you can plug new values on the explanatory side of the model and combine them following the model estimates to obtain predictions. In the example we have worked with, you can imagine this application would be useful to obtain valuations of a house, given we know its characteristics.</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>Conceptually, predicting in linear regression models involves using the estimates of the parameters to obtain a value for the dependent variable:</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a>\log(\bar{P_i}) = \bar{\alpha} + \bar{\beta_1} Acc_i^* + \bar{\beta_2} Bath_i^* + \bar{\beta_3} Bedr_i^* + \bar{\beta_4} Beds_i^*</span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>where $\log(\bar{P_i})$ is our predicted value, and we include the bar sign to note that it is our estimate obtained from fitting the model. We use the $^*$ sign to note that those can be new values for the explanatory variables, not necessarily those used to fit the model.</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>Technically speaking, prediction in linear models is relatively streamlined in R. Suppose we are given data for a new house which is to be put on the AirBnb platform. We know it accommodates four people, and has two bedrooms, three beds, and one bathroom. We also know that the surrounding properties have, on average, 1.5 bathrooms. Let us record the data first:</span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>new.house <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>  <span class="at">accommodates =</span> <span class="dv">4</span>, </span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a>  <span class="at">bedrooms =</span> <span class="dv">2</span>,</span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a>  <span class="at">beds =</span> <span class="dv">3</span>,</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>  <span class="at">bathrooms =</span> <span class="dv">1</span>,</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a>  <span class="at">w_bathrooms =</span> <span class="fl">1.5</span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a>To obtain the prediction for its price, we can use the <span class="in">`predict`</span> method:</span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a>new.price <span class="ot">&lt;-</span> <span class="fu">predict</span>(m5, new.house)</span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a>new.price</span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a>Now remember we were using the log of the price as dependent variable. If we want to recover the actual price of the house, we need to take its exponent:</span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(new.price)</span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>According to our model, the house would be worth \$<span class="in">`r exp(new.price)`</span>.</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #region --&gt;</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a>We will be using again the Madrid AirBnb dataset: <span class="co">&lt;!-- #endregion --&gt;</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>mad_abb <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">'./data/assignment_1_madrid/madrid_abb.gpkg'</span>)</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(mad_abb)</span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #region --&gt;</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>In addition to those we have already seen, the columns to use here are:</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`neighbourhood`</span>: a column with the name of the neighbourhood in which the property is located</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>With this at hand, answer the following questions:</span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Fit a baseline model with only property characteristics explaining the log of price</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Augment the model with fixed effects at the neighbourhood level</span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha_r + \beta_1 Acc_i + \beta_2 Bath_i + \beta_3 Bedr_i + \beta_4 Beds_i + \epsilon_i</span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span><span class="sc">\[</span>Optional<span class="sc">\]</span> Augment the model with spatial regimes at the neighbourhood level:</span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a>\log(P_i) = \alpha_r + \beta_{r1} Acc_i + \beta_{r2} Bath_i + \beta_{r3} Bedr_i + \beta_{r4} Beds_i + \epsilon_{ri}</span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Fit a model that augments the baseline in 1. with the spatial lag of a variable you consider interesting. Motivate this choice. Note that to complete this, you will need to also generate a spatial weights matrix.</span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>In each instance, provide a brief interpretation (no more thana few lines for each) that demonstrates your understanding of theunderlying concepts behind your approach. <span class="co">&lt;!-- #endregion --&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/GDSL-UL/san/edit/main/06-spatial-econometrics.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/GDSL-UL/san/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>