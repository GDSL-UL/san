<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Points | Spatial Analysis Notes</title>
  <meta name="description" content="Materials for a Spatial Analysis course in R." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Points | Spatial Analysis Notes" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Materials for a Spatial Analysis course in R." />
  <meta name="github-repo" content="gdsl-ul/san" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Points | Spatial Analysis Notes" />
  
  <meta name="twitter:description" content="Materials for a Spatial Analysis course in R." />
  

<meta name="author" content="Francisco Rowe-Gonzalez &amp; Dani Arribas-Bel" />


<meta name="date" content="2020-02-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="flows.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Spatial Analysis Notes</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="points.html"><a href="points.html"><i class="fa fa-check"></i><b>3</b> Points</a><ul>
<li class="chapter" data-level="3.1" data-path="points.html"><a href="points.html#dependencies"><i class="fa fa-check"></i><b>3.1</b> Dependencies</a></li>
<li class="chapter" data-level="3.2" data-path="points.html"><a href="points.html#data"><i class="fa fa-check"></i><b>3.2</b> Data</a></li>
<li class="chapter" data-level="3.3" data-path="points.html"><a href="points.html#kde"><i class="fa fa-check"></i><b>3.3</b> KDE</a><ul>
<li class="chapter" data-level="3.3.1" data-path="points.html"><a href="points.html#one-dimensional-kde"><i class="fa fa-check"></i><b>3.3.1</b> One-dimensional KDE</a></li>
<li class="chapter" data-level="3.3.2" data-path="points.html"><a href="points.html#two-dimensional-spatial-kde"><i class="fa fa-check"></i><b>3.3.2</b> Two-dimensional (spatial) KDE</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="points.html"><a href="points.html#spatial-interpolation"><i class="fa fa-check"></i><b>3.4</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="3.4.1" data-path="points.html"><a href="points.html#inverse-distance-weight-idw-interpolation"><i class="fa fa-check"></i><b>3.4.1</b> Inverse Distance Weight (IDW) interpolation</a></li>
<li class="chapter" data-level="3.4.2" data-path="points.html"><a href="points.html#a-surface-of-housing-prices"><i class="fa fa-check"></i><b>3.4.2</b> A surface of housing prices</a></li>
<li class="chapter" data-level="3.4.3" data-path="points.html"><a href="points.html#what-should-the-next-houses-price-be"><i class="fa fa-check"></i><b>3.4.3</b> <em>“What should the next house’s price be?”</em></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="flows.html"><a href="flows.html"><i class="fa fa-check"></i><b>4</b> Flows</a></li>
<li class="chapter" data-level="5" data-path="spatial-econometrics.html"><a href="spatial-econometrics.html"><i class="fa fa-check"></i><b>5</b> Spatial Econometrics</a></li>
<li class="chapter" data-level="6" data-path="multilevel-models-pt-i.html"><a href="multilevel-models-pt-i.html"><i class="fa fa-check"></i><b>6</b> Multilevel Models (Pt. I)</a></li>
<li class="chapter" data-level="7" data-path="multilevel-models-pt-ii.html"><a href="multilevel-models-pt-ii.html"><i class="fa fa-check"></i><b>7</b> Multilevel Models (Pt. II)</a></li>
<li class="chapter" data-level="8" data-path="gwr.html"><a href="gwr.html"><i class="fa fa-check"></i><b>8</b> GWR</a></li>
<li class="chapter" data-level="9" data-path="space-time-analysis.html"><a href="space-time-analysis.html"><i class="fa fa-check"></i><b>9</b> Space-Time Analysis</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Analysis Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="points" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Points</h1>
<p>This session<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> is based on the following references, which are great follow-up’s on the topic:</p>
<ul>
<li><span class="citation">Lovelace and Cheshire (<a href="#ref-lovelace2014introduction" role="doc-biblioref">2014</a>)</span> is a great introduction.</li>
<li>Chapter 6 of <span class="citation">Brunsdon and Comber (<a href="#ref-comber2015" role="doc-biblioref">2015</a>)</span>, in particular subsections 6.3 and 6.7.</li>
<li><span class="citation">Bivand, Pebesma, and Gómez-Rubio (<a href="#ref-bivand2013applied" role="doc-biblioref">2013</a>)</span> provides an in-depth treatment of spatial data in R.</li>
</ul>
<p>This tutorial is part of <a href="index.html">Spatial Analysis Notes</a>, a compilation hosted as a GitHub repository that you can access it in a few ways:</p>
<ul>
<li>As a <a href="https://github.com/darribas/spa_notes/archive/master.zip">download</a> of a <code>.zip</code> file that contains all the materials.</li>
<li>As an <a href="http://darribas.org/spa_notes/points.html">html
website</a>.</li>
<li>As a <a href="https://github.com/darribas/spa_notes/raw/master/points_book.pdf">pdf
document</a></li>
<li>As a <a href="https://github.com/darribas/spa_notes">GitHub repository</a>.</li>
</ul>
<div id="dependencies" class="section level2">
<h2><span class="header-section-number">3.1</span> Dependencies</h2>
<p>This tutorial relies on the following libraries that you will need to have installed on your machine to be able to interactively follow along<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. Once installed, load them up with the following commands:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="points.html#cb1-1"></a><span class="co"># Layout</span></span>
<span id="cb1-2"><a href="points.html#cb1-2"></a><span class="kw">library</span>(tufte)</span>
<span id="cb1-3"><a href="points.html#cb1-3"></a><span class="co"># For pretty table</span></span>
<span id="cb1-4"><a href="points.html#cb1-4"></a><span class="kw">library</span>(knitr)</span>
<span id="cb1-5"><a href="points.html#cb1-5"></a><span class="co"># Spatial Data management</span></span>
<span id="cb1-6"><a href="points.html#cb1-6"></a><span class="kw">library</span>(rgdal)</span></code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## rgdal: version: 1.4-4, (SVN revision 833)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.2.3, released 2017/11/20
##  Path to GDAL shared files: /usr/share/gdal/2.2
##  GDAL binary built with GEOS: TRUE 
##  Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]
##  Path to PROJ.4 shared files: (autodetected)
##  Linking to sp version: 1.3-1</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="points.html#cb4-1"></a><span class="co"># Pretty graphics</span></span>
<span id="cb4-2"><a href="points.html#cb4-2"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb4-3"><a href="points.html#cb4-3"></a><span class="co"># Thematic maps</span></span>
<span id="cb4-4"><a href="points.html#cb4-4"></a><span class="kw">library</span>(tmap)</span>
<span id="cb4-5"><a href="points.html#cb4-5"></a><span class="co"># Pretty maps</span></span>
<span id="cb4-6"><a href="points.html#cb4-6"></a><span class="kw">library</span>(ggmap)</span></code></pre></div>
<pre><code>## Google&#39;s Terms of Service: https://cloud.google.com/maps-platform/terms/.</code></pre>
<pre><code>## Please cite ggmap if you use it! See citation(&quot;ggmap&quot;) for details.</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="points.html#cb7-1"></a><span class="co"># Various GIS utilities</span></span>
<span id="cb7-2"><a href="points.html#cb7-2"></a><span class="kw">library</span>(GISTools)</span></code></pre></div>
<pre><code>## Loading required package: maptools</code></pre>
<pre><code>## Checking rgeos availability: TRUE</code></pre>
<pre><code>## Loading required package: RColorBrewer</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: rgeos</code></pre>
<pre><code>## rgeos version: 0.5-1, (SVN revision 614)
##  GEOS runtime version: 3.6.2-CAPI-1.10.2 
##  Linking to sp version: 1.3-1 
##  Polygon checking: TRUE</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="points.html#cb14-1"></a><span class="co"># For all your interpolation needs</span></span>
<span id="cb14-2"><a href="points.html#cb14-2"></a><span class="kw">library</span>(gstat)</span></code></pre></div>
<pre><code>## Registered S3 method overwritten by &#39;xts&#39;:
##   method     from
##   as.zoo.xts zoo</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="points.html#cb16-1"></a><span class="co"># For data manipulation</span></span>
<span id="cb16-2"><a href="points.html#cb16-2"></a><span class="kw">library</span>(plyr)</span></code></pre></div>
<p>Before we start any analysis, let us set the path to the directory where we are working. We can easily do that with <code>setwd()</code>. Please replace in the following line the path to the folder where you have placed this file -and where the <code>house_transactions</code> folder with the data lives.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="points.html#cb17-1"></a><span class="co">#setwd(&#39;/media/dani/baul/AAA/Documents/teaching/u-lvl/2016/envs453/code&#39;)</span></span>
<span id="cb17-2"><a href="points.html#cb17-2"></a><span class="kw">setwd</span>(<span class="st">&#39;.&#39;</span>)</span></code></pre></div>
</div>
<div id="data" class="section level2">
<h2><span class="header-section-number">3.2</span> Data</h2>
<p>For this session, we will use a subset of residential property transaction data for the city of Liverpool. These are provided by the Land Registry (as part of their <a href="https://www.gov.uk/government/collections/price-paid-data">Price Paid Data</a>) but have been cleaned and re-packaged by Dani Arribas-Bel.</p>
<p>Let us start by reading the data, which comes in a shapefile:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="points.html#cb18-1"></a>db &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">&#39;data/house_transactions&#39;</span>, <span class="dt">layer =</span> <span class="st">&#39;liv_house_trans&#39;</span>)</span></code></pre></div>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/home/jovyan/work/data/house_transactions&quot;, layer: &quot;liv_house_trans&quot;
## with 6324 features
## It has 18 fields
## Integer64 fields read as strings:  price</code></pre>
<p>Before we forget, let us make sure <code>price</code> is considered a number, not a factor:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="points.html#cb20-1"></a>db<span class="op">@</span>data<span class="op">$</span>price &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>((db<span class="op">@</span>data<span class="op">$</span>price)))</span></code></pre></div>
<p>The dataset spans the year 2014:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="points.html#cb21-1"></a><span class="co"># Format dates</span></span>
<span id="cb21-2"><a href="points.html#cb21-2"></a>dts &lt;-<span class="st"> </span><span class="kw">as.Date</span>(db<span class="op">@</span>data<span class="op">$</span>trans_date)</span>
<span id="cb21-3"><a href="points.html#cb21-3"></a><span class="co"># Set up summary table</span></span>
<span id="cb21-4"><a href="points.html#cb21-4"></a>tab &lt;-<span class="st"> </span><span class="kw">summary</span>(dts)</span>
<span id="cb21-5"><a href="points.html#cb21-5"></a>tab</span></code></pre></div>
<pre><code>##         Min.      1st Qu.       Median         Mean      3rd Qu. 
## &quot;2014-01-02&quot; &quot;2014-04-11&quot; &quot;2014-07-09&quot; &quot;2014-07-08&quot; &quot;2014-10-03&quot; 
##         Max. 
## &quot;2014-12-30&quot;</code></pre>
<p>We can then examine the elements of the object with the <code>summary</code> method:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="points.html#cb23-1"></a><span class="kw">summary</span>(db)</span></code></pre></div>
<pre><code>## Object of class SpatialPointsDataFrame
## Coordinates:
##              min    max
## coords.x1 333536 345449
## coords.x2 382684 397833
## Is projected: TRUE 
## proj4string :
## [+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000
## +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy
## +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894]
## Number of points: 6324
## Data attributes:
##       pcds                                           id      
##  L1 6LS : 126   {00029226-80EF-4280-9809-109B8509656A}:   1  
##  L8 5TE :  63   {00041BD2-4A07-4D41-A5AE-6459CD5FD37C}:   1  
##  L1 5AQ :  34   {0005AE67-9150-41D4-8D56-6BFC868EECA3}:   1  
##  L24 1WA:  31   {00183CD7-EE48-434B-8A1A-C94B30A93691}:   1  
##  L17 6BT:  26   {003EA3A5-F804-458D-A66F-447E27569456}:   1  
##  L3 1EE :  24   {00411304-DD5B-4F11-9748-93789D6A000E}:   1  
##  (Other):6020   (Other)                               :6318  
##      price                     trans_date   type     new      duration
##  Min.   :    1000   2014-06-27 00:00: 109   D: 505   N:5495   F:3927  
##  1st Qu.:   70000   2014-12-19 00:00: 109   F:1371   Y: 829   L:2397  
##  Median :  110000   2014-02-28 00:00: 105   O: 119                    
##  Mean   :  144310   2014-10-31 00:00:  95   S:1478                    
##  3rd Qu.:  160000   2014-03-28 00:00:  94   T:2851                    
##  Max.   :26615720   2014-11-28 00:00:  94                             
##                     (Other)         :5718                             
##       paon               saon                   street    
##  3      : 203   FLAT 2     :  25   CROSSHALL STREET: 133  
##  11     : 151   FLAT 3     :  25   STANHOPE STREET :  63  
##  14     : 148   FLAT 1     :  24   PALL MALL       :  47  
##  5      : 146   APARTMENT 4:  23   DUKE STREET     :  41  
##  4      : 140   APARTMENT 2:  21   MANN ISLAND     :  41  
##  8      : 128   (Other)    : 893   OLD HALL STREET :  39  
##  (Other):5408   NA&#39;s       :5313   (Other)         :5960  
##          locality           town           district           county    
##  WAVERTREE   : 126   LIVERPOOL:6324   KNOWSLEY :  12   MERSEYSIDE:6324  
##  MOSSLEY HILL: 102                    LIVERPOOL:6311                    
##  WALTON      :  88                    WIRRAL   :   1                    
##  WEST DERBY  :  71                                                      
##  WOOLTON     :  66                                                      
##  (Other)     : 548                                                      
##  NA&#39;s        :5323                                                      
##  ppd_cat  status         lsoa11          LSOA11CD   
##  A:5393   A:6324   E01033762: 144   E01033762: 144  
##  B: 931            E01033756:  98   E01033756:  98  
##                    E01033752:  93   E01033752:  93  
##                    E01033750:  71   E01033750:  71  
##                    E01006518:  68   E01006518:  68  
##                    E01033755:  65   E01033755:  65  
##                    (Other)  :5785   (Other)  :5785</code></pre>
<p>See how it contains several pieces, some relating to the spatial information, some relating to the tabular data attached to it. We can access each of the separately if we need it. For example, to pull out the names of the columns in the <code>data.frame</code>, we can use the <code>@data</code> appendix:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="points.html#cb25-1"></a><span class="kw">colnames</span>(db<span class="op">@</span>data)</span></code></pre></div>
<pre><code>##  [1] &quot;pcds&quot;       &quot;id&quot;         &quot;price&quot;      &quot;trans_date&quot; &quot;type&quot;      
##  [6] &quot;new&quot;        &quot;duration&quot;   &quot;paon&quot;       &quot;saon&quot;       &quot;street&quot;    
## [11] &quot;locality&quot;   &quot;town&quot;       &quot;district&quot;   &quot;county&quot;     &quot;ppd_cat&quot;   
## [16] &quot;status&quot;     &quot;lsoa11&quot;     &quot;LSOA11CD&quot;</code></pre>
<p>The rest of this session will focus on two main elements of the shapefile: the spatial dimension (as stored in the point coordinates), and the house price values contained in the <code>price</code> column. To get a sense of what they look like first, let us plot both. We can get a quick look at the non-spatial distribution of house values with the following commands:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="points.html#cb27-1"></a><span class="co"># Create the histogram</span></span>
<span id="cb27-2"><a href="points.html#cb27-2"></a>hist &lt;-<span class="st"> </span><span class="kw">qplot</span>(<span class="dt">data=</span>db<span class="op">@</span>data,<span class="dt">x=</span>price)</span>
<span id="cb27-3"><a href="points.html#cb27-3"></a>hist</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-8"></span>
<img src="02-points_files/figure-html/unnamed-chunk-8-1.png" alt="Raw house prices in Liverpool" width="672" />
<p class="caption">
Figure 3.1: Raw house prices in Liverpool
</p>
</div>
<p>This basically shows there is a lot of values concentrated around the lower end of the distribution but a few very large ones. A usual transformation to <em>shrink</em> these differences is to take logarithms:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="points.html#cb29-1"></a><span class="co"># Create log and add it to the table</span></span>
<span id="cb29-2"><a href="points.html#cb29-2"></a>logpr &lt;-<span class="st"> </span><span class="kw">log</span>(<span class="kw">as.numeric</span>(db<span class="op">@</span>data<span class="op">$</span>price))</span>
<span id="cb29-3"><a href="points.html#cb29-3"></a>db<span class="op">@</span>data[<span class="st">&#39;logpr&#39;</span>] &lt;-<span class="st"> </span>logpr</span>
<span id="cb29-4"><a href="points.html#cb29-4"></a><span class="co"># Create the histogram</span></span>
<span id="cb29-5"><a href="points.html#cb29-5"></a>hist &lt;-<span class="st"> </span><span class="kw">qplot</span>(<span class="dt">x=</span>logpr)</span>
<span id="cb29-6"><a href="points.html#cb29-6"></a>hist</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-9"></span>
<img src="02-points_files/figure-html/unnamed-chunk-9-1.png" alt="Log of house price in Liverpool" width="672" />
<p class="caption">
Figure 3.2: Log of house price in Liverpool
</p>
</div>
<p>To obtain the spatial distribution of these houses, we need to turn away from the <code>@data</code> component of <code>db</code>. The easiest, quickest (and also dirtiest) way to get a sense of what the data look like over space is using <code>plot</code>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="points.html#cb31-1"></a><span class="kw">plot</span>(db)</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-10"></span>
<img src="02-points_files/figure-html/unnamed-chunk-10-1.png" alt="Spatial distribution of house transactions in Liverpool" width="672" />
<p class="caption">
Figure 3.3: Spatial distribution of house transactions in Liverpool
</p>
</div>
</div>
<div id="kde" class="section level2">
<h2><span class="header-section-number">3.3</span> KDE</h2>
<p>Kernel Density Estimation (KDE) is a technique that creates a <em>continuous</em> representation of the distribution of a given variable, such as house prices. Although theoretically it can be applied to any dimension, usually, KDE is applied to either one or two dimensions.</p>
<div id="one-dimensional-kde" class="section level3">
<h3><span class="header-section-number">3.3.1</span> One-dimensional KDE</h3>
<p>KDE over a single dimension is essentially a contiguous version of a histogram. We can see that by overlaying a KDE on top of the histogram of logs that we have created before:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="points.html#cb32-1"></a><span class="co"># Create the base</span></span>
<span id="cb32-2"><a href="points.html#cb32-2"></a>base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(db<span class="op">@</span>data, <span class="kw">aes</span>(<span class="dt">x=</span>logpr))</span>
<span id="cb32-3"><a href="points.html#cb32-3"></a><span class="co"># Histogram</span></span>
<span id="cb32-4"><a href="points.html#cb32-4"></a>hist &lt;-<span class="st"> </span>base <span class="op">+</span><span class="st"> </span></span>
<span id="cb32-5"><a href="points.html#cb32-5"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="dt">bins=</span><span class="dv">50</span>, <span class="kw">aes</span>(<span class="dt">y=</span>..density..))</span>
<span id="cb32-6"><a href="points.html#cb32-6"></a><span class="co"># Overlay density plot</span></span>
<span id="cb32-7"><a href="points.html#cb32-7"></a>kde &lt;-<span class="st"> </span>hist <span class="op">+</span><span class="st"> </span></span>
<span id="cb32-8"><a href="points.html#cb32-8"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">fill=</span><span class="st">&quot;#FF6666&quot;</span>, <span class="dt">alpha=</span><span class="fl">0.5</span>, <span class="dt">colour=</span><span class="st">&quot;#FF6666&quot;</span>)</span>
<span id="cb32-9"><a href="points.html#cb32-9"></a>kde</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-11"></span>
<img src="02-points_files/figure-html/unnamed-chunk-11-1.png" alt="Histogram and KDE of the log of house prices in Liverpool" width="672" />
<p class="caption">
Figure 3.4: Histogram and KDE of the log of house prices in Liverpool
</p>
</div>
<p>The key idea is that we are smoothing out the discrete binning that the histogram involves. Note how the histogram is exactly the same as above shape-wise, but it has been rescalend on the Y axis to reflect probabilities rather than counts.</p>
</div>
<div id="two-dimensional-spatial-kde" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Two-dimensional (spatial) KDE</h3>
<p>Geography, at the end of the day, is usually represented as a two-dimensional space where we locate objects using a system of dual coordinates, <code>X</code> and <code>Y</code> (or latitude and longitude). Thanks to that, we can use the same technique as above to obtain a smooth representation of the distribution of a two-dimensional variable. The crucial difference is that, instead of obtaining a curve as the output, we will create a <em>surface</em>, where intensity will be represented with a color gradient, rather than with the second dimension, as it is the case in the figure above.</p>
<p>To create a spatial KDE in R, there are several ways. If you do not want to necessarily acknowledge the spatial nature of your data, or you they are not stored in a spatial format, you can plot them using <code>ggplot2</code>. Note we first need to convert the coordinates (stored in the spatial part of <code>db</code>) into columns of X and Y coordinates, then we can plot them:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="points.html#cb33-1"></a><span class="co"># Attach XY coordinates</span></span>
<span id="cb33-2"><a href="points.html#cb33-2"></a>db<span class="op">@</span>data[<span class="st">&#39;X&#39;</span>] &lt;-<span class="st"> </span>db<span class="op">@</span>coords[, <span class="dv">1</span>]</span>
<span id="cb33-3"><a href="points.html#cb33-3"></a>db<span class="op">@</span>data[<span class="st">&#39;Y&#39;</span>] &lt;-<span class="st"> </span>db<span class="op">@</span>coords[, <span class="dv">2</span>]</span>
<span id="cb33-4"><a href="points.html#cb33-4"></a><span class="co"># Set up base layer</span></span>
<span id="cb33-5"><a href="points.html#cb33-5"></a>base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>db<span class="op">@</span>data, <span class="kw">aes</span>(<span class="dt">x=</span>X, <span class="dt">y=</span>Y))</span>
<span id="cb33-6"><a href="points.html#cb33-6"></a><span class="co"># Create the KDE surface</span></span>
<span id="cb33-7"><a href="points.html#cb33-7"></a>kde &lt;-<span class="st"> </span>base <span class="op">+</span><span class="st"> </span><span class="kw">stat_density2d</span>(<span class="kw">aes</span>(<span class="dt">x =</span> X, <span class="dt">y =</span> Y, <span class="dt">alpha =</span> ..level..), </span>
<span id="cb33-8"><a href="points.html#cb33-8"></a>               <span class="dt">size =</span> <span class="fl">0.01</span>, <span class="dt">bins =</span> <span class="dv">16</span>, <span class="dt">geom =</span> <span class="st">&#39;polygon&#39;</span>) <span class="op">+</span></span>
<span id="cb33-9"><a href="points.html#cb33-9"></a><span class="st">            </span><span class="kw">scale_fill_gradient</span>()</span>
<span id="cb33-10"><a href="points.html#cb33-10"></a>kde</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-12"></span>
<img src="02-points_files/figure-html/unnamed-chunk-12-1.png" alt="KDE of house transactions in Liverpool" width="672" />
<p class="caption">
Figure 3.5: KDE of house transactions in Liverpool
</p>
</div>
<p>Or, we can use a package such as the <code>GISTools</code>, which allows to pass a spatial object directly:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="points.html#cb34-1"></a><span class="co"># Compute the KDE</span></span>
<span id="cb34-2"><a href="points.html#cb34-2"></a>kde &lt;-<span class="st"> </span><span class="kw">kde.points</span>(db)</span>
<span id="cb34-3"><a href="points.html#cb34-3"></a><span class="co"># Plot the KDE</span></span>
<span id="cb34-4"><a href="points.html#cb34-4"></a><span class="kw">level.plot</span>(kde)</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-13"></span>
<img src="02-points_files/figure-html/unnamed-chunk-13-1.png" alt="KDE of house transactions in Liverpool" width="672" />
<p class="caption">
Figure 3.6: KDE of house transactions in Liverpool
</p>
</div>
<p>Either of these approaches generate a surface that represents the density of dots, that is an estimation of the probability of finding a house transaction at a given coordinate. However, without any further information, they are hard to interpret and link with previous knowledge of the area. To bring such context to the figure, we can plot an underlying basemap, using a cloud provider such as Google Maps or, as in this case, OpenStreetMap. To do it, we will leverage the library <code>ggmap</code>, which is designed to play nicely with the <code>ggplot2</code> family (hence the seemingly counterintuitive example above). Before we can plot them with the online map, we need to reproject them though.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="points.html#cb35-1"></a><span class="co"># Reproject coordinates</span></span>
<span id="cb35-2"><a href="points.html#cb35-2"></a>wgs84 &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</span>)</span>
<span id="cb35-3"><a href="points.html#cb35-3"></a>db_wgs84 &lt;-<span class="st"> </span><span class="kw">spTransform</span>(db, wgs84)</span>
<span id="cb35-4"><a href="points.html#cb35-4"></a>db_wgs84<span class="op">@</span>data[<span class="st">&#39;lon&#39;</span>] &lt;-<span class="st"> </span>db_wgs84<span class="op">@</span>coords[, <span class="dv">1</span>]</span>
<span id="cb35-5"><a href="points.html#cb35-5"></a>db_wgs84<span class="op">@</span>data[<span class="st">&#39;lat&#39;</span>] &lt;-<span class="st"> </span>db_wgs84<span class="op">@</span>coords[, <span class="dv">2</span>]</span>
<span id="cb35-6"><a href="points.html#cb35-6"></a>xys &lt;-<span class="st"> </span>db_wgs84<span class="op">@</span>data[<span class="kw">c</span>(<span class="st">&#39;lon&#39;</span>, <span class="st">&#39;lat&#39;</span>)]</span>
<span id="cb35-7"><a href="points.html#cb35-7"></a><span class="co"># Bounding box</span></span>
<span id="cb35-8"><a href="points.html#cb35-8"></a>liv &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">left =</span> <span class="kw">min</span>(xys<span class="op">$</span>lon), <span class="dt">bottom =</span> <span class="kw">min</span>(xys<span class="op">$</span>lat), </span>
<span id="cb35-9"><a href="points.html#cb35-9"></a>         <span class="dt">right =</span> <span class="kw">max</span>(xys<span class="op">$</span>lon), <span class="dt">top =</span> <span class="kw">max</span>(xys<span class="op">$</span>lat))</span>
<span id="cb35-10"><a href="points.html#cb35-10"></a><span class="co"># Download map tiles</span></span>
<span id="cb35-11"><a href="points.html#cb35-11"></a>basemap &lt;-<span class="st"> </span><span class="kw">get_stamenmap</span>(liv, <span class="dt">zoom =</span> <span class="dv">12</span>, </span>
<span id="cb35-12"><a href="points.html#cb35-12"></a>                         <span class="dt">maptype =</span> <span class="st">&quot;toner-lite&quot;</span>)</span></code></pre></div>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2013/1325.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2014/1325.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2015/1325.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2013/1326.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2014/1326.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2015/1326.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2013/1327.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2014/1327.png</code></pre>
<pre><code>## Source : http://tile.stamen.com/toner-lite/12/2015/1327.png</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="points.html#cb45-1"></a><span class="co"># Overlay KDE</span></span>
<span id="cb45-2"><a href="points.html#cb45-2"></a>final &lt;-<span class="st"> </span><span class="kw">ggmap</span>(basemap, <span class="dt">extent =</span> <span class="st">&quot;device&quot;</span>, </span>
<span id="cb45-3"><a href="points.html#cb45-3"></a>               <span class="dt">maprange=</span><span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb45-4"><a href="points.html#cb45-4"></a><span class="st">  </span><span class="kw">stat_density2d</span>(<span class="dt">data =</span> db_wgs84<span class="op">@</span>data, </span>
<span id="cb45-5"><a href="points.html#cb45-5"></a>                <span class="kw">aes</span>(<span class="dt">x =</span> lon, <span class="dt">y =</span> lat, </span>
<span id="cb45-6"><a href="points.html#cb45-6"></a>                    <span class="dt">alpha=</span>..level.., </span>
<span id="cb45-7"><a href="points.html#cb45-7"></a>                    <span class="dt">fill =</span> ..level..), </span>
<span id="cb45-8"><a href="points.html#cb45-8"></a>                <span class="dt">size =</span> <span class="fl">0.01</span>, <span class="dt">bins =</span> <span class="dv">16</span>, </span>
<span id="cb45-9"><a href="points.html#cb45-9"></a>                <span class="dt">geom =</span> <span class="st">&#39;polygon&#39;</span>, </span>
<span id="cb45-10"><a href="points.html#cb45-10"></a>                <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb45-11"><a href="points.html#cb45-11"></a><span class="st">  </span><span class="kw">scale_fill_gradient2</span>(<span class="st">&quot;Transaction</span><span class="ch">\n</span><span class="st">Density&quot;</span>, </span>
<span id="cb45-12"><a href="points.html#cb45-12"></a>                       <span class="dt">low =</span> <span class="st">&quot;#fffff8&quot;</span>, </span>
<span id="cb45-13"><a href="points.html#cb45-13"></a>                       <span class="dt">high =</span> <span class="st">&quot;#8da0cb&quot;</span>)</span>
<span id="cb45-14"><a href="points.html#cb45-14"></a>final</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-14"></span>
<img src="02-points_files/figure-html/unnamed-chunk-14-1.png" alt="KDE of house transactions in Liverpool" width="672" />
<p class="caption">
Figure 3.7: KDE of house transactions in Liverpool
</p>
</div>
<p>The plot above<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> allows us to not only see the distribution of house transactions, but to relate it to what we know about Liverpool, allowing us to establish many more connections than we were previously able. Mainly, we can easily see that the area with a highest volume of houses being sold is the city centre, with a “hole” around it that displays very few to no transactions and then several pockets further away.</p>
</div>
</div>
<div id="spatial-interpolation" class="section level2">
<h2><span class="header-section-number">3.4</span> Spatial Interpolation</h2>
<p>The previous section demonstrates how to visualize the distribution of a set of spatial objects represented as points. In particular, given a bunch of house transactions, it shows how one can effectively visualize their distribution over space and get a sense of the density of occurrences. Such visualization, because it is based on KDE, is based on a smooth continuum, rather than on a discrete approach (as a choropleth would do, for example).</p>
<p>Many times however, we are not particularly interested in learning about the density of occurrences, but about the distribution of a given value attached to each location. Think for example of weather stations and temperature: the location of the stations is no secret and rarely changes, so it is not of particular interest to visualize the density of stations; what we are usually interested instead is to know how temperature is distributed over space, given we only measure it in a few places. One could argue the example we have been working with so far, house price transactions, fits into this category as well: although where house are sold may be of relevance, more often we are interested in finding out what the “surface of price” looks like. Rather than <em>where are most houses being sold?</em> we usually want to know <em>where the most expensive or most affordable</em> houses are located.</p>
<p>In cases where we are interested in creating a surface of a given value, rather than a simple density surface of occurrences, KDE cannot help us. In these cases, what we are interested in is <em>spatial interpolation</em>, a family of techniques that aim at exactly that: creating continuous surfaces for a particular phenomenon (e.g. temperature, house prices) given only a finite sample of observations. Spatial interpolation is a large field of research that is still being actively developed and that can involve a substantial amount of mathematical complexity in order to obtain the most accurate estimates possible<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>. In this session, we will introduce the simplest possible way of interpolating values, hoping this will give you a general understanding of the methodology and, if you are interested, you can check out further literature. For example, <span class="citation">Banerjee, Carlin, and Gelfand (<a href="#ref-banerjee2014hierarchical" role="doc-biblioref">2014</a>)</span> or <span class="citation">Cressie (<a href="#ref-cressie2015statistics" role="doc-biblioref">2015</a>)</span> are hard but good overviews.</p>
<div id="inverse-distance-weight-idw-interpolation" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Inverse Distance Weight (IDW) interpolation</h3>
<p>The technique we will cover here is called <em>Inverse Distance Weighting</em>, or IDW for convenience. <span class="citation">Brunsdon and Comber (<a href="#ref-comber2015" role="doc-biblioref">2015</a>)</span> offer a good description:</p>
<blockquote>
<p>In the <em>inverse distance weighting</em> (IDW) approach to interpolation, to estimate the value of <span class="math inline">\(z\)</span> at location <span class="math inline">\(x\)</span> a weighted mean of nearby observations is taken […]. To accommodate the idea that observations of <span class="math inline">\(z\)</span> at points closer to <span class="math inline">\(x\)</span> should be given more importance in the interpolation, greater weight is given to these points […]</p>
<p>— Page 204</p>
</blockquote>
<p>The math<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> is not particularly complicated and may be found in detail elsewhere (the reference above is a good starting point), so we will not spend too much time on it. More relevant in this context is the intuition behind. Essentially, the idea is that we will create a surface of house price by smoothing many values arranged along a regular grid and obtained by interpolating from the known locations to the regular grid locations. This will give us full and equal coverage to soundly perform the smoothing.</p>
<p>Enough chat, let’s code.</p>
<p>From what we have just mentioned, there are a few steps to perform an IDW spatial interpolation:</p>
<ol style="list-style-type: decimal">
<li>Create a regular grid over the area where we have house transactions.</li>
<li>Obtain IDW estimates for each point in the grid, based on the values of <span class="math inline">\(k\)</span> nearest neighbors.</li>
<li>Plot a smoothed version of the grid, effectively representing the surface of house prices.</li>
</ol>
<p>Let us go in detail into each of them<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. First, let us set up a grid:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="points.html#cb46-1"></a>liv.grid &lt;-<span class="st"> </span><span class="kw">spsample</span>(db, <span class="dt">type=</span><span class="st">&#39;regular&#39;</span>, <span class="dt">n=</span><span class="dv">25000</span>)</span></code></pre></div>
<p>That’s it, we’re done! The function <code>spsample</code> hugely simplifies the task by taking a spatial object and returning the grid we need. Not a couple of additional arguments we pass: <code>type</code> allows us to get a set of points that are <em>uniformly</em> distributed over space, which is handy for the later smoothing; <code>n</code> controls how many points we want to create in that grid.</p>
<p>On to the IDW. Again, this is hugely simplified by <code>gstat</code>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="points.html#cb47-1"></a>idw.hp &lt;-<span class="st"> </span><span class="kw">idw</span>(price <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">locations=</span>db, <span class="dt">newdata=</span>liv.grid)</span></code></pre></div>
<pre><code>## [inverse distance weighted interpolation]</code></pre>
<p>Boom! We’ve got it. Let us pause for a second to see how we just did it. First, we pass <code>price ~ 1</code>. This specifies the formula we are using to model house prices. The name on the left of <code>~</code> represents the variable we want to explain, while everything to its right captures the <em>explanatory</em> variables. Since we are considering the simplest possible case, we do not have further variables to add, so we simply write <code>1</code>. Then we specify the original locations for which we do have house prices (our original <code>db</code> object), and the points where we want to interpolate the house prices (the <code>liv.grid</code> object we just created above). One more note: by default, <code>idw.hp</code> uses all the available observations, weighted by distance, to provide an estimate for a given point. If you want to modify that and restrict the maximum number of neighbors to consider, you need to tweak the argument <code>nmax</code>, as we do above by using the 150 neares observations to each point<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>.</p>
<p>The object we get from <code>idw</code> is another spatial table, just as <code>db</code>, containing the interpolated values. As such, we can inspect it just as with any other of its kind. For example, to check out the top of the estimated table:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="points.html#cb49-1"></a><span class="kw">head</span>(idw.hp<span class="op">@</span>data)</span></code></pre></div>
<pre><code>##   var1.pred var1.var
## 1  158122.0       NA
## 2  158233.4       NA
## 3  158347.7       NA
## 4  158465.0       NA
## 5  158585.5       NA
## 6  158709.2       NA</code></pre>
<p>The column we will pay attention to is <code>var1.pred</code>. And to see the locations for which those correspond:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="points.html#cb51-1"></a><span class="kw">head</span>(idw.hp<span class="op">@</span>coords)</span></code></pre></div>
<pre><code>##            x1       x2
## [1,] 333608.5 382751.2
## [2,] 333693.5 382751.2
## [3,] 333778.4 382751.2
## [4,] 333863.4 382751.2
## [5,] 333948.3 382751.2
## [6,] 334033.3 382751.2</code></pre>
<p>So, for a hypothetical house sold at the location in the first row of <code>idw.hp@coords</code> (expressed in the OSGB coordinate system), the price we would guess it would cost, based on the price of houses sold nearby, is the first element of column <code>var1.pred</code> in <code>idw.hp@data</code>.</p>
</div>
<div id="a-surface-of-housing-prices" class="section level3">
<h3><span class="header-section-number">3.4.2</span> A surface of housing prices</h3>
<p>Once we have the IDW object computed, we can plot it to explore the distribution, not of house transactions in this case, but of house price over the geography of Liverpool. The easiest way to do this is by quickly calling the command <code>spplot</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="points.html#cb53-1"></a><span class="kw">spplot</span>(idw.hp[<span class="st">&#39;var1.pred&#39;</span>])</span></code></pre></div>
<p><img src="02-points_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>However, this is not entirely satisfactory for a number of reasons. Let us get an equivalen plot with the package <code>tmap</code>, which streamlines some of this and makes more aesthetically pleasant maps easier to build as it follows a “ggplot-y” approach.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="points.html#cb54-1"></a><span class="co"># Load up the layer</span></span>
<span id="cb54-2"><a href="points.html#cb54-2"></a>liv.otl &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="st">&#39;data/house_transactions&#39;</span>, <span class="st">&#39;liv_outline&#39;</span>)</span></code></pre></div>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/home/jovyan/work/data/house_transactions&quot;, layer: &quot;liv_outline&quot;
## with 1 features
## It has 1 fields</code></pre>
<p>The shape we will overlay looks like this:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="points.html#cb56-1"></a><span class="kw">qtm</span>(liv.otl)</span></code></pre></div>
<p><img src="02-points_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>Now let’s give it a first go!</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="points.html#cb57-1"></a><span class="co"># </span></span>
<span id="cb57-2"><a href="points.html#cb57-2"></a>p =<span class="st"> </span><span class="kw">tm_shape</span>(liv.otl) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="dt">col=</span><span class="st">&#39;black&#39;</span>, <span class="dt">alpha=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb57-3"><a href="points.html#cb57-3"></a><span class="st">  </span><span class="kw">tm_shape</span>(idw.hp) <span class="op">+</span><span class="st"> </span></span>
<span id="cb57-4"><a href="points.html#cb57-4"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">col=</span><span class="st">&#39;var1.pred&#39;</span>, <span class="dt">size=</span><span class="fl">0.1</span>, <span class="dt">alpha=</span><span class="fl">0.25</span>, </span>
<span id="cb57-5"><a href="points.html#cb57-5"></a>             <span class="dt">border.lwd=</span><span class="fl">0.</span>, <span class="dt">palette=</span><span class="st">&#39;YlGn&#39;</span>)</span>
<span id="cb57-6"><a href="points.html#cb57-6"></a>p</span></code></pre></div>
<p><img src="02-points_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>The last two plots, however, are not really a surface, but a representation of the points we have just estimated. To create a surface, we need to do an interim transformation to convert the spatial object <code>idw.hp</code> into a table that a “surface plotter” can understand.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="points.html#cb58-1"></a>xyz &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">coordinates</span>(idw.hp)[, <span class="dv">1</span>], </span>
<span id="cb58-2"><a href="points.html#cb58-2"></a>                  <span class="dt">y=</span><span class="kw">coordinates</span>(idw.hp)[, <span class="dv">2</span>], </span>
<span id="cb58-3"><a href="points.html#cb58-3"></a>                  <span class="dt">z=</span>idw.hp<span class="op">$</span>var1.pred)</span></code></pre></div>
<p>Now we are ready to plot the surface as a contour:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="points.html#cb59-1"></a>base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>xyz, <span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</span>
<span id="cb59-2"><a href="points.html#cb59-2"></a>surface &lt;-<span class="st"> </span>base <span class="op">+</span><span class="st"> </span><span class="kw">geom_contour</span>(<span class="kw">aes</span>(<span class="dt">z=</span>z))</span>
<span id="cb59-3"><a href="points.html#cb59-3"></a>surface</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-24"></span>
<img src="02-points_files/figure-html/unnamed-chunk-24-1.png" alt="Contour of prices in Liverpool" width="672" />
<p class="caption">
Figure 3.8: Contour of prices in Liverpool
</p>
</div>
<p>Which can also be shown as a filled contour:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="points.html#cb60-1"></a>base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>xyz, <span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</span>
<span id="cb60-2"><a href="points.html#cb60-2"></a>surface &lt;-<span class="st"> </span>base <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>z))</span>
<span id="cb60-3"><a href="points.html#cb60-3"></a>surface</span></code></pre></div>
<p><img src="02-points_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>The problem here, when compared to the KDE above for example, is that a few values are extremely large:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="points.html#cb61-1"></a><span class="kw">qplot</span>(<span class="dt">data=</span>xyz, <span class="dt">x=</span>z, <span class="dt">geom=</span><span class="st">&#39;density&#39;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-26"></span>
<img src="02-points_files/figure-html/unnamed-chunk-26-1.png" alt="Skewness of prices in Liverpool" width="672" />
<p class="caption">
Figure 3.9: Skewness of prices in Liverpool
</p>
</div>
<p>Let us then take the logarithm before we plot the surface:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="points.html#cb62-1"></a>xyz[<span class="st">&#39;lz&#39;</span>] &lt;-<span class="st"> </span><span class="kw">log</span>(xyz<span class="op">$</span>z)</span>
<span id="cb62-2"><a href="points.html#cb62-2"></a>base &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>xyz, <span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</span>
<span id="cb62-3"><a href="points.html#cb62-3"></a>surface &lt;-<span class="st"> </span>base <span class="op">+</span></span>
<span id="cb62-4"><a href="points.html#cb62-4"></a><span class="st">           </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>lz),</span>
<span id="cb62-5"><a href="points.html#cb62-5"></a>                       <span class="dt">show.legend =</span> F)</span>
<span id="cb62-6"><a href="points.html#cb62-6"></a>surface</span></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-27"></span>
<img src="02-points_files/figure-html/unnamed-chunk-27-1.png" alt="Surface of log-prices in Liverpool" width="672" />
<p class="caption">
Figure 3.10: Surface of log-prices in Liverpool
</p>
</div>
<p>Now this looks better. We can start to tell some patterns. To bring in context, it would be great to be able to add a basemap layer, as we did for the KDE. This is conceptually very similar to what we did above, starting by reprojecting the points and continuing by overlaying them on top of the basemap. However, technically speaking it is not possible because <code>ggmap</code> –the library we have been using to display tiles from cloud providers– does not play well with our own rasters (i.e. the price surface). At the moment, it is surprisingly tricky to get this to work, so we will park it for now. However, developments such as the <a href="https://github.com/edzer/sfr"><code>sf</code></a> project promise to make this easier in the future<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>.</p>
</div>
<div id="what-should-the-next-houses-price-be" class="section level3">
<h3><span class="header-section-number">3.4.3</span> <em>“What should the next house’s price be?”</em></h3>
<p>The last bit we will explore in this session relates to prediction for new values. Imagine you are a real state data scientist and your boss asks you to give an estimate of how much a new house going into the market should cost. The only information you have to make such a guess is the location of the house. In this case, the IDW model we have just fitted can help you. The trick is realizing that, instead of creating an entire grid, all we need is to obtain an estimate of a single location.</p>
<p>Let us say, the house is located on the coordinates <code>x=340000, y=390000</code> as expressed in the GB National Grid coordinate system. In that case, we can do as follows:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="points.html#cb63-1"></a>pt &lt;-<span class="st"> </span><span class="kw">SpatialPoints</span>(<span class="kw">cbind</span>(<span class="dt">x=</span><span class="dv">340000</span>, <span class="dt">y=</span><span class="dv">390000</span>),</span>
<span id="cb63-2"><a href="points.html#cb63-2"></a>                    <span class="dt">proj4string =</span> db<span class="op">@</span>proj4string)</span>
<span id="cb63-3"><a href="points.html#cb63-3"></a>idw.one &lt;-<span class="st"> </span><span class="kw">idw</span>(price <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">locations=</span>db, <span class="dt">newdata=</span>pt)</span></code></pre></div>
<pre><code>## [inverse distance weighted interpolation]</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="points.html#cb65-1"></a>idw.one</span></code></pre></div>
<pre><code>## class       : SpatialPointsDataFrame 
## features    : 1 
## extent      : 340000, 340000, 390000, 390000  (xmin, xmax, ymin, ymax)
## crs         : +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +datum=OSGB36 +units=m +no_defs +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 
## variables   : 2
## names       :        var1.pred, var1.var 
## value       : 157099.029513871,       NA</code></pre>
<p>And, as show above, the estimated value is GBP157,099<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>.</p>
<p>Using this predictive logic, and taking advantage of Google Maps and its geocoding capabilities, it is possible to devise a function that takes an arbitrary address in Liverpool and, based on the transactions occurred throughout 2014, provides an estimate of what the price for a property in that location could be.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="points.html#cb67-1"></a>how.much.is &lt;-<span class="st"> </span><span class="cf">function</span>(address, <span class="dt">print.message=</span><span class="ot">TRUE</span>){</span>
<span id="cb67-2"><a href="points.html#cb67-2"></a>  <span class="co"># Convert the address into Lon/Lat coordinates</span></span>
<span id="cb67-3"><a href="points.html#cb67-3"></a>  <span class="co"># </span><span class="al">NOTE</span><span class="co">: this now requires an API key</span></span>
<span id="cb67-4"><a href="points.html#cb67-4"></a>  <span class="co"># https://github.com/dkahle/ggmap#google-maps-and-credentials</span></span>
<span id="cb67-5"><a href="points.html#cb67-5"></a>  ll.pt &lt;-<span class="st"> </span><span class="kw">geocode</span>(address)</span>
<span id="cb67-6"><a href="points.html#cb67-6"></a>  <span class="co"># Process as spatial table</span></span>
<span id="cb67-7"><a href="points.html#cb67-7"></a>  wgs84 &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</span>)</span>
<span id="cb67-8"><a href="points.html#cb67-8"></a>  ll.pt &lt;-<span class="st"> </span><span class="kw">SpatialPoints</span>(<span class="kw">cbind</span>(<span class="dt">x=</span>ll.pt<span class="op">$</span>lon, <span class="dt">y=</span>ll.pt<span class="op">$</span>lat),</span>
<span id="cb67-9"><a href="points.html#cb67-9"></a>                      <span class="dt">proj4string =</span> wgs84)</span>
<span id="cb67-10"><a href="points.html#cb67-10"></a>  <span class="co"># Transform Lon/Lat into OSGB</span></span>
<span id="cb67-11"><a href="points.html#cb67-11"></a>  pt &lt;-<span class="st"> </span><span class="kw">spTransform</span>(ll.pt, db<span class="op">@</span>proj4string)</span>
<span id="cb67-12"><a href="points.html#cb67-12"></a>  <span class="co"># Obtain prediction</span></span>
<span id="cb67-13"><a href="points.html#cb67-13"></a>  idw.one &lt;-<span class="st"> </span><span class="kw">idw</span>(price <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">locations=</span>db, <span class="dt">newdata=</span>pt)</span>
<span id="cb67-14"><a href="points.html#cb67-14"></a>  price &lt;-<span class="st"> </span>idw.one<span class="op">@</span>data<span class="op">$</span>var1.pred</span>
<span id="cb67-15"><a href="points.html#cb67-15"></a>  <span class="co"># Return predicted price</span></span>
<span id="cb67-16"><a href="points.html#cb67-16"></a>  <span class="cf">if</span>(print.message<span class="op">==</span>T){</span>
<span id="cb67-17"><a href="points.html#cb67-17"></a>    <span class="kw">writeLines</span>(<span class="kw">paste</span>(<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">Based on what surrounding properties were sold&quot;</span>,</span>
<span id="cb67-18"><a href="points.html#cb67-18"></a>                    <span class="st">&quot;for in 2014 a house located at&quot;</span>, address, <span class="st">&quot;would&quot;</span>, </span>
<span id="cb67-19"><a href="points.html#cb67-19"></a>                    <span class="st">&quot;cost&quot;</span>,  <span class="kw">paste</span>(<span class="st">&quot;GBP&quot;</span>, <span class="kw">round</span>(price), <span class="st">&quot;.&quot;</span>, <span class="dt">sep=</span><span class="st">&#39;&#39;</span>), <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span>))</span>
<span id="cb67-20"><a href="points.html#cb67-20"></a>  }</span>
<span id="cb67-21"><a href="points.html#cb67-21"></a>  <span class="kw">return</span>(price)</span>
<span id="cb67-22"><a href="points.html#cb67-22"></a>}</span></code></pre></div>
<p>Ready to test!</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="points.html#cb68-1"></a>address &lt;-<span class="st"> &quot;74 Bedford St S, Liverpool, L69 7ZT, UK&quot;</span></span>
<span id="cb68-2"><a href="points.html#cb68-2"></a><span class="co">#p &lt;- how.much.is(address)</span></span></code></pre></div>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-banerjee2014hierarchical">
<p>Banerjee, Sudipto, Bradley P Carlin, and Alan E Gelfand. 2014. <em>Hierarchical Modeling and Analysis for Spatial Data</em>. Crc Press.</p>
</div>
<div id="ref-bivand2013applied">
<p>Bivand, Roger S, Edzer Pebesma, and Virgilio Gómez-Rubio. 2013. <em>Applied Spatial Data Analysis with R</em>. Springer New York.</p>
</div>
<div id="ref-comber2015">
<p>Brunsdon, Chris, and Lex Comber. 2015. <em>An Introduction to R for Spatial Analysis &amp; Mapping</em>. Sage.</p>
</div>
<div id="ref-cressie2015statistics">
<p>Cressie, Noel. 2015. <em>Statistics for Spatial Data</em>. John Wiley &amp; Sons.</p>
</div>
<div id="ref-lovelace2014introduction">
<p>Lovelace, Robin, and James Cheshire. 2014. “Introduction to visualising spatial data in R.” <em>National Centre for Research Methods Working Papers</em> 14 (03). <a href="https://github.com/Robinlovelace/Creating-maps-in-R">https://github.com/Robinlovelace/Creating-maps-in-R</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>This note is part of <a href="index.html">Spatial Analysis Notes</a> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Points – Kernel Density Estimation and Spatial interpolation</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://darribas.org" property="cc:attributionName" rel="cc:attributionURL">Dani Arribas-Bel</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.<a href="points.html#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>You can install package <code>mypackage</code> by running the command <code>install.packages("mypackage")</code> on the R prompt or through the <code>Tools --&gt; Install Packages...</code> menu in RStudio.<a href="points.html#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p><strong>EXERCISE</strong> The map above uses the Stamen map <code>toner-lite</code>. Explore additional tile styles on their <a href="http://maps.stamen.com/#watercolor/12/37.7706/-122.3782">website</a> and try to recreate the plot above.<a href="points.html#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>There is also an important economic incentive to do this: some of the most popular applications are in the oil and gas or mining industries. In fact, the very creator of this technique, <a href="https://en.wikipedia.org/wiki/Danie_G._Krige">Danie G. Krige</a>, was a mining engineer. His name is usually used to nickname spatial interpolation as <em>kriging</em>.<a href="points.html#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>Essentially, for any point <span class="math inline">\(x\)</span> in space, the IDW estimate for value <span class="math inline">\(z\)</span> is equivalent to <span class="math inline">\(\hat{z} (x) = \dfrac{\sum_i w_i z_i}{\sum_i w_i}\)</span> where <span class="math inline">\(i\)</span> are the observations for which we do have a value, and <span class="math inline">\(w_i\)</span> is a weight given to location <span class="math inline">\(i\)</span> based on its distance to <span class="math inline">\(x\)</span>.<a href="points.html#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>For the relevant calculations, we will be using the <code>gstat</code> library.<a href="points.html#fnref6" class="footnote-back">↩︎</a></p></li>
<li id="fn7"><p>Have a play with this because the results do change significantly. Can you reason why?<a href="points.html#fnref7" class="footnote-back">↩︎</a></p></li>
<li id="fn8"><p><strong>BONUS</strong> if you can figure out a way to do it yourself!<a href="points.html#fnref8" class="footnote-back">↩︎</a></p></li>
<li id="fn9"><p><strong>PRO QUESTION</strong> Is that house expensive or cheap, as compared to the other houses sold in this dataset? Can you figure out where the house is?<a href="points.html#fnref9" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="flows.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/02-points.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["spatial_analysis_notes.pdf", "spatial_analysis_notes.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
